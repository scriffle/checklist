<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist 2.0 â€” Student Progress Report</title>
    <style>
        :root {
            --color-primary: #2d9d78;
            --color-primary-dark: #1e7d5e;
            --color-primary-pale: #e8f5f0;
            --color-primary-glow: rgba(45, 157, 120, 0.15);
            --color-bg: #f8fafb;
            --color-bg-card: #ffffff;
            --color-bg-warm: #f5f7f6;
            --color-bg-hover: rgba(45, 157, 120, 0.08);
            --color-text: #1e293b;
            --color-text-secondary: #4a5f58;
            --color-text-muted: #64748b;
            --color-text-faint: #94a3b8;
            --color-text-inverse: #ffffff;
            --color-border: #e2e8f0;
            --color-border-light: #f1f5f9;
            --color-success: #22c55e;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --color-info: #3b82f6;
            --level-1: #cbd5e1;
            --level-2: #f97316;
            --level-3: #eab308;
            --level-4: #22c55e;
            --level-5: #8b5cf6;
            --font-display: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --font-body: 'Segoe UI', system-ui, -apple-system, sans-serif;
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.5rem;
            --space-6: 2rem;
            --space-8: 3rem;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.04);
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
        }

        [data-theme="dark"] {
            --color-bg: #0f1714;
            --color-bg-card: #1a2420;
            --color-bg-warm: #1f2d28;
            --color-bg-hover: rgba(45, 157, 120, 0.15);
            --color-text: #e8f0ed;
            --color-text-secondary: #a8b8b2;
            --color-text-muted: #6a7a74;
            --color-text-faint: #4a5a54;
            --color-border: #2d3d36;
            --color-border-light: #243029;
            --color-primary-pale: rgba(45, 157, 120, 0.2);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-body);
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            background: var(--color-bg-card);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-4) var(--space-6);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        .app-header h1 {
            font-family: var(--font-display);
            font-size: var(--text-xl);
            font-weight: 700;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .app-header h1 .icon { font-size: var(--text-2xl); }
        .header-actions { display: flex; align-items: center; gap: var(--space-3); }

        .theme-toggle {
            background: var(--color-bg-warm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-2);
            cursor: pointer;
            color: var(--color-text-secondary);
            font-size: var(--text-lg);
            width: 38px; height: 38px;
            display: flex; align-items: center; justify-content: center;
            transition: all var(--transition-fast);
        }
        .theme-toggle:hover { background: var(--color-bg-hover); border-color: var(--color-primary); }

        /* Main content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
        }

        /* Data input section */
        .data-input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-5);
            margin-bottom: var(--space-6);
        }
        @media (max-width: 768px) {
            .data-input-section { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            box-shadow: var(--shadow-sm);
            transition: box-shadow var(--transition-normal);
        }
        .card:hover { box-shadow: var(--shadow-md); }

        .card-title {
            font-family: var(--font-display);
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .card-title .icon { color: var(--color-primary); }

        .input-group {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
        }
        .input-group input[type="text"] {
            flex: 1;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            background: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-body);
            transition: border-color var(--transition-fast);
        }
        .input-group input[type="text"]:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-glow);
        }

        .btn {
            padding: var(--space-2) var(--space-4);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: 600;
            cursor: pointer;
            font-family: var(--font-body);
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            white-space: nowrap;
        }
        .btn-primary {
            background: var(--color-primary);
            color: var(--color-text-inverse);
        }
        .btn-primary:hover { background: var(--color-primary-dark); }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: var(--color-bg-warm);
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
        }
        .btn-secondary:hover { background: var(--color-bg-hover); border-color: var(--color-primary); }

        .input-hint {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            margin-top: var(--space-1);
        }

        .drop-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-8) var(--space-4);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            color: var(--color-text-muted);
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--color-primary);
            background: var(--color-primary-pale);
            color: var(--color-primary);
        }
        .drop-zone .drop-icon { font-size: 2rem; margin-bottom: var(--space-2); }
        .drop-zone p { font-size: var(--text-sm); }
        .drop-zone .drop-sub { font-size: var(--text-xs); margin-top: var(--space-1); color: var(--color-text-faint); }

        /* Summary stats */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-5);
        }
        @media (max-width: 768px) {
            .summary-stats { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .summary-stats { grid-template-columns: 1fr; }
        }
        .stat-box {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
            box-shadow: var(--shadow-sm);
        }
        .stat-value {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--color-primary);
            font-family: var(--font-display);
        }
        .stat-value.warning { color: var(--color-warning); }
        .stat-value.success { color: var(--color-success); }
        .stat-label {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--space-1);
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-5);
            flex-wrap: wrap;
        }
        .toolbar .search-input {
            flex: 1;
            min-width: 200px;
            padding: var(--space-2) var(--space-3);
            padding-left: 2.2rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            background: var(--color-bg-card);
            color: var(--color-text);
            font-family: var(--font-body);
            transition: border-color var(--transition-fast);
        }
        .toolbar .search-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-glow);
        }
        .search-wrapper {
            position: relative;
            flex: 1;
            min-width: 200px;
        }
        .search-wrapper .search-icon {
            position: absolute;
            left: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-faint);
            font-size: var(--text-sm);
            pointer-events: none;
        }

        .toolbar select {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            background: var(--color-bg-card);
            color: var(--color-text);
            font-family: var(--font-body);
            cursor: pointer;
            transition: border-color var(--transition-fast);
        }
        .toolbar select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .student-count-badge {
            background: var(--color-primary-pale);
            color: var(--color-primary);
            padding: var(--space-1) var(--space-3);
            border-radius: 999px;
            font-size: var(--text-xs);
            font-weight: 600;
            white-space: nowrap;
        }

        /* Student cards grid */
        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: var(--space-4);
        }
        @media (max-width: 400px) {
            .students-grid { grid-template-columns: 1fr; }
        }

        .student-card {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }
        .student-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
            transform: translateY(-2px);
        }

        .student-card-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }
        .avatar {
            width: 44px; height: 44px;
            border-radius: 50%;
            background: var(--color-primary);
            color: var(--color-text-inverse);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: var(--text-sm);
            flex-shrink: 0;
        }
        .student-card-header .student-info { flex: 1; min-width: 0; }
        .student-card-header .student-name {
            font-weight: 600;
            font-size: var(--text-base);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .class-badge {
            display: inline-block;
            background: var(--color-primary-pale);
            color: var(--color-primary-dark);
            padding: 1px var(--space-2);
            border-radius: 999px;
            font-size: var(--text-xs);
            font-weight: 600;
        }

        .progress-section { margin-bottom: var(--space-3); }
        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-1);
        }
        .progress-label span { font-size: var(--text-xs); color: var(--color-text-muted); }
        .progress-label .progress-value { font-weight: 700; color: var(--color-text); font-size: var(--text-sm); }

        .progress-bar-track {
            height: 8px;
            background: var(--color-border-light);
            border-radius: 999px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: var(--color-primary);
            border-radius: 999px;
            transition: width var(--transition-normal);
        }

        /* Level distribution bar */
        .level-dist-bar {
            display: flex;
            height: 10px;
            border-radius: 999px;
            overflow: hidden;
            margin-bottom: var(--space-3);
            background: var(--color-border-light);
        }
        .level-dist-bar .level-segment {
            height: 100%;
            transition: width var(--transition-normal);
        }
        .level-dist-bar .level-segment.l1 { background: var(--level-1); }
        .level-dist-bar .level-segment.l2 { background: var(--level-2); }
        .level-dist-bar .level-segment.l3 { background: var(--level-3); }
        .level-dist-bar .level-segment.l4 { background: var(--level-4); }
        .level-dist-bar .level-segment.l5 { background: var(--level-5); }

        .level-legend {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
            flex-wrap: wrap;
        }
        .level-legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        .level-legend-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
        }

        /* Engagement heatmap on student cards */
        .engagement-heatmap {
            display: flex;
            gap: 2px;
            margin-top: var(--space-2);
        }
        .heatmap-day {
            width: 14px; height: 14px;
            border-radius: 2px;
            background: var(--color-border-light);
            flex-shrink: 0;
        }
        .heatmap-day.h1 { background: #bbf7d0; }
        .heatmap-day.h2 { background: #4ade80; }
        .heatmap-day.h3 { background: #16a34a; }
        .heatmap-day.h4 { background: #166534; }
        [data-theme="dark"] .heatmap-day { background: rgba(255,255,255,0.08); }
        [data-theme="dark"] .heatmap-day.h1 { background: rgba(74,222,128,0.2); }
        [data-theme="dark"] .heatmap-day.h2 { background: rgba(74,222,128,0.4); }
        [data-theme="dark"] .heatmap-day.h3 { background: rgba(74,222,128,0.65); }
        [data-theme="dark"] .heatmap-day.h4 { background: rgba(74,222,128,0.9); }

        /* Check-in indicator */
        .checkin-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--text-xs);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
        }
        .checkin-indicator.recent { background: #dcfce7; color: #166534; }
        .checkin-indicator.overdue { background: #fee2e2; color: #991b1b; }
        [data-theme="dark"] .checkin-indicator.recent { background: rgba(22,163,74,0.15); color: #4ade80; }
        [data-theme="dark"] .checkin-indicator.overdue { background: rgba(239,68,68,0.15); color: #fca5a5; }

        /* Session summary in detail view */
        .session-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }
        .session-stat-box {
            text-align: center;
            padding: var(--space-3);
            background: var(--color-bg);
            border: 1px solid var(--color-border-light);
            border-radius: var(--radius-md);
        }
        .session-stat-box .sval { font-size: var(--text-xl); font-weight: 700; color: var(--color-primary); }
        .session-stat-box .slbl { font-size: var(--text-xs); color: var(--color-text-muted); margin-top: var(--space-1); }
        .activity-tags { display: flex; flex-wrap: wrap; gap: var(--space-2); margin-top: var(--space-3); }
        .activity-tag {
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: 600;
            background: var(--color-primary-pale);
            color: var(--color-primary);
        }
        .activity-tag.inactive { background: var(--color-border-light); color: var(--color-text-faint); }

        /* Daily activity bars */
        .daily-bars {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 60px;
            margin-top: var(--space-3);
        }
        .daily-bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
        }
        .daily-bar {
            width: 100%;
            min-height: 2px;
            background: var(--color-primary);
            border-radius: 2px 2px 0 0;
            opacity: 0.7;
        }
        .daily-bar-label {
            font-size: 9px;
            color: var(--color-text-faint);
            margin-top: 2px;
        }

        /* Radar chart */
        .radar-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-4);
            align-items: flex-start;
        }
        .radar-chart { flex-shrink: 0; }
        .radar-labels { font-size: 11px; fill: var(--color-text-muted); }
        .radar-polygon { stroke: var(--color-primary); stroke-width: 2; fill: rgba(45,157,120,0.15); }
        .radar-grid { stroke: var(--color-border); stroke-width: 0.5; fill: none; }
        .radar-axis { stroke: var(--color-border-light); stroke-width: 0.5; }
        .quality-list {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        .quality-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        .quality-label { font-size: var(--text-sm); color: var(--color-text-muted); width: 120px; flex-shrink: 0; }
        .quality-bar-track { flex: 1; height: 8px; background: var(--color-border-light); border-radius: 4px; overflow: hidden; }
        .quality-bar-fill { height: 100%; border-radius: 4px; background: var(--color-primary); transition: width 0.3s; }
        .quality-value { font-size: var(--text-xs); font-weight: 600; color: var(--color-text); width: 32px; text-align: right; }

        /* Growth timeline */
        .growth-timeline-svg { width: 100%; max-width: 600px; }
        .growth-line { stroke: var(--color-primary); stroke-width: 2.5; fill: none; }
        .growth-dot { fill: var(--color-primary); }
        .growth-grid-line { stroke: var(--color-border-light); stroke-width: 0.5; }
        .growth-label { font-size: 10px; fill: var(--color-text-faint); }
        .growth-val-label { font-size: 10px; fill: var(--color-text-muted); font-weight: 600; }

        /* Quality trend arrow on cards */
        .trend-arrow {
            display: inline-block;
            font-size: var(--text-xs);
            font-weight: 700;
            padding: 1px 4px;
            border-radius: var(--radius-sm);
        }
        .trend-arrow.up { color: #16a34a; }
        .trend-arrow.down { color: #dc2626; }
        .trend-arrow.flat { color: var(--color-text-faint); }

        /* Check-in participation table */
        .checkin-table { width: 100%; border-collapse: collapse; font-size: var(--text-sm); }
        .checkin-table th {
            text-align: left;
            padding: var(--space-2) var(--space-3);
            border-bottom: 2px solid var(--color-border);
            font-weight: 600;
            color: var(--color-text-muted);
            cursor: pointer;
        }
        .checkin-table th:hover { color: var(--color-primary); }
        .checkin-table td {
            padding: var(--space-2) var(--space-3);
            border-bottom: 1px solid var(--color-border-light);
        }
        .checkin-table tr.row-green td { background: rgba(22,163,74,0.05); }
        .checkin-table tr.row-amber td { background: rgba(217,119,6,0.05); }
        .checkin-table tr.row-red td { background: rgba(220,38,38,0.05); }

        .student-card-footer {
            display: flex;
            justify-content: space-between;
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            border-top: 1px solid var(--color-border-light);
            padding-top: var(--space-2);
        }
        .student-card-footer span {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: var(--space-8) var(--space-4);
            color: var(--color-text-muted);
        }
        .empty-state .empty-icon { font-size: 3rem; margin-bottom: var(--space-4); opacity: 0.5; }
        .empty-state h3 {
            font-size: var(--text-lg);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-2);
        }
        .empty-state p { font-size: var(--text-sm); }

        /* Student detail view */
        .detail-view { display: none; }
        .detail-view.active { display: block; }
        .overview-view.hidden { display: none; }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            font-size: var(--text-sm);
            font-family: var(--font-body);
            cursor: pointer;
            margin-bottom: var(--space-5);
            transition: all var(--transition-fast);
        }
        .back-button:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .detail-header {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: var(--space-5);
            flex-wrap: wrap;
        }
        .detail-header .avatar {
            width: 64px; height: 64px;
            font-size: var(--text-xl);
        }
        .detail-header-info { flex: 1; min-width: 200px; }
        .detail-header-info h2 {
            font-size: var(--text-2xl);
            font-weight: 700;
            font-family: var(--font-display);
        }
        .detail-header-meta {
            display: flex;
            gap: var(--space-4);
            flex-wrap: wrap;
            margin-top: var(--space-1);
            font-size: var(--text-sm);
            color: var(--color-text-muted);
        }
        .detail-header-stat {
            text-align: center;
            padding: var(--space-2) var(--space-4);
            background: var(--color-primary-pale);
            border-radius: var(--radius-md);
        }
        .detail-header-stat .stat-val {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--color-primary);
        }
        .detail-header-stat .stat-lbl {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }

        /* Detail sections */
        .detail-section {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-sm);
        }
        .detail-section h3 {
            font-family: var(--font-display);
            font-size: var(--text-lg);
            font-weight: 600;
            margin-bottom: var(--space-4);
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .detail-section h3 .icon { color: var(--color-primary); }

        /* Current levels grid */
        .levels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-3);
        }
        .lp-card {
            background: var(--color-bg-warm);
            border: 1px solid var(--color-border-light);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .lp-card .lp-name {
            font-size: var(--text-sm);
            color: var(--color-text);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: var(--space-2);
        }
        .level-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px; height: 30px;
            border-radius: var(--radius-sm);
            font-size: var(--text-sm);
            font-weight: 700;
            color: #fff;
            flex-shrink: 0;
        }
        .level-badge.l1 { background: var(--level-1); color: var(--color-text); }
        .level-badge.l2 { background: var(--level-2); }
        .level-badge.l3 { background: var(--level-3); color: #1a1a1a; }
        .level-badge.l4 { background: var(--level-4); }
        .level-badge.l5 { background: var(--level-5); }

        /* Timeline */
        .timeline-container { display: flex; flex-direction: column; gap: var(--space-4); }
        .timeline-lp-name {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-1);
        }
        .timeline-track {
            display: flex;
            align-items: center;
            gap: 0;
            padding: var(--space-2) 0;
            overflow-x: auto;
        }
        .timeline-dot {
            width: 24px; height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }
        .timeline-dot.l1 { background: var(--level-1); color: var(--color-text); }
        .timeline-dot.l2 { background: var(--level-2); }
        .timeline-dot.l3 { background: var(--level-3); color: #1a1a1a; }
        .timeline-dot.l4 { background: var(--level-4); }
        .timeline-dot.l5 { background: var(--level-5); }
        .timeline-line {
            height: 3px;
            width: 40px;
            background: var(--color-border);
            flex-shrink: 0;
        }
        .timeline-date {
            font-size: 9px;
            color: var(--color-text-faint);
            text-align: center;
            margin-top: 2px;
            white-space: nowrap;
        }
        .timeline-dot-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Quiz stats */
        .quiz-summary {
            display: flex;
            gap: var(--space-5);
            margin-bottom: var(--space-4);
            flex-wrap: wrap;
        }
        .quiz-stat-box {
            text-align: center;
        }
        .quiz-stat-box .qval {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--color-primary);
        }
        .quiz-stat-box .qlbl {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        .quiz-rate-bar {
            height: 12px;
            background: var(--color-border-light);
            border-radius: 999px;
            overflow: hidden;
            max-width: 300px;
            margin-bottom: var(--space-4);
        }
        .quiz-rate-fill {
            height: 100%;
            background: var(--color-success);
            border-radius: 999px;
            transition: width var(--transition-normal);
        }

        .quiz-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--text-sm);
        }
        .quiz-table th {
            text-align: left;
            font-weight: 600;
            padding: var(--space-2) var(--space-3);
            border-bottom: 2px solid var(--color-border);
            color: var(--color-text-secondary);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .quiz-table td {
            padding: var(--space-2) var(--space-3);
            border-bottom: 1px solid var(--color-border-light);
            color: var(--color-text);
        }
        .quiz-table tr:hover td { background: var(--color-bg-hover); }

        /* Activity log */
        .activity-log { display: flex; flex-direction: column; gap: var(--space-2); }
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            transition: background var(--transition-fast);
        }
        .activity-item:hover { background: var(--color-bg-warm); }
        .activity-time {
            font-size: var(--text-xs);
            color: var(--color-text-faint);
            white-space: nowrap;
            min-width: 80px;
            padding-top: 2px;
        }
        .activity-icon {
            width: 28px; height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-xs);
            flex-shrink: 0;
        }
        .activity-icon.level-change { background: var(--color-primary-pale); color: var(--color-primary); }
        .activity-icon.quiz-result { background: #eff6ff; color: var(--color-info); }
        [data-theme="dark"] .activity-icon.quiz-result { background: rgba(59,130,246,0.15); }
        .activity-icon.check-in { background: #fef3c7; color: #d97706; }
        [data-theme="dark"] .activity-icon.check-in { background: rgba(217,119,6,0.15); }
        .activity-icon.session-end { background: #f3e8ff; color: #7c3aed; }
        [data-theme="dark"] .activity-icon.session-end { background: rgba(124,58,237,0.15); }
        .activity-icon.character-snapshot { background: #fce7f3; color: #db2777; }
        [data-theme="dark"] .activity-icon.character-snapshot { background: rgba(219,39,119,0.15); }
        .activity-icon.test-event { background: var(--color-border-light); color: var(--color-text-faint); }
        .activity-content { flex: 1; min-width: 0; }
        .activity-content .activity-primary { color: var(--color-text); }
        .activity-content .activity-secondary { font-size: var(--text-xs); color: var(--color-text-muted); }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: var(--space-5);
            right: var(--space-5);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        .toast {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-left: 4px solid var(--color-primary);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            box-shadow: var(--shadow-lg);
            font-size: var(--text-sm);
            max-width: 360px;
            animation: toastIn 0.3s ease forwards;
            color: var(--color-text);
        }
        .toast.error { border-left-color: var(--color-error); }
        .toast.success { border-left-color: var(--color-success); }
        .toast.warning { border-left-color: var(--color-warning); }
        .toast.fade-out { animation: toastOut 0.3s ease forwards; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(40px); } }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 18px; height: 18px;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.15);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }
        .loading-overlay.active { display: flex; }
        .loading-box {
            background: var(--color-bg-card);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-3);
        }
        .loading-box .spinner { width: 32px; height: 32px; border-width: 3px; }
        .loading-box p { font-size: var(--text-sm); color: var(--color-text-muted); }
    </style>
</head>
<body>

<header class="app-header">
    <h1><span class="icon">&#x1F4CA;</span> Student Progress Report</h1>
    <div class="header-actions">
        <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">&#x1F319;</button>
    </div>
</header>

<main class="main-content">
    <!-- Data Input Section -->
    <section class="data-input-section">
        <div class="card">
            <div class="card-title"><span class="icon">&#x1F4C4;</span> Google Sheet URL</div>
            <div class="input-group">
                <input type="text" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
                <button class="btn btn-primary" id="fetchBtn" onclick="fetchSheetData()">
                    <span id="fetchBtnText">Fetch Data</span>
                </button>
            </div>
            <div class="input-hint">Sheet must be published to web via File &rarr; Share &rarr; Publish to web (as CSV).</div>
        </div>
        <div class="card">
            <div class="card-title"><span class="icon">&#x1F4C1;</span> Upload CSV</div>
            <div class="drop-zone" id="dropZone">
                <div class="drop-icon">&#x1F4E5;</div>
                <p>Drop a .csv file here or click to browse</p>
                <div class="drop-sub">Exported from your Google Sheet event log</div>
            </div>
            <input type="file" id="fileInput" accept=".csv" hidden>
        </div>
    </section>

    <!-- Overview View -->
    <div class="overview-view" id="overviewView">
        <!-- Summary Stats -->
        <div class="summary-stats" id="summaryStats" style="display:none;">
            <div class="stat-box">
                <div class="stat-value" id="statTotalStudents">0</div>
                <div class="stat-label">Total Students</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="statAvgProgress">0%</div>
                <div class="stat-label">Avg Progress</div>
            </div>
            <div class="stat-box">
                <div class="stat-value warning" id="statAtRisk">0</div>
                <div class="stat-label">At Risk (&lt;25%)</div>
            </div>
            <div class="stat-box">
                <div class="stat-value success" id="statTopPerformers">0</div>
                <div class="stat-label">Top Performers (&gt;75%)</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar" id="toolbar" style="display:none;">
            <div class="search-wrapper">
                <span class="search-icon">&#x1F50D;</span>
                <input type="text" class="search-input" id="searchInput" placeholder="Search students...">
            </div>
            <select id="classFilter">
                <option value="">All Classes</option>
            </select>
            <select id="sortSelect">
                <option value="name-az">Name A-Z</option>
                <option value="name-za">Name Z-A</option>
                <option value="progress-hl">Progress High-Low</option>
                <option value="progress-lh">Progress Low-High</option>
                <option value="recent">Most Recent</option>
            </select>
            <span class="student-count-badge" id="studentCountBadge">0 students</span>
        </div>

        <!-- Student Grid -->
        <div class="students-grid" id="studentsGrid"></div>

        <!-- Check-in Participation Table -->
        <div class="detail-section" id="checkinParticipation" style="display:none; margin-top:var(--space-4);">
            <h3 style="cursor:pointer;" onclick="toggleCheckinTable()"><span class="icon">&#x1F4CB;</span> Check-in Participation <span id="checkinToggleArrow" style="font-size:var(--text-xs);">&#x25BC;</span></h3>
            <div id="checkinTableContainer"></div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState">
            <div class="empty-icon">&#x1F4CB;</div>
            <h3>No student data loaded</h3>
            <p>Enter a Google Sheet URL or upload a CSV file above to view student progress.</p>
        </div>
    </div>

    <!-- Detail View -->
    <div class="detail-view" id="detailView">
        <button class="back-button" onclick="showOverview()">&#x2190; Back to Overview</button>
        <div id="detailContent"></div>
    </div>
</main>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-box">
        <div class="spinner"></div>
        <p>Loading data...</p>
    </div>
</div>

<script>
(function() {
    'use strict';

    // ============ State ============
    let rawEvents = [];
    let studentMap = {};
    let classCodes = new Set();
    let currentStudentId = null;

    // ============ Utility Functions ============

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }

    function getInitials(name) {
        if (!name) return '?';
        const words = name.trim().split(/\s+/);
        if (words.length === 1) return words[0][0].toUpperCase();
        return (words[0][0] + words[words.length - 1][0]).toUpperCase();
    }

    function formatDate(date) {
        if (!(date instanceof Date) || isNaN(date)) return '-';
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const y = date.getFullYear();
        return d + '/' + m + '/' + y;
    }

    function formatDateTime(date) {
        if (!(date instanceof Date) || isNaN(date)) return '-';
        return formatDate(date) + ' ' +
            String(date.getHours()).padStart(2, '0') + ':' +
            String(date.getMinutes()).padStart(2, '0');
    }

    function formatRelativeDate(date) {
        if (!(date instanceof Date) || isNaN(date)) return '-';
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return diffMins + ' min ago';
        if (diffHours < 24) return diffHours + 'h ago';
        if (diffDays === 1) return 'Yesterday';
        if (diffDays < 7) return diffDays + ' days ago';
        if (diffDays < 30) return Math.floor(diffDays / 7) + 'w ago';
        return formatDate(date);
    }

    function formatDuration(ms) {
        if (!ms || ms <= 0) return '0s';
        var secs = Math.floor(ms / 1000);
        if (secs < 60) return secs + 's';
        var mins = Math.floor(secs / 60);
        var remSecs = secs % 60;
        if (mins < 60) return mins + 'm ' + (remSecs > 0 ? remSecs + 's' : '');
        var hrs = Math.floor(mins / 60);
        var remMins = mins % 60;
        return hrs + 'h ' + (remMins > 0 ? remMins + 'm' : '');
    }

    function decodeActivities(bitmask) {
        var labels = [];
        if (bitmask & 1) labels.push('Quiz');
        if (bitmask & 2) labels.push('Content');
        if (bitmask & 4) labels.push('Search');
        if (bitmask & 8) labels.push('Question');
        return labels.join(', ');
    }

    function showToast(message, type) {
        type = type || 'info';
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(function() {
            toast.classList.add('fade-out');
            setTimeout(function() { toast.remove(); }, 300);
        }, 5000);
    }

    function setLoading(on) {
        document.getElementById('loadingOverlay').classList.toggle('active', on);
    }

    // ============ Theme ============

    function initTheme() {
        const saved = localStorage.getItem('checklist-report-theme');
        if (saved) {
            document.documentElement.setAttribute('data-theme', saved);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
        updateThemeIcon();
    }

    function updateThemeIcon() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.getElementById('themeToggle').innerHTML = isDark ? '&#x2600;' : '&#x1F319;';
    }

    document.getElementById('themeToggle').addEventListener('click', function() {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('checklist-report-theme', next);
        updateThemeIcon();
    });

    initTheme();

    // ============ CSV Parsing ============

    function parseCSV(text) {
        const lines = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            if (inQuotes) {
                if (ch === '"') {
                    if (i + 1 < text.length && text[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = false;
                    }
                } else {
                    current += ch;
                }
            } else {
                if (ch === '"') {
                    inQuotes = true;
                } else if (ch === ',') {
                    lines.push(current);
                    current = '';
                } else if (ch === '\n' || ch === '\r') {
                    lines.push(current);
                    current = '';
                    if (ch === '\r' && i + 1 < text.length && text[i + 1] === '\n') i++;
                    if (lines.length > 0) {
                        yield_row(lines);
                    }
                    lines.length = 0;
                } else {
                    current += ch;
                }
            }
        }
        // Flush last
        lines.push(current);
        if (lines.length > 0 && lines.some(function(c) { return c.trim() !== ''; })) {
            yield_row(lines);
        }

        // We use a collector pattern
        var rows = [];
        function yield_row(cols) {
            rows.push(cols.slice());
        }

        // Re-do with collector
        return _parseCSVRows(text);
    }

    function _parseCSVRows(text) {
        var rows = [];
        var row = [];
        var cell = '';
        var inQuotes = false;

        for (var i = 0; i < text.length; i++) {
            var ch = text[i];
            if (inQuotes) {
                if (ch === '"') {
                    if (i + 1 < text.length && text[i + 1] === '"') {
                        cell += '"';
                        i++;
                    } else {
                        inQuotes = false;
                    }
                } else {
                    cell += ch;
                }
            } else {
                if (ch === '"') {
                    inQuotes = true;
                } else if (ch === ',') {
                    row.push(cell);
                    cell = '';
                } else if (ch === '\n' || ch === '\r') {
                    row.push(cell);
                    cell = '';
                    if (ch === '\r' && i + 1 < text.length && text[i + 1] === '\n') i++;
                    if (row.length > 0 && row.some(function(c) { return c.trim() !== ''; })) {
                        rows.push(row);
                    }
                    row = [];
                } else {
                    cell += ch;
                }
            }
        }
        row.push(cell);
        if (row.length > 0 && row.some(function(c) { return c.trim() !== ''; })) {
            rows.push(row);
        }
        return rows;
    }

    function csvToObjects(text) {
        var rows = _parseCSVRows(text);
        if (rows.length < 2) return [];

        var headers = rows[0].map(function(h) {
            return h.trim().toLowerCase().replace(/\s+/g, '').replace(/%/g, 'percent');
        });

        var headerMap = {};
        // Map normalized headers to indices
        headers.forEach(function(h, i) {
            // Normalize known column names
            if (h === 'timestamp') headerMap['timestamp'] = i;
            else if (h === 'classcode') headerMap['classcode'] = i;
            else if (h === 'studentid') headerMap['studentid'] = i;
            else if (h === 'topiccode') headerMap['topiccode'] = i;
            else if (h === 'learningpoint') headerMap['learningpoint'] = i;
            else if (h === 'level') headerMap['level'] = i;
            else if (h === 'eventtype') headerMap['eventtype'] = i;
            else if (h === 'quizdata') headerMap['quizdata'] = i;
            else if (h === 'qualities') headerMap['qualities'] = i;
            else if (h === 'overallpercent') headerMap['overallpercent'] = i;
            else if (h === 'preferredname') headerMap['preferredname'] = i;
            else if (h === 'familyname') headerMap['familyname'] = i;
        });

        var objects = [];
        for (var r = 1; r < rows.length; r++) {
            var cols = rows[r];
            var obj = {
                timestamp: (cols[headerMap['timestamp']] || '').trim(),
                classcode: (cols[headerMap['classcode']] || '').trim(),
                studentid: (cols[headerMap['studentid']] || '').trim(),
                topiccode: (cols[headerMap['topiccode']] || '').trim(),
                learningpoint: (cols[headerMap['learningpoint']] || '').trim(),
                level: parseInt(cols[headerMap['level']] || '0', 10) || 0,
                eventtype: (cols[headerMap['eventtype']] || '').trim(),
                quizdata: (cols[headerMap['quizdata']] || '').trim(),
                qualities: (cols[headerMap['qualities']] || '').trim(),
                overallpercent: parseFloat(cols[headerMap['overallpercent']] || '0') || 0,
                preferredname: headerMap['preferredname'] !== undefined ? (cols[headerMap['preferredname']] || '').trim() : '',
                familyname: headerMap['familyname'] !== undefined ? (cols[headerMap['familyname']] || '').trim() : ''
            };
            if (obj.studentid) {
                objects.push(obj);
            }
        }
        return objects;
    }

    // ============ Sheet URL Parsing ============

    function extractSheetId(url) {
        // Match /spreadsheets/d/SHEET_ID
        var m = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
        return m ? m[1] : null;
    }

    // ============ Fetch Data ============

    window.fetchSheetData = function() {
        var url = document.getElementById('sheetUrl').value.trim();
        if (!url) {
            showToast('Please enter a Google Sheet URL.', 'warning');
            return;
        }

        var sheetId = extractSheetId(url);
        if (!sheetId) {
            showToast('Could not extract Sheet ID from URL. Check the format.', 'error');
            return;
        }

        localStorage.setItem('checklist-report-sheet-url', url);

        var csvUrl = 'https://docs.google.com/spreadsheets/d/' + sheetId + '/export?format=csv';

        var btn = document.getElementById('fetchBtn');
        btn.disabled = true;
        document.getElementById('fetchBtnText').innerHTML = '<span class="spinner"></span>';
        setLoading(true);

        fetch(csvUrl)
            .then(function(res) {
                if (!res.ok) throw new Error('Failed to fetch (HTTP ' + res.status + '). Is the sheet published to web?');
                return res.text();
            })
            .then(function(csvText) {
                loadCSVData(csvText);
                showToast('Data loaded successfully!', 'success');
            })
            .catch(function(err) {
                showToast(err.message, 'error');
            })
            .finally(function() {
                btn.disabled = false;
                document.getElementById('fetchBtnText').textContent = 'Fetch Data';
                setLoading(false);
            });
    };

    // ============ File Upload ============

    var dropZone = document.getElementById('dropZone');
    var fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('click', function() { fileInput.click(); });

    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', function() {
        dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        var files = e.dataTransfer.files;
        if (files.length > 0) handleFile(files[0]);
    });

    fileInput.addEventListener('change', function() {
        if (fileInput.files.length > 0) handleFile(fileInput.files[0]);
    });

    function handleFile(file) {
        if (!file.name.toLowerCase().endsWith('.csv')) {
            showToast('Please upload a .csv file.', 'warning');
            return;
        }
        setLoading(true);
        var reader = new FileReader();
        reader.onload = function(e) {
            loadCSVData(e.target.result);
            setLoading(false);
            showToast('CSV loaded: ' + file.name, 'success');
        };
        reader.onerror = function() {
            setLoading(false);
            showToast('Error reading file.', 'error');
        };
        reader.readAsText(file);
    }

    // ============ Data Processing ============

    function loadCSVData(csvText) {
        rawEvents = csvToObjects(csvText);
        if (rawEvents.length === 0) {
            showToast('No valid data rows found in CSV.', 'warning');
            return;
        }
        processEvents();
        showOverview();
        renderOverview();
    }

    function processEvents() {
        studentMap = {};
        classCodes = new Set();

        // Parse timestamps and sort chronologically
        rawEvents.forEach(function(evt) {
            if (evt.timestamp) {
                evt._date = new Date(evt.timestamp);
                if (isNaN(evt._date.getTime())) evt._date = null;
            } else {
                evt._date = null;
            }
        });

        rawEvents.sort(function(a, b) {
            var da = a._date ? a._date.getTime() : 0;
            var db = b._date ? b._date.getTime() : 0;
            return da - db;
        });

        rawEvents.forEach(function(evt) {
            var sid = evt.studentid;
            if (!sid) return;

            // Filter out test events from student records (but keep for activity log)
            var isTest = (evt.eventtype === 'test-ping' || evt.eventtype === 'end-to-end-test' || evt.eventtype === 'debug-test');

            if (!studentMap[sid]) {
                studentMap[sid] = {
                    id: sid,
                    preferredName: evt.preferredname || sid,
                    familyName: evt.familyname || '',
                    classcode: evt.classcode || '',
                    levels: {},          // lp -> {level, timestamp}
                    history: {},         // lp -> [{level, timestamp}]
                    quizResults: [],
                    checkins: [],        // check-in events
                    characters: [],      // character-snapshot events
                    sessions: [],        // session-end events
                    events: [],
                    lastActive: null,
                    overallPercent: 0
                };
            }

            var student = studentMap[sid];

            // Update class code if present
            if (evt.classcode) {
                student.classcode = evt.classcode;
                classCodes.add(evt.classcode);
            }

            // Track last active
            if (evt._date && (!student.lastActive || evt._date > student.lastActive)) {
                student.lastActive = evt._date;
            }

            // Update overall percent
            if (evt.overallpercent > 0) {
                student.overallPercent = evt.overallpercent;
            }

            // Process by event type
            if (!isTest) {
                if (evt.eventtype === 'level-change' && evt.learningpoint) {
                    var lp = evt.learningpoint;
                    student.levels[lp] = {
                        level: evt.level,
                        timestamp: evt._date,
                        topiccode: evt.topiccode
                    };
                    if (!student.history[lp]) student.history[lp] = [];
                    student.history[lp].push({
                        level: evt.level,
                        timestamp: evt._date
                    });
                }

                if (evt.eventtype === 'quiz-result') {
                    var qd = {};
                    if (evt.quizdata) {
                        try { qd = JSON.parse(evt.quizdata); } catch(e) {}
                    }
                    student.quizResults.push({
                        lp: evt.learningpoint,
                        topiccode: evt.topiccode,
                        correct: !!qd.correct,
                        questionIndex: qd.questionIndex || 0,
                        timestamp: evt._date
                    });
                }

                if (evt.eventtype === 'check-in') {
                    var ci = {};
                    if (evt.quizdata) {
                        try { ci = JSON.parse(evt.quizdata); } catch(e) {}
                    }
                    student.checkins.push({
                        type: ci.type || '',
                        itemsReviewed: ci.itemsReviewed || 0,
                        totalItems: ci.totalItems || 0,
                        durationMs: ci.durationMs || 0,
                        timestamp: evt._date
                    });
                }

                if (evt.eventtype === 'character-snapshot') {
                    var cd = {}, quals = {};
                    if (evt.quizdata) {
                        try { cd = JSON.parse(evt.quizdata); } catch(e) {}
                    }
                    if (evt.qualities) {
                        try { quals = JSON.parse(evt.qualities); } catch(e) {}
                    }
                    student.characters.push({
                        checkinType: cd.checkinType || '',
                        level: cd.level || 0,
                        growthMagnitude: cd.growthMagnitude || 0,
                        securedCount: cd.securedCount || 0,
                        consolidatedCount: cd.consolidatedCount || 0,
                        totalItems: cd.totalItems || 0,
                        activeDays: cd.activeDays || 0,
                        totalDays: cd.totalDays || 0,
                        consolidationRate: cd.consolidationRate || 0,
                        qualities: quals,
                        timestamp: evt._date
                    });
                }

                if (evt.eventtype === 'session-end') {
                    var sd = {};
                    if (evt.quizdata) {
                        try { sd = JSON.parse(evt.quizdata); } catch(e) {}
                    }
                    student.sessions.push({
                        activeMs: sd.activeMs || 0,
                        activities: sd.activities || 0,
                        durationMs: sd.durationMs || 0,
                        timestamp: evt._date
                    });
                }
            }

            // All events go to the log
            student.events.push(evt);
        });

        // Build class filter
        buildClassFilter();
    }

    function buildClassFilter() {
        var select = document.getElementById('classFilter');
        select.innerHTML = '<option value="">All Classes</option>';
        var sorted = Array.from(classCodes).sort();
        sorted.forEach(function(cc) {
            var opt = document.createElement('option');
            opt.value = cc;
            opt.textContent = cc;
            select.appendChild(opt);
        });
    }

    // ============ Overview Rendering ============

    function getStudentsArray() {
        return Object.values(studentMap);
    }

    function getFilteredStudents() {
        var students = getStudentsArray();
        var search = document.getElementById('searchInput').value.toLowerCase().trim();
        var classVal = document.getElementById('classFilter').value;
        var sortVal = document.getElementById('sortSelect').value;

        // Filter
        if (search) {
            students = students.filter(function(s) {
                var fullName = (s.preferredName + ' ' + s.familyName).toLowerCase();
                return s.id.toLowerCase().includes(search) ||
                       fullName.includes(search) ||
                       s.classcode.toLowerCase().includes(search);
            });
        }
        if (classVal) {
            students = students.filter(function(s) { return s.classcode === classVal; });
        }

        // Sort
        students.sort(function(a, b) {
            switch (sortVal) {
                case 'name-az': return (a.familyName + ' ' + a.preferredName).localeCompare(b.familyName + ' ' + b.preferredName);
                case 'name-za': return (b.familyName + ' ' + b.preferredName).localeCompare(a.familyName + ' ' + a.preferredName);
                case 'progress-hl': return b.overallPercent - a.overallPercent;
                case 'progress-lh': return a.overallPercent - b.overallPercent;
                case 'recent':
                    var da = a.lastActive ? a.lastActive.getTime() : 0;
                    var db = b.lastActive ? b.lastActive.getTime() : 0;
                    return db - da;
                default: return 0;
            }
        });

        return students;
    }

    function renderOverview() {
        var allStudents = getStudentsArray();

        if (allStudents.length === 0) {
            document.getElementById('summaryStats').style.display = 'none';
            document.getElementById('toolbar').style.display = 'none';
            document.getElementById('studentsGrid').innerHTML = '';
            document.getElementById('emptyState').style.display = '';
            return;
        }

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('summaryStats').style.display = '';
        document.getElementById('toolbar').style.display = '';

        // Render filtered student cards and update summary stats from filtered list
        renderStudentCards();
        renderCheckinParticipation();
    }

    function renderMiniHeatmap(student) {
        var html = '<div class="engagement-heatmap" title="Last 14 days activity">';
        var now = new Date();
        var sessions = student.sessions || [];
        // Build per-day activeMs map
        var dayMap = {};
        sessions.forEach(function(sess) {
            if (!sess.timestamp) return;
            var key = sess.timestamp.toISOString().slice(0, 10);
            dayMap[key] = (dayMap[key] || 0) + (sess.activeMs || 0);
        });
        for (var d = 13; d >= 0; d--) {
            var date = new Date(now.getTime() - d * 86400000);
            var key = date.toISOString().slice(0, 10);
            var ms = dayMap[key] || 0;
            var cls = '';
            if (ms > 0 && ms < 120000) cls = ' h1';        // < 2 min
            else if (ms >= 120000 && ms < 600000) cls = ' h2';  // 2-10 min
            else if (ms >= 600000 && ms < 1800000) cls = ' h3'; // 10-30 min
            else if (ms >= 1800000) cls = ' h4';                 // 30+ min
            var dayName = ['S','M','T','W','T','F','S'][date.getDay()];
            html += '<div class="heatmap-day' + cls + '" title="' + key + ': ' + formatDuration(ms) + '"></div>';
        }
        html += '</div>';
        return html;
    }

    function renderCheckinIndicator(student) {
        var checkins = student.checkins || [];
        if (checkins.length === 0) return '<span class="checkin-indicator overdue">No check-ins</span>';
        var last = checkins[checkins.length - 1];
        var now = new Date();
        var sevenDaysAgo = new Date(now.getTime() - 7 * 86400000);
        if (last.timestamp && last.timestamp > sevenDaysAgo) {
            return '<span class="checkin-indicator recent">&#x2713; ' + checkins.length + ' check-in' + (checkins.length !== 1 ? 's' : '') + '</span>';
        }
        return '<span class="checkin-indicator overdue">&#x26A0; ' + formatRelativeDate(last.timestamp) + '</span>';
    }

    function renderSessionSummary(student) {
        var sessions = student.sessions || [];
        if (sessions.length === 0) return '';

        var totalActiveMs = 0;
        var activityMask = 0;
        sessions.forEach(function(sess) {
            totalActiveMs += sess.activeMs || 0;
            activityMask |= (sess.activities || 0);
        });
        var avgMs = Math.round(totalActiveMs / sessions.length);

        var html = '<div class="detail-section">';
        html += '<h3><span class="icon">&#x23F1;</span> Session Activity</h3>';
        html += '<div class="session-stats-grid">';
        html += '<div class="session-stat-box"><div class="sval">' + formatDuration(totalActiveMs) + '</div><div class="slbl">Total Active Time</div></div>';
        html += '<div class="session-stat-box"><div class="sval">' + sessions.length + '</div><div class="slbl">Sessions</div></div>';
        html += '<div class="session-stat-box"><div class="sval">' + formatDuration(avgMs) + '</div><div class="slbl">Avg Session</div></div>';

        // Check-in count
        var checkins = student.checkins || [];
        html += '<div class="session-stat-box"><div class="sval">' + checkins.length + '</div><div class="slbl">Check-ins</div></div>';
        html += '</div>';

        // Activity breakdown
        html += '<div class="activity-tags">';
        var acts = [
            { mask: 1, label: 'Quiz' },
            { mask: 2, label: 'Content' },
            { mask: 4, label: 'Search' },
            { mask: 8, label: 'Questions' }
        ];
        acts.forEach(function(a) {
            var active = (activityMask & a.mask) ? '' : ' inactive';
            html += '<span class="activity-tag' + active + '">' + a.label + '</span>';
        });
        html += '</div>';

        // Daily activity bars (last 14 days)
        var now = new Date();
        var dayMap = {};
        var maxMs = 1;
        sessions.forEach(function(sess) {
            if (!sess.timestamp) return;
            var key = sess.timestamp.toISOString().slice(0, 10);
            dayMap[key] = (dayMap[key] || 0) + (sess.activeMs || 0);
            if (dayMap[key] > maxMs) maxMs = dayMap[key];
        });

        html += '<div class="daily-bars">';
        for (var d = 13; d >= 0; d--) {
            var date = new Date(now.getTime() - d * 86400000);
            var key = date.toISOString().slice(0, 10);
            var ms = dayMap[key] || 0;
            var h = ms > 0 ? Math.max(4, Math.round((ms / maxMs) * 56)) : 0;
            var dayLabel = ['S','M','T','W','T','F','S'][date.getDay()];
            html += '<div class="daily-bar-wrapper">';
            if (h > 0) html += '<div class="daily-bar" style="height:' + h + 'px" title="' + key + ': ' + formatDuration(ms) + '"></div>';
            html += '<div class="daily-bar-label">' + dayLabel + '</div>';
            html += '</div>';
        }
        html += '</div>';

        html += '</div>';
        return html;
    }

    function renderRadarChart(student) {
        var characters = student.characters || [];
        if (characters.length === 0) return '';

        var latest = characters[characters.length - 1];
        var quals = latest.qualities || {};
        var dims = [
            { key: 'foundation', label: 'Foundation' },
            { key: 'momentum', label: 'Momentum' },
            { key: 'steadiness', label: 'Steadiness' },
            { key: 'engagedCuriosity', label: 'Curiosity' },
            { key: 'persistence', label: 'Persistence' },
            { key: 'learningHabits', label: 'Habits' }
        ];
        var n = dims.length;
        var cx = 110, cy = 110, r = 80;

        // Build SVG radar
        var svg = '<svg class="radar-chart" viewBox="0 0 220 220" width="220" height="220">';

        // Grid rings
        [0.25, 0.5, 0.75, 1.0].forEach(function(scale) {
            var pts = [];
            for (var i = 0; i < n; i++) {
                var angle = (Math.PI * 2 * i / n) - Math.PI / 2;
                pts.push((cx + r * scale * Math.cos(angle)).toFixed(1) + ',' + (cy + r * scale * Math.sin(angle)).toFixed(1));
            }
            svg += '<polygon class="radar-grid" points="' + pts.join(' ') + '"/>';
        });

        // Axes
        for (var i = 0; i < n; i++) {
            var angle = (Math.PI * 2 * i / n) - Math.PI / 2;
            var x2 = cx + r * Math.cos(angle);
            var y2 = cy + r * Math.sin(angle);
            svg += '<line class="radar-axis" x1="' + cx + '" y1="' + cy + '" x2="' + x2.toFixed(1) + '" y2="' + y2.toFixed(1) + '"/>';
            // Labels
            var lx = cx + (r + 18) * Math.cos(angle);
            var ly = cy + (r + 18) * Math.sin(angle);
            var anchor = 'middle';
            if (lx < cx - 10) anchor = 'end';
            else if (lx > cx + 10) anchor = 'start';
            svg += '<text class="radar-labels" x="' + lx.toFixed(1) + '" y="' + (ly + 4).toFixed(1) + '" text-anchor="' + anchor + '">' + dims[i].label + '</text>';
        }

        // Data polygon
        var dataPts = [];
        for (var i = 0; i < n; i++) {
            var val = (quals[dims[i].key] || 0) / 100;
            var angle = (Math.PI * 2 * i / n) - Math.PI / 2;
            dataPts.push((cx + r * val * Math.cos(angle)).toFixed(1) + ',' + (cy + r * val * Math.sin(angle)).toFixed(1));
        }
        svg += '<polygon class="radar-polygon" points="' + dataPts.join(' ') + '"/>';
        // Dots
        dataPts.forEach(function(pt) {
            var parts = pt.split(',');
            svg += '<circle class="growth-dot" cx="' + parts[0] + '" cy="' + parts[1] + '" r="3"/>';
        });

        svg += '</svg>';

        // Quality bars list
        var bars = '<div class="quality-list">';
        dims.forEach(function(dim) {
            var val = Math.round(quals[dim.key] || 0);
            bars += '<div class="quality-item">';
            bars += '<span class="quality-label">' + dim.label + '</span>';
            bars += '<div class="quality-bar-track"><div class="quality-bar-fill" style="width:' + val + '%"></div></div>';
            bars += '<span class="quality-value">' + val + '</span>';
            bars += '</div>';
        });
        bars += '</div>';

        // Metrics summary
        var metrics = '<div style="margin-top:var(--space-3);font-size:var(--text-sm);color:var(--color-text-muted);">';
        metrics += 'Secured: <strong>' + (latest.securedCount || 0) + '/' + (latest.totalItems || 0) + '</strong> &middot; ';
        metrics += 'Consolidation: <strong>' + Math.round((latest.consolidationRate || 0) * 100) + '%</strong> &middot; ';
        metrics += 'Active days: <strong>' + (latest.activeDays || 0) + '/' + (latest.totalDays || 0) + '</strong>';
        metrics += '</div>';

        var html = '<div class="detail-section">';
        html += '<h3><span class="icon">&#x2B50;</span> Learning Character</h3>';
        html += '<div class="radar-container">' + svg + bars + '</div>';
        html += metrics;
        html += '</div>';
        return html;
    }

    function renderGrowthTimeline(student) {
        var characters = student.characters || [];
        if (characters.length < 2) return '';

        var w = 500, h = 120, pad = 40, padR = 20, padTop = 10, padBot = 30;
        var plotW = w - pad - padR;
        var plotH = h - padTop - padBot;
        var n = characters.length;

        var svg = '<svg class="growth-timeline-svg" viewBox="0 0 ' + w + ' ' + h + '">';

        // Grid lines
        [0, 25, 50, 75, 100].forEach(function(pct) {
            var y = padTop + plotH - (pct / 100 * plotH);
            svg += '<line class="growth-grid-line" x1="' + pad + '" y1="' + y.toFixed(1) + '" x2="' + (w - padR) + '" y2="' + y.toFixed(1) + '"/>';
            svg += '<text class="growth-label" x="' + (pad - 4) + '" y="' + (y + 3).toFixed(1) + '" text-anchor="end">' + pct + '%</text>';
        });

        // Data points and line
        var points = [];
        characters.forEach(function(c, i) {
            var x = pad + (i / (n - 1)) * plotW;
            var y = padTop + plotH - ((c.level || 0) * plotH);
            points.push(x.toFixed(1) + ',' + y.toFixed(1));
        });
        svg += '<polyline class="growth-line" points="' + points.join(' ') + '"/>';

        characters.forEach(function(c, i) {
            var x = pad + (i / (n - 1)) * plotW;
            var y = padTop + plotH - ((c.level || 0) * plotH);
            svg += '<circle class="growth-dot" cx="' + x.toFixed(1) + '" cy="' + y.toFixed(1) + '" r="4"/>';
            // Value label
            svg += '<text class="growth-val-label" x="' + x.toFixed(1) + '" y="' + (y - 8).toFixed(1) + '" text-anchor="middle">' + Math.round((c.level || 0) * 100) + '%</text>';
            // Date label
            if (c.timestamp) {
                var label = (c.timestamp.getDate()) + '/' + (c.timestamp.getMonth() + 1);
                svg += '<text class="growth-label" x="' + x.toFixed(1) + '" y="' + (h - 4) + '" text-anchor="middle">' + label + '</text>';
            }
        });

        svg += '</svg>';

        var html = '<div class="detail-section">';
        html += '<h3><span class="icon">&#x1F4C8;</span> Growth Over Time</h3>';
        html += svg;
        html += '</div>';
        return html;
    }

    function renderQualityTrend(student) {
        var characters = student.characters || [];
        if (characters.length < 2) return '';
        var prev = characters[characters.length - 2].qualities || {};
        var curr = characters[characters.length - 1].qualities || {};
        var dims = ['foundation', 'momentum', 'steadiness', 'engagedCuriosity', 'persistence', 'learningHabits'];
        var totalDelta = 0;
        dims.forEach(function(d) { totalDelta += ((curr[d] || 0) - (prev[d] || 0)); });
        var avg = totalDelta / dims.length;
        if (avg > 2) return '<span class="trend-arrow up">&#9650;</span>';
        if (avg < -2) return '<span class="trend-arrow down">&#9660;</span>';
        return '<span class="trend-arrow flat">&#9644;</span>';
    }

    function renderCheckinParticipation() {
        var students = getFilteredStudents();
        var container = document.getElementById('checkinTableContainer');
        var section = document.getElementById('checkinParticipation');
        if (!container || !section) return;

        // Only show if any students have check-in data
        var hasCheckins = students.some(function(s) { return s.checkins && s.checkins.length > 0; });
        if (!hasCheckins) {
            section.style.display = 'none';
            return;
        }
        section.style.display = '';

        var now = new Date();
        var sevenDaysAgo = new Date(now.getTime() - 7 * 86400000);

        var html = '<table class="checkin-table">';
        html += '<thead><tr><th>Student</th><th>Last Check-in</th><th>Type</th><th>Items Reviewed</th><th>Coverage</th><th>Duration</th><th>Total</th></tr></thead>';
        html += '<tbody>';

        students.forEach(function(s) {
            var checkins = s.checkins || [];
            var last = checkins.length > 0 ? checkins[checkins.length - 1] : null;

            var rowClass = '';
            if (!last) {
                rowClass = 'row-red';
            } else if (last.timestamp && last.timestamp > sevenDaysAgo) {
                var coverage = last.totalItems > 0 ? last.itemsReviewed / last.totalItems : 0;
                rowClass = coverage > 0.5 ? 'row-green' : 'row-amber';
            } else {
                rowClass = 'row-red';
            }

            html += '<tr class="' + rowClass + '" style="cursor:pointer" onclick="showStudentDetail(\'' + escapeHtml(s.id) + '\')">';
            html += '<td><strong>' + escapeHtml(s.preferredName) + '</strong></td>';

            if (last) {
                var coverage = last.totalItems > 0 ? Math.round(last.itemsReviewed / last.totalItems * 100) : 0;
                html += '<td>' + formatRelativeDate(last.timestamp) + '</td>';
                html += '<td>' + escapeHtml(last.type || '-') + '</td>';
                html += '<td>' + last.itemsReviewed + '/' + last.totalItems + '</td>';
                html += '<td>' + coverage + '%</td>';
                html += '<td>' + formatDuration(last.durationMs) + '</td>';
            } else {
                html += '<td>None</td><td>-</td><td>-</td><td>-</td><td>-</td>';
            }
            html += '<td>' + checkins.length + '</td>';
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    window.toggleCheckinTable = function() {
        var container = document.getElementById('checkinTableContainer');
        var arrow = document.getElementById('checkinToggleArrow');
        if (container.style.display === 'none') {
            container.style.display = '';
            if (arrow) arrow.innerHTML = '&#x25BC;';
        } else {
            container.style.display = 'none';
            if (arrow) arrow.innerHTML = '&#x25B6;';
        }
    };

    function renderStudentCards() {
        var students = getFilteredStudents();
        var grid = document.getElementById('studentsGrid');

        // Update summary stats from filtered list
        var total = students.length;
        var sumPct = 0;
        var atRisk = 0;
        var topPerf = 0;
        var now = new Date();
        var sevenDaysAgo = new Date(now.getTime() - 7 * 86400000);
        students.forEach(function(s) {
            sumPct += s.overallPercent;
            // At-risk: low progress, OR no sessions in 7 days, OR low growth
            var isAtRisk = s.overallPercent < 25;
            if (s.sessions && s.sessions.length > 0) {
                var lastSession = s.sessions[s.sessions.length - 1];
                if (lastSession.timestamp && lastSession.timestamp < sevenDaysAgo) isAtRisk = true;
            } else if (s.lastActive && s.lastActive < sevenDaysAgo) {
                isAtRisk = true;
            }
            if (s.characters && s.characters.length > 0) {
                var latestChar = s.characters[s.characters.length - 1];
                if (latestChar.growthMagnitude < 0.1 && s.overallPercent < 50) isAtRisk = true;
            }
            if (isAtRisk) atRisk++;
            if (s.overallPercent > 75) topPerf++;
        });
        document.getElementById('statTotalStudents').textContent = total;
        document.getElementById('statAvgProgress').textContent = total > 0 ? Math.round(sumPct / total) + '%' : '0%';
        document.getElementById('statAtRisk').textContent = atRisk;
        document.getElementById('statTopPerformers').textContent = topPerf;

        document.getElementById('studentCountBadge').textContent = students.length + ' student' + (students.length !== 1 ? 's' : '');

        if (students.length === 0) {
            grid.innerHTML = '<div class="empty-state"><div class="empty-icon">&#x1F50D;</div><h3>No matches found</h3><p>Try adjusting your search or filters.</p></div>';
            return;
        }

        var html = '';
        students.forEach(function(s) {
            var initials = getInitials(s.preferredName + ' ' + s.familyName);
            var pct = Math.round(s.overallPercent);
            var lpCount = Object.keys(s.levels).length;
            var quizTotal = s.quizResults.length;
            var quizCorrect = s.quizResults.filter(function(q) { return q.correct; }).length;
            var quizRate = quizTotal > 0 ? Math.round(quizCorrect / quizTotal * 100) : 0;

            // Level distribution
            var levelCounts = [0, 0, 0, 0, 0];
            Object.values(s.levels).forEach(function(lv) {
                var idx = lv.level - 1;
                if (idx >= 0 && idx < 5) levelCounts[idx]++;
            });
            var levelTotal = levelCounts.reduce(function(a, b) { return a + b; }, 0) || 1;

            html += '<div class="student-card" onclick="showStudentDetail(\'' + escapeHtml(s.id) + '\')">';
            html += '<div class="student-card-header">';
            html += '<div class="avatar">' + escapeHtml(initials) + '</div>';
            html += '<div class="student-info">';
            html += '<div class="student-name">' + escapeHtml(s.preferredName) + '</div>';
            if (s.classcode) html += '<span class="class-badge">' + escapeHtml(s.classcode) + '</span>';
            html += renderQualityTrend(s);
            html += '</div></div>';

            // Progress
            html += '<div class="progress-section">';
            html += '<div class="progress-label"><span>Overall Progress</span><span class="progress-value">' + pct + '%</span></div>';
            html += '<div class="progress-bar-track"><div class="progress-bar-fill" style="width:' + pct + '%"></div></div>';
            html += '</div>';

            // Level distribution bar
            html += '<div class="level-dist-bar">';
            for (var i = 0; i < 5; i++) {
                var w = (levelCounts[i] / levelTotal * 100);
                if (w > 0) {
                    html += '<div class="level-segment l' + (i + 1) + '" style="width:' + w + '%" title="Level ' + (i + 1) + ': ' + levelCounts[i] + '"></div>';
                }
            }
            html += '</div>';

            // Level legend
            html += '<div class="level-legend">';
            for (var j = 0; j < 5; j++) {
                if (levelCounts[j] > 0) {
                    html += '<span class="level-legend-item"><span class="level-legend-dot" style="background:var(--level-' + (j + 1) + ')"></span>L' + (j + 1) + ': ' + levelCounts[j] + '</span>';
                }
            }
            html += '</div>';

            // Engagement heatmap (last 14 days)
            html += renderMiniHeatmap(s);

            // Footer
            html += '<div class="student-card-footer">';
            html += '<span>&#x1F4C5; ' + formatRelativeDate(s.lastActive) + '</span>';
            html += renderCheckinIndicator(s);
            html += '<span>&#x2753; ' + quizRate + '%</span>';
            html += '<span>&#x1F4D6; ' + lpCount + ' LPs</span>';
            html += '</div>';

            html += '</div>';
        });

        grid.innerHTML = html;
    }

    // Toolbar events
    document.getElementById('searchInput').addEventListener('input', renderStudentCards);
    document.getElementById('classFilter').addEventListener('change', renderStudentCards);
    document.getElementById('sortSelect').addEventListener('change', renderStudentCards);

    // ============ Detail View ============

    window.showStudentDetail = function(studentId) {
        currentStudentId = studentId;
        var s = studentMap[studentId];
        if (!s) return;

        document.getElementById('overviewView').classList.add('hidden');
        document.getElementById('detailView').classList.add('active');

        var initials = getInitials(s.preferredName + ' ' + s.familyName);
        var pct = Math.round(s.overallPercent);
        var quizTotal = s.quizResults.length;
        var quizCorrect = s.quizResults.filter(function(q) { return q.correct; }).length;
        var quizRate = quizTotal > 0 ? Math.round(quizCorrect / quizTotal * 100) : 0;

        var html = '';

        // Header
        html += '<div class="detail-header">';
        html += '<div class="avatar">' + escapeHtml(initials) + '</div>';
        html += '<div class="detail-header-info">';
        html += '<h2>' + escapeHtml(s.preferredName + ' ' + s.familyName) + '</h2>';
        html += '<div class="detail-header-meta">';
        if (s.classcode) html += '<span>Class: <strong>' + escapeHtml(s.classcode) + '</strong></span>';
        html += '<span>Last active: <strong>' + formatRelativeDate(s.lastActive) + '</strong></span>';
        html += '</div></div>';
        html += '<div class="detail-header-stat"><div class="stat-val">' + pct + '%</div><div class="stat-lbl">Overall</div></div>';
        html += '</div>';

        // Current Levels
        var lpKeys = Object.keys(s.levels).sort();
        if (lpKeys.length > 0) {
            html += '<div class="detail-section">';
            html += '<h3><span class="icon">&#x1F3AF;</span> Current Levels</h3>';
            html += '<div class="levels-grid">';
            lpKeys.forEach(function(lp) {
                var lv = s.levels[lp];
                html += '<div class="lp-card">';
                html += '<span class="lp-name" title="' + escapeHtml(lp) + '">' + escapeHtml(lp) + '</span>';
                html += '<span class="level-badge l' + lv.level + '">' + lv.level + '</span>';
                html += '</div>';
            });
            html += '</div></div>';
        }

        // Level Progression Timeline
        var historyLps = Object.keys(s.history).filter(function(lp) { return s.history[lp].length > 1; }).sort();
        if (historyLps.length > 0) {
            html += '<div class="detail-section">';
            html += '<h3><span class="icon">&#x1F4C8;</span> Level Progression</h3>';
            html += '<div class="timeline-container">';
            historyLps.forEach(function(lp) {
                var steps = s.history[lp];
                html += '<div>';
                html += '<div class="timeline-lp-name">' + escapeHtml(lp) + '</div>';
                html += '<div class="timeline-track">';
                steps.forEach(function(step, idx) {
                    if (idx > 0) html += '<div class="timeline-line"></div>';
                    html += '<div class="timeline-dot-wrapper">';
                    html += '<div class="timeline-dot l' + step.level + '">' + step.level + '</div>';
                    html += '<div class="timeline-date">' + (step.timestamp ? formatDate(step.timestamp) : '') + '</div>';
                    html += '</div>';
                });
                html += '</div></div>';
            });
            html += '</div></div>';
        }

        // Quiz Performance
        if (quizTotal > 0) {
            html += '<div class="detail-section">';
            html += '<h3><span class="icon">&#x2753;</span> Quiz Performance</h3>';
            html += '<div class="quiz-summary">';
            html += '<div class="quiz-stat-box"><div class="qval">' + quizTotal + '</div><div class="qlbl">Total Attempts</div></div>';
            html += '<div class="quiz-stat-box"><div class="qval">' + quizCorrect + '</div><div class="qlbl">Correct</div></div>';
            html += '<div class="quiz-stat-box"><div class="qval">' + quizRate + '%</div><div class="qlbl">Success Rate</div></div>';
            html += '</div>';

            html += '<div class="quiz-rate-bar"><div class="quiz-rate-fill" style="width:' + quizRate + '%"></div></div>';

            // Per-LP quiz table
            var quizByLp = {};
            s.quizResults.forEach(function(q) {
                var key = q.lp || '(unknown)';
                if (!quizByLp[key]) quizByLp[key] = { total: 0, correct: 0 };
                quizByLp[key].total++;
                if (q.correct) quizByLp[key].correct++;
            });
            var lpQuizKeys = Object.keys(quizByLp).sort();
            if (lpQuizKeys.length > 0) {
                html += '<table class="quiz-table">';
                html += '<thead><tr><th>Learning Point</th><th>Attempts</th><th>Correct</th><th>Rate</th></tr></thead>';
                html += '<tbody>';
                lpQuizKeys.forEach(function(lp) {
                    var d = quizByLp[lp];
                    var rate = Math.round(d.correct / d.total * 100);
                    html += '<tr><td>' + escapeHtml(lp) + '</td><td>' + d.total + '</td><td>' + d.correct + '</td><td>' + rate + '%</td></tr>';
                });
                html += '</tbody></table>';
            }
            html += '</div>';
        }

        // Learning Character Radar
        html += renderRadarChart(s);

        // Growth Timeline
        html += renderGrowthTimeline(s);

        // Session Activity Summary
        html += renderSessionSummary(s);

        // Activity Log
        var events = s.events.slice().reverse().slice(0, 50);
        if (events.length > 0) {
            html += '<div class="detail-section">';
            html += '<h3><span class="icon">&#x1F4DD;</span> Activity Log</h3>';
            html += '<div class="activity-log">';
            events.forEach(function(evt) {
                var iconClass = 'test-event';
                var iconChar = '&#x1F527;';
                if (evt.eventtype === 'level-change') {
                    iconClass = 'level-change';
                    iconChar = '&#x2B06;';
                } else if (evt.eventtype === 'quiz-result') {
                    iconClass = 'quiz-result';
                    iconChar = '&#x2753;';
                } else if (evt.eventtype === 'check-in') {
                    iconClass = 'check-in';
                    iconChar = '&#x1F4CB;';
                } else if (evt.eventtype === 'session-end') {
                    iconClass = 'session-end';
                    iconChar = '&#x23F1;';
                } else if (evt.eventtype === 'character-snapshot') {
                    iconClass = 'character-snapshot';
                    iconChar = '&#x2B50;';
                }

                html += '<div class="activity-item">';
                html += '<span class="activity-time">' + (evt._date ? formatDateTime(evt._date) : '-') + '</span>';
                html += '<span class="activity-icon ' + iconClass + '">' + iconChar + '</span>';
                html += '<div class="activity-content">';

                if (evt.eventtype === 'level-change') {
                    html += '<div class="activity-primary">' + escapeHtml(evt.learningpoint) + ' &rarr; Level ' + evt.level + '</div>';
                    if (evt.topiccode) html += '<div class="activity-secondary">' + escapeHtml(evt.topiccode) + '</div>';
                } else if (evt.eventtype === 'quiz-result') {
                    var qd = {};
                    try { qd = JSON.parse(evt.quizdata || '{}'); } catch(e) {}
                    html += '<div class="activity-primary">Quiz: ' + escapeHtml(evt.learningpoint || '-') + ' &mdash; ' + (qd.correct ? 'Correct' : 'Incorrect') + '</div>';
                } else if (evt.eventtype === 'check-in') {
                    var ci = {};
                    try { ci = JSON.parse(evt.quizdata || '{}'); } catch(e) {}
                    html += '<div class="activity-primary">Check-in (' + escapeHtml(ci.type || 'unknown') + ')</div>';
                    html += '<div class="activity-secondary">' + (ci.itemsReviewed || 0) + '/' + (ci.totalItems || 0) + ' items reviewed, ' + formatDuration(ci.durationMs || 0) + '</div>';
                } else if (evt.eventtype === 'session-end') {
                    var sd = {};
                    try { sd = JSON.parse(evt.quizdata || '{}'); } catch(e) {}
                    var actLabels = decodeActivities(sd.activities || 0);
                    html += '<div class="activity-primary">Session ended &mdash; ' + formatDuration(sd.activeMs || 0) + ' active</div>';
                    if (actLabels) html += '<div class="activity-secondary">' + escapeHtml(actLabels) + '</div>';
                } else if (evt.eventtype === 'character-snapshot') {
                    var cd = {};
                    try { cd = JSON.parse(evt.quizdata || '{}'); } catch(e) {}
                    html += '<div class="activity-primary">Learning Character generated</div>';
                    html += '<div class="activity-secondary">Level: ' + Math.round((cd.level || 0) * 100) + '%, Growth: ' + Math.round((cd.growthMagnitude || 0) * 100) + '%, Secured: ' + (cd.securedCount || 0) + '/' + (cd.totalItems || 0) + '</div>';
                } else {
                    html += '<div class="activity-primary">' + escapeHtml(evt.eventtype) + '</div>';
                    if (evt.learningpoint) html += '<div class="activity-secondary">' + escapeHtml(evt.learningpoint) + '</div>';
                }

                html += '</div></div>';
            });
            html += '</div></div>';
        }

        document.getElementById('detailContent').innerHTML = html;
        window.scrollTo(0, 0);
    };

    window.showOverview = function() {
        currentStudentId = null;
        document.getElementById('overviewView').classList.remove('hidden');
        document.getElementById('detailView').classList.remove('active');
        window.scrollTo(0, 0);
    };

    // ============ Init ============

    // Restore saved sheet URL
    var savedUrl = localStorage.getItem('checklist-report-sheet-url');
    if (savedUrl) {
        document.getElementById('sheetUrl').value = savedUrl;
    }

})();
</script>
</body>
</html>