<!DOCTYPE html>
<html lang="en" data-theme="light" data-version="2.0.0">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Dynamic Learning Check List - Track your understanding and growth through structured check-ins">
    <title>Dynamic Learning Check List</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
/* ============================================
   CSS VARIABLES
   ============================================ */
:root {
    /* Primary palette - Growth/Nature themed */
    --color-primary: #2d9d78;
    --color-primary-dark: #1e7d5e;
    --color-primary-light: #4db896;
    --color-primary-pale: #e8f5f0;
    
    /* Secondary - Warm accent */
    --color-secondary: #f59e0b;
    --color-secondary-dark: #d97706;
    --color-secondary-light: #fbbf24;
    
    /* Understanding levels */
    --level-1: #94a3b8;  /* Not started - Neutral grey */
    --level-2: #06b6d4;  /* Beginning - Cyan blue */
    --level-3: #eab308;  /* Developing - Yellow */
    --level-4: #22c55e;  /* Confident - Green */
    --level-5: #8b5cf6;  /* Secured - Purple star */
    
    /* Understanding levels - Light/pale backgrounds */
    --level-1-light: #f1f5f9;
    --level-2-light: #ecfeff;
    --level-3-light: #fefce8;
    --level-4-light: #f0fdf4;
    --level-5-light: #faf5ff;
    
    /* Backgrounds */
    --color-bg: #fafdf9;
    --color-bg-warm: #f0f7f4;
    --color-bg-card: #ffffff;
    --color-bg-hover: #e8f0ed;
    --color-bg-active: #d4e5de;
    
    /* Text */
    --color-text: #1e3a32;
    --color-text-secondary: #4a6358;
    --color-text-muted: #7a9088;
    --color-text-inverse: #ffffff;
    
    /* Borders */
    --color-border: #d4e5de;
    --color-border-light: #e8f0ed;
    --color-border-focus: var(--color-primary);
    
    /* Status colors */
    --color-success: #22c55e;
    --color-success-bg: #dcfce7;
    --color-warning: #f59e0b;
    --color-warning-bg: #fef3c7;
    --color-info: #3b82f6;
    --color-info-bg: #dbeafe;
    --color-error: #ef4444;
    --color-error-bg: #fee2e2;
    
    /* Spacing - Compact */
    --space-1: 0.125rem;
    --space-2: 0.25rem;
    --space-3: 0.375rem;
    --space-4: 0.5rem;
    --space-5: 0.75rem;
    --space-6: 1rem;
    --space-7: 1.25rem;
    --space-8: 1.5rem;
    --space-9: 2rem;
    --space-10: 2.5rem;
    
    /* Typography */
    --font-display: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    --text-xs: 0.75rem;
    --text-sm: 0.85rem;
    --text-base: 0.95rem;
    --text-lg: 1.05rem;
    --text-xl: 1.2rem;
    --text-2xl: 1.4rem;
    --text-3xl: 1.75rem;
    --line-height-tight: 1.25;
    --line-height-normal: 1.5;
    --line-height-relaxed: 1.65;
    
    /* Effects */
    --shadow-sm: 0 1px 2px rgba(30, 58, 50, 0.04);
    --shadow-md: 0 4px 8px rgba(30, 58, 50, 0.06), 0 2px 4px rgba(30, 58, 50, 0.04);
    --shadow-lg: 0 12px 24px rgba(30, 58, 50, 0.1), 0 4px 8px rgba(30, 58, 50, 0.05);
    --shadow-focus: 0 0 0 3px rgba(45, 157, 120, 0.25);
    
    /* Borders */
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 14px;
    --radius-xl: 20px;
    --radius-full: 9999px;
    
    /* Transitions */
    --transition-fast: 0.15s ease;
    --transition-normal: 0.25s ease;
    --transition-slow: 0.4s ease;
    --transition-bounce: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* Dark Mode */
[data-theme="dark"] {
    --color-primary: #4db896;
    --color-primary-dark: #2d9d78;
    --color-primary-light: #6fcfaa;
    --color-primary-pale: #1a2f28;
    
    --color-bg: #0f1714;
    --color-bg-warm: #162420;
    --color-bg-card: #1c2d27;
    --color-bg-hover: #243832;
    --color-bg-active: #2d453d;
    
    --color-text: #e8f5f0;
    --color-text-secondary: #a8c4ba;
    --color-text-muted: #6b8f82;
    
    --color-border: #2d453d;
    --color-border-light: #243832;
    
    --color-success-bg: #14301e;
    --color-warning-bg: #302814;
    --color-info-bg: #142030;
    --color-error-bg: #301414;
    
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
    --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.25), 0 2px 4px rgba(0, 0, 0, 0.15);
    --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.3), 0 4px 8px rgba(0, 0, 0, 0.2);
    
    --level-5: #a78bfa;
    --level-5-light: #2d2640;
}

/* Dark mode purple glow */
[data-theme="dark"] .level-notch[data-level="5"],
[data-theme="dark"] .level-segment[data-level="5"],
[data-theme="dark"] .level-was-value[data-level="5"],
[data-theme="dark"] [style*="var(--level-5)"] {
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.3), 0 0 2px rgba(255, 255, 255, 0.2);
}

[data-theme="dark"] .level-notch.active[data-level="5"] {
    box-shadow: 0 0 8px rgba(167, 139, 250, 0.4), 0 0 2px rgba(255, 255, 255, 0.2);
}

/* ============================================
   RESET & BASE
   ============================================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { 
    font-size: 16px; 
    scroll-behavior: smooth;
    height: 100%;
}

@media (prefers-reduced-motion: reduce) {
    html { scroll-behavior: auto; }
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

body {
    font-family: var(--font-body);
    font-size: var(--text-base);
    line-height: var(--line-height-normal);
    color: var(--color-text);
    background: var(--color-bg);
    min-height: 100vh;
    min-height: 100dvh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* ============================================
   ACCESSIBILITY
   ============================================ */
.skip-link {
    position: absolute;
    top: -100%;
    left: var(--space-4);
    padding: var(--space-3) var(--space-5);
    background: var(--color-primary);
    color: var(--color-text-inverse);
    border-radius: var(--radius-md);
    text-decoration: none;
    font-weight: 600;
    z-index: 10000;
    transition: top var(--transition-fast);
}
.skip-link:focus { top: var(--space-4); outline: none; }

:focus-visible {
    outline: 2px solid var(--color-border-focus);
    outline-offset: 2px;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* ============================================
   APP LAYOUT
   ============================================ */
.app-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    min-height: 100dvh;
}

/* ============================================
   HEADER
   ============================================ */
.app-header {
    background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 50%, #3aa882 100%);
    color: var(--color-text-inverse);
    padding: var(--space-3) var(--space-4);
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-md);
}

.header-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.app-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 800;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.app-title-icon {
    font-size: 1.2rem;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-2px); }
}

.header-actions {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.header-btn {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--color-text-inverse);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: var(--text-xs);
    font-weight: 600;
    font-family: var(--font-body);
    transition: all var(--transition-fast);
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
}

.header-btn:hover { background: rgba(255, 255, 255, 0.25); }
.header-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.student-info {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    background: rgba(255, 255, 255, 0.1);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
}

.student-avatar {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-base);
}

/* ============================================
   TOPIC SELECTOR BAR
   ============================================ */
.topic-selector-bar {
    background: var(--color-bg-warm);
    border-bottom: 1px solid var(--color-border);
    padding: var(--space-2) var(--space-4);
}

.topic-selector-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.topic-selector-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.topic-selector-dropdowns {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
    flex: 1;
}

.topic-dropdown {
    padding: var(--space-2) var(--space-3);
    padding-right: var(--space-5);
    font-size: var(--text-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    cursor: pointer;
    min-width: 80px;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    transition: width 0.15s ease;
}

/* Hidden element for measuring dropdown text width */
.dropdown-measure {
    position: absolute;
    visibility: hidden;
    height: auto;
    width: auto;
    white-space: nowrap;
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    font-family: inherit;
    pointer-events: none;
}

.topic-dropdown:hover {
    border-color: var(--color-primary);
}

.topic-dropdown:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px var(--color-primary-pale);
}

.topic-dropdown:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: var(--color-bg-warm);
}

.topic-dropdown option.unavailable {
    color: var(--color-text-muted);
    font-style: italic;
}

.topic-dropdown option:disabled {
    color: var(--color-text-muted);
    background-color: var(--color-bg-warm);
}

.topic-refresh-btn {
    padding: var(--space-1) var(--space-2);
    font-size: var(--text-xs);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-bg-card);
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all 0.15s ease;
}

.topic-refresh-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
    background: var(--color-primary-pale);
}

.topic-refresh-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.topic-refresh-btn.refreshing {
    pointer-events: none;
}

.topic-refresh-btn.refreshing::after {
    content: '...';
    animation: ellipsis 1s infinite;
}

@keyframes ellipsis {
    0% { content: '.'; }
    33% { content: '..'; }
    66% { content: '...'; }
}

.topic-dropdown-separator {
    color: var(--color-text-muted);
    font-size: var(--text-sm);
}

.topic-current-display {
    margin-left: auto;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.topic-current-name {
    font-weight: 600;
    color: var(--color-text);
}

.topic-loading-indicator {
    display: none;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.topic-loading-indicator.active {
    display: flex;
}

.topic-loading-spinner {
    width: 14px;
    height: 14px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ============================================
   SUB NAVIGATION (TABS)
   ============================================ */
.sub-nav {
    background: var(--color-bg-card);
    border-bottom: 1px solid var(--color-border);
    padding: 0 var(--space-4);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.sub-nav::-webkit-scrollbar { display: none; }

.sub-nav-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    gap: var(--space-1);
}

.nav-tab {
    background: transparent;
    border: none;
    padding: var(--space-2) var(--space-3);
    font-family: var(--font-display);
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-muted);
    cursor: pointer;
    position: relative;
    transition: color var(--transition-fast);
    white-space: nowrap;
    min-height: 36px;
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.nav-tab:hover { color: var(--color-text); }

.nav-tab[aria-selected="true"] { color: var(--color-primary); }

.nav-tab[aria-selected="true"]::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: var(--space-1);
    right: var(--space-1);
    height: 2px;
    background: var(--color-primary);
    border-radius: 2px 2px 0 0;
}

.nav-tab-icon { font-size: 1em; }

.nav-tab-badge {
    background: var(--color-primary);
    color: white;
    font-size: 10px;
    padding: 0 5px;
    border-radius: var(--radius-full);
    font-weight: 700;
}

/* Learning tab attention pulse ‚Äî bright yellow glow when user is away from Learning Content
   Total 5s: 1s fade-in, 3s pulsing, 1s fade-out */
.nav-tab.pulse-glow {
    animation: learningTabPulse 5s ease-in-out;
}

@keyframes learningTabPulse {
    /* 0%‚Äì20% = 1s fade in */
    0%   { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); }
    20%  { box-shadow: 0 0 18px 6px rgba(250, 204, 21, 0.7); }
    /* 20%‚Äì80% = 3s pulsing bright yellow */
    35%  { box-shadow: 0 0 24px 8px rgba(250, 204, 21, 0.9); }
    50%  { box-shadow: 0 0 14px 4px rgba(250, 204, 21, 0.55); }
    65%  { box-shadow: 0 0 24px 8px rgba(250, 204, 21, 0.9); }
    80%  { box-shadow: 0 0 18px 6px rgba(250, 204, 21, 0.7); }
    /* 80%‚Äì100% = 1s fade out */
    100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); }
}

/* ============================================
   MAIN CONTENT AREA
   ============================================ */
.main-content {
    flex: 1;
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    padding: var(--space-3);
}

/* Panel Content */
.panel-content {
    display: none;
    animation: fadeSlideIn var(--transition-normal);
}

.panel-content.active { display: block; }

@keyframes fadeSlideIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ============================================
   CARDS
   ============================================ */
.card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin-bottom: var(--space-3);
    box-shadow: var(--shadow-sm);
    transition: box-shadow var(--transition-fast);
}

.card:hover { box-shadow: var(--shadow-md); }

.card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-3);
    gap: var(--space-2);
    flex-wrap: wrap;
}

.card-title {
    font-family: var(--font-display);
    font-size: var(--text-base);
    font-weight: 700;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.card-title-icon { font-size: 1.1em; }

.card-subtitle {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-1);
}

/* ============================================
   PROGRESS OVERVIEW CARD
   ============================================ */
.progress-overview {
    background: linear-gradient(135deg, var(--color-primary-pale) 0%, var(--color-bg-warm) 100%);
    border: 1px solid var(--color-primary);
    border-left: 4px solid var(--color-primary);
}

.progress-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--space-3);
    margin-top: var(--space-3);
}

.progress-stat {
    background: var(--color-bg-card);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    text-align: center;
    border: 1px solid var(--color-border-light);
}

.progress-stat-value {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    font-weight: 800;
    color: var(--color-primary);
    line-height: 1;
}

.progress-stat-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-2);
    font-weight: 500;
}

.progress-bar-container {
    margin-top: var(--space-4);
}

.progress-bar-label {
    display: flex;
    justify-content: space-between;
    font-size: var(--text-sm);
    margin-bottom: var(--space-2);
}

.progress-bar {
    height: 12px;
    background: var(--color-bg-card);
    border-radius: var(--radius-full);
    overflow: hidden;
    border: 1px solid var(--color-border-light);
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-primary-light));
    border-radius: var(--radius-full);
    transition: width 0.5s ease-out;
}

/* ============================================
   LEVEL LEGEND
   ============================================ */
.level-legend {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
}

.level-legend-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-text-secondary);
}

.level-legend-dot {
    width: 12px;
    height: 12px;
    border-radius: var(--radius-sm);
}

.level-legend-dot[data-level="1"] { background: var(--level-1); }
.level-legend-dot[data-level="2"] { background: var(--level-2); }
.level-legend-dot[data-level="3"] { background: var(--level-3); }
.level-legend-dot[data-level="4"] { background: var(--level-4); }
.level-legend-dot[data-level="5"] { background: var(--level-5); }

/* ============================================
   TOPIC SECTIONS (SUBTOPICS)
   ============================================ */
.topic-section {
    margin-bottom: var(--space-3);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--color-bg-card);
}

.topic-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3) var(--space-4);
    background: var(--color-bg-warm);
    cursor: pointer;
    gap: var(--space-3);
    transition: background var(--transition-fast);
}

.topic-header:hover {
    background: var(--color-bg-hover);
}

.topic-header-left {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex: 1;
    min-width: 0;
}

.topic-icon {
    font-size: 1.3rem;
    flex-shrink: 0;
}

.topic-info {
    min-width: 0;
}

.topic-title {
    font-family: var(--font-display);
    font-size: var(--text-base);
    font-weight: 700;
    color: var(--color-text);
}

.topic-meta {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-1);
}

.topic-progress {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-shrink: 0;
}

.topic-progress-bar {
    width: 80px;
    height: 6px;
    background: var(--color-border);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.topic-progress-fill {
    height: 100%;
    background: var(--color-primary);
    border-radius: var(--radius-full);
    transition: width 0.3s ease;
}

.topic-progress-text {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-primary);
    min-width: 35px;
    text-align: right;
}

.topic-toggle {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    transition: transform var(--transition-fast);
}

.topic-header[aria-expanded="true"] .topic-toggle {
    transform: rotate(180deg);
}

.topic-content {
    display: none;
    padding: var(--space-3);
    border-top: 1px solid var(--color-border-light);
}

.topic-content.expanded {
    display: block;
}

/* Subtopic Explanation */
.subtopic-explanation-wrapper {
    margin-bottom: var(--space-3);
}

.subtopic-explanation-toggle {
    width: 100%;
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    transition: all var(--transition-fast);
}

.subtopic-explanation-toggle:hover {
    background: var(--color-bg-hover);
    border-color: var(--color-primary);
}

.explanation-toggle-icon {
    font-size: var(--text-xs);
    transition: transform var(--transition-fast);
}

.explanation-toggle[aria-expanded="true"] .explanation-toggle-icon {
    transform: rotate(180deg);
}

.explanation-content {
    display: none;
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-top: none;
    border-radius: 0 0 var(--radius-md) var(--radius-md);
}

.explanation-content.expanded {
    display: block;
}

.explanation-section {
    margin-bottom: var(--space-3);
}

.explanation-section:last-child {
    margin-bottom: 0;
}

.explanation-heading {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-1);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.explanation-heading-icon {
    font-size: 1em;
}

.explanation-text {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
}

/* ============================================
   LEARNING ITEMS
   ============================================ */
.learning-item-simple {
    position: relative;
    padding: var(--space-3);
    border-left: 4px solid var(--level-1);
    background: var(--color-bg-card);
    margin-bottom: var(--space-2);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    transition: all var(--transition-fast);
}

.learning-item-simple:last-child {
    margin-bottom: 0;
}

.learning-item-simple:hover {
    background: var(--color-bg-hover);
}

.learning-item-simple[data-level="1"] { border-left-color: var(--level-1); }
.learning-item-simple[data-level="2"] { border-left-color: var(--level-2); }
.learning-item-simple[data-level="3"] { border-left-color: var(--level-3); }
.learning-item-simple[data-level="4"] { border-left-color: var(--level-4); }
.learning-item-simple[data-level="5"] { border-left-color: var(--level-5); }

.learning-item-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.learning-item-left {
    flex: 1;
    min-width: 200px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-2);
}

.learning-item-title {
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text);
    flex: 1 1 100%;
}

.learning-item-code {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    background: var(--color-bg-warm);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-family: var(--font-body);
}

.learning-item-updated {
    font-size: 10px;
    color: var(--color-text-muted);
}

.learning-item-right {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-shrink: 0;
}

/* No quiz badge */
.no-quiz-badge {
    font-size: 10px;
    color: var(--color-text-muted);
    background: var(--color-bg-warm);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    gap: 3px;
}

/* Consolidation / Practice More */
.consolidation-row {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-top: var(--space-2);
    padding-top: var(--space-2);
    border-top: 1px dashed var(--color-border);
}

.consolidation-progress {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
}

.consolidation-bar {
    width: 60px;
    height: 6px;
    background: var(--color-bg-warm);
    border-radius: 3px;
    overflow: hidden;
}

.consolidation-bar-fill {
    height: 100%;
    background: var(--level-5);
    border-radius: 3px;
    transition: width var(--transition-base);
}

.consolidation-text {
    white-space: nowrap;
}

.consolidation-complete {
    color: var(--color-success);
    font-weight: 500;
}

.practice-more-btn {
    font-size: var(--text-xs);
    color: var(--level-5);
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid var(--level-5);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    transition: all var(--transition-fast);
    white-space: nowrap;
}

.practice-more-btn:hover {
    background: var(--level-5);
    color: white;
}

.practice-more-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.practice-more-btn.consolidated {
    background: var(--color-success);
    border-color: var(--color-success);
    color: white;
    cursor: default;
}

/* Help toggle inline */
.help-toggle-inline {
    font-size: var(--text-xs);
    color: var(--color-secondary);
    background: var(--color-warning-bg);
    border: 1px solid transparent;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    transition: all var(--transition-fast);
}

.help-toggle-inline:hover {
    background: var(--color-secondary);
    color: white;
}

.help-toggle-inline[aria-expanded="true"] {
    background: var(--color-secondary);
    color: white;
}

/* Help content inline */
.help-content-inline {
    display: none;
    margin-top: var(--space-3);
    padding: var(--space-3);
    background: var(--color-warning-bg);
    border-radius: var(--radius-md);
    border: 1px solid rgba(245, 158, 11, 0.2);
}

.help-content-inline.expanded {
    display: block;
}

.help-inline-item {
    display: block;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
    line-height: var(--line-height-relaxed);
}

.help-inline-item:last-child {
    margin-bottom: 0;
}

.help-inline-item strong {
    color: var(--color-text);
}

/* ============================================
   LEVEL NOTCHES (5-LEVEL SELECTOR)
   ============================================ */
.level-notches {
    display: flex;
    gap: 3px;
    padding: 2px;
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
}

.level-notch {
    width: 28px;
    height: 28px;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-card);
    opacity: 0.4;
    transition: all var(--transition-fast);
    position: relative;
}

.level-notch:hover {
    opacity: 0.7;
    transform: scale(1.1);
}

.level-notch.filled {
    opacity: 0.7;
}

.level-notch.active {
    opacity: 1;
    transform: scale(1.15);
    box-shadow: var(--shadow-md);
}

.level-notch.locked {
    cursor: not-allowed;
    opacity: 0.3;
}

/* Direct lock - failed quiz 3 times on this level */
.level-notch.locked:not(.cascade-locked)::after {
    content: 'üîô';
    position: absolute;
    font-size: 8px;
    bottom: -2px;
    right: -2px;
}

/* Cascade lock - blocked because a lower level is locked */
.level-notch.locked.cascade-locked::after {
    content: 'üîê';
    position: absolute;
    font-size: 8px;
    bottom: -2px;
    right: -2px;
}

.level-notch[data-level="1"] { background: var(--level-1-light); }
.level-notch[data-level="2"] { background: var(--level-2-light); }
.level-notch[data-level="3"] { background: var(--level-3-light); }
.level-notch[data-level="4"] { background: var(--level-4-light); }
.level-notch[data-level="5"] { background: var(--level-5-light); }

.level-notch.filled[data-level="1"],
.level-notch.active[data-level="1"] { background: var(--level-1); color: white; }
.level-notch.filled[data-level="2"],
.level-notch.active[data-level="2"] { background: var(--level-2); color: white; }
.level-notch.filled[data-level="3"],
.level-notch.active[data-level="3"] { background: var(--level-3); color: white; }
.level-notch.filled[data-level="4"],
.level-notch.active[data-level="4"] { background: var(--level-4); color: white; }
.level-notch.filled[data-level="5"],
.level-notch.active[data-level="5"] { background: var(--level-5); color: white; }

/* Notch content elements for different display modes */
.notch-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
}

.notch-emoji {
    font-size: 12px;
    margin-left: 2px;
}

.level-notch .notch-dot {
    border: 1px solid rgba(255,255,255,0.3);
}

.level-notch:not(.filled):not(.active) .notch-dot {
    opacity: 0.5;
}

/* Check-in mode level controls */
.level-controls-checkin {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.level-was {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.level-was-value {
    font-weight: 600;
}

.level-was-value[data-level="1"] { color: var(--level-1); }
.level-was-value[data-level="2"] { color: var(--level-2); }
.level-was-value[data-level="3"] { color: var(--level-3); }
.level-was-value[data-level="4"] { color: var(--level-4); }
.level-was-value[data-level="5"] { color: var(--level-5); }

/* ============================================
   BUTTONS
   ============================================ */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: 600;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    border: 1px solid transparent;
    text-decoration: none;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-primary {
    background: var(--color-primary);
    color: var(--color-text-inverse);
    border-color: var(--color-primary);
}

.btn-primary:hover:not(:disabled) {
    background: var(--color-primary-dark);
    border-color: var(--color-primary-dark);
}

.btn-secondary {
    background: var(--color-bg-card);
    color: var(--color-text);
    border-color: var(--color-border);
}

.btn-secondary:hover:not(:disabled) {
    background: var(--color-bg-hover);
    border-color: var(--color-primary);
}

.btn-sm {
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
}

.btn-lg {
    padding: var(--space-3) var(--space-5);
    font-size: var(--text-base);
}

/* ============================================
   FORMS
   ============================================ */
.form-group {
    margin-bottom: var(--space-4);
}

.form-label {
    display: block;
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-2);
}

.form-input,
.form-textarea {
    width: 100%;
    padding: var(--space-2) var(--space-3);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.form-input:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px var(--color-primary-pale);
}

.form-textarea {
    resize: vertical;
    min-height: 80px;
}

.notes-input-group {
    display: flex;
    gap: var(--space-2);
    align-items: flex-start;
}

.notes-input-group .form-textarea {
    flex: 1;
}

/* ============================================
   EMPTY STATE
   ============================================ */
.empty-state {
    text-align: center;
    padding: var(--space-6);
    color: var(--color-text-muted);
}

.empty-state-icon {
    font-size: 2.5rem;
    margin-bottom: var(--space-3);
    opacity: 0.5;
}

.empty-state-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
}

.empty-state-desc {
    font-size: var(--text-sm);
    max-width: 300px;
    margin: 0 auto;
}

/* ============================================
   TOAST NOTIFICATIONS
   ============================================ */
.toast-container {
    position: fixed;
    bottom: var(--space-4);
    right: var(--space-4);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.toast {
    padding: var(--space-3) var(--space-4);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    font-size: var(--text-sm);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    animation: toastIn 0.3s ease-out;
    max-width: 300px;
}

.toast.success { border-left: 3px solid var(--color-success); }
.toast.error { border-left: 3px solid var(--color-error); }
.toast.info { border-left: 3px solid var(--color-info); }
.toast.warning { border-left: 3px solid var(--color-warning); }

.toast.selection-tip-toast {
    max-width: 380px;
    background: linear-gradient(135deg, var(--color-bg-card) 0%, var(--color-primary-pale) 100%);
    border-left: 3px solid var(--color-primary);
}

@keyframes toastIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
}

.toast-exit {
    animation: toastOut 0.2s ease-in forwards;
}

@keyframes toastOut {
    to { opacity: 0; transform: translateX(20px); }
}

/* ============================================
   QUIZ OVERLAY & MODAL
   ============================================ */
.quiz-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 500;
    display: none;
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
    backdrop-filter: blur(2px);
}

.quiz-overlay.active {
    display: flex;
}

.quiz-modal {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    animation: modalIn 0.3s ease-out;
}

@keyframes modalIn {
    from { opacity: 0; transform: scale(0.95) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

.quiz-header {
    padding: var(--space-4);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.quiz-header-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.quiz-close-btn {
    background: none;
    border: none;
    font-size: var(--text-xl);
    cursor: pointer;
    color: var(--color-text-muted);
    padding: var(--space-1);
    line-height: 1;
}

.quiz-close-btn:hover {
    color: var(--color-text);
}

.quiz-body {
    padding: var(--space-4);
}

.quiz-context {
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-4);
}

.quiz-item-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-2);
}

.quiz-level-transition {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

.quiz-level-arrow {
    color: var(--color-primary);
}

.quiz-question {
    margin-bottom: var(--space-4);
}

.quiz-question-text {
    font-size: var(--text-base);
    font-weight: 500;
    color: var(--color-text);
    line-height: var(--line-height-relaxed);
}

/* Quiz options for MC */
.quiz-options {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
}

.quiz-option {
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg-card);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    text-align: left;
    transition: all var(--transition-fast);
    font-family: var(--font-body);
    font-size: var(--text-sm);
}

.quiz-option:hover:not(:disabled) {
    border-color: var(--color-primary);
    background: var(--color-bg-hover);
}

.quiz-option.selected {
    border-color: var(--color-primary);
    background: var(--color-primary-pale);
}

.quiz-option.correct {
    border-color: var(--color-success);
    background: var(--color-success-bg);
}

.quiz-option.incorrect {
    border-color: var(--color-error);
    background: var(--color-error-bg);
}

.quiz-option:disabled {
    cursor: default;
}

.quiz-option-marker {
    width: 24px;
    height: 24px;
    border-radius: var(--radius-sm);
    background: var(--color-bg-warm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: var(--text-xs);
    flex-shrink: 0;
}

.quiz-option.selected .quiz-option-marker {
    background: var(--color-primary);
    color: white;
}

.quiz-option.correct .quiz-option-marker {
    background: var(--color-success);
    color: white;
}

.quiz-option.incorrect .quiz-option-marker {
    background: var(--color-error);
    color: white;
}

.quiz-option-text {
    flex: 1;
    line-height: var(--line-height-normal);
}

/* Quiz result feedback */
.quiz-result {
    display: none;
    padding: var(--space-3);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
}

.quiz-result.visible {
    display: block;
}

.quiz-result.correct {
    background: var(--color-success-bg);
    border: 1px solid var(--color-success);
}

.quiz-result.incorrect {
    background: var(--color-error-bg);
    border: 1px solid var(--color-error);
}

.quiz-result-header {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
}

.quiz-result-icon {
    font-size: var(--text-lg);
    font-weight: 700;
}

.quiz-result.correct .quiz-result-icon { color: var(--color-success); }
.quiz-result.incorrect .quiz-result-icon { color: var(--color-error); }

.quiz-result-text {
    font-weight: 600;
    font-size: var(--text-sm);
}

.quiz-result.correct .quiz-result-text { color: var(--color-success); }
.quiz-result.incorrect .quiz-result-text { color: var(--color-error); }

.quiz-result-explanation {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
    white-space: pre-wrap;
}

/* Quiz streak info */
.quiz-streak-info {
    background: var(--color-info-bg);
    border: 1px solid var(--color-info);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-4);
    text-align: center;
}

.quiz-streak-text {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
}

.quiz-streak-progress {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
}

.quiz-streak-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--color-border);
    transition: all var(--transition-fast);
}

.quiz-streak-dot.filled {
    background: var(--color-success);
    transform: scale(1.2);
}

/* Quiz footer */
.quiz-footer {
    padding: var(--space-4);
    border-top: 1px solid var(--color-border);
    display: flex;
    justify-content: flex-end;
    gap: var(--space-2);
}

/* ============================================
   GROWTH CHARACTER STYLES
   ============================================ */
.growth-character-modal {
    max-width: 550px;
}

.post-checkin-modal {
    max-width: 400px;
}

.post-checkin-summary {
    font-size: var(--text-lg);
    color: var(--color-text);
}

.gc-body {
    padding: var(--space-4) var(--space-5);
}

.gc-date-type {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
}

.gc-progress-section {
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    margin-bottom: var(--space-4);
}

.gc-progress-header {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
}

.gc-progress-bar-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.gc-progress-bar {
    height: 12px;
    background: var(--color-border);
    border-radius: var(--radius-full);
    position: relative;
    overflow: hidden;
}

.gc-progress-start {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: var(--color-text-muted);
    border-radius: var(--radius-full);
    opacity: 0.4;
}

.gc-progress-current {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-success));
    border-radius: var(--radius-full);
    transition: width 0.5s ease-out;
}

.gc-progress-labels {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: var(--text-sm);
}

.gc-progress-labels span:first-child {
    color: var(--color-text-muted);
}

.gc-progress-arrow {
    color: var(--color-text-muted);
}

.gc-progress-labels span:last-child {
    font-weight: 700;
    color: var(--color-success);
    font-size: var(--text-lg);
}

.gc-narrative-section {
    margin-bottom: var(--space-4);
}

.gc-narrative-text {
    font-size: var(--text-sm);
    line-height: var(--line-height-relaxed);
    color: var(--color-text-secondary);
    font-style: italic;
    background: var(--color-bg-warm);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--color-primary);
}

.gc-qualities-section {
    margin-bottom: var(--space-4);
}

.gc-qualities-header {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
}

.gc-qualities-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.gc-quality {
    display: grid;
    grid-template-columns: 110px 1fr auto;
    align-items: center;
    gap: var(--space-2);
}

.gc-quality-name {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text);
}

.gc-quality-bar {
    height: 8px;
    background: var(--color-border);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.gc-quality-fill {
    height: 100%;
    border-radius: var(--radius-full);
    transition: width 0.4s ease-out;
}

.gc-quality-fill[data-quality="foundation"] { background: var(--level-2); }
.gc-quality-fill[data-quality="momentum"] { background: var(--level-3); }
.gc-quality-fill[data-quality="steadiness"] { background: var(--level-4); }
.gc-quality-fill[data-quality="engagedCuriosity"] { background: var(--color-secondary); }
.gc-quality-fill[data-quality="persistence"] { background: var(--level-5); }
.gc-quality-fill[data-quality="learningHabits"] { background: var(--color-primary); }

.gc-quality-score {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-secondary);
    min-width: 32px;
    text-align: right;
}

.gc-quality-label {
    grid-column: 1 / -1;
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: calc(-1 * var(--space-2));
    padding-left: 110px;
}

.gc-comparison-section {
    background: var(--color-info-bg);
    border: 1px solid var(--color-info);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-4);
}

.gc-comparison-header {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-info);
    margin-bottom: var(--space-2);
}

.gc-comparison-text {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0;
}

.gc-stats-section {
    display: flex;
    justify-content: space-around;
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    padding: var(--space-3);
}

.gc-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.gc-stat-value {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-primary);
}

.gc-stat-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

/* Growth Character Overview Card (in dashboard) */
.gc-overview-card {
    background: linear-gradient(135deg, var(--color-bg-card), var(--color-primary-pale));
    border: 1px solid var(--color-primary-light);
}

.gc-overview-preview {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.gc-overview-level {
    display: flex;
    align-items: baseline;
    gap: var(--space-2);
}

.gc-overview-percent {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--color-primary);
}

.gc-overview-label {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
}

.gc-overview-top-quality {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.gc-overview-quality-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.gc-overview-quality-name {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
}

/* ============================================
   PRACTICE CALENDAR VISUALIZATIONS
   ============================================ */

/* Streak Counter */
.streak-counter {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
}

.streak-flame {
    font-size: var(--text-2xl);
}

.streak-info {
    display: flex;
    flex-direction: column;
}

.streak-number {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-primary);
    line-height: 1;
}

.streak-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.streak-dots {
    display: flex;
    gap: 4px;
    margin-left: auto;
}

.streak-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-border);
}

.streak-dot.active {
    background: var(--color-primary);
}

.streak-dot.today {
    background: var(--color-success);
    box-shadow: 0 0 4px var(--color-success);
}

/* Heatmap Grid (GitHub-style) */
.heatmap-container {
    padding: var(--space-3);
}

.heatmap-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
}

.heatmap-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
}

.heatmap-legend {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.heatmap-legend-squares {
    display: flex;
    gap: 2px;
}

.heatmap-legend-square {
    width: 10px;
    height: 10px;
    border-radius: 2px;
}

.heatmap-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 3px;
}

.heatmap-day-label {
    font-size: 9px;
    color: var(--color-text-muted);
    text-align: center;
    padding-bottom: 2px;
}

.heatmap-cell {
    aspect-ratio: 1;
    border-radius: 2px;
    background: var(--color-bg-warm);
    transition: transform 0.1s ease;
    cursor: default;
    min-width: 12px;
    max-width: 18px;
}

.heatmap-cell:hover {
    transform: scale(1.2);
}

.heatmap-cell[data-level="0"] { background: var(--color-bg-warm); }
.heatmap-cell[data-level="1"] { background: rgba(59, 130, 246, 0.2); }
.heatmap-cell[data-level="2"] { background: rgba(59, 130, 246, 0.4); }
.heatmap-cell[data-level="3"] { background: rgba(59, 130, 246, 0.6); }
.heatmap-cell[data-level="4"] { background: rgba(59, 130, 246, 0.8); }
.heatmap-cell[data-level="5"] { background: var(--color-primary); }

.heatmap-cell.future {
    background: transparent;
    border: 1px dashed var(--color-border);
    opacity: 0.3;
}

.heatmap-cell.today {
    outline: 2px solid var(--color-primary);
    outline-offset: 1px;
}

.heatmap-months {
    display: flex;
    justify-content: space-between;
    margin-top: var(--space-1);
    font-size: 9px;
    color: var(--color-text-muted);
}

/* Calendar View (Monthly) */
.calendar-container {
    padding: var(--space-3);
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-3);
}

.calendar-nav {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.calendar-nav-btn {
    width: 28px;
    height: 28px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-bg-card);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    transition: all var(--transition-fast);
}

.calendar-nav-btn:hover {
    background: var(--color-bg-warm);
    border-color: var(--color-primary);
}

.calendar-month-year {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    min-width: 120px;
    text-align: center;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: var(--space-1);
}

.calendar-weekday {
    font-size: 10px;
    font-weight: 600;
    color: var(--color-text-muted);
    text-align: center;
    padding: var(--space-1);
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-xs);
    border-radius: var(--radius-sm);
    background: var(--color-bg-card);
    color: var(--color-text-secondary);
    transition: all var(--transition-fast);
    cursor: default;
    position: relative;
}

.calendar-day.other-month {
    color: var(--color-text-muted);
    opacity: 0.4;
}

.calendar-day.today {
    font-weight: 700;
    outline: 2px solid var(--color-primary);
}

.calendar-day.has-activity {
    background: var(--color-primary-pale);
    color: var(--color-primary);
    font-weight: 600;
}

.calendar-day.has-activity.high {
    background: var(--color-primary);
    color: white;
}

.calendar-day-dot {
    position: absolute;
    bottom: 2px;
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: var(--color-success);
}

/* Bar Graph */
.bar-graph-container {
    padding: var(--space-3);
}

.bar-graph-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-3);
}

.bar-graph-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
}

.bar-graph-period-selector {
    display: flex;
    gap: var(--space-1);
}

.bar-graph-period-btn {
    padding: var(--space-1) var(--space-2);
    font-size: var(--text-xs);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-bg-card);
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.bar-graph-period-btn:hover {
    border-color: var(--color-primary);
}

.bar-graph-period-btn.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
}

.bar-graph {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 80px;
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--color-border);
}

.bar-graph-bar {
    flex: 1;
    background: var(--color-primary);
    border-radius: 2px 2px 0 0;
    min-height: 2px;
    transition: height 0.3s ease;
    cursor: default;
    position: relative;
}

.bar-graph-bar:hover {
    background: var(--color-primary-dark);
}

.bar-graph-bar.today {
    background: var(--color-success);
}

.bar-graph-bar.no-activity {
    background: var(--color-bg-warm);
}

.bar-graph-labels {
    display: flex;
    justify-content: space-between;
    margin-top: var(--space-1);
    font-size: 9px;
    color: var(--color-text-muted);
}

.bar-graph-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-text);
    color: var(--color-bg-card);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: 10px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}

.bar-graph-bar:hover .bar-graph-tooltip {
    opacity: 1;
}

.bar-graph-summary {
    display: flex;
    justify-content: space-around;
    margin-top: var(--space-3);
    padding-top: var(--space-3);
    border-top: 1px solid var(--color-border);
}

.bar-graph-stat {
    text-align: center;
}

.bar-graph-stat-value {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-primary);
}

.bar-graph-stat-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

/* Activity Card (for Overview) */
.activity-card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.activity-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    border-bottom: 1px solid var(--color-border);
}

.activity-card-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

/* ============================================
   CLOZE QUESTION STYLES
   ============================================ */
.cloze-sentence {
    font-size: var(--text-base);
    line-height: 2;
    color: var(--color-text);
    margin-bottom: var(--space-4);
}

.cloze-blank {
    display: inline-block;
    vertical-align: middle;
}

.cloze-select {
    padding: var(--space-1) var(--space-3);
    padding-right: var(--space-5);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    min-width: 120px;
    transition: all var(--transition-fast);
}

.cloze-select:hover {
    border-color: var(--color-primary);
}

.cloze-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px var(--color-primary-pale);
}

.cloze-select.answered {
    background-color: var(--color-primary-pale);
    border-color: var(--color-primary);
}

.cloze-select.correct {
    background-color: var(--color-success-bg);
    border-color: var(--color-success);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%2322c55e' stroke-width='3'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
}

.cloze-select.incorrect {
    background-color: var(--color-error-bg);
    border-color: var(--color-error);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23ef4444' stroke-width='3'%3E%3Cline x1='18' y1='6' x2='6' y2='18'%3E%3C/line%3E%3Cline x1='6' y1='6' x2='18' y2='18'%3E%3C/line%3E%3C/svg%3E");
}

.cloze-select:disabled {
    cursor: default;
    opacity: 1;
}

/* Cloze feedback per blank */
.cloze-feedback {
    margin-top: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
}

.cloze-feedback-item {
    margin-bottom: var(--space-2);
    padding-left: var(--space-3);
    border-left: 3px solid var(--color-border);
}

.cloze-feedback-item:last-child {
    margin-bottom: 0;
}

.cloze-feedback-item.correct {
    border-left-color: var(--color-success);
}

.cloze-feedback-item.incorrect {
    border-left-color: var(--color-error);
}

.cloze-feedback-label {
    font-weight: 600;
    margin-bottom: var(--space-1);
}

.cloze-feedback-correct {
    color: var(--color-success);
}

.cloze-feedback-text {
    color: var(--color-text-secondary);
}

/* ============================================
   CHECK-IN MODE STYLES
   ============================================ */
.checkin-mode-active {
    position: relative;
    border: 3px solid var(--color-primary);
    border-radius: var(--radius-lg);
    animation: checkinBorderPulse 1.5s ease-in-out infinite;
}

.checkin-mode-active::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(45, 157, 120, 0.12);
    border-radius: var(--radius-lg);
    pointer-events: none;
    animation: checkinPulse 1.5s ease-in-out infinite;
    z-index: 0;
}

@keyframes checkinPulse {
    0%, 100% { background: rgba(45, 157, 120, 0.08); }
    50% { background: rgba(45, 157, 120, 0.18); }
}

@keyframes checkinBorderPulse {
    0%, 100% { 
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0 rgba(45, 157, 120, 0.4);
    }
    50% { 
        border-color: #1a7a5a;
        box-shadow: 0 0 20px 5px rgba(45, 157, 120, 0.3);
    }
}

.checkin-mode-active > * {
    position: relative;
    z-index: 1;
}

/* Check-in Mode Banner */
.checkin-mode-banner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background: linear-gradient(135deg, var(--color-primary), #228b6b);
    color: white;
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.checkin-mode-info {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.checkin-mode-type {
    font-weight: 600;
    font-size: var(--text-sm);
}

.checkin-mode-progress {
    font-size: var(--text-xs);
    opacity: 0.9;
}

.checkin-stop-btn {
    padding: var(--space-2) var(--space-3);
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-md);
    color: white;
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.checkin-stop-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Floating Check-in Status Bar */
.checkin-floating-bar {
    position: fixed;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) var(--space-4);
    background: linear-gradient(135deg, var(--color-primary), #1a7a5a);
    color: white;
    border-radius: var(--radius-full);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    animation: floatIn 0.3s ease-out, floatingPulse 2s ease-in-out infinite;
}

.checkin-floating-bar.active {
    display: flex;
}

@keyframes floatIn {
    from { opacity: 0; transform: translateX(-50%) translateY(20px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

@keyframes floatingPulse {
    0%, 100% { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); }
    50% { box-shadow: 0 4px 30px rgba(45, 157, 120, 0.5); }
}

.checkin-floating-icon {
    font-size: 1rem;
    animation: iconPulse 1s ease-in-out infinite;
}

@keyframes iconPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

.checkin-floating-text {
    font-weight: 600;
    font-size: 11px;
}

.checkin-floating-progress {
    font-size: 10px;
    opacity: 0.9;
}

.checkin-floating-timer {
    font-size: 10px;
    background: rgba(255, 255, 255, 0.2);
    padding: 2px 6px;
    border-radius: var(--radius-full);
}

.checkin-floating-stop {
    padding: var(--space-1) var(--space-3);
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-full);
    color: white;
    font-size: var(--text-xs);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.checkin-floating-stop:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Item reviewed indicator */
.learning-item-simple.reviewed {
    background: rgba(45, 157, 120, 0.05);
}

.learning-item-simple.reviewed::after {
    content: '‚úî';
    position: absolute;
    top: var(--space-2);
    right: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-primary);
    opacity: 0.7;
}

/* ============================================
   DASHBOARD CARDS
   ============================================ */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-4);
}

.checkin-card {
    background: linear-gradient(135deg, var(--color-primary-pale), var(--color-bg-warm));
    border: 1px solid var(--color-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    text-align: center;
}

.checkin-icon {
    font-size: 2rem;
    margin-bottom: var(--space-3);
}

.checkin-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: var(--space-2);
}

.checkin-desc {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-4);
}

.stat-card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
}

.stat-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-3);
}

.stat-card-title {
    font-family: var(--font-display);
    font-size: var(--text-base);
    font-weight: 700;
    color: var(--color-text);
}

.stat-card-icon {
    font-size: 1.2rem;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--color-border-light);
}

.stat-row:last-child {
    border-bottom: none;
}

.stat-label {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

.stat-value {
    font-weight: 600;
    color: var(--color-text);
}

/* Goal items */
.goal-item {
    padding: var(--space-3);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-left: 4px solid var(--color-primary);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    margin-bottom: var(--space-2);
}

.goal-item:last-child {
    margin-bottom: 0;
}

.goal-text {
    font-size: var(--text-sm);
    color: var(--color-text);
    margin-bottom: var(--space-1);
}

.goal-meta {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.focus-area-link {
    cursor: pointer;
    transition: background var(--transition-fast);
}

.focus-area-link:hover {
    background: var(--color-bg-hover);
}

/* ============================================
   HISTORY / PROGRESS VISUALIZATION
   ============================================ */
.overall-progress {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-3);
}

.overall-progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
}

.overall-progress-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
}

.overall-progress-percent {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-primary);
}

.overall-progress-bar {
    height: 12px;
    background: var(--color-bg-warm);
    border-radius: var(--radius-full);
    overflow: hidden;
    margin-bottom: var(--space-2);
}

.overall-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-primary-light));
    border-radius: var(--radius-full);
    transition: width 0.5s ease-out;
}

.overall-progress-stats {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
}

.overall-stat {
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.overall-stat-value {
    font-weight: 600;
    color: var(--color-text);
}

/* Level Distribution */
.level-distribution {
    display: flex;
    height: 20px;
    border-radius: var(--radius-sm);
    overflow: hidden;
    background: var(--color-bg-warm);
    margin-bottom: var(--space-1);
}

.level-segment {
    height: 100%;
    transition: width 0.4s ease-out;
    position: relative;
    min-width: 0;
}

.level-segment[data-level="1"] { background: var(--level-1); }
.level-segment[data-level="2"] { background: var(--level-2); }
.level-segment[data-level="3"] { background: var(--level-3); }
.level-segment[data-level="4"] { background: var(--level-4); }
.level-segment[data-level="5"] { background: var(--level-5); }

.level-segment:hover {
    filter: brightness(1.1);
}

/* Subtopic Progress Cards */
.subtopic-progress {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: var(--space-2) var(--space-3);
    margin-bottom: var(--space-2);
}

.subtopic-progress:last-child {
    margin-bottom: 0;
}

.subtopic-progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
}

.subtopic-progress-name {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.subtopic-progress-change {
    font-size: 10px;
}

.level-distribution-legend {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    font-size: 9px;
    color: var(--color-text-muted);
}

/* ============================================
   CHECK-IN TYPE BUTTONS
   ============================================ */
.checkin-type-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    gap: var(--space-2);
    margin-bottom: var(--space-3);
}

.checkin-type-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-3);
    background: var(--color-bg-card);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-align: center;
}

.checkin-type-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-bg-hover);
}

.checkin-type-btn.active {
    border-color: var(--color-primary);
    background: rgba(45, 157, 120, 0.1);
}

.checkin-type-icon {
    font-size: 1.2rem;
}

.checkin-type-name {
    font-weight: 600;
    font-size: var(--text-xs);
    color: var(--color-text);
}

.checkin-type-desc {
    font-size: 10px;
    color: var(--color-text-muted);
    line-height: 1.2;
}

/* ============================================
   SETTINGS
   ============================================ */
.settings-section {
    margin-bottom: var(--space-6);
}

.settings-section:last-child { margin-bottom: 0; }

.settings-section-title {
    font-size: var(--text-xs);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    margin-bottom: var(--space-3);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--color-border-light);
}

.settings-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--color-border-light);
}

.settings-row:last-child {
    border-bottom: none;
}

.settings-label {
    font-size: var(--text-sm);
    color: var(--color-text);
}

.settings-label-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    flex: 1;
    min-width: 0;
}

.settings-hint {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    line-height: var(--line-height-normal);
}

/* Utility help card */
.utility-help-card {
    margin-bottom: var(--space-4);
    background: linear-gradient(135deg, var(--color-bg-card) 0%, var(--color-primary-pale) 100%);
    border: 1px solid var(--color-primary);
    border-left: 4px solid var(--color-primary);
}

.utility-help-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
    padding: var(--space-4);
    flex-wrap: wrap;
}

.utility-help-text {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.utility-help-icon {
    font-size: 28px;
}

.utility-help-text strong {
    display: block;
    font-size: var(--text-base);
    color: var(--color-text);
    margin-bottom: 2px;
}

.utility-help-text span {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

/* Export Section Styles */
.export-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    padding: var(--space-4);
}

.export-option {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
}

.export-option-icon {
    font-size: 2rem;
    flex-shrink: 0;
    width: 48px;
    text-align: center;
}

.export-option-content {
    flex: 1;
    min-width: 0;
}

.export-option-title {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 var(--space-1) 0;
}

.export-option-desc {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0;
}

.export-option-buttons {
    display: flex;
    gap: var(--space-2);
    flex-shrink: 0;
}

/* Restore Preview Panel */
.restore-preview-panel {
    margin: var(--space-4);
    padding: var(--space-4);
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    animation: slideDown 0.2s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.restore-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-3);
}

.restore-preview-header h3 {
    margin: 0;
    font-size: var(--text-base);
    font-weight: 600;
}

.restore-preview-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-muted);
    padding: 0;
    line-height: 1;
}

.restore-preview-close:hover {
    color: var(--color-text);
}

.restore-preview-content {
    font-size: var(--text-sm);
    margin-bottom: var(--space-3);
}

.restore-preview-content dl {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: var(--space-2) var(--space-4);
    margin: 0;
}

.restore-preview-content dt {
    color: var(--color-text-secondary);
    font-weight: 500;
}

.restore-preview-content dd {
    margin: 0;
    color: var(--color-text);
}

.restore-preview-warning {
    padding: var(--space-3);
    background: rgba(234, 179, 8, 0.1);
    border: 1px solid rgba(234, 179, 8, 0.3);
    border-radius: var(--radius-sm);
    font-size: var(--text-sm);
    color: var(--color-text);
    margin-bottom: var(--space-3);
}

.restore-topic-mismatch {
    padding: var(--space-3);
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: var(--radius-sm);
    font-size: var(--text-sm);
    color: var(--color-error);
    margin-bottom: var(--space-3);
}

.restore-type-badge {
    display: inline-block;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: var(--space-3);
}

.restore-type-full {
    background: rgba(139, 92, 246, 0.15);
    color: #8b5cf6;
    border: 1px solid rgba(139, 92, 246, 0.3);
}

.restore-type-single {
    background: rgba(59, 130, 246, 0.15);
    color: #3b82f6;
    border: 1px solid rgba(59, 130, 246, 0.3);
}

.restore-topics-list {
    margin-top: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--text-sm);
}

.restore-topics-list ul {
    margin: var(--space-2) 0 0 var(--space-4);
    padding: 0;
}

.restore-topics-list li {
    margin-bottom: var(--space-1);
    color: var(--color-text-secondary);
}

.restore-preview-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-2);
}

/* Email Preview Panel */
.email-preview-panel {
    margin: var(--space-4) 0;
    padding: var(--space-4);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    animation: slideDown 0.2s ease;
}

.email-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-3);
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--color-border);
}

.email-preview-header h3 {
    margin: 0;
    font-size: var(--text-base);
    font-weight: 600;
}

.email-preview-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-muted);
    padding: 0;
    line-height: 1;
}

.email-preview-close:hover {
    color: var(--color-text);
}

.email-subject-line {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-3);
    font-size: var(--text-sm);
}

.email-subject-label {
    font-weight: 600;
    color: var(--color-text-secondary);
    flex-shrink: 0;
}

.email-subject-text {
    color: var(--color-text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.email-preview-content {
    max-height: 400px;
    overflow-y: auto;
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: 'Courier New', Courier, monospace;
    font-size: var(--text-xs);
    white-space: pre-wrap;
    line-height: 1.5;
    margin-bottom: var(--space-3);
}

/* Questions banner at top of email preview */
.email-questions-banner {
    padding: var(--space-3);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-3);
    font-size: var(--text-sm);
    line-height: 1.5;
}

.email-questions-banner.has-questions {
    background: rgba(45, 157, 120, 0.1);
    border: 2px solid rgba(45, 157, 120, 0.35);
}

.email-questions-banner.no-questions {
    background: rgba(234, 179, 8, 0.1);
    border: 2px solid rgba(234, 179, 8, 0.35);
}

.email-questions-banner h4 {
    margin: 0 0 var(--space-2) 0;
    font-size: var(--text-sm);
    font-weight: 700;
}

.email-questions-banner ol {
    margin: 0;
    padding-left: var(--space-4);
}

.email-questions-banner ol li {
    margin-bottom: var(--space-1);
}

.email-preview-hint {
    padding: var(--space-2) var(--space-3);
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
}

.email-preview-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-2);
}

/* Responsive adjustments for export options */
@media (max-width: 640px) {
    .export-option {
        flex-direction: column;
        text-align: center;
    }

    .export-option-buttons {
        width: 100%;
        justify-content: center;
    }

    .export-option .btn {
        width: 100%;
    }
}

/* Inline confirmation dialogs for data management */
.data-action-item {
    margin-bottom: var(--space-3);
}

.data-action-item:last-child {
    margin-bottom: 0;
}

.data-action-confirm {
    display: none;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    margin-top: var(--space-2);
    animation: confirmSlideIn 0.2s ease;
}

@keyframes confirmSlideIn {
    from {
        opacity: 0;
        transform: translateY(-8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.data-action-item.confirming .data-action-main {
    display: none;
}

.data-action-item.confirming .data-action-confirm {
    display: flex;
}

.confirm-message {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

.confirm-message.confirm-danger {
    color: var(--color-error);
    font-weight: 500;
}

.confirm-buttons {
    display: flex;
    gap: var(--space-2);
    flex-shrink: 0;
}

.btn-small {
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
}

.btn-ghost {
    background: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-text-secondary);
}

.btn-ghost:hover {
    background: var(--color-bg-hover);
    border-color: var(--color-text-muted);
}

.btn-danger {
    background: var(--color-error);
    border: 1px solid var(--color-error);
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
    border-color: #dc2626;
}

/* Toggle switch */
.toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: var(--color-border);
    border-radius: var(--radius-full);
    transition: all var(--transition-fast);
}

.toggle-slider::before {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    left: 3px;
    bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: all var(--transition-fast);
}

.toggle-switch input:checked + .toggle-slider {
    background: var(--color-primary);
}

.toggle-switch input:checked + .toggle-slider::before {
    transform: translateX(20px);
}

/* Level customization settings */
.level-display-options {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
}

.level-display-option {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-3);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    cursor: pointer;
    font-size: var(--text-sm);
    transition: all 0.15s ease;
}

.level-display-option:hover {
    border-color: var(--color-primary);
}

.level-display-option.active {
    border-color: var(--color-primary);
    background: var(--color-primary-pale);
}

.level-display-option input {
    display: none;
}

.emoji-progression-select {
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    cursor: pointer;
    min-width: 200px;
}

.emoji-progression-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px var(--color-primary-pale);
}

.level-colors-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: var(--space-3);
    margin-top: var(--space-2);
}

.level-color-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-1);
}

.level-color-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-align: center;
}

.level-color-picker {
    width: 40px;
    height: 40px;
    padding: 0;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    background: transparent;
}

.level-color-picker::-webkit-color-swatch-wrapper {
    padding: 2px;
}

.level-color-picker::-webkit-color-swatch {
    border: none;
    border-radius: var(--radius-sm);
}

.level-color-picker::-moz-color-swatch {
    border: none;
    border-radius: var(--radius-sm);
}

.level-color-picker:hover {
    border-color: var(--color-primary);
}

.level-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    margin-top: var(--space-3);
}

.level-preview-item {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--text-sm);
}

.level-preview-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.level-preview-emoji {
    font-size: var(--text-base);
}

.settings-subsection {
    margin-top: var(--space-4);
    padding-top: var(--space-3);
    border-top: 1px dashed var(--color-border-light);
}

.settings-subsection-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
}

.reset-colors-btn {
    margin-top: var(--space-3);
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-xs);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all 0.15s ease;
}

.reset-colors-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
}

@media (max-width: 600px) {
    .level-colors-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .level-preview {
        flex-wrap: wrap;
    }
}

/* ============================================
   STATUS BAR (FOOTER)
   ============================================ */
.status-bar {
    background: var(--color-bg-card);
    border-top: 1px solid var(--color-border);
    padding: var(--space-2) var(--space-5);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 50;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.status-indicator::before {
    content: '';
    width: 8px;
    height: 8px;
    background: var(--color-success);
    border-radius: var(--radius-full);
}

/* ============================================
   TEXT SELECTION POPUP
   ============================================ */
.selection-popup {
    position: absolute;
    z-index: 1000;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    padding: var(--space-1);
    display: none;
    flex-direction: column;
    gap: 2px;
    min-width: 180px;
    animation: popupFadeIn 0.15s ease-out;
}

@keyframes popupFadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
}

.selection-popup-btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    color: var(--color-text);
    cursor: pointer;
    text-align: left;
    transition: background var(--transition-fast);
}

.selection-popup-btn:hover {
    background: var(--color-bg-hover);
}

.selection-popup-btn .popup-icon {
    font-size: 14px;
    width: 20px;
    text-align: center;
}

.selection-popup-btn .popup-label {
    flex: 1;
}

.selection-popup-btn.teacher { color: var(--color-primary); }
.selection-popup-btn.google { color: #4285f4; }
.selection-popup-btn.chatgpt { color: #10a37f; }

.selection-popup-btn.teacher:hover { background: var(--color-primary-pale); }
.selection-popup-btn.google:hover { background: rgba(66, 133, 244, 0.1); }
.selection-popup-btn.chatgpt:hover { background: rgba(16, 163, 127, 0.1); }

/* ============================================
   LOADING STATE
   ============================================ */
.loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: var(--space-3);
}

[data-theme="dark"] .loading-overlay {
    background: rgba(15, 23, 20, 0.9);
}

.loading-overlay.active {
    display: flex;
}

.loading-spinner-large {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

.loading-text {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

/* ============================================
   MESSAGES SYSTEM
   ============================================ */

/* Message Icon Button in Header */
.message-icon-btn {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--color-text-inverse);
    padding: var(--space-1);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: var(--text-base);
    transition: all var(--transition-fast);
    min-width: 36px;
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.message-icon-btn:hover {
    background: rgba(255, 255, 255, 0.25);
}

.message-icon-btn.hidden {
    display: none;
}

.message-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--color-error);
    color: white;
    font-size: 10px;
    font-weight: 700;
    min-width: 16px;
    height: 16px;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.message-badge.hidden {
    display: none;
}

/* Messages Dialog Overlay */
.messages-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: var(--space-4);
    backdrop-filter: blur(4px);
}

.messages-overlay.active {
    display: flex;
}

/* Messages Dialog */
.messages-dialog {
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    max-width: 700px;
    width: 100%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    animation: messagesSlideIn 0.3s ease;
    overflow: hidden;
}

@keyframes messagesSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.messages-dialog-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--color-border);
    background: var(--color-bg-warm);
}

.messages-dialog-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin: 0;
}

.messages-close-btn {
    background: transparent;
    border: none;
    color: var(--color-text-muted);
    font-size: var(--text-xl);
    cursor: pointer;
    padding: var(--space-1);
    line-height: 1;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
}

.messages-close-btn:hover {
    background: var(--color-bg-hover);
    color: var(--color-text);
}

/* Messages Content - Split Layout */
.messages-content {
    display: flex;
    flex: 1;
    min-height: 300px;
    max-height: 60vh;
    overflow: hidden;
}

/* Messages List Panel */
.messages-list-panel {
    width: 220px;
    flex-shrink: 0;
    border-right: 1px solid var(--color-border);
    display: flex;
    flex-direction: column;
    background: var(--color-bg-warm);
}

.messages-list {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-2);
}

.message-list-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-2);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: var(--space-1);
    border: 1px solid transparent;
}

.message-list-item:hover {
    background: var(--color-bg-hover);
}

.message-list-item.selected {
    background: var(--color-bg-card);
    border-color: var(--color-border);
    box-shadow: var(--shadow-sm);
}

.message-unread-dot {
    width: 8px;
    height: 8px;
    border-radius: var(--radius-full);
    background: var(--color-primary);
    flex-shrink: 0;
    margin-top: 6px;
}

.message-unread-dot.read {
    background: transparent;
}

.message-list-info {
    flex: 1;
    min-width: 0;
}

.message-list-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: var(--space-1);
}

.message-list-item.unread .message-list-title {
    color: var(--color-primary-dark);
}

.message-list-date {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

/* Messages Detail Panel */
.messages-detail-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    overflow: hidden;
}

.message-detail-header {
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--color-border-light);
}

.message-detail-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-text);
    margin: 0 0 var(--space-1);
}

.message-detail-meta {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.message-detail-type {
    background: var(--color-primary-pale);
    color: var(--color-primary-dark);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

.message-detail-type.update {
    background: var(--color-info-bg);
    color: var(--color-info);
}

.message-detail-body {
    flex: 1;
    padding: var(--space-4) var(--space-5);
    overflow-y: auto;
}

.message-detail-content {
    font-size: var(--text-base);
    color: var(--color-text-secondary);
    line-height: 1.7;
    white-space: pre-wrap;
}

.message-detail-content ul,
.message-detail-content ol {
    margin: var(--space-3) 0;
    padding-left: var(--space-6);
}

.message-detail-content li {
    margin-bottom: var(--space-2);
}

/* Empty state for detail panel */
.message-detail-empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-6);
    color: var(--color-text-muted);
    text-align: center;
}

.message-detail-empty-icon {
    font-size: 48px;
    margin-bottom: var(--space-3);
    opacity: 0.5;
}

.message-detail-empty-text {
    font-size: var(--text-sm);
}

/* Messages Dialog Footer */
.messages-dialog-footer {
    padding: var(--space-3) var(--space-5);
    border-top: 1px solid var(--color-border);
    display: flex;
    justify-content: flex-end;
    background: var(--color-bg-warm);
}

/* Settings Messages Button */
.settings-messages-btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    width: 100%;
    padding: var(--space-3) var(--space-4);
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: var(--space-4);
}

.settings-messages-btn:hover {
    background: var(--color-bg-hover);
    border-color: var(--color-primary);
}

.settings-messages-btn.hidden {
    display: none;
}

.settings-messages-icon {
    font-size: var(--text-base);
}

.settings-messages-badge {
    background: var(--color-error);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: var(--radius-full);
    margin-left: auto;
}

.settings-messages-badge.hidden {
    display: none;
}

/* ============================================
   WELCOME DIALOG
   ============================================ */
.welcome-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: var(--space-4);
    backdrop-filter: blur(4px);
}

.welcome-overlay.active {
    display: flex;
}

.welcome-dialog {
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    max-width: 540px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    animation: welcomeSlideIn 0.3s ease;
}

@keyframes welcomeSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.welcome-header {
    padding: var(--space-6) var(--space-6) var(--space-4);
    text-align: center;
    border-bottom: 1px solid var(--color-border-light);
}

.welcome-icon {
    font-size: 48px;
    display: block;
    margin-bottom: var(--space-3);
}

.welcome-title {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-text);
    margin: 0;
}

.welcome-body {
    padding: var(--space-5) var(--space-6);
}

.welcome-intro {
    font-size: var(--text-base);
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin: 0 0 var(--space-5);
}

.welcome-features {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.welcome-feature {
    display: flex;
    gap: var(--space-3);
    align-items: flex-start;
}

.welcome-feature-icon {
    font-size: 24px;
    flex-shrink: 0;
    width: 32px;
    text-align: center;
}

.welcome-feature-text {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.welcome-feature-text strong {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
}

.welcome-feature-text span {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.5;
}

.welcome-user-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-5);
}

.welcome-form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.welcome-form-label {
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text);
}

.welcome-form-input {
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-base);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
}

.welcome-form-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-pale);
}

.welcome-form-input::placeholder {
    color: var(--color-text-muted);
}

.welcome-footer-text {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin: var(--space-5) 0 0;
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border-light);
    text-align: center;
}

.welcome-footer {
    padding: var(--space-4) var(--space-6) var(--space-6);
    display: flex;
    justify-content: space-between;
    gap: var(--space-3);
}

.welcome-footer .btn {
    min-width: 120px;
}

.welcome-start-btn {
    min-width: 160px;
    padding: var(--space-3) var(--space-6);
    font-size: var(--text-base);
}

/* Welcome pages */
.welcome-page {
    display: none;
}

.welcome-page.active {
    display: block;
}

/* Tutorial steps */
.tutorial-steps {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.tutorial-step {
    display: flex;
    gap: var(--space-3);
    align-items: flex-start;
}

.tutorial-step-number {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--color-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-sm);
    font-weight: 700;
    flex-shrink: 0;
}

.tutorial-step-content {
    flex: 1;
}

.tutorial-step-content strong {
    display: block;
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-1);
}

.tutorial-step-content p {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.5;
    margin: 0;
}

.tutorial-demo {
    display: flex;
    gap: var(--space-2);
    margin-top: var(--space-2);
    padding: var(--space-2);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    justify-content: center;
}

.tutorial-demo-level {
    font-size: 18px;
    padding: var(--space-1);
}

/* ============================================
   MOBILE RESPONSIVE
   ============================================ */
@media (max-width: 768px) {
    .header-content { flex-wrap: wrap; }
    .app-title { font-size: var(--text-xl); }
    .student-info { display: none; }
    .main-content { padding: var(--space-3); }
    
    .topic-selector-bar {
        padding: var(--space-2);
    }
    
    .topic-selector-content {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-2);
    }
    
    .topic-selector-label {
        display: none;
    }
    
    .topic-selector-dropdowns {
        flex-direction: column;
        gap: var(--space-2);
    }
    
    .topic-dropdown {
        width: 100%;
        min-width: unset;
    }
    
    .topic-dropdown-separator {
        display: none;
    }
    
    .topic-current-display {
        margin-left: 0;
        justify-content: center;
        padding-top: var(--space-2);
        border-top: 1px solid var(--color-border);
    }
    
    .topic-header { flex-wrap: wrap; gap: var(--space-2); }
    .topic-progress { width: 100%; justify-content: flex-end; }
    
    .progress-stats { grid-template-columns: repeat(2, 1fr); }
    
    .dashboard-grid { grid-template-columns: 1fr; }
    
    .learning-item-row {
        flex-direction: column;
        gap: var(--space-2);
    }
    
    .learning-item-right {
        width: 100%;
        justify-content: flex-end;
    }
    
    .quiz-modal {
        max-height: 100vh;
        border-radius: var(--radius-lg);
        margin: var(--space-2);
    }
    
    .checkin-floating-bar {
        left: var(--space-2);
        right: var(--space-2);
        transform: none;
        border-radius: var(--radius-lg);
        justify-content: space-between;
    }
}

/* ============================================
   PRINT STYLES
   ============================================ */
@media print {
    .app-header, .sub-nav, .header-actions, .status-bar,
    .toast-container, .quiz-overlay, .btn, .level-notches,
    .checkin-floating-bar, .selection-popup { 
        display: none !important; 
    }
    
    body { 
        background: white; 
        color: black; 
        font-size: 11pt; 
    }
    
    .main-content { 
        max-width: none; 
        padding: 0; 
    }
    
    .card, .topic-section { 
        break-inside: avoid; 
        border: 1px solid #ccc; 
        box-shadow: none; 
    }
    
    .topic-content, .help-content-inline { 
        display: block !important; 
    }
}
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div class="app-container">
        <!-- Header -->
        <header class="app-header" role="banner">
            <div class="header-content">
                <h1 class="app-title">
                    <span class="app-title-icon">üå±</span>
                    <span>Dynamic Learning Check List</span>
                </h1>
                
                <div class="student-info" id="student-info">
                    <span class="student-avatar">üë§</span>
                    <span id="student-name-display">Student</span>
                </div>
                
                <div class="header-actions">
                    <button class="message-icon-btn hidden" id="message-icon-btn" title="Messages" aria-label="View messages">
                        <span>üì¢</span>
                        <span class="message-badge hidden" id="message-badge">0</span>
                    </button>
                    <button class="header-btn" id="new-checkin-btn" title="Start a new check-in">
                        <span>üìã</span> Check In
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Topic Selector Bar -->
        <div class="topic-selector-bar">
            <div class="topic-selector-content">
                <span class="topic-selector-label">Topic:</span>
                <div class="topic-selector-dropdowns">
                    <select class="topic-dropdown" id="year-level-dropdown" aria-label="Select year level">
                        <option value="">Select Year Level</option>
                    </select>
                    <span class="topic-dropdown-separator">‚Ä∫</span>
                    <select class="topic-dropdown" id="subject-dropdown" aria-label="Select subject" disabled>
                        <option value="">Select Subject</option>
                    </select>
                    <span class="topic-dropdown-separator">‚Ä∫</span>
                    <select class="topic-dropdown" id="topic-dropdown" aria-label="Select topic" disabled>
                        <option value="">Select Topic</option>
                    </select>
                    <button class="topic-refresh-btn" id="refresh-topics-btn" title="Refresh topic availability" aria-label="Refresh topic availability">‚Üª</button>
                    <span class="dropdown-measure" id="dropdown-measure" aria-hidden="true"></span>
                </div>
                <div class="topic-loading-indicator" id="topic-loading-indicator">
                    <div class="topic-loading-spinner"></div>
                    <span>Loading...</span>
                </div>
                <div class="topic-current-display">
                    <span id="topic-current-name">No topic selected</span>
                </div>
                <div class="class-badge-container" id="class-badge-container" style="margin-left:auto;">
                    <span class="class-badge" id="class-badge-display" title="Click to change class" style="cursor:pointer; padding: var(--space-1) var(--space-3); font-size: var(--text-xs); font-weight: 600; background: var(--color-primary-pale); color: var(--color-primary); border-radius: var(--radius-sm); border: 1px solid var(--color-primary); display:inline-block;">No class</span>
                </div>
            </div>
        </div>

        <!-- Class Mismatch Modal -->
        <div id="class-mismatch-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
            <div style="background:var(--color-bg-card); border-radius:var(--radius-lg); padding:var(--space-6); max-width:420px; width:90%; box-shadow:var(--shadow-lg);">
                <h3 style="margin-bottom:var(--space-3); color:var(--color-text);">Class Mismatch</h3>
                <p id="class-mismatch-message" style="margin-bottom:var(--space-4); color:var(--color-text-secondary); font-size:var(--text-sm); line-height:1.5;"></p>
                <div style="margin-bottom:var(--space-4);">
                    <label style="font-size:var(--text-sm); font-weight:600; color:var(--color-text); display:block; margin-bottom:var(--space-2);">Select your class:</label>
                    <select id="class-mismatch-select" class="form-input" style="width:100%; padding:var(--space-2) var(--space-3); font-size:var(--text-sm); border:1px solid var(--color-border); border-radius:var(--radius-md); background:var(--color-bg-card); color:var(--color-text);">
                        <option value="">-- Select your class --</option>
                        <option value="12BioTSH">12BioTSH</option>
                        <option value="12CheDMH">12CheDMH</option>
                        <option value="12PhyJIM">12PhyJIM</option>
                        <option value="12PhyEVA">12PhyEVA</option>
                        <option value="11PhyJIM">11PhyJIM</option>
                        <option value="11BioTSH">11BioTSH</option>
                        <option value="10SciJIM">10SciJIM</option>
                        <option value="10SciKLA">10SciKLA</option>
                        <option value="10SciDMH">10SciDMH</option>
                        <option value="08SciDMH">08SciDMH</option>
                    </select>
                </div>
                <div style="display:flex; gap:var(--space-3); justify-content:flex-end;">
                    <button id="class-mismatch-dismiss" style="padding:var(--space-2) var(--space-4); font-size:var(--text-sm); border:1px solid var(--color-border); border-radius:var(--radius-md); background:var(--color-bg-card); color:var(--color-text); cursor:pointer;">Keep Current</button>
                    <button id="class-mismatch-confirm" style="padding:var(--space-2) var(--space-4); font-size:var(--text-sm); border:none; border-radius:var(--radius-md); background:var(--color-primary); color:white; cursor:pointer; font-weight:600;">Update Class</button>
                </div>
            </div>
        </div>

        <!-- Sub Navigation (Tabs) -->
        <nav class="sub-nav" role="tablist" aria-label="Main sections">
            <div class="sub-nav-content">
                <button class="nav-tab" id="overview-tab" role="tab" aria-selected="true" aria-controls="overview-panel">
                    <span class="nav-tab-icon">üìä</span> Overview
                </button>
                <button class="nav-tab" id="learning-tab" role="tab" aria-selected="false" aria-controls="learning-panel">
                    <span class="nav-tab-icon">üìö</span> Learning Content
                </button>
                <button class="nav-tab" id="history-tab" role="tab" aria-selected="false" aria-controls="history-panel">
                    <span class="nav-tab-icon">üìÖ</span> History
                </button>
                <button class="nav-tab" id="goals-tab" role="tab" aria-selected="false" aria-controls="goals-panel">
                    <span class="nav-tab-icon">üéØ</span> Goals
                    <span class="nav-tab-badge" id="goals-badge" style="display: none;">0</span>
                </button>
                <button class="nav-tab" id="export-tab" role="tab" aria-selected="false" aria-controls="export-panel">
                    <span class="nav-tab-icon">‚öôÔ∏è</span> Utility
                </button>
            </div>
        </nav>
        
        <!-- Main Content Area -->
        <main class="main-content" id="main-content">
            
            <!-- Overview Panel -->
            <div class="panel-content active" id="overview-panel" role="tabpanel" aria-labelledby="overview-tab">
                
                <!-- Progress Overview Card -->
                <div class="card progress-overview">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">üìà</span>
                            <span id="topic-name-display">Your Progress</span>
                        </h2>
                    </div>
                    
                    <div class="progress-bar-container">
                        <div class="progress-bar-label">
                            <span>Overall Progress</span>
                            <span id="overall-percentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="overall-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="progress-stats" id="progress-stats">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <!-- Level Legend -->
                <div class="level-legend" id="overview-level-legend">
                    <!-- Dynamically populated -->
                </div>
                
                <!-- Quick Actions -->
                <div class="dashboard-grid">
                    <div class="checkin-card" id="next-checkin-card">
                        <div class="checkin-icon">üìã</div>
                        <h3 class="checkin-title">Ready for your next check-in?</h3>
                        <p class="checkin-desc">Track your progress by checking in on your understanding</p>
                        <button class="btn btn-primary btn-lg" id="start-checkin-btn">Start Check-in</button>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h3 class="stat-card-title">Quick Stats</h3>
                            <span class="stat-card-icon">üìà</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total check-ins</span>
                            <span class="stat-value" id="total-checkins">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Items secured</span>
                            <span class="stat-value" id="items-secured">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Last check-in</span>
                            <span class="stat-value" id="last-checkin-date">‚Äî</span>
                        </div>
                    </div>

                    <div class="stat-card gc-overview-card" id="gc-overview-card" style="display: none;">
                        <div class="stat-card-header">
                            <h3 class="stat-card-title">Growth Character</h3>
                            <span class="stat-card-icon">üå±</span>
                        </div>
                        <div class="gc-overview-preview">
                            <div class="gc-overview-level">
                                <span class="gc-overview-percent" id="gc-overview-percent">0%</span>
                                <span class="gc-overview-label">Overall</span>
                            </div>
                            <div class="gc-overview-top-quality">
                                <span class="gc-overview-quality-label">Top strength:</span>
                                <span class="gc-overview-quality-name" id="gc-overview-top-quality">-</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm" id="view-growth-character-btn" style="width: 100%; margin-top: var(--space-3);">
                            üìà View Growth Character
                        </button>
                    </div>

                    <!-- Activity Card (Streak + Mini Heatmap) -->
                    <div class="stat-card activity-card" id="activity-overview-card">
                        <div class="stat-card-header">
                            <h3 class="stat-card-title">Activity</h3>
                            <span class="stat-card-icon">üìÖ</span>
                        </div>
                        <div id="overview-streak-container"></div>
                        <div id="overview-heatmap-container" style="margin-top: var(--space-3);"></div>
                    </div>
                </div>

                <!-- Areas to Focus -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">üéØ</span>
                            Focus Areas
                        </h2>
                    </div>
                    <div id="focus-areas">
                        <p class="empty-state-desc">Complete your first check-in to see your focus areas.</p>
                    </div>
                </div>
                
            </div>
            
            <!-- Learning Content Panel -->
            <div class="panel-content" id="learning-panel" role="tabpanel" aria-labelledby="learning-tab">
                
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">
                                <span class="card-title-icon">üìö</span>
                                <span id="topic-title">Learning Content</span>
                            </h2>
                            <p class="card-subtitle" id="curriculum-code">Select a topic to begin</p>
                        </div>
                        <div>
                            <button class="btn btn-secondary btn-sm" id="expand-all-btn">Expand All</button>
                            <button class="btn btn-secondary btn-sm" id="collapse-all-btn">Collapse All</button>
                        </div>
                    </div>
                    
                    <!-- Level Legend -->
                    <div class="level-legend" id="learning-level-legend">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <div id="topics-container">
                    <!-- Dynamically populated subtopics and learning items -->
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <div class="empty-state-title">No topic loaded</div>
                        <p class="empty-state-desc">Select a year level, subject, and topic from the dropdowns above to get started.</p>
                    </div>
                </div>
                
            </div>
            
            <!-- History Panel -->
            <div class="panel-content" id="history-panel" role="tabpanel" aria-labelledby="history-tab">
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">üìÖ</span>
                            Check-in History
                        </h2>
                    </div>
                    
                    <div class="checkin-timeline" id="checkin-timeline">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <div class="empty-state-title">No check-ins yet</div>
                            <p class="empty-state-desc">Start your first check-in to track your learning journey over time.</p>
                        </div>
                    </div>
                </div>

                <!-- Activity Visualizations Card -->
                <div class="card" id="history-activity-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">üìä</span>
                            Activity Overview
                        </h2>
                    </div>
                    <div id="history-calendar-container" style="margin-bottom: var(--space-4);"></div>
                    <div id="history-bargraph-container"></div>
                </div>

            </div>

            <!-- Goals Panel -->
            <div class="panel-content" id="goals-panel" role="tabpanel" aria-labelledby="goals-tab">
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">üéØ</span>
                            My Learning Goals
                        </h2>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="new-goal-input">Add a new goal</label>
                        <div class="notes-input-group">
                            <textarea id="new-goal-input" class="form-textarea" placeholder="What do you want to achieve? (e.g., 'I want to be confident in all plasma membrane concepts by Friday')" rows="2"></textarea>
                            <button class="btn btn-primary" id="add-goal-btn">Add Goal</button>
                        </div>
                    </div>
                    
                    <div id="goals-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">üéØ</div>
                            <div class="empty-state-title">No goals set</div>
                            <p class="empty-state-desc">Set goals to help focus your learning.</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">‚ùì</span>
                            Questions for My Teacher
                        </h2>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="new-question-input">Ask a question</label>
                        <div class="notes-input-group">
                            <textarea id="new-question-input" class="form-textarea" placeholder="What would you like to ask your teacher?" rows="2"></textarea>
                            <button class="btn btn-primary" id="add-question-btn">Add Question</button>
                        </div>
                    </div>
                    
                    <div id="questions-list">
                        <div class="empty-state">
                            <p class="empty-state-desc">No questions yet. If you're stuck, ask here.</p>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Export Panel -->
            <div class="panel-content" id="export-panel" role="tabpanel" aria-labelledby="export-tab">
                
                <!-- Help & Guide Section -->
                <div class="card utility-help-card">
                    <div class="utility-help-content">
                        <div class="utility-help-text">
                            <span class="utility-help-icon">üìñ</span>
                            <div>
                                <strong>Need help?</strong>
                                <span>View the welcome guide and learn how to use this app</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" id="show-welcome-btn">Show Welcome Guide</button>
                    </div>
                </div>
                
                <!-- Share Your Progress Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">üì§</span>
                            Share Your Progress
                        </h2>
                    </div>

                    <div class="export-grid">
                        <!-- Print Report -->
                        <div class="export-option">
                            <div class="export-option-icon">üìÑ</div>
                            <div class="export-option-content">
                                <h3 class="export-option-title">Print Report</h3>
                                <p class="export-option-desc">Generate a printable progress report for parents and teachers</p>
                            </div>
                            <button class="btn btn-primary" id="export-pdf-btn">Print Report</button>
                        </div>

                        <!-- Email Summary -->
                        <div class="export-option">
                            <div class="export-option-icon">‚úâÔ∏è</div>
                            <div class="export-option-content">
                                <h3 class="export-option-title">Email Summary</h3>
                                <p class="export-option-desc">Must include any questions for the teacher</p>
                            </div>
                            <div class="export-option-buttons">
                                <button class="btn btn-ghost" id="email-preview-btn">Preview</button>
                                <button class="btn btn-secondary" id="email-copy-btn">Copy</button>
                                <button class="btn btn-primary" id="email-send-btn">Email</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Management Section -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">üíæ</span>
                            Data Management
                        </h2>
                    </div>

                    <div class="export-grid">
                        <!-- Backup All Data -->
                        <div class="export-option">
                            <div class="export-option-icon">üíæ</div>
                            <div class="export-option-content">
                                <h3 class="export-option-title">Backup All Data</h3>
                                <p class="export-option-desc">Download all your learning data across all topics</p>
                            </div>
                            <button class="btn btn-primary" id="export-all-btn">Download Full Backup</button>
                        </div>

                        <!-- Restore All Data -->
                        <div class="export-option">
                            <div class="export-option-icon">üìÇ</div>
                            <div class="export-option-content">
                                <h3 class="export-option-title">Restore Data</h3>
                                <p class="export-option-desc">Restore your progress from a backup file</p>
                            </div>
                            <div class="export-option-buttons">
                                <input type="file" id="restore-file-input" accept=".json" style="display: none;">
                                <button class="btn btn-secondary" id="restore-browse-btn">Choose File...</button>
                            </div>
                        </div>
                    </div>

                    <!-- Restore Preview Panel (hidden by default) -->
                    <div class="restore-preview-panel" id="restore-preview-panel" style="display: none;">
                        <div class="restore-preview-header">
                            <h3>Restore Preview</h3>
                            <button class="restore-preview-close" id="restore-preview-close">√ó</button>
                        </div>
                        <div class="restore-preview-content" id="restore-preview-content">
                            <!-- Dynamically populated -->
                        </div>
                        <div class="restore-preview-warning" id="restore-preview-warning">
                            ‚ö†Ô∏è This will replace all current data
                        </div>
                        <div class="restore-preview-actions">
                            <button class="btn btn-ghost" id="restore-cancel-btn">Cancel</button>
                            <button class="btn btn-primary" id="restore-confirm-btn">Restore Data</button>
                        </div>
                    </div>
                </div>

                <!-- Email Preview Panel (hidden by default) -->
                <div class="email-preview-panel" id="email-preview-panel" style="display: none;">
                    <div class="email-preview-header">
                        <h3>Email Summary Preview</h3>
                        <button class="email-preview-close" id="email-preview-close">√ó</button>
                    </div>
                    <div class="email-subject-line">
                        <span class="email-subject-label">Subject:</span>
                        <span class="email-subject-text" id="email-subject-text">Learning Progress: Student - Topic - Date</span>
                    </div>
                    <div id="email-questions-banner">
                        <!-- Dynamically populated: prominent questions summary -->
                    </div>
                    <div class="email-preview-content" id="email-preview-content">
                        <!-- Dynamically populated -->
                    </div>
                    <div class="email-preview-hint">
                        üí° Tip: Teachers can extract the JSON block at the bottom for class-wide data aggregation
                    </div>
                    <div class="email-preview-actions">
                        <button class="btn btn-secondary" id="email-copy-json-btn">Copy JSON Only</button>
                        <button class="btn btn-secondary" id="email-copy-full-btn">Copy Full Summary</button>
                        <button class="btn btn-primary" id="email-open-btn">Open in Email App</button>
                    </div>
                </div>

                <!-- Data Summary Card -->
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h3 class="stat-card-title">Data Summary</h3>
                            <span class="stat-card-icon">üìä</span>
                        </div>
                        <div id="data-summary">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>
                
                <!-- Settings Section (moved here for simplicity) -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">‚öôÔ∏è</span>
                            Settings
                        </h2>
                    </div>

                    <!-- Messages Button -->
                    <button class="settings-messages-btn hidden" id="settings-messages-btn">
                        <span class="settings-messages-icon">üì¢</span>
                        <span>Messages &amp; Announcements</span>
                        <span class="settings-messages-badge hidden" id="settings-messages-badge">0</span>
                    </button>

                    <div class="settings-section">
                        <div class="settings-section-title">Your Details</div>
                        <div class="form-group">
                            <label class="form-label" for="student-name-input">Your Name</label>
                            <input type="text" id="student-name-input" class="form-input" placeholder="Enter your name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="class-input">Your Class</label>
                            <select id="class-input" class="form-input">
                                <option value="">-- Select your class --</option>
                                <option value="12BioTSH">12BioTSH</option>
                                <option value="12CheDMH">12CheDMH</option>
                                <option value="12PhyJIM">12PhyJIM</option>
                                <option value="12PhyEVA">12PhyEVA</option>
                                <option value="11PhyJIM">11PhyJIM</option>
                                <option value="11BioTSH">11BioTSH</option>
                                <option value="10SciJIM">10SciJIM</option>
                                <option value="10SciKLA">10SciKLA</option>
                                <option value="10SciDMH">10SciDMH</option>
                                <option value="08SciDMH">08SciDMH</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-title">Appearance</div>
                        <div class="settings-row">
                            <span class="settings-label">Dark Mode</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="dark-mode-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title">Check-in Behaviour</div>
                        <div class="settings-row">
                            <div class="settings-label-group">
                                <span class="settings-label">Skip Questions in Pre-Topic Check-in</span>
                                <span class="settings-hint">When enabled, you can set levels freely during pre-topic check-ins without answering questions</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="skip-pretopic-questions-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title">Level Indicators</div>
                        
                        <!-- Display Mode -->
                        <div class="settings-subsection">
                            <div class="settings-subsection-title">Display Mode</div>
                            <div class="level-display-options">
                                <label class="level-display-option active" data-mode="emoji">
                                    <input type="radio" name="level-display-mode" value="emoji" checked>
                                    <span>üå± Emoji Only</span>
                                </label>
                                <label class="level-display-option" data-mode="dots">
                                    <input type="radio" name="level-display-mode" value="dots">
                                    <span>‚óè Dots Only</span>
                                </label>
                                <label class="level-display-option" data-mode="both">
                                    <input type="radio" name="level-display-mode" value="both">
                                    <span>‚óè üå± Both</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Emoji Progression -->
                        <div class="settings-subsection">
                            <div class="settings-subsection-title">Emoji Style</div>
                            <select class="emoji-progression-select" id="emoji-progression-select">
                                <option value="0">üå± üåø üå≥ üå≤ ‚≠ê Growth</option>
                                <option value="1">üìñ ‚úèÔ∏è üìù üìö üéì Learning</option>
                                <option value="2">‚óã ‚óî ‚óë ‚óè ‚óè Fill Circles</option>
                                <option value="3">1Ô∏è‚É£ 2Ô∏è‚É£ 3Ô∏è‚É£ 4Ô∏è‚É£ 5Ô∏è‚É£ Numbers</option>
                                <option value="4">ü•â ü•à ü•á üèÜ üëë Achievement</option>
                                <option value="5">‚ùÑÔ∏è üåßÔ∏è ‚õÖ ‚òÄÔ∏è üåü Weather</option>
                            </select>
                        </div>
                        
                        <!-- Color Customization -->
                        <div class="settings-subsection">
                            <div class="settings-subsection-title">Level Colors</div>
                            <div class="level-colors-grid">
                                <div class="level-color-item">
                                    <input type="color" class="level-color-picker" id="level-color-1" value="#94a3b8">
                                    <span class="level-color-label">Not Started</span>
                                </div>
                                <div class="level-color-item">
                                    <input type="color" class="level-color-picker" id="level-color-2" value="#06b6d4">
                                    <span class="level-color-label">Beginning</span>
                                </div>
                                <div class="level-color-item">
                                    <input type="color" class="level-color-picker" id="level-color-3" value="#eab308">
                                    <span class="level-color-label">Developing</span>
                                </div>
                                <div class="level-color-item">
                                    <input type="color" class="level-color-picker" id="level-color-4" value="#22c55e">
                                    <span class="level-color-label">Confident</span>
                                </div>
                                <div class="level-color-item">
                                    <input type="color" class="level-color-picker" id="level-color-5" value="#8b5cf6">
                                    <span class="level-color-label">Secured</span>
                                </div>
                            </div>
                            <button class="reset-colors-btn" id="reset-colors-btn">‚Ü∫ Reset to Default Colors</button>
                        </div>
                        
                        <!-- Preview -->
                        <div class="settings-subsection">
                            <div class="settings-subsection-title">Preview</div>
                            <div class="level-preview" id="level-preview">
                                <!-- Filled dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title">Data Management</div>
                        
                        <!-- Clear Topic Progress -->
                        <div class="data-action-item" id="clear-topic-action">
                            <div class="data-action-main">
                                <button class="btn btn-secondary" id="clear-progress-btn">Clear Progress for Current Topic</button>
                            </div>
                            <div class="data-action-confirm" id="clear-topic-confirm">
                                <span class="confirm-message">Clear all progress for this topic?</span>
                                <div class="confirm-buttons">
                                    <button class="btn btn-small btn-ghost" id="clear-topic-cancel">Cancel</button>
                                    <button class="btn btn-small btn-danger" id="clear-topic-delete">Delete</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Clear All Data -->
                        <div class="data-action-item" id="clear-all-action">
                            <div class="data-action-main">
                                <button class="btn btn-secondary" id="clear-all-btn" style="color: var(--color-error);">Clear All Data</button>
                            </div>
                            <div class="data-action-confirm" id="clear-all-confirm">
                                <span class="confirm-message confirm-danger">Delete ALL data including progress, goals, and settings?</span>
                                <div class="confirm-buttons">
                                    <button class="btn btn-small btn-ghost" id="clear-all-cancel">Cancel</button>
                                    <button class="btn btn-small btn-danger" id="clear-all-delete">Delete Everything</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            
        </main>
        
        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-indicator">
                <span id="save-status">All changes saved</span>
            </div>
            <div>
                <span id="version-display">v2.0.0</span>
            </div>
        </footer>
        
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Quiz Modal Overlay -->
    <div class="quiz-overlay" id="quiz-overlay">
        <div class="quiz-modal" role="dialog" aria-labelledby="quiz-header-title" aria-modal="true">
            <div class="quiz-header">
                <h2 class="quiz-header-title" id="quiz-header-title">
                    <span>üß†</span> Quick Check
                </h2>
                <button class="quiz-close-btn" id="quiz-cancel-btn" aria-label="Close quiz">√ó</button>
            </div>
            <div class="quiz-body">
                <div class="quiz-context">
                    <div class="quiz-item-title" id="quiz-item-title">Learning point title</div>
                    <div class="quiz-level-transition">
                        <span id="quiz-from-level">üå± Not started</span>
                        <span class="quiz-level-arrow">‚Üí</span>
                        <span id="quiz-to-level">üåø Beginning</span>
                    </div>
                </div>
                
                <div class="quiz-streak-info" id="quiz-streak-info" style="display: none;">
                    <div class="quiz-streak-text" id="quiz-streak-text">You need 2 correct answers to advance</div>
                    <div class="quiz-streak-progress" id="quiz-streak-progress">
                        <!-- Filled dynamically -->
                    </div>
                </div>
                
                <div class="quiz-question">
                    <p class="quiz-question-text" id="quiz-question-text">Question text goes here</p>
                </div>
                
                <!-- For MC questions -->
                <div class="quiz-options" id="quiz-options">
                    <!-- Dynamically populated -->
                </div>
                
                <!-- For Cloze questions -->
                <div class="cloze-sentence" id="cloze-sentence" style="display: none;">
                    <!-- Dynamically populated with inline selects -->
                </div>
                
                <div class="quiz-result" id="quiz-result">
                    <div class="quiz-result-header">
                        <span class="quiz-result-icon" id="quiz-result-icon">‚úî</span>
                        <span class="quiz-result-text" id="quiz-result-text">Correct</span>
                    </div>
                    <p class="quiz-result-explanation" id="quiz-result-explanation">Explanation text</p>
                </div>
                
                <!-- Cloze feedback area -->
                <div class="cloze-feedback" id="cloze-feedback" style="display: none;">
                    <!-- Dynamically populated -->
                </div>
            </div>
            <div class="quiz-footer">
                <button class="btn btn-secondary" id="quiz-cancel-btn-footer">Cancel</button>
                <button class="btn btn-primary" id="quiz-submit-btn" disabled>Check Answer</button>
            </div>
        </div>
    </div>
    
    <!-- Check-in Mode Floating Bar -->
    <div class="checkin-floating-bar" id="checkin-floating-bar">
        <span class="checkin-floating-icon">üìã</span>
        <span class="checkin-floating-text" id="checkin-floating-type">Check-in Mode</span>
        <span class="checkin-floating-progress" id="checkin-floating-progress">0/0 reviewed</span>
        <span class="checkin-floating-timer" id="checkin-floating-timer">10:00</span>
        <button class="checkin-floating-stop" id="checkin-floating-stop">Stop</button>
    </div>
    
    <!-- Check-in Start Modal -->
    <div class="quiz-overlay" id="checkin-start-overlay">
        <div class="quiz-modal">
            <div class="quiz-header">
                <h2 class="quiz-header-title">
                    <span>üìã</span> Start Check-in
                </h2>
                <button class="quiz-close-btn" id="checkin-start-cancel">√ó</button>
            </div>
            <div class="quiz-body">
                <p style="margin-bottom: var(--space-4); color: var(--color-text-secondary);">
                    Choose the type of check-in you want to do:
                </p>
                
                <div class="checkin-type-grid" id="checkin-type-grid">
                    <button class="checkin-type-btn active" data-type="pre">
                        <span class="checkin-type-icon">üåÖ</span>
                        <span class="checkin-type-name">Pre-Topic</span>
                        <span class="checkin-type-desc">Before starting a new topic</span>
                    </button>
                    <button class="checkin-type-btn" data-type="weekly">
                        <span class="checkin-type-icon">üì†</span>
                        <span class="checkin-type-name">Weekly</span>
                        <span class="checkin-type-desc">Regular weekly review</span>
                    </button>
                    <button class="checkin-type-btn" data-type="revision">
                        <span class="checkin-type-icon">üìñ</span>
                        <span class="checkin-type-name">Revision</span>
                        <span class="checkin-type-desc">Before a test or exam</span>
                    </button>
                    <button class="checkin-type-btn" data-type="post">
                        <span class="checkin-type-icon">‚úÖ</span>
                        <span class="checkin-type-name">Post-Test</span>
                        <span class="checkin-type-desc">After completing assessment</span>
                    </button>
                </div>
                
                <div class="checkin-instructions" style="margin-top: var(--space-3);">
                    <p><strong>Instructions:</strong></p>
                    <p>‚Ä¢ Go through each learning point and rate your understanding</p>
                    <p>‚Ä¢ Be honest - this helps identify where to focus</p>
                    <p>‚Ä¢ You have 10 minutes to complete the check-in</p>
                </div>
            </div>
            <div class="quiz-footer">
                <button class="btn btn-secondary" id="checkin-start-cancel-btn">Cancel</button>
                <button class="btn btn-primary" id="checkin-start-confirm-btn">Start Check-in</button>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner-large"></div>
        <div class="loading-text" id="loading-text">Loading topic...</div>
    </div>

    <!-- Post Check-in Modal -->
    <div class="quiz-overlay" id="post-checkin-overlay">
        <div class="quiz-modal post-checkin-modal">
            <div class="quiz-header">
                <h2 class="quiz-header-title">
                    <span>‚úì</span> Check-in Complete
                </h2>
            </div>
            <div class="quiz-body" style="text-align: center;">
                <p class="post-checkin-summary">
                    You reviewed <strong id="post-checkin-reviewed">0</strong> of <strong id="post-checkin-total">0</strong> items.
                </p>
                <p id="post-checkin-message" style="color: var(--color-text-secondary); margin-top: var(--space-3);"></p>
            </div>
            <div class="quiz-footer" style="justify-content: center; gap: var(--space-4);">
                <button class="btn btn-primary" id="post-checkin-view-gc-btn">
                    üìà View Your Growth Character
                </button>
                <button class="btn btn-secondary" id="post-checkin-done-btn">Done</button>
            </div>
        </div>
    </div>

    <!-- Growth Character Modal -->
    <div class="quiz-overlay" id="growth-character-overlay">
        <div class="quiz-modal growth-character-modal">
            <div class="quiz-header">
                <h2 class="quiz-header-title">
                    <span>üìà</span> Your Growth Character
                </h2>
                <button class="quiz-close-btn" id="gc-close-btn" aria-label="Close">√ó</button>
            </div>
            <div class="quiz-body gc-body">
                <div class="gc-date-type">
                    <span id="gc-checkin-type">Weekly Check-in</span>
                    <span id="gc-date">24 January 2026</span>
                </div>

                <div class="gc-progress-section">
                    <div class="gc-progress-header">Your Journey</div>
                    <div class="gc-progress-bar-container">
                        <div class="gc-progress-bar">
                            <div class="gc-progress-start" id="gc-progress-start"></div>
                            <div class="gc-progress-current" id="gc-progress-current"></div>
                        </div>
                        <div class="gc-progress-labels">
                            <span id="gc-start-percent">38%</span>
                            <span class="gc-progress-arrow">‚Üí</span>
                            <span id="gc-current-percent">83%</span>
                        </div>
                    </div>
                </div>

                <div class="gc-narrative-section">
                    <p id="gc-narrative" class="gc-narrative-text"></p>
                </div>

                <div class="gc-qualities-section">
                    <div class="gc-qualities-header">Learning Qualities</div>
                    <div class="gc-qualities-grid" id="gc-qualities-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="gc-comparison-section" id="gc-comparison-section" style="display: none;">
                    <div class="gc-comparison-header">Since Last Check-in</div>
                    <p id="gc-comparison-text" class="gc-comparison-text"></p>
                </div>

                <div class="gc-stats-section">
                    <div class="gc-stat">
                        <span class="gc-stat-value" id="gc-secured-count">0</span>
                        <span class="gc-stat-label">Secured</span>
                    </div>
                    <div class="gc-stat">
                        <span class="gc-stat-value" id="gc-active-days">0</span>
                        <span class="gc-stat-label">Active Days</span>
                    </div>
                    <div class="gc-stat">
                        <span class="gc-stat-value" id="gc-consolidated-count">0</span>
                        <span class="gc-stat-label">Consolidated</span>
                    </div>
                </div>

                <!-- Activity Section (Streak + Heatmap) -->
                <div style="margin-top: var(--space-4);">
                    <div id="gc-streak-container"></div>
                    <div id="gc-heatmap-container" style="margin-top: var(--space-3);"></div>
                </div>
            </div>
            <div class="quiz-footer">
                <button class="btn btn-secondary" id="gc-history-btn">View History</button>
                <button class="btn btn-primary" id="gc-done-btn">Done</button>
            </div>
        </div>
    </div>

    <!-- Text Selection Popup -->
    <div class="selection-popup" id="selection-popup">
        <button class="selection-popup-btn teacher" id="popup-teacher-btn">
            <span class="popup-icon">‚úâ</span>
            <span class="popup-label">Ask my teacher</span>
        </button>
        <button class="selection-popup-btn google" id="popup-google-btn">
            <span class="popup-icon">üß†</span>
            <span class="popup-label">Search Google</span>
        </button>
        <button class="selection-popup-btn chatgpt" id="popup-chatgpt-btn">
            <span class="popup-icon">ü§ñ</span>
            <span class="popup-label">Ask ChatGPT</span>
        </button>
    </div>

    <!-- Messages Dialog -->
    <div class="messages-overlay" id="messages-overlay">
        <div class="messages-dialog" role="dialog" aria-labelledby="messages-dialog-title" aria-modal="true">
            <div class="messages-dialog-header">
                <h2 class="messages-dialog-title" id="messages-dialog-title">
                    <span>üì¢</span> Messages
                </h2>
                <button class="messages-close-btn" id="messages-close-btn" aria-label="Close messages">&times;</button>
            </div>
            <div class="messages-content">
                <div class="messages-list-panel">
                    <div class="messages-list" id="messages-list">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                <div class="messages-detail-panel" id="messages-detail-panel">
                    <div class="message-detail-empty" id="message-detail-empty">
                        <span class="message-detail-empty-icon">üì¨</span>
                        <span class="message-detail-empty-text">Select a message to view</span>
                    </div>
                    <div class="message-detail-header" id="message-detail-header" style="display: none;">
                        <h3 class="message-detail-title" id="message-detail-title"></h3>
                        <div class="message-detail-meta">
                            <span class="message-detail-type" id="message-detail-type"></span>
                            <span id="message-detail-date"></span>
                        </div>
                    </div>
                    <div class="message-detail-body" id="message-detail-body" style="display: none;">
                        <div class="message-detail-content" id="message-detail-content"></div>
                    </div>
                </div>
            </div>
            <div class="messages-dialog-footer">
                <button class="btn btn-secondary btn-sm" id="mark-all-read-btn">Mark All Read</button>
            </div>
        </div>
    </div>

    <!-- Welcome Dialog (First Run) -->
    <div class="welcome-overlay" id="welcome-overlay">
        <div class="welcome-dialog" role="dialog" aria-labelledby="welcome-title" aria-modal="true">
            
            <!-- Page 1: Welcome -->
            <div class="welcome-page active" id="welcome-page-1">
                <div class="welcome-header">
                    <span class="welcome-icon">üìö</span>
                    <h2 class="welcome-title" id="welcome-title">Welcome to Your Learning Check List</h2>
                </div>
                <div class="welcome-body">
                    <p class="welcome-intro">This app helps you track your understanding of each topic as you learn. It is designed to support your learning journey, not to test you.</p>
                    
                    <!-- User Info Section -->
                    <div class="welcome-user-info">
                        <div class="welcome-form-group">
                            <label class="welcome-form-label" for="welcome-name-input">Your name</label>
                            <input type="text" id="welcome-name-input" class="welcome-form-input" placeholder="Enter your name">
                        </div>
                        <div class="welcome-form-group">
                            <label class="welcome-form-label" for="welcome-class-input">Your class</label>
                            <select id="welcome-class-input" class="welcome-form-input">
                                <option value="">-- Select your class --</option>
                                <option value="12BioTSH">12BioTSH</option>
                                <option value="12CheDMH">12CheDMH</option>
                                <option value="12PhyJIM">12PhyJIM</option>
                                <option value="12PhyEVA">12PhyEVA</option>
                                <option value="11PhyJIM">11PhyJIM</option>
                                <option value="11BioTSH">11BioTSH</option>
                                <option value="10SciJIM">10SciJIM</option>
                                <option value="10SciKLA">10SciKLA</option>
                                <option value="10SciDMH">10SciDMH</option>
                                <option value="08SciDMH">08SciDMH</option>
                            </select>
                        </div>
                    </div>

                    <div class="welcome-features">
                        <div class="welcome-feature">
                            <span class="welcome-feature-icon">üéØ</span>
                            <div class="welcome-feature-text">
                                <strong>Rate your understanding</strong>
                                <span>For each learning point, select the level that best describes where you are right now. Be honest with yourself - this is for your benefit.</span>
                            </div>
                        </div>
                        <div class="welcome-feature">
                            <span class="welcome-feature-icon">üìã</span>
                            <div class="welcome-feature-text">
                                <strong>Regular check-ins</strong>
                                <span>Use check-ins to review your progress over time. You can do a pre-topic check-in before starting, and weekly reviews as you learn.</span>
                            </div>
                        </div>
                        <div class="welcome-feature">
                            <span class="welcome-feature-icon">üìñ</span>
                            <div class="welcome-feature-text">
                                <strong>What, Why, Example</strong>
                                <span>Click these buttons on any learning point to see explanations that help you understand the content better.</span>
                            </div>
                        </div>
                        <div class="welcome-feature">
                            <span class="welcome-feature-icon">üéì</span>
                            <div class="welcome-feature-text">
                                <strong>Quick checks</strong>
                                <span>When you move to a higher level, you will be asked a quick question to confirm your understanding. This helps ensure your self-assessment is accurate.</span>
                            </div>
                        </div>
                    </div>
                    
                    <p class="welcome-footer-text">Your progress is saved automatically and stays private on your device.</p>
                </div>
                <div class="welcome-footer">
                    <button class="btn btn-ghost" id="welcome-skip-btn">Skip</button>
                    <button class="btn btn-primary" id="welcome-next-btn">Show Me How ‚Üí</button>
                </div>
            </div>
            
            <!-- Page 2: Tutorial -->
            <div class="welcome-page" id="welcome-page-2">
                <div class="welcome-header">
                    <span class="welcome-icon">üéì</span>
                    <h2 class="welcome-title">Quick Tour</h2>
                </div>
                <div class="welcome-body">
                    <div class="tutorial-steps">
                        <div class="tutorial-step">
                            <div class="tutorial-step-number">1</div>
                            <div class="tutorial-step-content">
                                <strong>Select your topic</strong>
                                <p>Use the dropdowns at the top to choose your year level, subject, and topic. The content will load automatically.</p>
                            </div>
                        </div>
                        
                        <div class="tutorial-step">
                            <div class="tutorial-step-number">2</div>
                            <div class="tutorial-step-content">
                                <strong>Rate each learning point</strong>
                                <p>Click the level buttons to indicate your understanding. The levels go from "Not started" through to "Secured".</p>
                                <div class="tutorial-demo">
                                    <span class="tutorial-demo-level">üå±</span>
                                    <span class="tutorial-demo-level">üåø</span>
                                    <span class="tutorial-demo-level">üå≥</span>
                                    <span class="tutorial-demo-level">üå≤</span>
                                    <span class="tutorial-demo-level">‚≠ê</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tutorial-step">
                            <div class="tutorial-step-number">3</div>
                            <div class="tutorial-step-content">
                                <strong>Start a check-in</strong>
                                <p>Click the "Check In" button to begin a timed review session. This helps you track progress over time.</p>
                            </div>
                        </div>
                        
                        <div class="tutorial-step">
                            <div class="tutorial-step-number">4</div>
                            <div class="tutorial-step-content">
                                <strong>Select text to get help</strong>
                                <p>Highlight any text in the learning content to quickly search Google, ask AI, or note it for your teacher.</p>
                            </div>
                        </div>
                        
                        <div class="tutorial-step">
                            <div class="tutorial-step-number">5</div>
                            <div class="tutorial-step-content">
                                <strong>Explore the tabs</strong>
                                <p>Use the tabs to view your overview, learning content, history, goals, and settings.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="welcome-footer">
                    <button class="btn btn-ghost" id="welcome-back-btn">‚Üê Back</button>
                    <button class="btn btn-primary" id="welcome-next-2-btn">More Features ‚Üí</button>
                </div>
            </div>

            <!-- Page 3: Analytics & Export -->
            <div class="welcome-page" id="welcome-page-3">
                <div class="welcome-header">
                    <span class="welcome-icon">üìä</span>
                    <h2 class="welcome-title">Tracking and Sharing</h2>
                </div>
                <div class="welcome-body">
                    <div class="welcome-features">
                        <div class="welcome-feature">
                            <span class="welcome-feature-icon">üìà</span>
                            <div class="welcome-feature-text">
                                <strong>Learning Character</strong>
                                <span>After each check-in, the app analyses your learning patterns and generates a Learning Character. This shows qualities like momentum, persistence, and study habits - not just what you know, but how you learn.</span>
                            </div>
                        </div>
                        <div class="welcome-feature">
                            <span class="welcome-feature-icon">üìä</span>
                            <div class="welcome-feature-text">
                                <strong>Overview Dashboard</strong>
                                <span>The Overview tab shows your overall progress, level distribution, current streak, and your latest Learning Character. Use it to get a quick picture of where you stand.</span>
                            </div>
                        </div>
                        <div class="welcome-feature">
                            <span class="welcome-feature-icon">üìÑ</span>
                            <div class="welcome-feature-text">
                                <strong>Print Report</strong>
                                <span>Generate a printable progress report to share with parents or teachers. It includes your progress, Learning Character, and areas to focus on.</span>
                            </div>
                        </div>
                        <div class="welcome-feature">
                            <span class="welcome-feature-icon">‚úâÔ∏è</span>
                            <div class="welcome-feature-text">
                                <strong>Email Summary</strong>
                                <span>Send a structured summary to your teacher. The email includes data they can use to track your progress.</span>
                            </div>
                        </div>
                        <div class="welcome-feature">
                            <span class="welcome-feature-icon">üíæ</span>
                            <div class="welcome-feature-text">
                                <strong>Backup and Restore</strong>
                                <span>Your data stays on your device. Use the backup feature to save your progress to a file, and restore it if you change devices or clear your browser data.</span>
                            </div>
                        </div>
                    </div>

                    <p class="welcome-footer-text">Find all these features in the Utility tab (the cog icon).</p>
                </div>
                <div class="welcome-footer">
                    <button class="btn btn-ghost" id="welcome-back-2-btn">‚Üê Back</button>
                    <button class="btn btn-primary" id="welcome-start-btn">Get Started</button>
                </div>
            </div>

        </div>
    </div>

    <script>
// ============================================
// CONSTANTS
// ============================================
const STORAGE_KEY = 'dynamicLearningCheckin_v2';
const PROGRESS_STORE_KEY = 'learning-checkin-progress-store';
const QUIZ_STATE_KEY = 'learning-checkin-quiz-state';
const DROPDOWN_SELECTION_KEY = 'learning-checkin-dropdown-selection';
const TOPIC_AVAILABILITY_KEY = 'learning-checkin-topic-availability';
const LEVEL_PREFS_KEY = 'learning-checkin-level-prefs';
const FIRST_RUN_KEY = 'learning-checkin-first-run-complete';
const SELECTION_TIP_KEY = 'learning-checkin-selection-tip-shown';
const MESSAGES_READ_KEY = 'learning-checkin-messages-read';
const QUIZ_LOCKOUT_DURATION = 5 * 60 * 1000; // 5 minutes
const AVAILABILITY_CACHE_DURATION = 60 * 60 * 1000; // 1 hour
const SELECTION_TIP_DELAY = 3 * 60 * 1000; // 3 minutes

const levelNames = ['Not started', 'Beginning', 'Developing', 'Confident', 'Secured'];

// Emoji progression options
const emojiProgressions = [
    ['üå±', 'üåø', 'üå≥', 'üå≤', '‚≠ê'],  // Growth
    ['üìñ', '‚úèÔ∏è', 'üìù', 'üìö', 'üéì'],  // Learning
    ['‚óã', '‚óî', '‚óë', '‚óï', '‚óè'],      // Fill circles
    ['1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£'],  // Numbers
    ['ü•â', 'ü•à', 'ü•á', 'üèÜ', 'üëë'],  // Achievement
    ['‚ùÑÔ∏è', 'üåßÔ∏è', '‚õÖ', '‚òÄÔ∏è', 'üåü']   // Weather
];

// Default colors (cyan for level 2)
const defaultLevelColors = ['#94a3b8', '#06b6d4', '#eab308', '#22c55e', '#8b5cf6'];

// Level display preferences (loaded from localStorage)
let levelPrefs = {
    displayMode: 'emoji',  // 'emoji', 'dots', 'both'
    emojiProgression: 0,   // index into emojiProgressions
    colors: [...defaultLevelColors]
};

// Dynamic getter for current emojis based on selected progression
function getLevelEmojis() {
    return emojiProgressions[levelPrefs.emojiProgression] || emojiProgressions[0];
}

// For backwards compatibility - will be replaced by getLevelEmojis() calls
let levelEmojis = emojiProgressions[0];

const checkinTypeLabels = {
    pre: 'Pre-Topic',
    weekly: 'Weekly',
    revision: 'Revision',
    post: 'Post-Test'
};

// ============================================
// STATE MANAGEMENT
// ============================================
let appState = {
    student: {
        name: '',
        class: ''
    },
    topic: null,
    currentTopicId: null,
    currentTopicPath: null, // Store the base path for loading subtopics/questions
    learningItems: {},
    checkins: [],
    goals: [],
    questions: [],
    theme: 'light',
    skipPreTopicQuestions: false, // When true, skip quizzes during pre-topic check-ins
    lastSaved: null,

    // Growth Character System - Session tracking
    sessions: [],              // Array of session records

    // Growth Character System - Practice calendar (keyed by YYYYMMDD)
    practiceCalendar: {},

    // Growth Character System - Per-LP, per-question stats
    quizStats: {},

    // Growth Character System - Generated Growth Characters
    growthCharacters: []
};

// Manifest data (loaded from manifest.json)
let manifest = null;

// Topic availability cache: { path: { available: bool, checkedAt: timestamp } }
let topicAvailabilityCache = {};

// Per-topic progress storage
let topicProgressStore = {};

// Currently selected dropdown values
let selectedYearLevel = null;
let selectedSubject = null;

// Quiz state
let quizState = {};
let currentQuiz = null;

// Questions cache - keyed by item UUID
let questionsCache = {};

// Check-in mode state
let checkinModeActive = false;
let currentCheckinType = 'weekly';
let checkinStartLevels = {};
let checkinReviewedItems = new Set();
let checkinTimer = null;
let checkinStartTime = null;
let checkinDurationMs = null;  // Dynamic duration based on LP count

// Check-in duration constants
const CHECKIN_MIN_MINUTES = 5;      // Minimum 5 minutes
const CHECKIN_MAX_MINUTES = 30;     // Maximum 30 minutes
const CHECKIN_MINUTES_PER_LP = 2;   // ~2 minutes per learning point

// Text selection popup
let selectionPopup = null;
let selectionTimeout = null;

// Session tracking for Growth Character System
let currentSession = null;
let lastInteractionTime = null;
let sessionIdleTimeout = null;
const SESSION_IDLE_THRESHOLD_MS = 60000;  // 60 seconds idle = pause active time

// Activity flags for session tracking (bitmask)
const ACTIVITY = {
    QUIZ: 1,
    CONTENT: 2,
    SEARCH: 4,
    QUESTION: 8
};

// ============================================
// STORAGE FUNCTIONS
// ============================================
function saveData() {
    appState.lastSaved = new Date().toISOString();
    try {
        // Save current topic's progress to the per-topic store (use path as unique key)
        if (appState.currentTopicPath) {
            topicProgressStore[appState.currentTopicPath] = {
                learningItems: appState.learningItems,
                checkins: appState.checkins,
                goals: appState.goals,
                questions: appState.questions,
                // Growth Character System data (per-topic)
                sessions: appState.sessions,
                practiceCalendar: appState.practiceCalendar,
                quizStats: appState.quizStats,
                growthCharacters: appState.growthCharacters
            };
        }

        // Save app state
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            student: appState.student,
            currentTopicId: appState.currentTopicId,
            currentTopicPath: appState.currentTopicPath,
            topic: appState.topic,
            learningItems: appState.learningItems,
            checkins: appState.checkins,
            goals: appState.goals,
            questions: appState.questions,
            theme: appState.theme,
            lastSaved: appState.lastSaved,
            // Growth Character System data
            sessions: appState.sessions,
            practiceCalendar: appState.practiceCalendar,
            quizStats: appState.quizStats,
            growthCharacters: appState.growthCharacters
        }));
        
        // Save per-topic progress store
        localStorage.setItem(PROGRESS_STORE_KEY, JSON.stringify(topicProgressStore));
        
        updateSaveStatus();
    } catch (e) {
        console.error('Save failed:', e);
        showToast('Failed to save changes', 'error');
    }
}

// ============================================
// GOOGLE SHEETS PUSH (Progress Reporting)
// ============================================
const PROGRESS_API_URL = 'https://script.google.com/macros/s/AKfycbyscvAfbJUR_t6p5W-u6A5SE_QvjntWt6ihg03Oc-uODwcP9WGjEOA2obh6rZ6OQG9G4g/exec';

function pushProgressToServer(eventType, detail) {
    const classCode = appState.student.class;
    if (!classCode) return; // Don't push if no class selected

    const payload = {
        classCode: classCode,
        studentId: appState.student.name || 'anonymous',
        topicCode: appState.topic?.name || appState.currentTopicId || '',
        eventType: eventType,
        learningPointCode: detail.learningPointCode || '',
        currentLevel: detail.currentLevel || '',
        quizResults: detail.quizResults || {},
        qualities: detail.qualities || {},
        overallPercent: detail.overallPercent || 0
    };

    try {
        fetch(PROGRESS_API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).catch(err => console.warn('Progress push failed:', err));
    } catch (e) {
        console.warn('Progress push failed:', e);
    }
}

// ============================================
// CLASS CODE BADGE & SMART CLASS SELECTION
// ============================================

// Lookup table: manifest yearLevel/subject ‚Üí possible class codes
// Key format: "yearLevelId/subjectId" matching manifest structure
const CLASS_CODE_LOOKUP = {
    'year10/science':    ['10SciJIM', '10SciKLA', '10SciDMH'],
    'vce-unit1/physics': ['11PhyJIM'],
    'vce-unit1/biology': ['11BioTSH'],
    'vce-unit3/biology': ['12BioTSH'],
    // Future topics ‚Äî ready when content is added
    'year8/science':     ['08SciDMH'],
    'vce-unit3/physics': ['12PhyJIM', '12PhyEVA'],
    'vce-unit3/chemistry': ['12CheDMH']
};

function updateClassBadge() {
    const badge = document.getElementById('class-badge-display');
    if (!badge) return;
    const code = appState.student.class;
    badge.textContent = code || 'No class';
    badge.style.background = code ? 'var(--color-primary-pale)' : 'var(--color-warning)';
    badge.style.color = code ? 'var(--color-primary)' : 'white';
    badge.style.borderColor = code ? 'var(--color-primary)' : 'var(--color-warning)';
}

function getSelectedYearSubjectKey() {
    const yearDropdown = document.getElementById('year-level-dropdown');
    const subjectDropdown = document.getElementById('subject-dropdown');
    if (!yearDropdown?.value || !subjectDropdown?.value) return null;
    return yearDropdown.value + '/' + subjectDropdown.value;
}

function checkClassForTopic() {
    const key = getSelectedYearSubjectKey();
    if (!key) return;

    const validCodes = CLASS_CODE_LOOKUP[key];
    if (!validCodes || validCodes.length === 0) {
        // No class codes mapped for this year/subject ‚Äî no action needed
        return;
    }

    const currentClass = appState.student.class;

    // If current class is already valid for this topic, do nothing
    if (currentClass && validCodes.includes(currentClass)) return;

    if (validCodes.length === 1) {
        // Only one possible class ‚Äî auto-select it
        setClassCode(validCodes[0]);
        showToast(`Class set to ${validCodes[0]}`, 'success');
    } else {
        // Multiple teachers ‚Äî show picker with only the valid options
        showClassPickerModal(validCodes);
    }
}

function setClassCode(code) {
    appState.student.class = code;
    const settingsInput = document.getElementById('class-input');
    if (settingsInput) settingsInput.value = code;
    saveData();
    updateClassBadge();
}

function showClassPickerModal(validCodes) {
    const overlay = document.getElementById('class-mismatch-overlay');
    const msgEl = document.getElementById('class-mismatch-message');
    const selectEl = document.getElementById('class-mismatch-select');
    if (!overlay || !msgEl || !selectEl) return;

    msgEl.textContent = 'Multiple teachers available for this topic. Please select your class:';

    // Populate dropdown with only valid codes
    selectEl.innerHTML = '<option value="">-- Select your class --</option>';
    validCodes.forEach(code => {
        const opt = document.createElement('option');
        opt.value = code;
        opt.textContent = code;
        selectEl.appendChild(opt);
    });

    // Pre-select current class if it's in the list
    if (appState.student.class && validCodes.includes(appState.student.class)) {
        selectEl.value = appState.student.class;
    }

    overlay.style.display = 'flex';
}

function showClassMismatchModal(message) {
    const overlay = document.getElementById('class-mismatch-overlay');
    const msgEl = document.getElementById('class-mismatch-message');
    const selectEl = document.getElementById('class-mismatch-select');
    if (!overlay || !msgEl || !selectEl) return;

    msgEl.textContent = message;

    // Restore full dropdown options
    selectEl.innerHTML = `
        <option value="">-- Select your class --</option>
        <option value="12BioTSH">12BioTSH</option>
        <option value="12CheDMH">12CheDMH</option>
        <option value="12PhyJIM">12PhyJIM</option>
        <option value="12PhyEVA">12PhyEVA</option>
        <option value="11PhyJIM">11PhyJIM</option>
        <option value="11BioTSH">11BioTSH</option>
        <option value="10SciJIM">10SciJIM</option>
        <option value="10SciKLA">10SciKLA</option>
        <option value="10SciDMH">10SciDMH</option>
        <option value="08SciDMH">08SciDMH</option>
    `;
    selectEl.value = appState.student.class || '';
    overlay.style.display = 'flex';
}

function hideClassMismatchModal() {
    const overlay = document.getElementById('class-mismatch-overlay');
    if (overlay) overlay.style.display = 'none';
}

function confirmClassMismatch() {
    const selectEl = document.getElementById('class-mismatch-select');
    const newClass = selectEl ? selectEl.value : '';
    if (newClass) {
        setClassCode(newClass);
        showToast(`Class updated to ${newClass}`, 'success');
    }
    hideClassMismatchModal();
}

function loadData() {
    try {
        // Load per-topic progress store
        const progressStore = localStorage.getItem(PROGRESS_STORE_KEY);
        if (progressStore) {
            topicProgressStore = JSON.parse(progressStore);
        }
        
        // Load app state
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            appState.student = parsed.student || appState.student;
            appState.currentTopicId = parsed.currentTopicId || null;
            appState.currentTopicPath = parsed.currentTopicPath || null;
            appState.topic = parsed.topic || null;
            appState.learningItems = parsed.learningItems || {};
            appState.checkins = parsed.checkins || [];
            appState.goals = parsed.goals || [];
            appState.questions = parsed.questions || [];
            appState.theme = parsed.theme || 'light';

            // Growth Character System data (with migration for existing users)
            appState.sessions = parsed.sessions || [];
            appState.practiceCalendar = parsed.practiceCalendar || {};
            appState.quizStats = parsed.quizStats || {};
            appState.growthCharacters = parsed.growthCharacters || [];

            if (appState.theme) applyTheme(appState.theme);
        }
    } catch (e) {
        console.error('Load failed:', e);
    }

    // Initialize learning items for current topic
    initLearningItems();
}

function initLearningItems() {
    if (!appState.topic || !appState.topic.subtopics) return;
    
    appState.topic.subtopics.forEach(subtopic => {
        if (subtopic.items) {
            subtopic.items.forEach(item => {
                const itemKey = getItemKey(subtopic.id, item.id);
                if (!appState.learningItems[itemKey]) {
                    appState.learningItems[itemKey] = {
                        level: 1,
                        history: [],
                        notes: []
                    };
                }
            });
        }
    });
}

function updateSaveStatus() {
    const el = document.getElementById('save-status');
    if (el) el.textContent = 'All changes saved';
}

// ============================================
// SESSION TRACKING (Growth Character System)
// ============================================

/**
 * Generate a UUID v4
 */
function generateSessionId() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

/**
 * Format a date as YYYYMMDD for practice calendar keys
 */
function formatDateKey(date) {
    const d = date || new Date();
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}${month}${day}`;
}

/**
 * Start a new session
 */
function startSession() {
    if (currentSession) return; // Already have an active session

    currentSession = {
        id: generateSessionId(),
        start: Date.now(),
        end: null,
        activeMs: 0,
        activities: 0
    };
    lastInteractionTime = Date.now();

    // Set up idle timeout
    resetIdleTimeout();
}

/**
 * Reset the idle timeout
 */
function resetIdleTimeout() {
    if (sessionIdleTimeout) {
        clearTimeout(sessionIdleTimeout);
    }
    sessionIdleTimeout = setTimeout(endSession, SESSION_IDLE_THRESHOLD_MS);
}

/**
 * Track a user interaction and accumulate active time
 * @param {number} activityType - Optional activity flag (ACTIVITY.QUIZ, etc.)
 */
function trackInteraction(activityType) {
    // Start session if not already active
    if (!currentSession) {
        startSession();
        return; // First interaction just starts the session
    }

    const now = Date.now();
    const gap = now - lastInteractionTime;

    // Only count time if gap < idle threshold (user was active)
    if (gap < SESSION_IDLE_THRESHOLD_MS) {
        currentSession.activeMs += gap;
    }

    lastInteractionTime = now;

    // Set activity flag if provided
    if (activityType) {
        currentSession.activities |= activityType;
    }

    // Reset idle timeout
    resetIdleTimeout();
}

/**
 * End the current session and save it
 */
function endSession() {
    if (!currentSession) return;

    // Clear idle timeout
    if (sessionIdleTimeout) {
        clearTimeout(sessionIdleTimeout);
        sessionIdleTimeout = null;
    }

    // Finalize session
    currentSession.end = Date.now();

    // Only save if there was meaningful activity (at least 5 seconds)
    if (currentSession.activeMs >= 5000) {
        appState.sessions.push(currentSession);
        updatePracticeCalendar(currentSession);
        saveData();
    }

    // Reset
    currentSession = null;
    lastInteractionTime = null;
}

/**
 * Update the practice calendar with session data
 */
function updatePracticeCalendar(session) {
    const dateKey = formatDateKey(new Date(session.start));

    if (!appState.practiceCalendar[dateKey]) {
        appState.practiceCalendar[dateKey] = {
            sessions: 0,
            activeMs: 0,
            levelsGained: 0
        };
    }

    appState.practiceCalendar[dateKey].sessions++;
    appState.practiceCalendar[dateKey].activeMs += session.activeMs;
}

/**
 * Track a level change in today's practice calendar
 */
function trackLevelGain(fromLevel, toLevel) {
    if (toLevel <= fromLevel) return;

    const dateKey = formatDateKey(new Date());

    if (!appState.practiceCalendar[dateKey]) {
        appState.practiceCalendar[dateKey] = {
            sessions: 0,
            activeMs: 0,
            levelsGained: 0
        };
    }

    appState.practiceCalendar[dateKey].levelsGained += (toLevel - fromLevel);
}

/**
 * Initialize session tracking event listeners
 */
function initSessionTracking() {
    // Track clicks
    document.addEventListener('click', () => trackInteraction(), { passive: true });

    // Track key presses
    document.addEventListener('keydown', () => trackInteraction(), { passive: true });

    // Track scrolling (throttled via passive listener)
    document.addEventListener('scroll', () => trackInteraction(), { passive: true });

    // End session on page unload
    window.addEventListener('beforeunload', endSession);

    // Also end session on visibility change (tab hidden)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            endSession();
        }
    });
}

// ============================================
// CONTENT ENGAGEMENT TRACKING (Growth Character System)
// ============================================

/**
 * Track content expansion (What/Why/Example)
 * @param {string} itemKey - The learning item key
 * @param {string} contentType - 'what', 'why', or 'example' (or 'all' for combined toggle)
 */
function trackContentExpansion(itemKey, contentType) {
    trackInteraction(ACTIVITY.CONTENT);

    // Initialize engagementCounts if needed
    if (!appState.learningItems[itemKey]) return;

    if (!appState.learningItems[itemKey].engagementCounts) {
        appState.learningItems[itemKey].engagementCounts = {
            what: 0,
            why: 0,
            example: 0
        };
    }

    // For combined "What Why Example" button, count all three
    if (contentType === 'all') {
        appState.learningItems[itemKey].engagementCounts.what++;
        appState.learningItems[itemKey].engagementCounts.why++;
        appState.learningItems[itemKey].engagementCounts.example++;
    } else if (contentType in appState.learningItems[itemKey].engagementCounts) {
        appState.learningItems[itemKey].engagementCounts[contentType]++;
    }
}

/**
 * Track search activity (Google search from selection popup)
 */
function trackSearchActivity() {
    trackInteraction(ACTIVITY.SEARCH);
}

/**
 * Track question submission
 */
function trackQuestionSubmission() {
    trackInteraction(ACTIVITY.QUESTION);
}

// ============================================
// QUIZ STATS TRACKING (Growth Character System)
// ============================================

/**
 * Record a quiz result for Growth Character stats
 * @param {string} lpKey - The learning item key
 * @param {number} questionIndex - The question index within the LP
 * @param {boolean} wasCorrect - Whether the answer was correct
 */
function recordQuizResult(lpKey, questionIndex, wasCorrect) {
    // Track as quiz activity
    trackInteraction(ACTIVITY.QUIZ);

    // Initialize quizStats structure if needed
    if (!appState.quizStats[lpKey]) {
        appState.quizStats[lpKey] = {};
    }

    const qKey = String(questionIndex);

    if (!appState.quizStats[lpKey][qKey]) {
        appState.quizStats[lpKey][qKey] = {
            attempts: 0,
            correct: 0,
            lastTs: null
        };
    }

    const stat = appState.quizStats[lpKey][qKey];
    stat.attempts++;
    if (wasCorrect) stat.correct++;
    stat.lastTs = Date.now();

    // Update consolidation tracking
    updateConsolidation(lpKey);
}

/**
 * Update consolidation status for a learning item
 * @param {string} lpKey - The learning item key
 */
function updateConsolidation(lpKey) {
    const item = appState.learningItems[lpKey];
    if (!item) return;

    // Initialize consolidation if needed
    if (!item.consolidation) {
        item.consolidation = {
            masteredAt: null,
            qAttempted: 0,
            qCorrect: 0,
            qTotal: 0,
            isConsolidated: false
        };
    }

    const cons = item.consolidation;

    // Track secured timestamp when reaching level 5
    if (item.level === 5 && !cons.masteredAt) {
        cons.masteredAt = Date.now();
    }

    // Get question count for this LP (from cache if available)
    const lpStats = appState.quizStats[lpKey] || {};

    // Count unique questions attempted
    cons.qAttempted = Object.keys(lpStats).length;

    // Count questions ever answered correctly
    let everCorrect = 0;
    Object.values(lpStats).forEach(q => {
        if (q.correct > 0) everCorrect++;
    });
    cons.qCorrect = everCorrect;

    // Get total questions available (async, so we update when known)
    updateConsolidationTotal(lpKey);

    // Check if consolidated (all questions attempted)
    if (cons.qTotal > 0 && cons.qAttempted >= cons.qTotal) {
        cons.isConsolidated = true;
    }
}

/**
 * Update the total question count for consolidation
 * @param {string} lpKey - The learning item key
 */
async function updateConsolidationTotal(lpKey) {
    try {
        const item = appState.learningItems[lpKey];
        if (!item || !item.consolidation) return;

        // Extract UUID from the item to look up questions
        const lpItem = getItemByKey(lpKey);
        const uuid = lpItem?.uuid;
        if (!uuid) return;

        // Only use cached questions - don't fetch (to avoid blocking)
        const questionData = questionsCache[uuid];
        if (questionData && questionData !== null) {
            // Count all questions across all levels (format: toLevel2, toLevel3, toLevel4, toLevel5)
            let total = 0;
            for (let level = 2; level <= 5; level++) {
                const levelKey = `toLevel${level}`;
                if (Array.isArray(questionData[levelKey])) {
                    total += questionData[levelKey].length;
                }
            }
            item.consolidation.qTotal = total;

            // Re-check consolidation status
            if (total > 0 && item.consolidation.qAttempted >= total) {
                item.consolidation.isConsolidated = true;
            }
        }
    } catch (e) {
        console.error('Error updating consolidation total:', e);
    }
}

// ============================================
// DERIVED METRICS (Growth Character System)
// ============================================

/**
 * Calculate days between two dates
 */
function daysBetween(date1, date2) {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    const diffTime = Math.abs(d2 - d1);
    return Math.floor(diffTime / (1000 * 60 * 60 * 24));
}

/**
 * Parse a YYYYMMDD date key back to a Date
 */
function parseDateKey(dateKey) {
    const year = parseInt(dateKey.substring(0, 4));
    const month = parseInt(dateKey.substring(4, 6)) - 1;
    const day = parseInt(dateKey.substring(6, 8));
    return new Date(year, month, day);
}

/**
 * Calculate spacing score (how well-distributed practice is)
 * @returns {number} 0-1, higher = better distributed
 */
function calculateSpacingScore() {
    const calendar = appState.practiceCalendar;
    const activeDays = Object.keys(calendar).length;

    if (activeDays === 0) return 0;

    // Find topic start date from first check-in
    const firstCheckin = appState.checkins.find(c => c.type === 'pre') || appState.checkins[0];
    if (!firstCheckin) return 0;

    const startDate = new Date(firstCheckin.date);
    const totalDays = Math.max(1, daysBetween(startDate, new Date()));

    return Math.min(1, activeDays / totalDays);
}

/**
 * Calculate session variety (how many different activities per session)
 * @returns {number} 0-1, higher = more varied sessions
 */
function calculateSessionVariety() {
    const sessions = appState.sessions;
    if (sessions.length === 0) return 0;

    let variedSessions = 0;
    sessions.forEach(s => {
        // Count bits set in activities bitmask
        let activityCount = 0;
        let n = s.activities;
        while (n) {
            activityCount += n & 1;
            n >>= 1;
        }
        if (activityCount >= 2) variedSessions++;
    });

    return variedSessions / sessions.length;
}

/**
 * Calculate content engagement rate (% of items with help content viewed)
 * @returns {number} 0-1
 */
function calculateContentEngagementRate() {
    const items = Object.values(appState.learningItems);
    if (items.length === 0) return 0;

    let itemsWithEngagement = 0;
    items.forEach(item => {
        const counts = item.engagementCounts || {};
        if (counts.what || counts.why || counts.example) {
            itemsWithEngagement++;
        }
    });

    return itemsWithEngagement / items.length;
}

/**
 * Calculate consolidation rate (% of secured items that are consolidated)
 * @returns {number} 0-1
 */
function calculateConsolidationRate() {
    const items = Object.values(appState.learningItems);
    let securedCount = 0;
    let consolidatedCount = 0;

    items.forEach(item => {
        if (item.level === 5) {
            securedCount++;
            if (item.consolidation?.isConsolidated) {
                consolidatedCount++;
            }
        }
    });

    return securedCount > 0 ? consolidatedCount / securedCount : 0;
}

/**
 * Calculate error metrics from quiz stats and history
 * @returns {object} { errorRate, lockoutCount }
 */
function calculateErrorMetrics() {
    let totalAttempts = 0;
    let totalErrors = 0;
    let lockoutCount = 0;

    // Count from quiz stats
    Object.values(appState.quizStats).forEach(lpStats => {
        Object.values(lpStats).forEach(q => {
            totalAttempts += q.attempts;
            totalErrors += (q.attempts - q.correct);
        });
    });

    // Count lockouts from history
    Object.values(appState.learningItems).forEach(item => {
        (item.history || []).forEach(h => {
            // Check for level drops (lockouts cause level to stay same or context indicates lockout)
            if (h.previousLevel && h.level < h.previousLevel) {
                lockoutCount++;
            }
        });
    });

    const errorRate = totalAttempts > 0 ? totalErrors / totalAttempts : 0;

    return { errorRate, lockoutCount };
}

/**
 * Calculate recovery rate (% of lockouts followed by subsequent progress)
 * @returns {number} 0-1
 */
function calculateRecoveryRate() {
    let lockouts = 0;
    let recoveries = 0;

    Object.values(appState.learningItems).forEach(item => {
        const history = item.history || [];
        for (let i = 0; i < history.length; i++) {
            const h = history[i];
            // Detect lockout (level drop)
            if (h.previousLevel && h.level < h.previousLevel) {
                lockouts++;
                // Check if any subsequent entry shows recovery
                for (let j = i + 1; j < history.length; j++) {
                    if (history[j].level > h.level) {
                        recoveries++;
                        break;
                    }
                }
            }
        }
    });

    return lockouts > 0 ? recoveries / lockouts : 1;
}

/**
 * Calculate session consistency (regularity of practice gaps)
 * @returns {number} 0-1, higher = more consistent
 */
function calculateSessionConsistency() {
    const dates = Object.keys(appState.practiceCalendar).sort();
    if (dates.length < 2) return 0.5;

    // Calculate gaps between sessions
    const gaps = [];
    for (let i = 1; i < dates.length; i++) {
        const gap = daysBetween(parseDateKey(dates[i - 1]), parseDateKey(dates[i]));
        gaps.push(gap);
    }

    if (gaps.length === 0) return 0.5;

    // Calculate variance
    const avgGap = gaps.reduce((a, b) => a + b, 0) / gaps.length;
    const variance = gaps.reduce((sum, g) => sum + Math.pow(g - avgGap, 2), 0) / gaps.length;

    // Convert to 0-1 score (lower variance = higher score)
    // Variance of 25 (5 day std dev) = 0 score
    return Math.max(0, 1 - (variance / 25));
}

/**
 * Get the overall level as a 1-5 average
 * @returns {number}
 */
function calculateOverallLevel() {
    const items = Object.values(appState.learningItems);
    if (items.length === 0) return 1;
    return items.reduce((sum, i) => sum + i.level, 0) / items.length;
}

/**
 * Get the pre-topic level (from first check-in)
 * @returns {number}
 */
function getPreTopicLevel() {
    const firstCheckin = appState.checkins.find(c => c.type === 'pre');
    if (firstCheckin?.stats?.overallPercentage !== undefined) {
        // Convert percentage back to 1-5 scale
        return 1 + (firstCheckin.stats.overallPercentage / 100) * 4;
    }
    return 1;
}

/**
 * Get all derived metrics for Growth Character generation
 * @returns {object}
 */
function getAllDerivedMetrics() {
    const preTopicLevel = getPreTopicLevel();
    const currentLevel = calculateOverallLevel();
    const growthMagnitude = (currentLevel - preTopicLevel) / 4; // Normalize to 0-1

    const firstCheckin = appState.checkins.find(c => c.type === 'pre') || appState.checkins[0];
    const topicStartDate = firstCheckin?.date || new Date().toISOString();
    const totalDays = Math.max(1, daysBetween(new Date(topicStartDate), new Date()));
    const activeDays = Object.keys(appState.practiceCalendar).length;

    const spacingScore = calculateSpacingScore();
    const sessionVariety = calculateSessionVariety();
    const contentEngagementRate = calculateContentEngagementRate();
    const consolidationRate = calculateConsolidationRate();
    const { errorRate, lockoutCount } = calculateErrorMetrics();
    const recoveryRate = calculateRecoveryRate();
    const sessionConsistency = calculateSessionConsistency();

    const totalItems = Object.keys(appState.learningItems).length;
    const securedCount = Object.values(appState.learningItems).filter(i => i.level === 5).length;
    const consolidatedCount = Object.values(appState.learningItems).filter(i => i.consolidation?.isConsolidated).length;
    const questionsSubmitted = appState.questions?.length || 0;

    // Calculate total active time
    const totalActiveMs = appState.sessions.reduce((sum, s) => sum + s.activeMs, 0);

    return {
        // Achievement
        preTopicLevel,
        currentLevel,
        growthMagnitude,
        totalDays,
        activeDays,

        // High-value metrics
        spacingScore,
        sessionVariety,
        contentEngagementRate,
        consolidationRate,
        errorRate,
        lockoutCount,
        recoveryRate,
        sessionConsistency,

        // Counts
        totalItems,
        securedCount,
        consolidatedCount,
        questionsSubmitted,
        sessionCount: appState.sessions.length,
        totalActiveMs
    };
}

// ============================================
// LEARNING QUALITIES (Growth Character System)
// ============================================

/**
 * Quality label thresholds and text
 */
const QUALITY_LABELS = {
    foundation: [
        [30, "Building from the ground up"],
        [50, "Establishing foundations"],
        [70, "Solid starting point"],
        [85, "Strong prior knowledge"],
        [100, "Excellent foundation"]
    ],
    momentum: [
        [30, "Taking time to build understanding"],
        [50, "Building at a steady pace"],
        [70, "Good forward progress"],
        [85, "Strong momentum"],
        [100, "Excellent momentum"]
    ],
    steadiness: [
        [30, "Working through challenges"],
        [50, "Building consistency"],
        [70, "Progressing steadily"],
        [85, "Smooth progression"],
        [100, "Very consistent progress"]
    ],
    engagedCuriosity: [
        [30, "Opportunity to explore more"],
        [50, "Beginning to investigate"],
        [70, "Actively engaging"],
        [85, "Curious and thorough"],
        [100, "Deeply engaged"]
    ],
    persistence: [
        [30, "Building resilience"],
        [50, "Developing determination"],
        [70, "Shows persistence"],
        [85, "Resilient and determined"],
        [100, "Highly persistent"]
    ],
    learningHabits: [
        [30, "Building study habits"],
        [50, "Developing learning strategies"],
        [70, "Good learning approach"],
        [85, "Strong study habits"],
        [100, "Excellent learning strategies"]
    ]
};

/**
 * Get the label for a quality score
 * @param {string} quality - Quality name
 * @param {number} score - Score 0-100
 * @returns {string}
 */
function getQualityLabel(quality, score) {
    const thresholds = QUALITY_LABELS[quality];
    if (!thresholds) return '';

    for (const [threshold, label] of thresholds) {
        if (score <= threshold) return label;
    }
    return thresholds[thresholds.length - 1][1];
}

/**
 * Calculate Foundation quality (0-100)
 * Based on pre-topic starting level
 */
function calculateFoundation(metrics) {
    // Scale 1-5 to 0-100
    return Math.round(((metrics.preTopicLevel - 1) / 4) * 100);
}

/**
 * Calculate Momentum quality (0-100)
 * Based on growth rate and spacing
 */
function calculateMomentum(metrics) {
    // Expected growth: ~0.1 levels per day of the topic duration
    const expectedGrowth = metrics.totalDays * 0.1;
    const velocityScore = Math.min(1, metrics.growthMagnitude / Math.max(expectedGrowth, 0.1));

    // 60% velocity, 40% spacing
    return Math.round((velocityScore * 60) + (metrics.spacingScore * 40));
}

/**
 * Calculate Steadiness quality (0-100)
 * Based on error rate and lockouts
 */
function calculateSteadiness(metrics) {
    let score = 100;

    // Error rate penalty (up to -40)
    score -= metrics.errorRate * 40;

    // Lockout penalty (up to -30, scaled by item count)
    const lockoutRate = metrics.lockoutCount / Math.max(metrics.totalItems, 1);
    score -= Math.min(lockoutRate * 100, 30);

    return Math.round(Math.max(0, Math.min(100, score)));
}

/**
 * Calculate Engaged Curiosity quality (0-100)
 * Based on content engagement, consolidation, questions, session variety
 */
function calculateEngagedCuriosity(metrics) {
    // Content engagement: 35%
    const contentComponent = metrics.contentEngagementRate * 35;

    // Consolidation: 25%
    const consolidationComponent = metrics.consolidationRate * 25;

    // Questions submitted: 20% (cap at 5)
    const questionsComponent = (Math.min(metrics.questionsSubmitted, 5) / 5) * 20;

    // Session variety: 20%
    const varietyComponent = metrics.sessionVariety * 20;

    return Math.round(contentComponent + consolidationComponent + questionsComponent + varietyComponent);
}

/**
 * Calculate Persistence quality (0-100)
 * Based on recovery rate, spacing, session consistency
 */
function calculatePersistence(metrics) {
    // Recovery from setbacks: 40%
    const recoveryComponent = metrics.recoveryRate * 40;

    // Spacing (kept coming back): 30%
    const spacingComponent = metrics.spacingScore * 30;

    // Session consistency: 30%
    const consistencyComponent = metrics.sessionConsistency * 30;

    return Math.round(recoveryComponent + spacingComponent + consistencyComponent);
}

/**
 * Calculate Learning Habits quality (0-100)
 * Based on spacing, content engagement, session variety
 */
function calculateLearningHabits(metrics) {
    // Spacing: 40%
    const spacingComponent = metrics.spacingScore * 40;

    // Content engagement: 30%
    const contentComponent = metrics.contentEngagementRate * 30;

    // Session variety: 30%
    const varietyComponent = metrics.sessionVariety * 30;

    return Math.round(spacingComponent + contentComponent + varietyComponent);
}

/**
 * Calculate all six learning qualities
 * @returns {object} { qualities, qualityLabels }
 */
function calculateAllQualities() {
    const metrics = getAllDerivedMetrics();

    const qualities = {
        foundation: calculateFoundation(metrics),
        momentum: calculateMomentum(metrics),
        steadiness: calculateSteadiness(metrics),
        engagedCuriosity: calculateEngagedCuriosity(metrics),
        persistence: calculatePersistence(metrics),
        learningHabits: calculateLearningHabits(metrics)
    };

    const qualityLabels = {};
    Object.keys(qualities).forEach(q => {
        qualityLabels[q] = getQualityLabel(q, qualities[q]);
    });

    return { qualities, qualityLabels, metrics };
}

// ============================================
// NARRATIVE GENERATION (Growth Character System)
// ============================================

/**
 * Narrative template bank
 */
const NARRATIVE_TEMPLATES = {
    foundation: {
        low: "You're building this topic from the ground up",
        medium: "You came into this topic with some background",
        high: "You started with solid prior knowledge"
    },

    progress: {
        none: "You're at the early stages of your learning journey",
        slow: "You're taking time to build solid understanding",
        steady: "You've been making steady progress",
        fast: "You've made excellent progress"
    },

    spacing: {
        good: "Your practice has been well spread across days, which helps learning stick",
        needsWork: "Try spreading your practice across more days, as even short sessions help"
    },

    strengths: {
        engagedCuriosity: "Your curiosity has been a real strength, and you explore thoroughly",
        persistence: "You've shown real determination, coming back stronger after challenges",
        steadiness: "You've been progressing smoothly, building understanding step by step",
        momentum: "You've built strong momentum, moving through the content with confidence",
        learningHabits: "Your study approach is effective, and you practice consistently"
    },

    consolidation: {
        high: "You've gone beyond just passing and strengthened your knowledge with extra practice",
        some: "You've started strengthening your secured areas with additional practice"
    },

    encouragement: {
        general: "Keep going, you're building solid understanding",
        explore: "Try exploring the help content, as it can deepen your understanding",
        spacing: "Try spreading your practice across more days for better retention",
        maintain: "Keep up this approach, it's working well for you"
    }
};

/**
 * Generate a narrative summary for the Growth Character
 * @param {object} qualities - The six quality scores
 * @param {object} metrics - Derived metrics
 * @returns {string}
 */
function generateNarrative(qualities, metrics) {
    const parts = [];

    // 1. Foundation statement
    const foundationKey = metrics.preTopicLevel < 2 ? 'low' :
                          metrics.preTopicLevel < 3.5 ? 'medium' : 'high';
    parts.push(NARRATIVE_TEMPLATES.foundation[foundationKey]);

    // 2. Progress statement
    const progressKey = metrics.growthMagnitude < 0.1 ? 'none' :
                        metrics.growthMagnitude < 0.3 ? 'slow' :
                        metrics.growthMagnitude < 0.5 ? 'steady' : 'fast';
    parts.push(NARRATIVE_TEMPLATES.progress[progressKey]);

    // 3. Spacing observation (only if good)
    if (metrics.spacingScore > 0.5) {
        parts.push(NARRATIVE_TEMPLATES.spacing.good);
    }

    // 4. Strength highlight (highest quality, excluding foundation)
    const strengthQualities = {
        engagedCuriosity: qualities.engagedCuriosity,
        persistence: qualities.persistence,
        steadiness: qualities.steadiness,
        momentum: qualities.momentum,
        learningHabits: qualities.learningHabits
    };
    const topStrength = Object.entries(strengthQualities)
        .sort((a, b) => b[1] - a[1])[0];

    if (topStrength && topStrength[1] > 50) {
        parts.push(NARRATIVE_TEMPLATES.strengths[topStrength[0]]);
    }

    // 5. Consolidation note (if applicable)
    if (metrics.consolidationRate > 0.5) {
        parts.push(NARRATIVE_TEMPLATES.consolidation.high);
    } else if (metrics.consolidationRate > 0) {
        parts.push(NARRATIVE_TEMPLATES.consolidation.some);
    }

    // 6. Encouragement
    if (metrics.spacingScore < 0.3) {
        parts.push(NARRATIVE_TEMPLATES.encouragement.spacing);
    } else if (qualities.engagedCuriosity < 40) {
        parts.push(NARRATIVE_TEMPLATES.encouragement.explore);
    } else if (qualities.momentum > 70) {
        parts.push(NARRATIVE_TEMPLATES.encouragement.maintain);
    } else {
        parts.push(NARRATIVE_TEMPLATES.encouragement.general);
    }

    return parts.join('. ') + '.';
}

/**
 * Generate comparison to previous Growth Character
 * @param {object} current - Current qualities and level
 * @param {object} previous - Previous Growth Character (or null)
 * @returns {object|null}
 */
function generateComparison(current, previous) {
    if (!previous) return null;

    const qualityChanges = {};
    const qualityKeys = ['foundation', 'momentum', 'steadiness', 'engagedCuriosity', 'persistence', 'learningHabits'];

    qualityKeys.forEach(q => {
        qualityChanges[q] = current.qualities[q] - (previous.qualities?.[q] || 0);
    });

    // Find most improved (excluding foundation, which shouldn't change)
    const improvements = Object.entries(qualityChanges)
        .filter(([k, v]) => k !== 'foundation' && v > 5)
        .sort((a, b) => b[1] - a[1]);

    let narrativeChange = "Your learning approach has been consistent.";

    if (improvements.length > 0) {
        const [quality, amount] = improvements[0];
        const changeNarratives = {
            momentum: "You've picked up pace since last time",
            steadiness: "You're progressing more smoothly now",
            engagedCuriosity: "You've been exploring and engaging more deeply",
            persistence: "Your determination has strengthened",
            learningHabits: "Your study approach has improved"
        };
        narrativeChange = changeNarratives[quality] || narrativeChange;
    }

    // Check for any declines
    const declines = Object.entries(qualityChanges)
        .filter(([k, v]) => k !== 'foundation' && v < -10)
        .sort((a, b) => a[1] - b[1]);

    if (declines.length > 0 && improvements.length === 0) {
        narrativeChange = "This check-in shows some areas to focus on. Keep at it.";
    }

    return {
        previousId: previous.id,
        daysSince: daysBetween(new Date(previous.generatedAt), new Date()),
        qualityChanges,
        levelChange: current.level - (previous.level || 0),
        narrativeChange
    };
}

// ============================================
// GROWTH CHARACTER GENERATION
// ============================================

/**
 * Generate a Growth Character at check-in completion
 * @param {string} checkinId - The ID of the completed check-in
 * @param {string} checkinType - The type of check-in (pre, weekly, etc.)
 * @returns {object} The generated Growth Character
 */
function generateGrowthCharacter(checkinId, checkinType) {
    // Get all qualities and metrics
    const { qualities, qualityLabels, metrics } = calculateAllQualities();

    // Calculate overall level as percentage (0-1)
    const levelPercentage = (metrics.currentLevel - 1) / 4;

    // Generate narrative
    const narrative = generateNarrative(qualities, metrics);

    // Get previous Growth Character for comparison
    const previousGC = appState.growthCharacters.length > 0
        ? appState.growthCharacters[appState.growthCharacters.length - 1]
        : null;

    // Generate comparison
    const comparison = generateComparison(
        { qualities, level: levelPercentage },
        previousGC
    );

    // Build the Growth Character object
    const growthCharacter = {
        id: generateSessionId(), // Reuse UUID generator
        checkinId: checkinId,
        checkinType: checkinType,
        generatedAt: Date.now(),
        level: levelPercentage,
        qualities: qualities,
        qualityLabels: qualityLabels,
        narrative: narrative,
        metrics: {
            preTopicLevel: metrics.preTopicLevel,
            currentLevel: metrics.currentLevel,
            growthMagnitude: metrics.growthMagnitude,
            spacingScore: metrics.spacingScore,
            securedCount: metrics.securedCount,
            consolidatedCount: metrics.consolidatedCount,
            activeDays: metrics.activeDays,
            totalDays: metrics.totalDays,
            consolidationRate: metrics.consolidationRate,
            totalItems: metrics.totalItems
        },
        comparison: comparison
    };

    // Store it
    appState.growthCharacters.push(growthCharacter);
    saveData();

    return growthCharacter;
}

/**
 * Get the most recent Growth Character
 * @returns {object|null}
 */
function getLatestGrowthCharacter() {
    if (appState.growthCharacters.length === 0) return null;
    return appState.growthCharacters[appState.growthCharacters.length - 1];
}

/**
 * Format a Growth Character for display
 * @param {object} gc - The Growth Character
 * @returns {object} Formatted data for UI
 */
function formatGrowthCharacterForDisplay(gc) {
    if (!gc) return null;

    const checkinTypeLabels = {
        'pre': 'Pre-topic',
        'weekly': 'Weekly',
        'mid': 'Mid-topic',
        'end': 'End of topic'
    };

    return {
        id: gc.id,
        date: new Date(gc.generatedAt).toLocaleDateString('en-AU', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        }),
        checkinType: checkinTypeLabels[gc.checkinType] || gc.checkinType,
        levelPercent: Math.round(gc.level * 100),
        startPercent: Math.round(((gc.metrics.preTopicLevel - 1) / 4) * 100),
        qualities: gc.qualities,
        qualityLabels: gc.qualityLabels,
        narrative: gc.narrative,
        metrics: gc.metrics,
        comparison: gc.comparison,
        hasComparison: gc.comparison !== null
    };
}

// ============================================
// GROWTH CHARACTER UI FUNCTIONS
// ============================================

/**
 * Show the post check-in modal
 * @param {object} checkin - The check-in data
 * @param {object} growthCharacter - The generated Growth Character
 * @param {boolean} autoStopped - Whether the check-in was auto-stopped
 */
function showPostCheckinModal(checkin, growthCharacter, autoStopped) {
    // Update summary stats
    document.getElementById('post-checkin-reviewed').textContent = checkin.itemsReviewed;
    document.getElementById('post-checkin-total').textContent = checkin.totalItems;

    // Set message based on how check-in ended
    const messageEl = document.getElementById('post-checkin-message');
    if (autoStopped) {
        messageEl.textContent = 'Your check-in was automatically saved after reviewing all items.';
    } else {
        messageEl.textContent = 'Great progress! Keep up the good work.';
    }

    // Store the growth character for the view button
    document.getElementById('post-checkin-overlay').dataset.gcId = growthCharacter?.id || '';

    // Show the modal
    document.getElementById('post-checkin-overlay').classList.add('active');
}

/**
 * Hide the post check-in modal
 */
function hidePostCheckinModal() {
    document.getElementById('post-checkin-overlay').classList.remove('active');
}

/**
 * Show the Growth Character modal with data
 * @param {object} gc - Optional Growth Character to display. If null, shows latest.
 */
function showGrowthCharacterModal(gc) {
    // Get the Growth Character to display
    const growthCharacter = gc || getLatestGrowthCharacter();

    if (!growthCharacter) {
        showToast('No Growth Character available yet. Complete a check-in first.', 'warning');
        return;
    }

    // Format for display
    const formatted = formatGrowthCharacterForDisplay(growthCharacter);

    // Render the content
    renderGrowthCharacter(formatted);

    // Show the modal
    document.getElementById('growth-character-overlay').classList.add('active');
}

/**
 * Hide the Growth Character modal
 */
function hideGrowthCharacterModal() {
    document.getElementById('growth-character-overlay').classList.remove('active');
}

/**
 * Render Growth Character data into the modal
 * @param {object} gc - Formatted Growth Character data
 */
function renderGrowthCharacter(gc) {
    // Date and type
    document.getElementById('gc-checkin-type').textContent = gc.checkinType + ' Check-in';
    document.getElementById('gc-date').textContent = gc.date;

    // Progress bar
    const startPercent = gc.startPercent;
    const currentPercent = gc.levelPercent;

    document.getElementById('gc-progress-start').style.width = startPercent + '%';
    document.getElementById('gc-progress-current').style.width = currentPercent + '%';
    document.getElementById('gc-start-percent').textContent = startPercent + '%';
    document.getElementById('gc-current-percent').textContent = currentPercent + '%';

    // Narrative
    document.getElementById('gc-narrative').textContent = gc.narrative;

    // Qualities grid
    const qualitiesGrid = document.getElementById('gc-qualities-grid');
    const qualityNames = {
        foundation: 'Foundation',
        momentum: 'Momentum',
        steadiness: 'Steadiness',
        engagedCuriosity: 'Engaged Curiosity',
        persistence: 'Persistence',
        learningHabits: 'Learning Habits'
    };

    qualitiesGrid.innerHTML = Object.entries(gc.qualities).map(([key, value]) => `
        <div class="gc-quality-item">
            <div class="gc-quality-name">${qualityNames[key] || key}</div>
            <div class="gc-quality-bar-container">
                <div class="gc-quality-bar" style="width: ${value}%"></div>
            </div>
            <div class="gc-quality-label">${gc.qualityLabels[key] || ''}</div>
        </div>
    `).join('');

    // Comparison section
    const comparisonSection = document.getElementById('gc-comparison-section');
    const comparisonText = document.getElementById('gc-comparison-text');

    if (gc.hasComparison && gc.comparison) {
        comparisonSection.style.display = 'block';
        comparisonText.textContent = gc.comparison;
    } else {
        comparisonSection.style.display = 'none';
    }

    // Stats
    document.getElementById('gc-secured-count').textContent = gc.metrics.securedCount || 0;
    document.getElementById('gc-active-days').textContent = gc.metrics.activeDays || 0;
    document.getElementById('gc-consolidated-count').textContent = gc.metrics.consolidatedCount || 0;

    // Render activity visualizations (streak + heatmap)
    renderStreakCounter('gc-streak-container');
    renderHeatmapGrid('gc-heatmap-container', 12); // 12 weeks for full view
}

/**
 * Update the Growth Character overview card in the Overview panel
 */
function updateGrowthCharacterOverviewCard() {
    const card = document.getElementById('gc-overview-card');
    if (!card) return;

    const latestGC = getLatestGrowthCharacter();

    if (!latestGC) {
        card.style.display = 'none';
        return;
    }

    // Show the card
    card.style.display = 'block';

    // Update percent
    const levelPercent = Math.round(latestGC.level * 100);
    document.getElementById('gc-overview-percent').textContent = levelPercent + '%';

    // Find top quality
    const qualities = latestGC.qualities;
    let topQuality = '';
    let topValue = 0;

    const qualityNames = {
        foundation: 'Foundation',
        momentum: 'Momentum',
        steadiness: 'Steadiness',
        engagedCuriosity: 'Engaged Curiosity',
        persistence: 'Persistence',
        learningHabits: 'Learning Habits'
    };

    Object.entries(qualities).forEach(([key, value]) => {
        if (value > topValue) {
            topValue = value;
            topQuality = qualityNames[key] || key;
        }
    });

    document.getElementById('gc-overview-top-quality').textContent = topQuality || '-';
}

/**
 * Initialize Growth Character event listeners
 */
function initGrowthCharacterListeners() {
    // Post check-in modal: View Growth Character button
    const viewGCBtn = document.getElementById('post-checkin-view-gc-btn');
    if (viewGCBtn) {
        viewGCBtn.addEventListener('click', () => {
            hidePostCheckinModal();
            // Find the specific Growth Character by ID stored in the overlay
            const gcId = document.getElementById('post-checkin-overlay').dataset.gcId;
            const gc = gcId
                ? appState.growthCharacters.find(g => g.id === gcId)
                : null;
            showGrowthCharacterModal(gc);
        });
    }

    // Post check-in modal: Done button
    const postCheckinDoneBtn = document.getElementById('post-checkin-done-btn');
    if (postCheckinDoneBtn) {
        postCheckinDoneBtn.addEventListener('click', hidePostCheckinModal);
    }

    // Growth Character modal: Close button (X)
    const gcCloseBtn = document.getElementById('gc-close-btn');
    if (gcCloseBtn) {
        gcCloseBtn.addEventListener('click', hideGrowthCharacterModal);
    }

    // Growth Character modal: Done button
    const gcDoneBtn = document.getElementById('gc-done-btn');
    if (gcDoneBtn) {
        gcDoneBtn.addEventListener('click', hideGrowthCharacterModal);
    }

    // Growth Character modal: View History button
    const gcHistoryBtn = document.getElementById('gc-history-btn');
    if (gcHistoryBtn) {
        gcHistoryBtn.addEventListener('click', () => {
            hideGrowthCharacterModal();
            switchTab('history');
            showToast('Growth Character history coming soon.', 'info');
        });
    }

    // Overview panel: View Growth Character button
    const viewGrowthCharacterBtn = document.getElementById('view-growth-character-btn');
    if (viewGrowthCharacterBtn) {
        viewGrowthCharacterBtn.addEventListener('click', () => {
            showGrowthCharacterModal();
        });
    }

    // Close modals on overlay click
    const postCheckinOverlay = document.getElementById('post-checkin-overlay');
    if (postCheckinOverlay) {
        postCheckinOverlay.addEventListener('click', (e) => {
            if (e.target === postCheckinOverlay) {
                hidePostCheckinModal();
            }
        });
    }

    const gcOverlay = document.getElementById('growth-character-overlay');
    if (gcOverlay) {
        gcOverlay.addEventListener('click', (e) => {
            if (e.target === gcOverlay) {
                hideGrowthCharacterModal();
            }
        });
    }
}

// ============================================
// QUIZ STATE MANAGEMENT
// ============================================
function saveQuizState() {
    try {
        localStorage.setItem(QUIZ_STATE_KEY, JSON.stringify(quizState));
    } catch (e) {
        console.error('Failed to save quiz state:', e);
    }
}

function loadQuizState() {
    try {
        const saved = localStorage.getItem(QUIZ_STATE_KEY);
        if (saved) {
            quizState = JSON.parse(saved);
            // Clean up expired lockouts
            const now = Date.now();
            Object.keys(quizState).forEach(key => {
                if (quizState[key].lockedUntil && quizState[key].lockedUntil < now) {
                    quizState[key] = {
                        usedQuestions: [],
                        wrongCount: 0,
                        correctStreak: 0,
                        requiredCorrect: 1,
                        lockedUntil: null
                    };
                }
            });
            saveQuizState();
        }
    } catch (e) {
        console.error('Failed to load quiz state:', e);
        quizState = {};
    }
}

// ============================================
// PRACTICE CALENDAR VISUALIZATIONS
// ============================================

/**
 * Calculate current streak (consecutive days with activity)
 * @returns {object} { current, longest, lastSevenDays }
 */
function calculateStreak() {
    const calendar = appState.practiceCalendar || {};
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    let currentStreak = 0;
    let longestStreak = 0;
    let tempStreak = 0;
    let lastSevenDays = [];

    // Check last 7 days for the dots display
    for (let i = 6; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const key = formatDateKey(d);
        const hasActivity = calendar[key] && calendar[key].sessions > 0;
        lastSevenDays.push({
            date: d,
            hasActivity,
            isToday: i === 0
        });
    }

    // Calculate current streak (going backwards from today)
    let checkDate = new Date(today);
    // First check if today has activity, if not start from yesterday
    const todayKey = formatDateKey(today);
    if (!calendar[todayKey] || calendar[todayKey].sessions === 0) {
        checkDate.setDate(checkDate.getDate() - 1);
    }

    while (true) {
        const key = formatDateKey(checkDate);
        if (calendar[key] && calendar[key].sessions > 0) {
            currentStreak++;
            checkDate.setDate(checkDate.getDate() - 1);
        } else {
            break;
        }
        // Safety limit
        if (currentStreak > 365) break;
    }

    // Calculate longest streak (scan all days)
    const sortedDays = Object.keys(calendar).sort();
    sortedDays.forEach(key => {
        if (calendar[key] && calendar[key].sessions > 0) {
            tempStreak++;
            longestStreak = Math.max(longestStreak, tempStreak);
        } else {
            tempStreak = 0;
        }
    });

    return { current: currentStreak, longest: longestStreak, lastSevenDays };
}

/**
 * Render streak counter component
 * @param {string} containerId - The container element ID
 */
function renderStreakCounter(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const streak = calculateStreak();

    const dotsHtml = streak.lastSevenDays.map(day => {
        let classes = 'streak-dot';
        if (day.hasActivity) classes += ' active';
        if (day.isToday) classes += ' today';
        return `<div class="${classes}" title="${day.date.toLocaleDateString()}"></div>`;
    }).join('');

    container.innerHTML = `
        <div class="streak-counter">
            <span class="streak-flame">${streak.current > 0 ? 'üî•' : 'üí§'}</span>
            <div class="streak-info">
                <span class="streak-number">${streak.current}</span>
                <span class="streak-label">day streak</span>
            </div>
            <div class="streak-dots">
                ${dotsHtml}
            </div>
        </div>
    `;
}

/**
 * Get activity level for a date (0-5 scale)
 * @param {string} dateKey - YYYYMMDD format
 * @returns {number} 0-5
 */
function getActivityLevel(dateKey) {
    const calendar = appState.practiceCalendar || {};
    const day = calendar[dateKey];
    if (!day || day.sessions === 0) return 0;

    // Scale based on active time (in minutes)
    const minutes = Math.round(day.activeMs / 60000);
    if (minutes >= 30) return 5;
    if (minutes >= 20) return 4;
    if (minutes >= 10) return 3;
    if (minutes >= 5) return 2;
    return 1;
}

/**
 * Render heatmap grid (GitHub-style)
 * @param {string} containerId - The container element ID
 * @param {number} weeks - Number of weeks to show (default 12)
 */
function renderHeatmapGrid(containerId, weeks = 12) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayKey = formatDateKey(today);

    // Calculate start date (weeks ago, aligned to Sunday)
    const startDate = new Date(today);
    startDate.setDate(startDate.getDate() - (weeks * 7) + 1);
    // Align to Sunday
    startDate.setDate(startDate.getDate() - startDate.getDay());

    // Generate cells
    let cellsHtml = '';
    const dayLabels = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];

    // Day labels column
    cellsHtml += dayLabels.map(d => `<div class="heatmap-day-label">${d}</div>`).join('');

    // Generate weeks
    const currentDate = new Date(startDate);
    const totalDays = weeks * 7;

    for (let i = 0; i < totalDays; i++) {
        const dateKey = formatDateKey(currentDate);
        const level = getActivityLevel(dateKey);
        const isFuture = currentDate > today;
        const isToday = dateKey === todayKey;

        let classes = 'heatmap-cell';
        if (isFuture) classes += ' future';
        if (isToday) classes += ' today';

        const dayData = appState.practiceCalendar?.[dateKey];
        const title = isFuture ? 'Future' :
            (dayData ? `${currentDate.toLocaleDateString()}: ${dayData.sessions} session(s), ${Math.round(dayData.activeMs / 60000)}min` :
                `${currentDate.toLocaleDateString()}: No activity`);

        cellsHtml += `<div class="${classes}" data-level="${isFuture ? 0 : level}" title="${title}"></div>`;
        currentDate.setDate(currentDate.getDate() + 1);
    }

    // Month labels
    const months = [];
    const checkDate = new Date(startDate);
    let lastMonth = -1;
    while (checkDate <= today) {
        if (checkDate.getMonth() !== lastMonth) {
            months.push(checkDate.toLocaleDateString('en-AU', { month: 'short' }));
            lastMonth = checkDate.getMonth();
        }
        checkDate.setDate(checkDate.getDate() + 7);
    }

    container.innerHTML = `
        <div class="heatmap-container">
            <div class="heatmap-header">
                <span class="heatmap-title">Activity</span>
                <div class="heatmap-legend">
                    <span>Less</span>
                    <div class="heatmap-legend-squares">
                        <div class="heatmap-legend-square" style="background: var(--color-bg-warm);"></div>
                        <div class="heatmap-legend-square" style="background: rgba(59, 130, 246, 0.2);"></div>
                        <div class="heatmap-legend-square" style="background: rgba(59, 130, 246, 0.4);"></div>
                        <div class="heatmap-legend-square" style="background: rgba(59, 130, 246, 0.6);"></div>
                        <div class="heatmap-legend-square" style="background: var(--color-primary);"></div>
                    </div>
                    <span>More</span>
                </div>
            </div>
            <div class="heatmap-grid" style="grid-template-columns: repeat(${weeks}, 1fr); grid-template-rows: repeat(7, 1fr);">
                ${cellsHtml}
            </div>
            <div class="heatmap-months">
                ${months.map(m => `<span>${m}</span>`).join('')}
            </div>
        </div>
    `;
}

/**
 * Render calendar view (monthly)
 * @param {string} containerId - The container element ID
 * @param {Date} month - The month to display (defaults to current)
 */
function renderCalendarView(containerId, month = new Date()) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const year = month.getFullYear();
    const monthIndex = month.getMonth();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayKey = formatDateKey(today);

    // First day of month
    const firstDay = new Date(year, monthIndex, 1);
    const lastDay = new Date(year, monthIndex + 1, 0);
    const startPadding = firstDay.getDay(); // Days to show from previous month

    const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    // Generate day cells
    let daysHtml = '';

    // Previous month padding
    const prevMonth = new Date(year, monthIndex, 0);
    for (let i = startPadding - 1; i >= 0; i--) {
        const day = prevMonth.getDate() - i;
        daysHtml += `<div class="calendar-day other-month">${day}</div>`;
    }

    // Current month days
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(year, monthIndex, day);
        const dateKey = formatDateKey(date);
        const dayData = appState.practiceCalendar?.[dateKey];
        const hasActivity = dayData && dayData.sessions > 0;
        const isToday = dateKey === todayKey;
        const level = getActivityLevel(dateKey);

        let classes = 'calendar-day';
        if (isToday) classes += ' today';
        if (hasActivity) {
            classes += ' has-activity';
            if (level >= 4) classes += ' high';
        }

        const title = hasActivity ?
            `${dayData.sessions} session(s), ${Math.round(dayData.activeMs / 60000)}min, +${dayData.levelsGained || 0} levels` :
            '';

        daysHtml += `
            <div class="${classes}" title="${title}">
                ${day}
                ${dayData?.levelsGained > 0 ? '<div class="calendar-day-dot"></div>' : ''}
            </div>
        `;
    }

    // Next month padding
    const endPadding = 42 - (startPadding + lastDay.getDate()); // 6 rows * 7 days
    for (let i = 1; i <= endPadding && i <= 7; i++) {
        daysHtml += `<div class="calendar-day other-month">${i}</div>`;
    }

    const monthName = month.toLocaleDateString('en-AU', { month: 'long', year: 'numeric' });

    container.innerHTML = `
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" data-action="prev">‚Üê</button>
                    <span class="calendar-month-year">${monthName}</span>
                    <button class="calendar-nav-btn" data-action="next">‚Üí</button>
                </div>
            </div>
            <div class="calendar-weekdays">
                ${weekdays.map(d => `<div class="calendar-weekday">${d}</div>`).join('')}
            </div>
            <div class="calendar-days">
                ${daysHtml}
            </div>
        </div>
    `;

    // Add navigation listeners
    container.querySelectorAll('.calendar-nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const action = btn.dataset.action;
            const newMonth = new Date(year, monthIndex + (action === 'prev' ? -1 : 1), 1);
            renderCalendarView(containerId, newMonth);
        });
    });
}

/**
 * Render bar graph
 * @param {string} containerId - The container element ID
 * @param {number} days - Number of days to show (7, 14, or 30)
 */
function renderBarGraph(containerId, days = 7) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayKey = formatDateKey(today);

    // Gather data for the period
    const data = [];
    let maxMinutes = 1; // Avoid division by zero
    let totalMinutes = 0;
    let totalSessions = 0;
    let activeDays = 0;

    for (let i = days - 1; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateKey = formatDateKey(date);
        const dayData = appState.practiceCalendar?.[dateKey];
        const minutes = dayData ? Math.round(dayData.activeMs / 60000) : 0;

        if (minutes > maxMinutes) maxMinutes = minutes;
        if (minutes > 0) {
            activeDays++;
            totalMinutes += minutes;
            totalSessions += dayData.sessions;
        }

        data.push({
            date,
            dateKey,
            minutes,
            sessions: dayData?.sessions || 0,
            isToday: dateKey === todayKey
        });
    }

    // Generate bars
    const barsHtml = data.map(d => {
        const height = Math.max(2, (d.minutes / maxMinutes) * 100);
        let classes = 'bar-graph-bar';
        if (d.isToday) classes += ' today';
        if (d.minutes === 0) classes += ' no-activity';

        const dayLabel = d.date.toLocaleDateString('en-AU', { weekday: 'short' });
        const tooltip = d.minutes > 0 ?
            `${dayLabel}: ${d.minutes}min, ${d.sessions} session(s)` :
            `${dayLabel}: No activity`;

        return `
            <div class="${classes}" style="height: ${height}%;" title="${tooltip}">
                <div class="bar-graph-tooltip">${tooltip}</div>
            </div>
        `;
    }).join('');

    // Labels (show first, middle, last)
    const firstLabel = data[0].date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
    const lastLabel = data[data.length - 1].date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });

    container.innerHTML = `
        <div class="bar-graph-container">
            <div class="bar-graph-header">
                <span class="bar-graph-title">Activity</span>
                <div class="bar-graph-period-selector">
                    <button class="bar-graph-period-btn ${days === 7 ? 'active' : ''}" data-days="7">7d</button>
                    <button class="bar-graph-period-btn ${days === 14 ? 'active' : ''}" data-days="14">14d</button>
                    <button class="bar-graph-period-btn ${days === 30 ? 'active' : ''}" data-days="30">30d</button>
                </div>
            </div>
            <div class="bar-graph">
                ${barsHtml}
            </div>
            <div class="bar-graph-labels">
                <span>${firstLabel}</span>
                <span>${lastLabel}</span>
            </div>
            <div class="bar-graph-summary">
                <div class="bar-graph-stat">
                    <div class="bar-graph-stat-value">${activeDays}</div>
                    <div class="bar-graph-stat-label">active days</div>
                </div>
                <div class="bar-graph-stat">
                    <div class="bar-graph-stat-value">${totalMinutes}</div>
                    <div class="bar-graph-stat-label">total minutes</div>
                </div>
                <div class="bar-graph-stat">
                    <div class="bar-graph-stat-value">${totalSessions}</div>
                    <div class="bar-graph-stat-label">sessions</div>
                </div>
            </div>
        </div>
    `;

    // Add period selector listeners
    container.querySelectorAll('.bar-graph-period-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const newDays = parseInt(btn.dataset.days);
            renderBarGraph(containerId, newDays);
        });
    });
}

// ============================================
// TOPIC LOADING - PHASE 1 CORE
// ============================================

/**
 * Show/hide loading indicator
 */
function showTopicLoading(show, text = 'Loading...') {
    const indicator = document.getElementById('topic-loading-indicator');
    const overlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    
    if (indicator) {
        indicator.classList.toggle('active', show);
    }
    
    if (overlay) {
        overlay.classList.toggle('active', show);
    }
    
    if (loadingText) {
        loadingText.textContent = text;
    }
}

/**
 * Update the current topic display in the header
 */
function updateTopicCurrentDisplay() {
    const display = document.getElementById('topic-current-name');
    if (display) {
        if (appState.topic) {
            display.textContent = `${appState.topic.name} (${appState.topic.yearLevel})`;
        } else {
            display.textContent = 'No topic selected';
        }
    }
}

/**
 * Load manifest.json from server
 */
async function loadManifest() {
    try {
        showTopicLoading(true, 'Loading curriculum...');
        
        const response = await fetch('manifest.json');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        manifest = await response.json();

        // Ensure selector bar is visible (in case it was previously hidden)
        const selectorBar = document.querySelector('.topic-selector-bar');
        if (selectorBar) {
            selectorBar.style.display = '';
        }

        // Populate year level dropdown
        populateYearLevelDropdown();
        
        // Try to restore previous selection
        restoreDropdownSelection();
        
        // Resize dropdowns to fit content
        resizeAllDropdowns();
        
        console.log('Manifest loaded:', manifest.yearLevels?.length, 'year levels');
        
    } catch (error) {
        console.log('Manifest not available:', error.message);
        showToast('Could not load curriculum manifest', 'warning');
        
        // Hide the topic selector if no manifest
        const selectorBar = document.querySelector('.topic-selector-bar');
        if (selectorBar) {
            selectorBar.style.display = 'none';
        }
    } finally {
        showTopicLoading(false);
    }
}

/**
 * Load a topic from server - fetches topic.json and all subtopic files
 * @param {string} topicPath - Base path like "topics/vce-unit3/biology/"
 * @returns {object|null} - Merged topic data with subtopics populated
 */
async function loadTopicFromServer(topicPath) {
    try {
        showTopicLoading(true, 'Loading topic...');
        
        // Ensure path ends with /
        if (!topicPath.endsWith('/')) {
            topicPath += '/';
        }
        
        // 1. Load topic.json
        const topicUrl = `${topicPath}topic.json`;
        console.log('Loading topic from:', topicUrl);
        
        const topicResponse = await fetch(topicUrl);
        if (!topicResponse.ok) {
            throw new Error(`Could not load topic.json (HTTP ${topicResponse.status})`);
        }
        
        const topicData = await topicResponse.json();
        
        // Validate basic structure
        if (!topicData.name || !topicData.subtopics || !Array.isArray(topicData.subtopics)) {
            throw new Error('Invalid topic format: missing name or subtopics');
        }
        
        console.log('Topic loaded:', topicData.name, 'with', topicData.subtopics.length, 'subtopics');
        
        // 2. Load each subtopic file
        showTopicLoading(true, 'Loading subtopics...');
        
        const subtopicsWithItems = await Promise.all(
            topicData.subtopics.map(async (subtopicRef) => {
                try {
                    const subtopicUrl = `${topicPath}subtopics/${subtopicRef.file || subtopicRef.id + '.json'}`;
                    console.log('Loading subtopic:', subtopicUrl);
                    
                    const subtopicResponse = await fetch(subtopicUrl);
                    if (!subtopicResponse.ok) {
                        console.warn(`Could not load subtopic ${subtopicRef.id}: HTTP ${subtopicResponse.status}`);
                        // Return a minimal subtopic with no items
                        return {
                            id: subtopicRef.id,
                            name: subtopicRef.name,
                            icon: subtopicRef.icon || 'üìÑ',
                            what: '',
                            why: '',
                            items: [],
                            _loadError: true
                        };
                    }
                    
                    const subtopicData = await subtopicResponse.json();
                    
                    // Merge ref data with file data (file takes precedence)
                    return {
                        id: subtopicData.id || subtopicRef.id,
                        name: subtopicData.name || subtopicRef.name,
                        icon: subtopicData.icon || subtopicRef.icon || 'üìÑ',
                        what: subtopicData.what || '',
                        why: subtopicData.why || '',
                        items: subtopicData.items || []
                    };
                    
                } catch (error) {
                    console.error(`Error loading subtopic ${subtopicRef.id}:`, error);
                    return {
                        id: subtopicRef.id,
                        name: subtopicRef.name,
                        icon: subtopicRef.icon || 'üìÑ',
                        what: '',
                        why: '',
                        items: [],
                        _loadError: true
                    };
                }
            })
        );
        
        // 3. Merge subtopics into topic data
        topicData.subtopics = subtopicsWithItems;
        
        // Count total items
        const totalItems = subtopicsWithItems.reduce((sum, st) => sum + (st.items?.length || 0), 0);
        console.log('Topic fully loaded:', totalItems, 'learning points');
        
        return topicData;
        
    } catch (error) {
        console.error('Failed to load topic:', error);
        showToast(`Failed to load topic: ${error.message}`, 'error');
        return null;
    } finally {
        showTopicLoading(false);
    }
}

/**
 * Load questions for a specific learning point
 * @param {string} uuid - The learning point UUID
 * @returns {object|null} - Question data or null if not available
 */
async function loadQuestionsForItem(uuid) {
    // Check cache first
    if (questionsCache[uuid]) {
        return questionsCache[uuid];
    }

    if (!appState.currentTopicPath) {
        return null;
    }

    try {
        const questionUrl = `${appState.currentTopicPath}questions/q-${uuid}.json`;
        const response = await fetch(questionUrl);

        if (!response.ok) {
            // KNOWN ISSUE (Bug #4 ‚Äî documented 2026-01-31):
            // Negative caching: when a fetch returns a non-200 status (e.g. 404, 503),
            // we cache null for this UUID. On subsequent calls, the cache check above
            // returns null immediately ‚Äî the student will never see questions for this
            // item again during the session, even if the server recovers.
            //
            // For a genuine 404 (file doesn't exist) this is fine and avoids repeated
            // failed fetches. But for transient errors (503 Service Unavailable, network
            // hiccup, timeout), caching null is incorrect ‚Äî the questions may become
            // available later.
            //
            // FIX: Only cache null for 404 responses (file genuinely missing). For
            // other HTTP errors (5xx, 429, etc.), do NOT cache ‚Äî let the next call
            // retry the fetch. Alternatively, cache with a short TTL (e.g. 30 seconds)
            // for non-404 errors, or use a retry counter that allows N retries before
            // giving up.
            //
            // Example fix:
            //   if (response.status === 404) {
            //       questionsCache[uuid] = null;  // genuinely missing, safe to cache
            //   }
            //   // else: don't cache, allow retry on next call
            //
            console.log(`No questions for ${uuid} (HTTP ${response.status})`);
            questionsCache[uuid] = null;
            return null;
        }

        const questionData = await response.json();
        questionsCache[uuid] = questionData;
        return questionData;

    } catch (error) {
        // KNOWN ISSUE (Bug #4 continued):
        // Network errors (offline, DNS failure, CORS, timeout) also cache null,
        // permanently blocking retry for this UUID within the session.
        // Same fix applies: do not cache null on network errors, only on 404.
        console.log(`Could not load questions for ${uuid}:`, error.message);
        questionsCache[uuid] = null;
        return null;
    }
}

/**
 * Check if questions exist for a learning point (from cache or fetch)
 */
async function hasQuestionsForItem(uuid) {
    const questions = await loadQuestionsForItem(uuid);
    return questions !== null;
}

/**
 * Get questions for a specific level transition
 */
async function getQuestionsForLevel(itemKey, toLevel) {
    // Find the item to get its UUID
    const item = getItemByKey(itemKey);
    if (!item || !item.uuid) {
        return [];
    }
    
    const questionData = await loadQuestionsForItem(item.uuid);
    if (!questionData) {
        return [];
    }
    
    const levelKey = `toLevel${toLevel}`;
    return questionData[levelKey] || [];
}

/**
 * Get an item by its numeric ID
 */
function getItemById(itemId) {
    if (!appState.topic) return null;
    for (const subtopic of appState.topic.subtopics) {
        const item = subtopic.items?.find(i => i.id === itemId);
        if (item) return item;
    }
    return null;
}

/**
 * Switch to a new topic
 */
async function switchTopic(topicId, topicPath) {
    // Save current progress before switching
    saveCurrentTopicProgress();
    
    // Clear questions cache for new topic
    questionsCache = {};
    
    // Load topic data from server
    const topicData = await loadTopicFromServer(topicPath);
    
    if (topicData) {
        // Set new topic
        appState.topic = topicData;
        appState.currentTopicId = topicId;
        appState.currentTopicPath = topicPath.endsWith('/') ? topicPath : topicPath + '/';
        
        // Update class from topic if provided
        if (topicData.class) {
            appState.student.class = topicData.class;
            const classInput = document.getElementById('class-input');
            if (classInput) classInput.value = topicData.class;
        }
        
        // Restore or initialize progress for this topic (use path as unique key)
        restoreTopicProgress(appState.currentTopicPath);
        
        // Initialize any new learning items
        initLearningItems();
        
        // Save and render
        saveData();
        renderAll();
        updateTopicCurrentDisplay();
        
        showToast(`Loaded: ${topicData.name}`, 'success');
    }
}

/**
 * Save current topic progress before switching
 */
function saveCurrentTopicProgress() {
    if (appState.currentTopicPath) {
        topicProgressStore[appState.currentTopicPath] = {
            learningItems: { ...appState.learningItems },
            checkins: [...appState.checkins],
            goals: [...appState.goals],
            questions: [...appState.questions],
            // Growth Character System data (per-topic)
            sessions: [...appState.sessions],
            practiceCalendar: { ...appState.practiceCalendar },
            quizStats: JSON.parse(JSON.stringify(appState.quizStats)), // deep copy
            growthCharacters: [...appState.growthCharacters]
        };
    }
}

/**
 * Restore progress for a topic (or initialize fresh)
 */
function restoreTopicProgress(topicPath) {
    if (topicProgressStore[topicPath]) {
        const stored = topicProgressStore[topicPath];
        appState.learningItems = stored.learningItems || {};
        appState.checkins = stored.checkins || [];
        appState.goals = stored.goals || [];
        appState.questions = stored.questions || [];
        // Growth Character System data (with migration for existing topics)
        appState.sessions = stored.sessions || [];
        appState.practiceCalendar = stored.practiceCalendar || {};
        appState.quizStats = stored.quizStats || {};
        appState.growthCharacters = stored.growthCharacters || [];
    } else {
        // Fresh start for this topic
        appState.learningItems = {};
        appState.checkins = [];
        appState.goals = [];
        appState.questions = [];
        // Growth Character System - fresh start
        appState.sessions = [];
        appState.practiceCalendar = {};
        appState.quizStats = {};
        appState.growthCharacters = [];
    }

    // Reset session tracking when switching topics
    currentSession = null;
    lastInteractionTime = null;
    if (sessionIdleTimeout) {
        clearTimeout(sessionIdleTimeout);
        sessionIdleTimeout = null;
    }
}

// ============================================
// DROPDOWN POPULATION
// ============================================

function populateYearLevelDropdown() {
    const dropdown = document.getElementById('year-level-dropdown');
    if (!dropdown || !manifest) return;
    
    dropdown.innerHTML = '<option value="">Select Year Level</option>';
    
    manifest.yearLevels.forEach(yearLevel => {
        const option = document.createElement('option');
        option.value = yearLevel.id;
        option.textContent = yearLevel.name;
        dropdown.appendChild(option);
    });
}

function populateSubjectDropdown(yearLevelId) {
    const dropdown = document.getElementById('subject-dropdown');
    const topicDropdown = document.getElementById('topic-dropdown');
    
    if (!dropdown || !manifest) return;
    
    // Reset subject and topic dropdowns
    dropdown.innerHTML = '<option value="">Select Subject</option>';
    dropdown.disabled = true;
    topicDropdown.innerHTML = '<option value="">Select Topic</option>';
    topicDropdown.disabled = true;
    selectedSubject = null;
    
    if (!yearLevelId) return;
    
    const yearLevel = manifest.yearLevels.find(y => y.id === yearLevelId);
    if (!yearLevel) return;
    
    yearLevel.subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject.id;
        option.textContent = `${subject.icon || ''} ${subject.name}`.trim();
        dropdown.appendChild(option);
    });
    
    dropdown.disabled = false;
}

function populateTopicDropdown(yearLevelId, subjectId) {
    const dropdown = document.getElementById('topic-dropdown');
    
    if (!dropdown || !manifest) return;
    
    dropdown.innerHTML = '<option value="">Select Topic</option>';
    dropdown.disabled = true;
    
    if (!yearLevelId || !subjectId) return;
    
    const yearLevel = manifest.yearLevels.find(y => y.id === yearLevelId);
    if (!yearLevel) return;
    
    const subject = yearLevel.subjects.find(s => s.id === subjectId);
    if (!subject || !subject.topics) return;
    
    // Add topics with availability status
    subject.topics.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic.id;
        option.dataset.path = topic.path;
        
        const availability = topicAvailabilityCache[topic.path];
        if (availability && availability.available === false) {
            // Topic confirmed unavailable
            option.textContent = `${topic.name} (unavailable)`;
            option.disabled = true;
            option.classList.add('unavailable');
        } else if (availability && availability.available === true) {
            // Topic confirmed available
            option.textContent = topic.name;
        } else {
            // Unknown - show as pending check
            option.textContent = `${topic.name}`;
        }
        
        dropdown.appendChild(option);
    });
    
    dropdown.disabled = false;
    
    // Check availability for unchecked topics in background
    checkTopicsAvailability(subject.topics);
}

// ============================================
// TOPIC AVAILABILITY CHECKING
// ============================================

/**
 * Load availability cache from localStorage
 */
function loadAvailabilityCache() {
    try {
        const saved = localStorage.getItem(TOPIC_AVAILABILITY_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            // Filter out expired entries
            const now = Date.now();
            Object.keys(parsed).forEach(path => {
                if (parsed[path].checkedAt && (now - parsed[path].checkedAt) < AVAILABILITY_CACHE_DURATION) {
                    topicAvailabilityCache[path] = parsed[path];
                }
            });
        }
    } catch (e) {
        console.warn('Failed to load availability cache:', e);
        topicAvailabilityCache = {};
    }
}

/**
 * Save availability cache to localStorage
 */
function saveAvailabilityCache() {
    try {
        localStorage.setItem(TOPIC_AVAILABILITY_KEY, JSON.stringify(topicAvailabilityCache));
    } catch (e) {
        console.warn('Failed to save availability cache:', e);
    }
}

/**
 * Check if a single topic is available (has topic.json)
 */
async function checkTopicAvailability(topicPath) {
    const normalizedPath = topicPath.endsWith('/') ? topicPath : topicPath + '/';
    const topicJsonUrl = normalizedPath + 'topic.json';
    
    try {
        const response = await fetch(topicJsonUrl, { method: 'HEAD' });
        const available = response.ok;
        
        topicAvailabilityCache[topicPath] = {
            available,
            checkedAt: Date.now()
        };
        
        saveAvailabilityCache();
        return available;
    } catch (e) {
        // Network error - mark as unavailable
        topicAvailabilityCache[topicPath] = {
            available: false,
            checkedAt: Date.now()
        };
        saveAvailabilityCache();
        return false;
    }
}

/**
 * Check availability for multiple topics (in background)
 */
async function checkTopicsAvailability(topics) {
    const uncheckedTopics = topics.filter(topic => {
        const cached = topicAvailabilityCache[topic.path];
        // Check if not cached or cache expired
        if (!cached) return true;
        if ((Date.now() - cached.checkedAt) > AVAILABILITY_CACHE_DURATION) return true;
        return false;
    });
    
    if (uncheckedTopics.length === 0) return;
    
    // Check each topic and update dropdown as results come in
    for (const topic of uncheckedTopics) {
        await checkTopicAvailability(topic.path);
        updateTopicOptionStatus(topic);
    }
}

/**
 * Update a single topic option in the dropdown after availability check
 */
function updateTopicOptionStatus(topic) {
    const dropdown = document.getElementById('topic-dropdown');
    if (!dropdown) return;
    
    const option = dropdown.querySelector(`option[data-path="${topic.path}"]`);
    if (!option) return;
    
    const availability = topicAvailabilityCache[topic.path];
    if (availability && availability.available === false) {
        option.textContent = `${topic.name} (unavailable)`;
        option.disabled = true;
        option.classList.add('unavailable');
    } else if (availability && availability.available === true) {
        option.textContent = topic.name;
        option.disabled = false;
        option.classList.remove('unavailable');
    }
}

/**
 * Force refresh availability for all topics in current subject
 */
async function refreshTopicAvailability() {
    if (!selectedYearLevel || !selectedSubject || !manifest) {
        showToast('Select a year level and subject first', 'warning');
        return;
    }
    
    const yearLevel = manifest.yearLevels.find(y => y.id === selectedYearLevel);
    if (!yearLevel) return;
    
    const subject = yearLevel.subjects.find(s => s.id === selectedSubject);
    if (!subject || !subject.topics) return;
    
    // Clear cache for these topics
    subject.topics.forEach(topic => {
        delete topicAvailabilityCache[topic.path];
    });
    saveAvailabilityCache();
    
    // Re-populate dropdown (will trigger fresh checks)
    populateTopicDropdown(selectedYearLevel, selectedSubject);
    
    showToast('Refreshing topic availability...', 'info');
}

/**
 * Refresh all topic availability (for settings/manual refresh)
 */
async function refreshAllTopicAvailability() {
    topicAvailabilityCache = {};
    saveAvailabilityCache();
    
    // Re-populate current dropdown if applicable
    if (selectedYearLevel && selectedSubject) {
        populateTopicDropdown(selectedYearLevel, selectedSubject);
    }
    
    showToast('Topic availability cache cleared', 'info');
}

// Dropdown event handlers
function onYearLevelChange(event) {
    selectedYearLevel = event.target.value;
    populateSubjectDropdown(selectedYearLevel);
    clearCurrentTopic();
    saveDropdownSelection();
    resizeAllDropdowns();
}

function onSubjectChange(event) {
    selectedSubject = event.target.value;
    populateTopicDropdown(selectedYearLevel, selectedSubject);
    clearCurrentTopic();
    saveDropdownSelection();
    resizeAllDropdowns();
}

function onTopicChange(event) {
    const select = event.target;
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption && selectedOption.value) {
        const topicId = selectedOption.value;
        const topicPath = selectedOption.dataset.path;
        saveDropdownSelection();
        switchTopic(topicId, topicPath);
    } else {
        // "Select Topic" placeholder selected - clear current topic
        clearCurrentTopic();
        saveDropdownSelection();
    }
    resizeDropdownToFit('topic-dropdown');
}

/**
 * Clear the current topic and update UI
 */
function clearCurrentTopic() {
    // Save progress for current topic before clearing
    saveCurrentTopicProgress();
    
    // Clear topic state
    appState.topic = null;
    appState.currentTopicId = null;
    appState.currentTopicPath = null;
    appState.learningItems = {};
    appState.checkins = [];
    appState.goals = [];
    appState.questions = [];
    
    // Update UI
    renderLearningContent();
    renderOverview();
    renderHistory();
    renderGoals();
    renderQuestions();
    updateTopicCurrentDisplay();
}

// Save/restore dropdown selection
function saveDropdownSelection() {
    const selection = {
        yearLevel: selectedYearLevel,
        subject: selectedSubject,
        topicId: document.getElementById('topic-dropdown')?.value || null
    };
    localStorage.setItem(DROPDOWN_SELECTION_KEY, JSON.stringify(selection));
}

function restoreDropdownSelection() {
    try {
        const saved = localStorage.getItem(DROPDOWN_SELECTION_KEY);
        if (!saved || !manifest) return;
        
        const selection = JSON.parse(saved);
        
        // Restore year level
        if (selection.yearLevel) {
            const yearDropdown = document.getElementById('year-level-dropdown');
            if (yearDropdown) {
                yearDropdown.value = selection.yearLevel;
                selectedYearLevel = selection.yearLevel;
                populateSubjectDropdown(selection.yearLevel);
            }
        }
        
        // Restore subject
        if (selection.subject) {
            const subjectDropdown = document.getElementById('subject-dropdown');
            if (subjectDropdown) {
                subjectDropdown.value = selection.subject;
                selectedSubject = selection.subject;
                populateTopicDropdown(selection.yearLevel, selection.subject);
            }
        }
        
        // Restore topic selection (visual only - if topic already loaded, don't reload)
        if (selection.topicId && appState.currentTopicId === selection.topicId) {
            const topicDropdown = document.getElementById('topic-dropdown');
            if (topicDropdown) {
                topicDropdown.value = selection.topicId;
            }
        }
        
        // Resize dropdowns to fit restored selections
        resizeAllDropdowns();
    } catch (e) {
        console.log('Could not restore dropdown selection:', e);
    }
}
// ============================================
// CALCULATIONS
// ============================================
function calculateStats() {
    const items = Object.values(appState.learningItems);
    const total = items.length || 1;
    
    const counts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    let totalScore = 0;
    
    items.forEach(item => {
        counts[item.level]++;
        totalScore += item.level;
    });
    
    const avgLevel = totalScore / total;
    const overallPercentage = Math.round(((avgLevel - 1) / 4) * 100);
    
    return {
        total,
        counts,
        avgLevel,
        overallPercentage,
        secured: counts[5],
        confident: counts[4],
        developing: counts[3],
        beginning: counts[2],
        notStarted: counts[1]
    };
}

function calculateSubtopicProgress(subtopic) {
    let totalScore = 0;
    let count = 0;
    
    if (!subtopic.items) return 0;
    
    subtopic.items.forEach(item => {
        const itemKey = getItemKey(subtopic.id, item.id);
        const itemData = appState.learningItems[itemKey];
        if (itemData) {
            totalScore += itemData.level;
            count++;
        }
    });
    
    if (count === 0) return 0;
    const avgLevel = totalScore / count;
    return Math.round(((avgLevel - 1) / 4) * 100);
}

function getFocusAreas() {
    const items = [];
    
    if (!appState.topic || !appState.topic.subtopics) return items;
    
    appState.topic.subtopics.forEach(subtopic => {
        if (!subtopic.items) return;
        subtopic.items.forEach(item => {
            const itemKey = getItemKey(subtopic.id, item.id);
            const itemData = appState.learningItems[itemKey];
            if (itemData && itemData.level <= 2) {
                items.push({
                    ...item,
                    itemKey: itemKey, // Store the composite key
                    subtopicId: subtopic.id,
                    subtopic: subtopic.name,
                    level: itemData.level
                });
            }
        });
    });
    
    return items.slice(0, 5);
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

/**
 * Create a unique key for a learning item (combines subtopic + item IDs)
 */
function getItemKey(subtopicId, itemId) {
    return `${subtopicId}__${itemId}`;
}

/**
 * Parse a composite item key back into subtopicId and itemId
 */
function parseItemKey(key) {
    const parts = key.split('__');
    return {
        subtopicId: parts[0],
        itemId: parseInt(parts[1])
    };
}

/**
 * Get an item by its composite key
 */
function getItemByKey(itemKey) {
    if (!appState.topic) return null;
    const { subtopicId, itemId } = parseItemKey(itemKey);
    
    const subtopic = appState.topic.subtopics.find(st => st.id === subtopicId);
    if (!subtopic || !subtopic.items) return null;
    
    return subtopic.items.find(i => i.id === itemId);
}

/**
 * Get subtopic by its ID
 */
function getSubtopicById(subtopicId) {
    if (!appState.topic) return null;
    return appState.topic.subtopics.find(st => st.id === subtopicId);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

/**
 * Measure and resize a dropdown to fit its current selection
 */
function resizeDropdownToFit(selectId) {
    const select = document.getElementById(selectId);
    const measure = document.getElementById('dropdown-measure');
    
    if (!select || !measure) return;
    
    // Get the text of the selected option
    const selectedOption = select.options[select.selectedIndex];
    const text = selectedOption ? selectedOption.textContent : '';
    
    // Measure the text width
    measure.textContent = text;
    const textWidth = measure.offsetWidth;
    
    // Add space for dropdown arrow and padding (35px)
    const minWidth = 80;
    const arrowPadding = 35;
    const newWidth = Math.max(minWidth, textWidth + arrowPadding);
    
    select.style.width = newWidth + 'px';
}

/**
 * Resize all topic dropdowns to fit their selections
 */
function resizeAllDropdowns() {
    resizeDropdownToFit('year-level-dropdown');
    resizeDropdownToFit('subject-dropdown');
    resizeDropdownToFit('topic-dropdown');
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <span>${type === 'success' ? '‚úî' : type === 'error' ? '‚úó' : type === 'warning' ? '‚ö†' : '‚Ñπ'}</span>
        <span>${escapeHtml(message)}</span>
    `;
    
    container.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 200);
    }, 3000);
}

// ============================================
// RENDERING - MAIN
// ============================================
function renderAll() {
    renderStudentInfo();
    renderOverview();
    renderLearningContent();
    renderHistory();
    renderGoals();
    renderQuestions();
    renderDataSummary();
    renderLevelLegends();
    updateBadges();
}

function renderStudentInfo() {
    const nameDisplay = document.getElementById('student-name-display');
    if (nameDisplay) {
        nameDisplay.textContent = appState.student.name || 'Student';
    }
    
    const nameInput = document.getElementById('student-name-input');
    if (nameInput) nameInput.value = appState.student.name || '';
    
    const classInput = document.getElementById('class-input');
    if (classInput) classInput.value = appState.student.class || '';
}

function renderOverview() {
    // Topic info
    const topicNameEl = document.getElementById('topic-name-display');
    if (topicNameEl) {
        topicNameEl.textContent = appState.topic 
            ? `${appState.topic.name} ‚Ä¢ ${appState.topic.yearLevel}` 
            : 'Your Progress';
    }
    
    // Stats
    const stats = calculateStats();
    
    const overallPercentEl = document.getElementById('overall-percentage');
    if (overallPercentEl) overallPercentEl.textContent = stats.overallPercentage + '%';
    
    const progressFillEl = document.getElementById('overall-progress-fill');
    if (progressFillEl) progressFillEl.style.width = stats.overallPercentage + '%';
    
    const progressStatsEl = document.getElementById('progress-stats');
    if (progressStatsEl) {
        progressStatsEl.innerHTML = `
            <div class="progress-stat">
                <div class="progress-stat-value" style="color: var(--level-1)">${stats.notStarted}</div>
                <div class="progress-stat-label">Not Started</div>
            </div>
            <div class="progress-stat">
                <div class="progress-stat-value" style="color: var(--level-2)">${stats.beginning}</div>
                <div class="progress-stat-label">Beginning</div>
            </div>
            <div class="progress-stat">
                <div class="progress-stat-value" style="color: var(--level-3)">${stats.developing}</div>
                <div class="progress-stat-label">Developing</div>
            </div>
            <div class="progress-stat">
                <div class="progress-stat-value" style="color: var(--level-4)">${stats.confident}</div>
                <div class="progress-stat-label">Confident</div>
            </div>
            <div class="progress-stat">
                <div class="progress-stat-value" style="color: var(--level-5)">${stats.secured}</div>
                <div class="progress-stat-label">Secured</div>
            </div>
        `;
    }
    
    // Quick stats
    const totalCheckinsEl = document.getElementById('total-checkins');
    if (totalCheckinsEl) totalCheckinsEl.textContent = appState.checkins.length;
    
    const itemsSecuredEl = document.getElementById('items-secured');
    if (itemsSecuredEl) itemsSecuredEl.textContent = stats.secured;
    
    // Last check-in
    const lastCheckinEl = document.getElementById('last-checkin-date');
    if (lastCheckinEl) {
        if (appState.checkins.length > 0) {
            const lastCheckin = appState.checkins[appState.checkins.length - 1];
            lastCheckinEl.textContent = new Date(lastCheckin.date).toLocaleDateString();
        } else {
            lastCheckinEl.textContent = '‚Äî';
        }
    }
    
    // Focus areas
    const focusAreas = getFocusAreas();
    const focusContainer = document.getElementById('focus-areas');
    
    if (focusContainer) {
        if (!appState.topic) {
            focusContainer.innerHTML = `
                <div class="empty-state" style="padding: var(--space-4);">
                    <p class="empty-state-desc">Select a topic to see your focus areas.</p>
                </div>
            `;
        } else if (focusAreas.length === 0) {
            focusContainer.innerHTML = `
                <div class="empty-state" style="padding: var(--space-4);">
                    <p class="empty-state-desc">
                        ${stats.total === stats.secured ? 
                            'üéâ Amazing. You\'ve secured all content.' : 
                            'Complete a check-in to identify your focus areas.'}
                    </p>
                </div>
            `;
        } else {
            focusContainer.innerHTML = focusAreas.map(item => `
                <div class="goal-item focus-area-link" style="border-left-color: var(--level-${item.level}); cursor: pointer;" 
                     data-item-key="${item.itemKey}" 
                     title="Click to go to this item">
                    <div class="goal-text">${escapeHtml(item.title)}</div>
                    <div class="goal-meta">${escapeHtml(item.subtopic)} ‚Ä¢ ${escapeHtml(item.code)} <span style="color: var(--color-primary);">‚Üí Go</span></div>
                </div>
            `).join('');
            
            // Add click handlers
            focusContainer.querySelectorAll('.focus-area-link').forEach(el => {
                el.addEventListener('click', () => {
                    const itemKey = el.dataset.itemKey;
                    navigateToLearningItem(itemKey);
                });
            });
        }
    }

    // Update Growth Character overview card
    updateGrowthCharacterOverviewCard();

    // Render activity visualizations (streak + mini heatmap)
    renderStreakCounter('overview-streak-container');
    renderHeatmapGrid('overview-heatmap-container', 8); // 8 weeks for mini view
}

// ============================================
// RENDERING - LEARNING CONTENT
// ============================================
function renderLearningContent() {
    const container = document.getElementById('topics-container');
    const learningPanel = document.getElementById('learning-panel');
    
    // Add/remove check-in mode styling
    if (learningPanel) {
        learningPanel.classList.toggle('checkin-mode-active', checkinModeActive);
    }
    
    if (!appState.topic || !appState.topic.subtopics) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìö</div>
                <div class="empty-state-title">No topic loaded</div>
                <p class="empty-state-desc">Select a year level, subject, and topic from the dropdowns above to get started.</p>
            </div>
        `;
        return;
    }
    
    // Update header
    const topicTitleEl = document.getElementById('topic-title');
    if (topicTitleEl) topicTitleEl.textContent = appState.topic.name;
    
    const curriculumCodeEl = document.getElementById('curriculum-code');
    if (curriculumCodeEl) {
        curriculumCodeEl.textContent = `${appState.topic.subject} ‚Ä¢ ${appState.topic.yearLevel}${appState.topic.curriculumCode ? ' ‚Ä¢ ' + appState.topic.curriculumCode : ''}`;
    }
    
    // Check-in mode banner
    const checkinBanner = checkinModeActive ? `
        <div class="checkin-mode-banner">
            <div class="checkin-mode-info">
                <span class="checkin-mode-type">${checkinTypeLabels[currentCheckinType]} Check-in</span>
                <span class="checkin-mode-progress" id="checkin-progress-text">0/${Object.keys(checkinStartLevels).length} items reviewed</span>
            </div>
            <button class="checkin-stop-btn" onclick="stopCheckinMode(false)">‚èπ Stop Check-in</button>
        </div>
    ` : '';
    
    // Render subtopics
    container.innerHTML = checkinBanner + appState.topic.subtopics.map(subtopic => {
        const progress = calculateSubtopicProgress(subtopic);
        const headerId = `subtopic-${subtopic.id}-header`;
        const contentId = `subtopic-${subtopic.id}-content`;
        const hasSubtopicExplanation = subtopic.what || subtopic.why;
        
        // Check for load error
        const loadErrorBadge = subtopic._loadError ? `<span class="no-quiz-badge" title="Could not load subtopic content">‚ö†Ô∏è Load error</span>` : '';
        
        return `
            <div class="topic-section" data-subtopic-id="${subtopic.id}">
                <div class="topic-header" id="${headerId}" aria-expanded="${checkinModeActive ? 'true' : 'false'}" aria-controls="${contentId}">
                    <div class="topic-header-left">
                        <div class="topic-icon">${subtopic.icon || 'üìÑ'}</div>
                        <div class="topic-info">
                            <div class="topic-title">${escapeHtml(subtopic.name)} ${loadErrorBadge}</div>
                            <div class="topic-meta">
                                <span>${subtopic.items?.length || 0} learning outcomes</span>
                            </div>
                        </div>
                    </div>
                    <div class="topic-progress">
                        <div class="topic-progress-bar">
                            <div class="topic-progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="topic-progress-text">${progress}%</div>
                    </div>
                    <span class="topic-toggle">‚ñº</span>
                </div>
                <div class="topic-content ${checkinModeActive ? 'expanded' : ''}" id="${contentId}">
                    ${hasSubtopicExplanation ? renderSubtopicExplanation(subtopic) : ''}
                    ${(subtopic.items || []).map(item => renderLearningItem(item, subtopic)).join('')}
                </div>
            </div>
        `;
    }).join('');
    
    setupLearningContentListeners();
}

function renderSubtopicExplanation(subtopic) {
    const explanationId = `subtopic-explanation-${subtopic.id}`;
    const explanationContentId = `subtopic-explanation-content-${subtopic.id}`;
    
    return `
        <div class="subtopic-explanation-wrapper">
            <button class="explanation-toggle subtopic-explanation-toggle" id="${explanationId}" aria-expanded="false" aria-controls="${explanationContentId}">
                <span class="explanation-toggle-icon">‚ñº</span>
                <span>üìñ What is this section about & Why does it matter?</span>
            </button>
            <div class="explanation-content subtopic-explanation-content" id="${explanationContentId}">
                ${subtopic.what ? `
                    <div class="explanation-section">
                        <div class="explanation-heading">
                            <span class="explanation-heading-icon">üìñ</span> What is this section?
                        </div>
                        <p class="explanation-text">${escapeHtml(subtopic.what)}</p>
                    </div>
                ` : ''}
                ${subtopic.why ? `
                    <div class="explanation-section">
                        <div class="explanation-heading">
                            <span class="explanation-heading-icon">üí°</span> Why does it matter?
                        </div>
                        <p class="explanation-text">${escapeHtml(subtopic.why)}</p>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function renderLearningItem(item, subtopic) {
    const itemKey = getItemKey(subtopic.id, item.id);
    const data = appState.learningItems[itemKey] || { level: 1, history: [], notes: [] };
    const explanationId = `explanation-${subtopic.id}-${item.id}`;
    const explanationContentId = `explanation-content-${subtopic.id}-${item.id}`;

    const hasExplanation = item.what || item.why || item.example;

    // Consolidation data for level 5 items
    const isSecured = data.level === 5;
    const consolidation = data.consolidation || { qAttempted: 0, qCorrect: 0, qTotal: 0, isConsolidated: false };
    
    // Get last change date
    const lastChange = data.history.length > 0 ? data.history[data.history.length - 1] : null;
    const lastChangeText = lastChange 
        ? `${new Date(lastChange.date).toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })} ${new Date(lastChange.date).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' })}`
        : '';
    
    // Check-in mode: get "was" level
    const wasLevel = getWasLevel(itemKey);
    const isReviewed = checkinReviewedItems.has(itemKey);
    
    // Get current emojis based on preference
    const emojis = getLevelEmojis();
    
    // Build notch content based on display mode
    const getNotchContent = (level) => {
        const emoji = emojis[level - 1];
        const color = levelPrefs.colors[level - 1];
        
        if (levelPrefs.displayMode === 'dots') {
            return `<span class="notch-dot" style="background: ${color}"></span>`;
        } else if (levelPrefs.displayMode === 'emoji') {
            return emoji;
        } else { // both
            return `<span class="notch-dot" style="background: ${color}"></span><span class="notch-emoji">${emoji}</span>`;
        }
    };
    
    // Build notch selector
    const notchesHtml = `
        <div class="level-notches" data-item-key="${itemKey}" role="radiogroup" aria-label="Understanding level">
            ${[1, 2, 3, 4, 5].map(level => {
                const isFilled = level <= data.level;
                const isActive = level === data.level;
                // Check for direct lock on this level
                const isDirectlyLocked = level > data.level && isLevelLocked(itemKey, level);
                // Check for cascade lock (a lower level is blocking this one)
                const isCascadeLocked = level > data.level && !isDirectlyLocked && isAnyLevelLockedBelow(itemKey, data.level, level);
                const isLocked = isDirectlyLocked || isCascadeLocked;
                const lockType = isDirectlyLocked ? 'direct' : (isCascadeLocked ? 'cascade' : '');
                return `<button class="level-notch ${isFilled ? 'filled' : ''} ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''} ${isCascadeLocked ? 'cascade-locked' : ''}"
                    data-level="${level}"
                    data-label="${levelNames[level - 1]}"
                    data-lock-type="${lockType}"
                    role="radio"
                    aria-checked="${isActive}"
                    aria-label="${emojis[level - 1]} ${levelNames[level - 1]}${isDirectlyLocked ? ' (locked)' : ''}${isCascadeLocked ? ' (blocked)' : ''}"
                    tabindex="${isActive ? '0' : '-1'}">${getNotchContent(level)}</button>`;
            }).join('')}
        </div>
    `;
    
    // Build "was" level display
    const getWasLevelDisplay = (level) => {
        const emoji = emojis[level - 1];
        const color = levelPrefs.colors[level - 1];
        const name = levelNames[level - 1];
        
        if (levelPrefs.displayMode === 'dots') {
            return `<span class="notch-dot" style="background: ${color}"></span> ${name}`;
        } else if (levelPrefs.displayMode === 'emoji') {
            return `${emoji} ${name}`;
        } else {
            return `<span class="notch-dot" style="background: ${color}"></span> ${emoji} ${name}`;
        }
    };
    
    // Build controls based on mode
    let controlsHtml;
    if (checkinModeActive) {
        controlsHtml = `
            <div class="level-controls-checkin">
                <div class="level-was">Was: <span class="level-was-value" data-level="${wasLevel}">${getWasLevelDisplay(wasLevel)}</span></div>
                ${notchesHtml}
            </div>
        `;
    } else {
        controlsHtml = notchesHtml;
    }

    // Build consolidation row for secured items (level 5)
    let consolidationHtml = '';
    if (isSecured && !checkinModeActive && item.uuid) {
        const progressPercent = consolidation.qTotal > 0
            ? Math.round((consolidation.qAttempted / consolidation.qTotal) * 100)
            : 0;

        // Check if we know questions don't exist (cache set to null after 404)
        const questionsKnownMissing = questionsCache[item.uuid] === null;

        if (consolidation.isConsolidated) {
            consolidationHtml = `
                <div class="consolidation-row">
                    <div class="consolidation-progress">
                        <span class="consolidation-complete">‚úì Consolidated</span>
                        <span class="consolidation-text">${consolidation.qCorrect}/${consolidation.qTotal} correct</span>
                    </div>
                </div>
            `;
        } else if (questionsKnownMissing) {
            // Questions file doesn't exist - don't show practice option
            consolidationHtml = '';
        } else {
            consolidationHtml = `
                <div class="consolidation-row">
                    <button class="practice-more-btn" data-item-key="${itemKey}" data-uuid="${item.uuid || ''}">
                        Practice More
                    </button>
                    <div class="consolidation-progress">
                        <div class="consolidation-bar">
                            <div class="consolidation-bar-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <span class="consolidation-text">${consolidation.qAttempted}/${consolidation.qTotal || '?'} questions</span>
                    </div>
                </div>
            `;
        }
    }

    return `
        <div class="learning-item-simple ${isReviewed ? 'reviewed' : ''}" data-level="${data.level}" data-item-key="${itemKey}" data-uuid="${item.uuid || ''}">
            <div class="learning-item-row">
                <div class="learning-item-left">
                    <span class="learning-item-title">${escapeHtml(item.title)}</span>
                    <span class="learning-item-code">${escapeHtml(item.code)}</span>
                    ${hasExplanation ? `<button class="help-toggle-inline" id="${explanationId}" aria-expanded="false" aria-controls="${explanationContentId}">What Why Example</button>` : ''}
                    ${lastChangeText ? `<span class="learning-item-updated">${lastChangeText}</span>` : ''}
                </div>
                <div class="learning-item-right">
                    ${controlsHtml}
                </div>
            </div>
            ${consolidationHtml}
            ${hasExplanation ? `
                <div class="help-content-inline" id="${explanationContentId}">
                    ${item.what ? `<span class="help-inline-item"><strong>üìñ What:</strong> ${escapeHtml(item.what)}</span>` : ''}
                    ${item.why ? `<span class="help-inline-item"><strong>üí° Why:</strong> ${escapeHtml(item.why)}</span>` : ''}
                    ${item.example ? `<span class="help-inline-item"><strong>‚úèÔ∏è Example:</strong> ${escapeHtml(item.example)}</span>` : ''}
                </div>
            ` : ''}
        </div>
    `;
}

function setupLearningContentListeners() {
    // Topic headers (subtopic collapsing)
    document.querySelectorAll('.topic-header').forEach(header => {
        header.addEventListener('click', () => {
            const expanded = header.getAttribute('aria-expanded') === 'true';
            header.setAttribute('aria-expanded', !expanded);
            document.getElementById(header.getAttribute('aria-controls')).classList.toggle('expanded', !expanded);
        });
    });
    
    // Level notches - main interaction
    document.querySelectorAll('.level-notch').forEach(notch => {
        notch.addEventListener('click', (e) => {
            e.stopPropagation();
            const notchContainer = notch.closest('.level-notches');
            const itemKey = notchContainer.dataset.itemKey;
            const level = parseInt(notch.dataset.level);
            const currentLevel = appState.learningItems[itemKey]?.level || 1;

            // Check if this level is locked
            if (notch.classList.contains('locked')) {
                const lockType = notch.dataset.lockType;

                if (lockType === 'cascade') {
                    // Find the blocking level and show appropriate message
                    const blockingLevel = findBlockingLevel(itemKey, currentLevel, level);
                    const remaining = getLockoutRemainingTime(itemKey, blockingLevel);
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    showToast(`Complete Level ${blockingLevel} first (locked for ${mins}:${secs.toString().padStart(2, '0')})`, 'error');
                } else {
                    // Direct lock on this level
                    const remaining = getLockoutRemainingTime(itemKey, level);
                    const mins = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    showToast(`Locked for ${mins}:${secs.toString().padStart(2, '0')}`, 'error');
                }
                return;
            }

            // Mark as reviewed in check-in mode
            if (checkinModeActive) {
                markItemReviewed(itemKey);
            }

            // Update level (may trigger quiz for upward moves)
            handleLevelChange(itemKey, level);
        });
        
        // Keyboard navigation
        notch.addEventListener('keydown', (e) => {
            const notchContainer = notch.closest('.level-notches');
            const notches = Array.from(notchContainer.querySelectorAll('.level-notch'));
            const currentIndex = notches.indexOf(notch);
            
            let newIndex = currentIndex;
            if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
                newIndex = Math.min(currentIndex + 1, notches.length - 1);
                e.preventDefault();
            } else if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
                newIndex = Math.max(currentIndex - 1, 0);
                e.preventDefault();
            }
            
            if (newIndex !== currentIndex) {
                notches[newIndex].focus();
                notches[newIndex].click();
            }
        });
    });
    
    // Help toggles
    document.querySelectorAll('.help-toggle-inline').forEach(toggle => {
        toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const expanded = toggle.getAttribute('aria-expanded') === 'true';
            toggle.setAttribute('aria-expanded', !expanded);
            const content = document.getElementById(toggle.getAttribute('aria-controls'));
            if (content) content.classList.toggle('expanded', !expanded);

            // Track content expansion (Growth Character System)
            if (!expanded) {
                const itemEl = toggle.closest('.learning-item-simple');
                if (itemEl) {
                    const itemKey = itemEl.dataset.itemKey;
                    trackContentExpansion(itemKey, 'all');
                }
            }
        });
    });
    
    // Subtopic explanation toggles
    document.querySelectorAll('.explanation-toggle').forEach(toggle => {
        toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const expanded = toggle.getAttribute('aria-expanded') === 'true';
            toggle.setAttribute('aria-expanded', !expanded);
            const content = document.getElementById(toggle.getAttribute('aria-controls'));
            if (content) content.classList.toggle('expanded', !expanded);
        });
    });

    // Practice More buttons (consolidation)
    document.querySelectorAll('.practice-more-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const itemKey = btn.dataset.itemKey;
            const uuid = btn.dataset.uuid;
            if (itemKey && uuid) {
                startConsolidationPractice(itemKey, uuid);
            }
        });
    });
}

// ============================================
// RENDERING - HISTORY
// ============================================
function renderHistory() {
    const container = document.getElementById('checkin-timeline');
    
    if (!appState.topic || !appState.topic.subtopics) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <div class="empty-state-title">No topic loaded</div>
                <p class="empty-state-desc">Load a topic to see progress.</p>
            </div>
        `;
        return;
    }
    
    // Calculate stats
    let totalItems = 0;
    let totalPoints = 0;
    let maxPoints = 0;
    let levelCounts = [0, 0, 0, 0, 0];
    
    appState.topic.subtopics.forEach(subtopic => {
        if (!subtopic.items) return;
        subtopic.items.forEach(item => {
            const itemKey = getItemKey(subtopic.id, item.id);
            const itemData = appState.learningItems[itemKey] || { level: 1 };
            levelCounts[itemData.level - 1]++;
            totalPoints += itemData.level;
            totalItems++;
            maxPoints += 5;
        });
    });
    
    const overallPercentage = maxPoints > 0 ? Math.round((totalPoints / maxPoints) * 100) : 0;
    
    // Get current emojis
    const emojis = getLevelEmojis();
    
    // Build level distribution
    const levelDistributionHtml = levelCounts.map((count, i) => {
        const percent = totalItems > 0 ? (count / totalItems * 100) : 0;
        if (percent === 0) return '';
        return `<div class="level-segment" data-level="${i + 1}" style="width: ${percent}%" title="${emojis[i]} ${levelNames[i]}: ${count}"></div>`;
    }).join('');
    
    // Render
    container.innerHTML = `
        <div class="overall-progress">
            <div class="overall-progress-header">
                <div class="overall-progress-title">üìà Overall Progress</div>
                <div class="overall-progress-percent">${overallPercentage}%</div>
            </div>
            <div class="overall-progress-bar">
                <div class="overall-progress-fill" style="width: ${overallPercentage}%"></div>
            </div>
            <div class="overall-progress-stats">
                <div class="overall-stat"><span class="overall-stat-value">${totalItems}</span> items</div>
                <div class="overall-stat"><span class="overall-stat-value">${levelCounts[4]}</span> secured</div>
                <div class="overall-stat"><span class="overall-stat-value">${levelCounts[3]}</span> confident</div>
            </div>
        </div>
        
        <div class="card" style="margin-bottom: var(--space-3);">
            <div class="card-title" style="margin-bottom: var(--space-2);">Level Distribution</div>
            <div class="level-distribution">${levelDistributionHtml}</div>
            <div class="level-distribution-legend">
                ${levelCounts.map((count, i) => count > 0 ? `
                    <div class="level-legend-item">
                        <span class="level-legend-dot" data-level="${i + 1}"></span>
                        <span>${emojis[i]} ${count}</span>
                    </div>
                ` : '').join('')}
            </div>
        </div>
        
        ${appState.checkins.length === 0 ? `
            <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <div class="empty-state-title">No check-ins recorded</div>
                <p class="empty-state-desc">Start a check-in to track your progress over time.</p>
            </div>
        ` : `
            <div class="card">
                <div class="card-title">Check-in History</div>
                ${appState.checkins.slice().reverse().slice(0, 10).map(checkin => `
                    <div class="goal-item" style="border-left-color: var(--color-primary);">
                        <div class="goal-text">${checkinTypeLabels[checkin.type] || 'Check-in'}</div>
                        <div class="goal-meta">${new Date(checkin.date).toLocaleDateString()} ‚Ä¢ ${checkin.itemsReviewed || 0} items reviewed</div>
                    </div>
                `).join('')}
            </div>
        `}
    `;

    // Render activity visualizations (calendar + bar graph)
    renderCalendarView('history-calendar-container');
    renderBarGraph('history-bargraph-container');
}

// ============================================
// RENDERING - GOALS & QUESTIONS
// ============================================
function renderGoals() {
    const container = document.getElementById('goals-list');
    
    if (appState.goals.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üéØ</div>
                <div class="empty-state-title">No goals set</div>
                <p class="empty-state-desc">Set goals to help focus your learning.</p>
            </div>
        `;
    } else {
        container.innerHTML = appState.goals.map((goal, index) => `
            <div class="goal-item" data-index="${index}">
                <div class="goal-text">${escapeHtml(goal.text)}</div>
                <div class="goal-meta">
                    Added ${new Date(goal.created).toLocaleDateString()}
                    <button class="btn btn-sm btn-secondary" style="padding: 2px 8px; margin-left: 8px;" onclick="deleteGoal(${index})">√ó</button>
                </div>
            </div>
        `).join('');
    }
}

function renderQuestions() {
    const container = document.getElementById('questions-list');
    
    if (appState.questions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p class="empty-state-desc">No questions yet. If you're stuck, ask here.</p>
            </div>
        `;
    } else {
        container.innerHTML = appState.questions.map((question, index) => `
            <div class="goal-item" style="border-left-color: var(--color-info);" data-index="${index}">
                <div class="goal-text">${escapeHtml(question.text)}</div>
                <div class="goal-meta">
                    ${question.context ? `About: ${escapeHtml(question.context)} ‚Ä¢ ` : ''}
                    ${new Date(question.created).toLocaleDateString()}
                    <button class="btn btn-sm btn-secondary" style="padding: 2px 8px; margin-left: 8px;" onclick="deleteQuestion(${index})">√ó</button>
                </div>
            </div>
        `).join('');
    }
}

function renderDataSummary() {
    const container = document.getElementById('data-summary');
    if (!container) return;
    
    const stats = calculateStats();
    
    container.innerHTML = `
        <div class="stat-row">
            <span class="stat-label">Current topic</span>
            <span class="stat-value">${appState.topic?.name || 'None'}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Learning items</span>
            <span class="stat-value">${stats.total}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Check-ins completed</span>
            <span class="stat-value">${appState.checkins.length}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Goals set</span>
            <span class="stat-value">${appState.goals.length}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Questions asked</span>
            <span class="stat-value">${appState.questions.length}</span>
        </div>
    `;
}

function updateBadges() {
    const goalsBadge = document.getElementById('goals-badge');
    if (goalsBadge) {
        const count = appState.goals.length + appState.questions.length;
        goalsBadge.textContent = count;
        goalsBadge.style.display = count > 0 ? 'inline' : 'none';
    }
}
// ============================================
// QUIZ STATE HELPERS
// ============================================
function getQuizStateKey(itemKey, toLevel) {
    return `${appState.currentTopicPath || 'default'}-${itemKey}-toLevel${toLevel}`;
}

function getQuizStateForItem(itemKey, toLevel) {
    const key = getQuizStateKey(itemKey, toLevel);
    if (!quizState[key]) {
        quizState[key] = {
            usedQuestions: [],
            wrongCount: 0,
            correctStreak: 0,
            requiredCorrect: 1,
            lockedUntil: null
        };
    }
    return quizState[key];
}

function isLevelLocked(itemKey, toLevel) {
    const state = getQuizStateForItem(itemKey, toLevel);
    if (state.lockedUntil) {
        if (Date.now() < state.lockedUntil) {
            return true;
        } else {
            // Lockout expired, reset
            state.usedQuestions = [];
            state.wrongCount = 0;
            state.correctStreak = 0;
            state.requiredCorrect = 1;
            state.lockedUntil = null;
            saveQuizState();
        }
    }
    return false;
}

function getLockoutRemainingTime(itemKey, toLevel) {
    const state = getQuizStateForItem(itemKey, toLevel);
    if (state.lockedUntil && Date.now() < state.lockedUntil) {
        return Math.ceil((state.lockedUntil - Date.now()) / 1000);
    }
    return 0;
}

/**
 * Check if any level between current and target is locked (cascade lock)
 * Returns true if any intermediate level is locked, blocking access to higher levels
 */
function isAnyLevelLockedBelow(itemKey, currentLevel, targetLevel) {
    for (let lvl = currentLevel + 1; lvl <= targetLevel; lvl++) {
        if (isLevelLocked(itemKey, lvl)) {
            return true;
        }
    }
    return false;
}

/**
 * Find the first (lowest) level that is blocking access to higher levels
 * Returns the blocking level number, or null if no level is blocking
 */
function findBlockingLevel(itemKey, currentLevel, targetLevel) {
    for (let lvl = currentLevel + 1; lvl <= targetLevel; lvl++) {
        if (isLevelLocked(itemKey, lvl)) {
            return lvl;
        }
    }
    return null;
}

// ============================================
// LEVEL CHANGE HANDLING
// ============================================
async function handleLevelChange(itemKey, newLevel) {
    const currentLevel = appState.learningItems[itemKey]?.level || 1;
    
    // Pre-topic check-in: allow free level changes without quizzes ONLY if setting is enabled
    const isPreTopicCheckin = checkinModeActive && currentCheckinType === 'pre';
    const shouldSkipQuiz = isPreTopicCheckin && appState.skipPreTopicQuestions;
    
    if (newLevel > currentLevel) {
        // Moving UP - check if quiz needed
        if (shouldSkipQuiz) {
            // Pre-topic with skip enabled: skip quiz, allow immediate change
            applyLevelChange(itemKey, newLevel);
        } else {
            const questions = await getQuestionsForLevel(itemKey, newLevel);
            
            if (questions.length > 0) {
                // Show quiz
                showQuiz(itemKey, currentLevel, newLevel);
            } else {
                // No questions available - allow immediate change
                applyLevelChange(itemKey, newLevel);
            }
        }
    } else if (newLevel < currentLevel) {
        // Moving DOWN - allow immediately
        applyLevelChange(itemKey, newLevel);
    }
    // Same level - do nothing
}

function applyLevelChange(itemKey, level) {
    if (!appState.learningItems[itemKey]) {
        appState.learningItems[itemKey] = { level: 1, history: [], notes: [] };
    }
    
    const oldLevel = appState.learningItems[itemKey].level;
    
    if (oldLevel !== level) {
        appState.learningItems[itemKey].level = level;
        appState.learningItems[itemKey].history.push({
            date: new Date().toISOString(),
            level: level,
            previousLevel: oldLevel
        });

        // Track level gain in practice calendar (Growth Character System)
        trackLevelGain(oldLevel, level);

        // Update visuals immediately
        const notchContainer = document.querySelector(`.level-notches[data-item-key="${itemKey}"]`);
        if (notchContainer) {
            notchContainer.querySelectorAll('.level-notch').forEach(notch => {
                const notchLevel = parseInt(notch.dataset.level);
                notch.classList.toggle('filled', notchLevel <= level);
                notch.classList.toggle('active', notchLevel === level);
                notch.setAttribute('aria-checked', notchLevel === level);
                notch.setAttribute('tabindex', notchLevel === level ? '0' : '-1');
            });
        }
        
        // Update item border color
        const itemEl = document.querySelector(`.learning-item-simple[data-item-key="${itemKey}"]`);
        if (itemEl) {
            itemEl.dataset.level = level;
        }

        // If reached level 5 (secured), re-render to show consolidation row
        if (level === 5) {
            renderLearningContentPreserveState();
        }

        saveData();
        pushProgressToServer('level-change', {
            learningPointCode: itemKey,
            currentLevel: level,
            overallPercent: calculateStats()?.overallPercentage || 0
        });
        renderOverview();
        renderHistory();
    }
}

// ============================================
// CONSOLIDATION PRACTICE
// ============================================

/**
 * Start consolidation practice for a secured item
 * This picks questions the student hasn't attempted yet
 * @param {string} itemKey - The learning item key
 * @param {string} uuid - The item's UUID for fetching questions
 */
async function startConsolidationPractice(itemKey, uuid) {
    // Fetch all questions for this item (uses same loader as regular quizzes)
    const questionData = await fetchQuestionsForUUID(uuid);
    if (!questionData) {
        showToast('No practice questions available for this item.', 'info');
        // Re-render to hide the button now that we know questions don't exist
        renderLearningContentPreserveState();
        return;
    }

    // Flatten all questions from all levels into one array
    // Question data format is: { toLevel2: [...], toLevel3: [...], toLevel4: [...], toLevel5: [...] }
    const allQuestions = [];
    for (let level = 2; level <= 5; level++) {
        const levelKey = `toLevel${level}`;
        const questions = questionData[levelKey];
        if (Array.isArray(questions)) {
            questions.forEach((q, idx) => {
                allQuestions.push({
                    question: q,
                    level: level,
                    originalIndex: idx,
                    // Create a unique key for tracking: "level-index" format
                    globalIndex: allQuestions.length
                });
            });
        }
    }

    if (allQuestions.length === 0) {
        showToast('No questions available for practice.', 'warning');
        renderLearningContentPreserveState();
        return;
    }

    // Update consolidation total now that we know the question count
    const itemData = appState.learningItems[itemKey];
    if (itemData && itemData.consolidation) {
        itemData.consolidation.qTotal = allQuestions.length;
        saveData();
    }

    // Get quiz stats to find unattempted questions
    const lpStats = appState.quizStats[itemKey] || {};

    // Find questions not yet attempted (for consolidation tracking)
    const unattemptedQuestions = allQuestions.filter(q => {
        const qKey = String(q.globalIndex);
        return !lpStats[qKey] || lpStats[qKey].attempts === 0;
    });

    // If all attempted, allow re-practice of any question
    const questionsToUse = unattemptedQuestions.length > 0 ? unattemptedQuestions : allQuestions;

    // Pick a random question
    const randomQ = questionsToUse[Math.floor(Math.random() * questionsToUse.length)];

    // Get the item for display
    const displayItem = getItemByKey(itemKey);
    if (!displayItem) {
        showToast('Item not found.', 'error');
        return;
    }

    // Normalize question from any schema variant to standard format
    normalizeQuestion(randomQ.question);

    // Determine question type
    const questionType = randomQ.question.type || 'mc';

    // Store current quiz data (consolidation mode)
    currentQuiz = {
        itemKey,
        fromLevel: 5,  // Already secured
        toLevel: 5,    // Staying at secured
        questionIndex: randomQ.globalIndex,
        question: randomQ.question,
        questionType,
        selectedIndex: null,
        clozeAnswers: {},
        answered: false,
        isConsolidation: true  // Flag for consolidation mode
    };

    // Update header UI for consolidation mode
    document.getElementById('quiz-item-title').textContent = displayItem.title;
    document.getElementById('quiz-from-level').innerHTML = `<span style="color: var(--level-5);">Practice</span>`;
    document.getElementById('quiz-to-level').innerHTML = `<span style="color: var(--level-5);">Consolidation</span>`;

    // Hide streak info for consolidation
    document.getElementById('quiz-streak-info').style.display = 'none';

    // Render based on question type
    if (questionType === 'cloze') {
        renderClozeQuestion(randomQ.question);
    } else {
        // MC and TF both render as multiple-choice style
        renderMCQuestion(randomQ.question);
    }

    // Reset result section
    document.getElementById('quiz-result').classList.remove('visible', 'correct', 'incorrect');
    document.getElementById('cloze-feedback').style.display = 'none';
    document.getElementById('quiz-submit-btn').disabled = true;
    document.getElementById('quiz-submit-btn').textContent = 'Check Answer';
    document.getElementById('quiz-cancel-btn').style.display = '';
    document.getElementById('quiz-cancel-btn-footer').style.display = '';

    // Show overlay
    document.getElementById('quiz-overlay').classList.add('active');
}

/**
 * Fetch questions for a UUID (used by consolidation)
 * Uses the same loading mechanism as the regular quiz system
 * @param {string} uuid - The item UUID
 * @returns {object|null} Question data
 */
async function fetchQuestionsForUUID(uuid) {
    // Use the existing loadQuestionsForItem which handles caching and correct path
    return await loadQuestionsForItem(uuid);
}

// ============================================
// QUIZ DISPLAY - MAIN ENTRY
// ============================================
async function showQuiz(itemKey, fromLevel, toLevel) {
    console.log('showQuiz called with:', { itemKey, fromLevel, toLevel });
    
    const item = getItemByKey(itemKey);
    if (!item) {
        console.log('showQuiz: item not found');
        return false;
    }
    
    const questions = await getQuestionsForLevel(itemKey, toLevel);
    console.log('showQuiz: questions loaded:', questions.length);
    if (questions.length === 0) {
        console.log('showQuiz: no questions, returning false');
        return false;
    }
    
    const state = getQuizStateForItem(itemKey, toLevel);
    console.log('showQuiz: quiz state:', state);
    
    // Select a random question
    const questionData = selectRandomQuestion(questions, state);
    if (!questionData) {
        console.log('showQuiz: no questionData from selectRandomQuestion');
        return false;
    }
    
    const { question, index } = questionData;

    // Normalize question from any schema variant to standard format
    normalizeQuestion(question);

    // Determine question type (default to MC for backwards compatibility)
    const questionType = question.type || 'mc';

    // Store current quiz data
    currentQuiz = {
        itemKey,
        fromLevel,
        toLevel,
        questionIndex: index,
        question,
        questionType,
        selectedIndex: null,
        clozeAnswers: {},
        answered: false
    };

    // Update header UI
    document.getElementById('quiz-item-title').textContent = item.title;
    const emojis = getLevelEmojis();
    document.getElementById('quiz-from-level').innerHTML = getLevelIndicatorHtml(fromLevel, true);
    document.getElementById('quiz-to-level').innerHTML = getLevelIndicatorHtml(toLevel, true);

    // Show streak info if required > 1
    const streakInfo = document.getElementById('quiz-streak-info');
    if (state.requiredCorrect > 1) {
        streakInfo.style.display = 'block';
        document.getElementById('quiz-streak-text').textContent =
            `You need ${state.requiredCorrect} correct answer${state.requiredCorrect > 1 ? 's' : ''} to advance`;

        // Render progress dots
        const progressContainer = document.getElementById('quiz-streak-progress');
        let dotsHtml = '';
        for (let i = 0; i < state.requiredCorrect; i++) {
            const filled = i < state.correctStreak;
            dotsHtml += `<span class="quiz-streak-dot ${filled ? 'filled' : ''}"></span>`;
        }
        progressContainer.innerHTML = dotsHtml;
    } else {
        streakInfo.style.display = 'none';
    }

    // Render based on question type
    if (questionType === 'cloze') {
        renderClozeQuestion(question);
    } else {
        // MC and TF both render as multiple-choice style
        renderMCQuestion(question);
    }
    
    // Reset result section
    document.getElementById('quiz-result').classList.remove('visible', 'correct', 'incorrect');
    document.getElementById('cloze-feedback').style.display = 'none';
    document.getElementById('quiz-submit-btn').disabled = true;
    document.getElementById('quiz-submit-btn').textContent = 'Check Answer';
    document.getElementById('quiz-cancel-btn').style.display = '';
    document.getElementById('quiz-cancel-btn-footer').style.display = '';
    
    // Show overlay
    document.getElementById('quiz-overlay').classList.add('active');
    
    return true;
}

function selectRandomQuestion(questions, state) {
    if (questions.length === 0) return null;
    
    // Find unused questions
    let availableIndices = [];
    for (let i = 0; i < questions.length; i++) {
        if (!state.usedQuestions.includes(i)) {
            availableIndices.push(i);
        }
    }
    
    // If all used, reshuffle
    if (availableIndices.length === 0) {
        state.usedQuestions = [];
        availableIndices = questions.map((_, i) => i);
        saveQuizState();
    }
    
    // Pick random
    const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
    return { question: questions[randomIndex], index: randomIndex };
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

/**
 * Normalize a question object from any known schema variant into the standard schema.
 * Standard MC/TF: { type, question, correct, correctExplanation, distractors: [{answer, explanation}] }
 * Standard Cloze: { type, prompt, sentence, blanks: { id: {correct, correctExplanation, distractors} } }
 * Returns the normalized question (may mutate the original).
 *
 * CHANGE LOG (2026-01-31):
 * Added to fix a crash where renderMCQuestion() would throw:
 *   "Uncaught TypeError: Cannot read properties of undefined (reading 'forEach')"
 * on question.distractors.forEach(). Root cause: question JSON files across the
 * codebase use 11 different schema variants (generated by different prompt templates).
 * Some use "correctAnswer" instead of "correct", "MC" instead of "mc", "stem" instead
 * of "question", "options" with embedded correct flags, "correctIndex" integers,
 * Anki-style {{c1::answer}} cloze syntax, [[answer]] bracket syntax, etc.
 *
 * This function is called in showQuiz() and startConsolidationPractice() BEFORE
 * rendering, and maps all known variants to the standard schema so the renderers
 * and validators only need to handle one format.
 *
 * Handles these known MC/TF schema variants:
 *   1. {options: [{text, correct: true/false}], question}
 *   2. {options: [string], correctIndex: N, stem, bloom, feedback}
 *   3. {options: [string], correct: "text", distractorExplanations}
 *   4. {correctAnswer: "text", distractors: [...]} (correctAnswer instead of correct)
 *   5. {statement, correct: boolean, explanation} (TF with boolean)
 *   6. {stem, correctAnswer, feedback: {correct, incorrect}, bloom} (TF alt)
 *
 * Handles these known Cloze schema variants:
 *   7. {template, blanks} (template instead of sentence)
 *   8. {segments: [...], blanks} (segments array instead of sentence string)
 *   9. {question: "{{c1::answer}}", correct} (Anki-style cloze deletion)
 *  10. {question: "[[answer]]", correctAnswer, distractors}
 *  11. {prompt: "{{blank:1}}", correctAnswer, distractors} (no blanks object)
 *  12. blanks with {correctIndex, options} instead of {correct, distractors}
 */
function normalizeQuestion(q) {
    if (!q || typeof q !== 'object') return q;

    // Normalize type to lowercase
    if (q.type) {
        q.type = q.type.toLowerCase();
    } else {
        q.type = 'mc';
    }

    // --- MC and TF normalization ---
    if (q.type === 'mc' || q.type === 'tf') {

        // Normalize question text: stem -> question
        if (!q.question && q.stem) {
            q.question = q.stem;
        }
        if (!q.question && q.statement) {
            q.question = q.statement;
        }

        // Normalize correct answer: correctAnswer -> correct
        if (q.correct === undefined && q.correctAnswer !== undefined) {
            q.correct = q.correctAnswer;
        }

        // Schema: {options: [{text, correct: true/false, ...}], question}
        // Options array with embedded correct flag
        if (Array.isArray(q.options) && q.options.length > 0 && typeof q.options[0] === 'object' && 'correct' in q.options[0]) {
            const correctOpt = q.options.find(o => o.correct === true);
            if (correctOpt && q.correct === undefined) {
                q.correct = correctOpt.text || correctOpt.answer || correctOpt.value || '';
                q.correctExplanation = q.correctExplanation || correctOpt.explanation || '';
            }
            if (!Array.isArray(q.distractors) || q.distractors.length === 0) {
                q.distractors = q.options
                    .filter(o => !o.correct)
                    .map(o => ({ answer: o.text || o.answer || o.value || '', explanation: o.explanation || '' }));
            }
        }

        // Schema: {options: [string, ...], correctIndex: N, stem, bloom, feedback}
        if (Array.isArray(q.options) && q.options.length > 0 && typeof q.options[0] === 'string' && q.correctIndex !== undefined) {
            if (q.correct === undefined) {
                q.correct = q.options[q.correctIndex] || q.options[0];
                q.correctExplanation = q.correctExplanation || (q.feedback && q.feedback.correct) || '';
            }
            if (!Array.isArray(q.distractors) || q.distractors.length === 0) {
                q.distractors = q.options
                    .filter((_, i) => i !== q.correctIndex)
                    .map(text => ({ answer: text, explanation: (q.feedback && q.feedback.incorrect) || '' }));
            }
        }

        // Schema: {options: [string, ...], correct: "answer text", distractorExplanations}
        if (Array.isArray(q.options) && q.options.length > 0 && typeof q.options[0] === 'string' && q.correct && (!Array.isArray(q.distractors) || q.distractors.length === 0)) {
            const explanations = q.distractorExplanations || {};
            q.distractors = q.options
                .filter(text => text !== q.correct)
                .map((text, i) => ({ answer: text, explanation: explanations[i] || explanations[text] || '' }));
        }

        // TF with boolean correct and explanation field
        if (q.type === 'tf') {
            if (typeof q.correct === 'boolean') {
                q.correct = q.correct ? 'True' : 'False';
            }
            if (!q.correctExplanation && q.explanation) {
                q.correctExplanation = q.explanation;
            }
            if (!q.correctExplanation && q.feedback) {
                if (typeof q.feedback === 'string') {
                    q.correctExplanation = q.feedback;
                } else if (q.feedback.correct) {
                    q.correctExplanation = q.feedback.correct;
                }
            }
            // TF must have at least the opposite as a distractor
            if (!Array.isArray(q.distractors) || q.distractors.length === 0) {
                const opposite = q.correct === 'True' ? 'False' : 'True';
                const wrongExplanation = (q.feedback && typeof q.feedback === 'object' && q.feedback.incorrect) || '';
                q.distractors = [{ answer: opposite, explanation: wrongExplanation }];
            }
        }

        // Final safety: ensure distractors is a valid array
        if (!Array.isArray(q.distractors)) {
            q.distractors = [];
        }

        // Ensure correct has a value
        if (q.correct === undefined || q.correct === null) {
            q.correct = '(no answer provided)';
        }

        // Ensure correctExplanation exists
        if (!q.correctExplanation) {
            q.correctExplanation = '';
        }
    }

    // --- Cloze normalization ---
    if (q.type === 'cloze') {

        // Normalize prompt text
        if (!q.prompt) {
            q.prompt = q.stem || q.question || 'Complete the sentence:';
        }

        // Schema: {template, blanks} -> sentence = template
        if (!q.sentence && q.template) {
            q.sentence = q.template;
        }

        // Schema: {segments: [...], blanks: {...}} -> build sentence from segments
        if (!q.sentence && Array.isArray(q.segments)) {
            let built = '';
            q.segments.forEach(seg => {
                if (typeof seg === 'string') {
                    built += seg;
                } else if (seg.blank) {
                    built += `{{blank:${seg.blank}}}`;
                } else if (seg.blankId) {
                    built += `{{blank:${seg.blankId}}}`;
                }
            });
            q.sentence = built;
        }

        // Schema: {question: "text with {{c1::answer}} Anki-style", correct}
        // Convert Anki-style cloze to standard blanks
        if (!q.sentence && q.question && q.question.includes('{{c')) {
            let blankCounter = 0;
            const blanks = {};
            q.sentence = q.question.replace(/\{\{c(\d+)::([^}]+)\}\}/g, (match, cNum, answer) => {
                blankCounter++;
                const id = String(blankCounter);
                blanks[id] = {
                    correct: answer,
                    correctExplanation: q.correctExplanation || '',
                    distractors: Array.isArray(q.distractors) ? q.distractors : []
                };
                return `{{blank:${id}}}`;
            });
            if (!q.blanks && Object.keys(blanks).length > 0) {
                q.blanks = blanks;
            }
        }

        // Schema: {question: "text with [[answer]]", correctAnswer, distractors}
        if (!q.sentence && q.question && q.question.includes('[[')) {
            let blankCounter = 0;
            const blanks = {};
            q.sentence = q.question.replace(/\[\[([^\]]+)\]\]/g, (match, answer) => {
                blankCounter++;
                const id = String(blankCounter);
                blanks[id] = {
                    correct: q.correctAnswer || answer,
                    correctExplanation: q.correctExplanation || '',
                    distractors: Array.isArray(q.distractors) ? q.distractors : []
                };
                return `{{blank:${id}}}`;
            });
            if (!q.blanks && Object.keys(blanks).length > 0) {
                q.blanks = blanks;
            }
        }

        // Schema: {prompt: "text with {{blank:1}}", correctAnswer, distractors} (no blanks object)
        if (q.sentence && !q.blanks && q.correctAnswer) {
            const blankMatches = q.sentence.match(/\{\{blank:([^}]+)\}\}/g);
            if (blankMatches) {
                q.blanks = {};
                blankMatches.forEach(m => {
                    const id = m.replace(/\{\{blank:|\}\}/g, '');
                    q.blanks[id] = {
                        correct: q.correctAnswer,
                        correctExplanation: q.correctExplanation || '',
                        distractors: Array.isArray(q.distractors) ? q.distractors : []
                    };
                });
            }
        }

        // Normalize blanks that use correctIndex instead of correct
        if (q.blanks && typeof q.blanks === 'object') {
            Object.keys(q.blanks).forEach(id => {
                const b = q.blanks[id];
                if (b.correctIndex !== undefined && Array.isArray(b.options)) {
                    b.correct = b.options[b.correctIndex] || '';
                    if (!Array.isArray(b.distractors) || b.distractors.length === 0) {
                        b.distractors = b.options
                            .filter((_, i) => i !== b.correctIndex)
                            .map(text => ({ answer: text, explanation: '' }));
                    }
                }
                if (!b.correctExplanation) {
                    b.correctExplanation = (b.feedback && b.feedback.correct) || '';
                }
                if (!Array.isArray(b.distractors)) {
                    b.distractors = [];
                }
            });
        }

        // Final safety for cloze
        if (!q.sentence) {
            q.sentence = q.prompt || '(question text missing)';
        }
        if (!q.blanks || typeof q.blanks !== 'object') {
            q.blanks = {};
        }
    }

    return q;
}

// ============================================
// MC QUESTION RENDERING
// ============================================
/**
 * Renders a multiple-choice or true/false question in the quiz modal.
 * Also handles TF questions ‚Äî they are rendered as MC with two options.
 *
 * CHANGE LOG (2026-01-31):
 * Added defensive guards to prevent the crash:
 *   "Uncaught TypeError: Cannot read properties of undefined (reading 'forEach')"
 *   at question.distractors.forEach()
 *
 * The crash occurred intermittently because selectRandomQuestion() picks a random
 * question from the pool ‚Äî if one question in the array had missing/malformed
 * fields (no distractors, wrong schema), the quiz would crash only when that
 * specific question was randomly selected.
 *
 * Guards added:
 *   - distractors: accessed via Array.isArray() check, defaults to []
 *   - question.question: falls back to '(Question text missing)'
 *   - question.correct: falls back to '(no answer)'
 *   - distractor objects: checked for d.answer || d.text || d.value
 *
 * normalizeQuestion() (called upstream in showQuiz/startConsolidationPractice)
 * should handle most schema variants, but these guards act as a safety net
 * for any unexpected data shapes.
 */
function renderMCQuestion(question) {
    // Hide cloze, show MC
    document.getElementById('cloze-sentence').style.display = 'none';
    document.getElementById('quiz-options').style.display = 'flex';

    // Set question text
    document.getElementById('quiz-question-text').textContent = question.question || '(Question text missing)';

    // Guard: ensure distractors is a usable array
    const distractors = Array.isArray(question.distractors) ? question.distractors : [];

    // Build options array
    const options = [
        { text: question.correct || '(no answer)', isCorrect: true, explanation: question.correctExplanation || 'That is correct.' }
    ];

    distractors.forEach(d => {
        if (typeof d === 'string') {
            options.push({ text: d, isCorrect: false, explanation: '' });
        } else if (d && typeof d === 'object') {
            options.push({ text: d.answer || d.text || d.value || '', isCorrect: false, explanation: d.explanation || '' });
        }
    });

    // Shuffle options
    const shuffledOptions = shuffleArray(options);
    currentQuiz.options = shuffledOptions;

    // Render options
    const optionsContainer = document.getElementById('quiz-options');
    optionsContainer.innerHTML = shuffledOptions.map((opt, i) => `
        <button class="quiz-option" data-index="${i}">
            <span class="quiz-option-marker">${String.fromCharCode(65 + i)}</span>
            <span class="quiz-option-text">${escapeHtml(opt.text)}</span>
        </button>
    `).join('');

    // Add click listeners
    optionsContainer.querySelectorAll('.quiz-option').forEach(btn => {
        btn.addEventListener('click', () => selectMCOption(parseInt(btn.dataset.index)));
    });
}

function selectMCOption(index) {
    if (currentQuiz.answered) return;
    
    currentQuiz.selectedIndex = index;
    
    // Update visual selection
    document.querySelectorAll('.quiz-option').forEach((btn, i) => {
        btn.classList.toggle('selected', i === index);
    });
    
    document.getElementById('quiz-submit-btn').disabled = false;
}

// ============================================
// CLOZE QUESTION RENDERING
// ============================================
/**
 * Renders a cloze (fill-in-the-blank) question in the quiz modal.
 *
 * CHANGE LOG (2026-01-31):
 * Rewrote to fix Bug #1: the original code had a dead escapeHtml() call.
 *
 * Original code did:
 *   let html = escapeHtml(sentence);                    // escaped version
 *   html = sentence.replace(blankRegex, (match) => {    // OVERWRITES with raw sentence
 *       ...
 *   });
 *
 * The escaped version was immediately overwritten by .replace() on the RAW
 * sentence, so surrounding text (outside {{blank:N}} markers) was injected
 * into innerHTML without sanitization. If question text contained HTML-special
 * characters (e.g. "if T < 100¬∞C"), the browser would parse them as HTML tags.
 *
 * New approach: split the sentence on {{blank:N}} markers, escapeHtml() each
 * plain-text segment individually, then insert raw <select> HTML between them.
 * This ensures all user-visible text is escaped while the dropdown HTML is
 * correctly rendered.
 *
 * Also fixed:
 *   - Uses a separate regex instance for ID collection (avoids /g lastIndex
 *     statefulness fragility between the exec loop and the split)
 *   - Guards for missing blanks data and missing/non-array distractors
 *   - blankId values escaped in data attributes
 */
function renderClozeQuestion(question) {
    // Hide MC, show cloze
    document.getElementById('quiz-options').style.display = 'none';
    document.getElementById('cloze-sentence').style.display = 'block';

    // Set prompt/question text
    document.getElementById('quiz-question-text').textContent = question.prompt || 'Complete the sentence:';

    // Parse sentence and create dropdowns
    const sentence = question.sentence || '(sentence missing)';
    const blanks = question.blanks || {};

    // Collect blank IDs from the sentence (use a fresh regex to avoid lastIndex issues)
    const blankIds = [];
    const idRegex = /\{\{blank:([^}]+)\}\}/g;
    let match;
    while ((match = idRegex.exec(sentence)) !== null) {
        blankIds.push(match[1]);
    }

    // Store blank data for validation
    currentQuiz.blanks = blanks;
    currentQuiz.blankIds = blankIds;
    currentQuiz.clozeAnswers = {};

    // Split the sentence on blank placeholders so we can escape text parts
    // while inserting raw HTML for the <select> elements
    const parts = sentence.split(/\{\{blank:[^}]+\}\}/);
    let blankIndex = 0;
    let html = '';

    for (let p = 0; p < parts.length; p++) {
        // Escape the plain-text segment
        html += escapeHtml(parts[p]);

        // Insert a <select> dropdown for the blank that follows this segment
        if (blankIndex < blankIds.length) {
            const blankId = blankIds[blankIndex];
            const blankData = blanks[blankId];
            blankIndex++;

            if (!blankData) {
                html += `<span class="cloze-blank">[?]</span>`;
                continue;
            }

            // Build options: correct + distractors, shuffled
            const distractors = Array.isArray(blankData.distractors) ? blankData.distractors : [];
            const options = [
                { value: blankData.correct || '', isCorrect: true }
            ];

            distractors.forEach(d => {
                if (typeof d === 'string') {
                    options.push({ value: d, isCorrect: false });
                } else if (d && typeof d === 'object') {
                    options.push({ value: d.answer || d.text || d.value || '', isCorrect: false });
                }
            });

            const shuffledOptions = shuffleArray(options);

            // Store shuffled options for later validation
            currentQuiz[`blankOptions_${blankId}`] = shuffledOptions;

            // Create select HTML
            const optionsHtml = shuffledOptions.map(opt =>
                `<option value="${escapeHtml(opt.value)}">${escapeHtml(opt.value)}</option>`
            ).join('');

            html += `<span class="cloze-blank"><select class="cloze-select" data-blank-id="${escapeHtml(blankId)}" aria-label="Blank ${escapeHtml(blankId)}">
                <option value="">select</option>
                ${optionsHtml}
            </select></span>`;
        }
    }

    document.getElementById('cloze-sentence').innerHTML = html;

    // Add change listeners to dropdowns
    document.querySelectorAll('.cloze-select').forEach(select => {
        select.addEventListener('change', () => onClozeSelectChange(select));
    });
}

function onClozeSelectChange(select) {
    if (currentQuiz.answered) return;
    
    const blankId = select.dataset.blankId;
    const value = select.value;
    
    currentQuiz.clozeAnswers[blankId] = value;
    
    // Visual feedback for answered
    select.classList.toggle('answered', value !== '');
    
    // Check if all blanks filled
    const allFilled = currentQuiz.blankIds.every(id => 
        currentQuiz.clozeAnswers[id] && currentQuiz.clozeAnswers[id] !== ''
    );
    
    document.getElementById('quiz-submit-btn').disabled = !allFilled;
}

// ============================================
// QUIZ SUBMISSION
// ============================================
function submitQuizAnswer() {
    if (!currentQuiz || currentQuiz.answered) return;
    
    if (currentQuiz.questionType === 'cloze') {
        submitClozeAnswer();
    } else {
        submitMCAnswer();
    }
}

function submitMCAnswer() {
    if (currentQuiz.selectedIndex === null) return;
    
    currentQuiz.answered = true;
    const selectedOption = currentQuiz.options[currentQuiz.selectedIndex];
    const isCorrect = selectedOption.isCorrect;
    
    processQuizResult(isCorrect, selectedOption.explanation);
    
    // Update options visual state
    document.querySelectorAll('.quiz-option').forEach((btn, i) => {
        btn.disabled = true;
        if (currentQuiz.options[i].isCorrect) {
            btn.classList.add('correct');
        } else if (i === currentQuiz.selectedIndex) {
            btn.classList.add('incorrect');
        }
    });
}

function submitClozeAnswer() {
    // Check if all blanks filled
    const allFilled = currentQuiz.blankIds.every(id => 
        currentQuiz.clozeAnswers[id] && currentQuiz.clozeAnswers[id] !== ''
    );
    
    if (!allFilled) return;
    
    currentQuiz.answered = true;
    
    // Check each blank
    const results = [];
    let allCorrect = true;
    
    currentQuiz.blankIds.forEach(blankId => {
        const blankData = currentQuiz.blanks[blankId];
        const userAnswer = currentQuiz.clozeAnswers[blankId];
        const isCorrect = userAnswer === blankData.correct;
        
        if (!isCorrect) allCorrect = false;
        
        // Find explanation for wrong answer
        let explanation = '';
        if (isCorrect) {
            explanation = blankData.correctExplanation || 'Correct.';
        } else {
            // Find the distractor explanation
            const distractor = blankData.distractors.find(d => 
                (typeof d === 'string' ? d : d.answer) === userAnswer
            );
            if (distractor && typeof distractor === 'object') {
                explanation = distractor.explanation || '';
            }
        }
        
        results.push({
            blankId,
            userAnswer,
            correctAnswer: blankData.correct,
            isCorrect,
            explanation
        });
    });
    
    // Update dropdown visuals
    document.querySelectorAll('.cloze-select').forEach(select => {
        const blankId = select.dataset.blankId;
        const result = results.find(r => r.blankId === blankId);
        
        select.disabled = true;
        select.classList.remove('answered');
        select.classList.add(result.isCorrect ? 'correct' : 'incorrect');
    });
    
    // Show feedback for each blank
    const feedbackContainer = document.getElementById('cloze-feedback');
    feedbackContainer.style.display = 'block';
    feedbackContainer.innerHTML = results.map(result => `
        <div class="cloze-feedback-item ${result.isCorrect ? 'correct' : 'incorrect'}">
            <div class="cloze-feedback-label">
                ${result.isCorrect ? '‚úî' : '‚úó'} 
                ${result.isCorrect ? 'Correct' : `Incorrect - correct answer: "${escapeHtml(result.correctAnswer)}"`}
            </div>
            ${result.explanation ? `<div class="cloze-feedback-text">${escapeHtml(result.explanation)}</div>` : ''}
        </div>
    `).join('');
    
    // For cloze with scoring: "all", all must be correct
    const scoring = currentQuiz.question.scoring || 'all';
    const isCorrect = scoring === 'all' ? allCorrect : allCorrect; // Future: handle partial
    
    // Build overall explanation
    const overallExplanation = allCorrect 
        ? (currentQuiz.question.feedback?.allCorrect || 'All blanks correct.')
        : (currentQuiz.question.feedback?.partial || 'Review the feedback above.');
    
    processQuizResult(isCorrect, overallExplanation);
}

function processQuizResult(isCorrect, explanation) {
    // Record quiz result for Growth Character System
    recordQuizResult(currentQuiz.itemKey, currentQuiz.questionIndex, isCorrect);

    // Push quiz result to Google Sheet
    pushProgressToServer('quiz-result', {
        learningPointCode: currentQuiz.itemKey,
        currentLevel: currentQuiz.toLevel,
        quizResults: { correct: isCorrect, questionIndex: currentQuiz.questionIndex }
    });

    // Show result
    const resultEl = document.getElementById('quiz-result');
    resultEl.classList.remove('correct', 'incorrect');
    resultEl.classList.add('visible', isCorrect ? 'correct' : 'incorrect');

    document.getElementById('quiz-result-icon').textContent = isCorrect ? '‚úî' : '‚úó';
    document.getElementById('quiz-result-text').textContent = isCorrect ? 'Correct' : 'Incorrect';
    document.getElementById('quiz-result-explanation').textContent = explanation;

    // Handle consolidation mode differently
    if (currentQuiz.isConsolidation) {
        processConsolidationResult(isCorrect, explanation);
        return;
    }

    const state = getQuizStateForItem(currentQuiz.itemKey, currentQuiz.toLevel);

    // Mark question as used
    if (!state.usedQuestions.includes(currentQuiz.questionIndex)) {
        state.usedQuestions.push(currentQuiz.questionIndex);
    }

    if (isCorrect) {
        state.correctStreak++;
        state.wrongCount = 0;
        
        // Update streak dots
        const dots = document.querySelectorAll('.quiz-streak-dot');
        dots.forEach((dot, i) => {
            if (i < state.correctStreak) {
                dot.classList.add('filled');
            }
        });
        
        // Check if earned the level
        if (state.correctStreak >= state.requiredCorrect) {
            // Success! Capture values before closeQuiz nullifies currentQuiz
            const itemKey = currentQuiz.itemKey;
            const toLevel = currentQuiz.toLevel;
            
            document.getElementById('quiz-submit-btn').textContent = 'Continue';
            document.getElementById('quiz-submit-btn').disabled = false;
            document.getElementById('quiz-submit-btn').onclick = () => {
                closeQuiz();
                applyLevelChange(itemKey, toLevel);
                // Reset state
                state.usedQuestions = [];
                state.wrongCount = 0;
                state.correctStreak = 0;
                state.requiredCorrect = 1;
                saveQuizState();
            };
            document.getElementById('quiz-cancel-btn').style.display = 'none';
            document.getElementById('quiz-cancel-btn-footer').style.display = 'none';
        } else {
            // Need more correct - capture values before closeQuiz nullifies currentQuiz
            const itemKey = currentQuiz.itemKey;
            const fromLevel = currentQuiz.fromLevel;
            const toLevel = currentQuiz.toLevel;
            
            document.getElementById('quiz-submit-btn').textContent = 'Next Question';
            document.getElementById('quiz-submit-btn').disabled = false;
            document.getElementById('quiz-submit-btn').onclick = () => {
                saveQuizState();
                closeQuiz();
                setTimeout(() => {
                    showQuiz(itemKey, fromLevel, toLevel);
                }, 100);
            };
        }
    } else {
        state.wrongCount++;
        state.correctStreak = 0;
        
        if (state.wrongCount >= 3) {
            // Lockout
            state.lockedUntil = Date.now() + QUIZ_LOCKOUT_DURATION;
            state.usedQuestions = [];
            state.requiredCorrect = 1;
            
            document.getElementById('quiz-result-explanation').textContent = 
                explanation + '\n\nThis level is now locked for 5 minutes. Take some time to review this concept.';
            
            document.getElementById('quiz-submit-btn').textContent = 'Close';
            document.getElementById('quiz-submit-btn').disabled = false;
            document.getElementById('quiz-submit-btn').onclick = () => {
                saveQuizState();
                closeQuiz();
                renderLearningContentPreserveState(); // Re-render to show locked state while preserving accordion state
            };
            document.getElementById('quiz-cancel-btn').style.display = 'none';
            document.getElementById('quiz-cancel-btn-footer').style.display = 'none';
        } else {
            // Increase required
            state.requiredCorrect = state.wrongCount + 1;
            
            // Capture values before closeQuiz nullifies currentQuiz
            const itemKey = currentQuiz.itemKey;
            const fromLevel = currentQuiz.fromLevel;
            const toLevel = currentQuiz.toLevel;
            
            console.log('Setting up Try Again with:', { itemKey, fromLevel, toLevel });
            
            document.getElementById('quiz-submit-btn').textContent = 'Try Again';
            document.getElementById('quiz-submit-btn').disabled = false;
            document.getElementById('quiz-submit-btn').onclick = () => {
                console.log('Try Again clicked, calling showQuiz...');
                saveQuizState();
                closeQuiz();
                setTimeout(async () => {
                    console.log('setTimeout fired, calling showQuiz');
                    const result = await showQuiz(itemKey, fromLevel, toLevel);
                    console.log('showQuiz returned:', result);
                }, 100);
            };
        }
    }
    
    saveQuizState();
}

/**
 * Process quiz result in consolidation mode
 * Simpler flow: just show result and offer to practice more or close
 */
function processConsolidationResult(isCorrect, explanation) {
    const itemKey = currentQuiz.itemKey;
    const uuid = document.querySelector(`.learning-item-simple[data-item-key="${itemKey}"]`)?.dataset.uuid;

    // Get or initialize item data
    const item = appState.learningItems[itemKey];
    if (!item) return;

    // Initialize consolidation if needed
    if (!item.consolidation) {
        item.consolidation = { qAttempted: 0, qCorrect: 0, qTotal: 0, isConsolidated: false };
    }

    // Update consolidation counters
    //
    // KNOWN ISSUE (Bug #3 ‚Äî documented 2026-01-31):
    // qAttempted counts TOTAL submissions, not UNIQUE questions attempted.
    // When a student re-practices after all questions have been seen (the fallback
    // in startConsolidationPractice where unattemptedQuestions.length === 0),
    // qAttempted continues to increment. The completion check below compares
    // qAttempted >= qTotal, so a student could be marked "consolidated" by
    // answering a small subset of questions repeatedly (e.g., 3 unique questions
    // answered 4 times each = 12 attempts, which exceeds a qTotal of 10).
    //
    // FIX: Track unique question indices attempted (e.g., via a Set or array of
    // globalIndex values in the consolidation object) and check that the count
    // of unique attempts >= qTotal. Alternatively, use appState.quizStats[itemKey]
    // which already tracks per-question attempts ‚Äî count keys with attempts > 0
    // and compare against qTotal.
    //
    item.consolidation.qAttempted = (item.consolidation.qAttempted || 0) + 1;
    if (isCorrect) {
        item.consolidation.qCorrect = (item.consolidation.qCorrect || 0) + 1;
    }

    // Check if fully consolidated (all questions attempted)
    // NOTE: See KNOWN ISSUE above ‚Äî this comparison is against total submissions,
    // not unique questions, so it can trigger prematurely.
    if (item.consolidation.qTotal > 0 && item.consolidation.qAttempted >= item.consolidation.qTotal) {
        item.consolidation.isConsolidated = true;
    }

    const consolidation = item.consolidation;
    const isNowConsolidated = consolidation.isConsolidated;

    if (isCorrect) {
        if (isNowConsolidated) {
            // Fully consolidated
            document.getElementById('quiz-result-explanation').textContent =
                explanation + '\n\nYou have practiced all questions for this item. Great consolidation work.';
            document.getElementById('quiz-submit-btn').textContent = 'Done';
            document.getElementById('quiz-submit-btn').disabled = false;
            document.getElementById('quiz-submit-btn').onclick = () => {
                closeQuiz();
                renderLearningContentPreserveState();
            };
        } else {
            // More to practice
            document.getElementById('quiz-submit-btn').textContent = 'Practice Another';
            document.getElementById('quiz-submit-btn').disabled = false;
            document.getElementById('quiz-submit-btn').onclick = () => {
                closeQuiz();
                renderLearningContentPreserveState(); // Update button count
                if (uuid) {
                    setTimeout(() => startConsolidationPractice(itemKey, uuid), 100);
                }
            };
        }
    } else {
        // Wrong answer in consolidation - just offer to try again or close
        document.getElementById('quiz-submit-btn').textContent = 'Try Another';
        document.getElementById('quiz-submit-btn').disabled = false;
        document.getElementById('quiz-submit-btn').onclick = () => {
            closeQuiz();
            renderLearningContentPreserveState(); // Update button count
            if (uuid) {
                setTimeout(() => startConsolidationPractice(itemKey, uuid), 100);
            }
        };
    }

    // Hide cancel button - use Done button instead
    document.getElementById('quiz-cancel-btn').style.display = 'none';
    document.getElementById('quiz-cancel-btn-footer').style.display = '';
    document.getElementById('quiz-cancel-btn-footer').textContent = 'Done';
    document.getElementById('quiz-cancel-btn-footer').onclick = () => {
        closeQuiz();
        renderLearningContentPreserveState();
    };

    saveData();
}

function closeQuiz() {
    document.getElementById('quiz-overlay').classList.remove('active');
    currentQuiz = null;

    // Clear custom onclick handler - addEventListener handles default submission
    document.getElementById('quiz-submit-btn').onclick = null;

    // Reset cancel button text
    const cancelFooter = document.getElementById('quiz-cancel-btn-footer');
    if (cancelFooter) {
        cancelFooter.textContent = 'Cancel';
        cancelFooter.onclick = null;
    }
}

// ============================================
// ACCORDION STATE PRESERVATION
// ============================================
/**
 * Get the current expanded state of all accordions
 * @returns {Object} Map of subtopic IDs to their expanded state
 */
function getAccordionState() {
    const state = {};
    document.querySelectorAll('.topic-header').forEach(header => {
        const contentId = header.getAttribute('aria-controls');
        if (contentId) {
            // Extract subtopic ID from content ID (format: subtopic-{id}-content)
            const match = contentId.match(/subtopic-(.+)-content/);
            if (match) {
                state[match[1]] = header.getAttribute('aria-expanded') === 'true';
            }
        }
    });
    return state;
}

/**
 * Restore accordion expanded state after re-render
 * @param {Object} state - Map of subtopic IDs to their expanded state
 */
function restoreAccordionState(state) {
    Object.entries(state).forEach(([subtopicId, isExpanded]) => {
        const header = document.getElementById(`subtopic-${subtopicId}-header`);
        const content = document.getElementById(`subtopic-${subtopicId}-content`);
        if (header && content) {
            header.setAttribute('aria-expanded', isExpanded);
            content.classList.toggle('expanded', isExpanded);
        }
    });
}

/**
 * Re-render learning content while preserving accordion state
 */
function renderLearningContentPreserveState() {
    const accordionState = getAccordionState();
    renderLearningContent();
    restoreAccordionState(accordionState);
}

// ============================================
// THEME
// ============================================
function applyTheme(theme) {
    appState.theme = theme;
    document.documentElement.setAttribute('data-theme', theme);
    const toggle = document.getElementById('dark-mode-toggle');
    if (toggle) {
        toggle.checked = (theme === 'dark');
    }
}

function toggleTheme() {
    const toggle = document.getElementById('dark-mode-toggle');
    applyTheme(toggle && toggle.checked ? 'dark' : 'light');
    saveData();
}

// ============================================
// FIRST RUN WELCOME & TIPS
// ============================================

/**
 * Check if this is the first run and show welcome dialog
 */
function checkFirstRun() {
    const firstRunComplete = localStorage.getItem(FIRST_RUN_KEY);
    if (!firstRunComplete) {
        showWelcomeDialog();
    }
}

/**
 * Show the welcome dialog
 */
function showWelcomeDialog() {
    const overlay = document.getElementById('welcome-overlay');
    if (overlay) {
        // Reset to first page
        document.getElementById('welcome-page-1')?.classList.add('active');
        document.getElementById('welcome-page-2')?.classList.remove('active');
        
        // Populate fields with existing data if available
        const welcomeNameInput = document.getElementById('welcome-name-input');
        const welcomeClassInput = document.getElementById('welcome-class-input');
        if (welcomeNameInput) welcomeNameInput.value = appState.student.name || '';
        if (welcomeClassInput) welcomeClassInput.value = appState.student.class || '';
        
        overlay.classList.add('active');
    }
}

/**
 * Hide the welcome dialog and mark first run as complete
 */
function hideWelcomeDialog() {
    // Save user info from welcome form
    const welcomeNameInput = document.getElementById('welcome-name-input');
    const welcomeClassInput = document.getElementById('welcome-class-input');
    
    if (welcomeNameInput && welcomeNameInput.value.trim()) {
        appState.student.name = welcomeNameInput.value.trim();
    }
    if (welcomeClassInput && welcomeClassInput.value) {
        appState.student.class = welcomeClassInput.value;
    }
    
    // Sync with settings inputs
    const settingsNameInput = document.getElementById('student-name-input');
    const settingsClassInput = document.getElementById('class-input');
    if (settingsNameInput) settingsNameInput.value = appState.student.name || '';
    if (settingsClassInput) settingsClassInput.value = appState.student.class || '';
    
    // Save and update display
    saveData();
    renderStudentInfo();
    
    // Hide overlay
    const overlay = document.getElementById('welcome-overlay');
    if (overlay) {
        overlay.classList.remove('active');
    }
    localStorage.setItem(FIRST_RUN_KEY, 'true');
    
    // Start the selection tip timer after welcome is closed
    scheduleSelectionTip();
}

/**
 * Navigate to welcome page 1 (intro)
 */
function showWelcomePage1() {
    document.getElementById('welcome-page-2')?.classList.remove('active');
    document.getElementById('welcome-page-3')?.classList.remove('active');
    document.getElementById('welcome-page-1')?.classList.add('active');
}

/**
 * Navigate to welcome page 2 (how it works)
 */
function showWelcomePage2() {
    document.getElementById('welcome-page-1')?.classList.remove('active');
    document.getElementById('welcome-page-3')?.classList.remove('active');
    document.getElementById('welcome-page-2')?.classList.add('active');
}

/**
 * Navigate to welcome page 3 (tracking and sharing)
 */
function showWelcomePage3() {
    document.getElementById('welcome-page-1')?.classList.remove('active');
    document.getElementById('welcome-page-2')?.classList.remove('active');
    document.getElementById('welcome-page-3')?.classList.add('active');
}

/**
 * Schedule the selection tip to show after 3 minutes
 */
function scheduleSelectionTip() {
    const tipShown = localStorage.getItem(SELECTION_TIP_KEY);
    if (tipShown) return;
    
    setTimeout(() => {
        showSelectionTip();
    }, SELECTION_TIP_DELAY);
}

/**
 * Show the selection tip toast
 */
function showSelectionTip() {
    const tipShown = localStorage.getItem(SELECTION_TIP_KEY);
    if (tipShown) return;
    
    // Create a longer-lasting toast for the tip
    const container = document.getElementById('toast-container');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = 'toast info selection-tip-toast';
    toast.innerHTML = `
        <span>üí°</span>
        <span>Tip: Select any text in the learning content to quickly ask your teacher, search Google, or ask AI about it.</span>
    `;
    
    container.appendChild(toast);
    
    // Mark as shown
    localStorage.setItem(SELECTION_TIP_KEY, 'true');
    
    // Remove after 8 seconds (longer than normal toasts)
    setTimeout(() => {
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 200);
    }, 8000);
}

// ============================================
// MESSAGES SYSTEM
// ============================================

// Message state
let messagesData = [];
let readMessageIds = [];
let selectedMessageId = null;

/**
 * Load read message IDs from localStorage
 */
function loadReadMessages() {
    try {
        const saved = localStorage.getItem(MESSAGES_READ_KEY);
        if (saved) {
            readMessageIds = JSON.parse(saved);
        }
    } catch (e) {
        console.warn('Failed to load read messages:', e);
        readMessageIds = [];
    }
}

/**
 * Save read message IDs to localStorage
 */
function saveReadMessages() {
    try {
        localStorage.setItem(MESSAGES_READ_KEY, JSON.stringify(readMessageIds));
    } catch (e) {
        console.warn('Failed to save read messages:', e);
    }
}

/**
 * Mark a message as read
 */
function markMessageAsRead(messageId) {
    if (!readMessageIds.includes(messageId)) {
        readMessageIds.push(messageId);
        saveReadMessages();
        updateMessageUI();
    }
}

/**
 * Mark all messages as read
 */
function markAllMessagesAsRead() {
    const activeMessages = getActiveMessages();
    activeMessages.forEach(msg => {
        if (!readMessageIds.includes(msg.id)) {
            readMessageIds.push(msg.id);
        }
    });
    saveReadMessages();
    updateMessageUI();
    renderMessagesList();
}

/**
 * Check if a message is within its active date range
 */
function isMessageActive(message) {
    const now = new Date();
    const today = now.toISOString().split('T')[0];

    // Check if message has date constraints
    if (message.startDate && today < message.startDate) return false;
    if (message.endDate && today > message.endDate) return false;

    // Also check the active flag if present
    if (message.active === false) return false;

    return true;
}

/**
 * Get all active messages (within date range)
 */
function getActiveMessages() {
    return messagesData.filter(isMessageActive);
}

/**
 * Get unread messages
 */
function getUnreadMessages() {
    return getActiveMessages().filter(msg => !readMessageIds.includes(msg.id));
}

/**
 * Load messages from message.json
 */
async function loadMessages() {
    try {
        const response = await fetch('message.json');
        if (!response.ok) {
            console.log('No message.json found or failed to load');
            messagesData = [];
            return;
        }
        messagesData = await response.json();
        console.log(`Loaded ${messagesData.length} messages`);
    } catch (e) {
        console.warn('Failed to load messages:', e);
        messagesData = [];
    }
}

/**
 * Update message icon badge and visibility
 */
function updateMessageUI() {
    const activeMessages = getActiveMessages();
    const unreadMessages = getUnreadMessages();
    const unreadCount = unreadMessages.length;
    const hasActiveMessages = activeMessages.length > 0;

    // Header icon
    const iconBtn = document.getElementById('message-icon-btn');
    const badge = document.getElementById('message-badge');

    if (iconBtn) {
        iconBtn.classList.toggle('hidden', !hasActiveMessages);
    }

    if (badge) {
        badge.textContent = unreadCount;
        badge.classList.toggle('hidden', unreadCount === 0);
    }

    // Settings button
    const settingsBtn = document.getElementById('settings-messages-btn');
    const settingsBadge = document.getElementById('settings-messages-badge');

    if (settingsBtn) {
        settingsBtn.classList.toggle('hidden', !hasActiveMessages);
    }

    if (settingsBadge) {
        settingsBadge.textContent = unreadCount;
        settingsBadge.classList.toggle('hidden', unreadCount === 0);
    }
}

/**
 * Show the messages dialog
 */
function showMessagesDialog() {
    const overlay = document.getElementById('messages-overlay');
    if (overlay) {
        overlay.classList.add('active');
        renderMessagesList();

        // Auto-select first unread message, or first message if all read
        const unread = getUnreadMessages();
        const active = getActiveMessages();
        if (unread.length > 0) {
            selectMessage(unread[0].id);
        } else if (active.length > 0) {
            selectMessage(active[0].id);
        } else {
            clearMessageSelection();
        }
    }
}

/**
 * Hide the messages dialog
 */
function hideMessagesDialog() {
    const overlay = document.getElementById('messages-overlay');
    if (overlay) {
        overlay.classList.remove('active');
    }
    selectedMessageId = null;
}

/**
 * Render the messages list
 */
function renderMessagesList() {
    const listContainer = document.getElementById('messages-list');
    if (!listContainer) return;

    const activeMessages = getActiveMessages();

    // Sort: unread first, then by date (newest first)
    const sortedMessages = [...activeMessages].sort((a, b) => {
        const aUnread = !readMessageIds.includes(a.id);
        const bUnread = !readMessageIds.includes(b.id);

        if (aUnread && !bUnread) return -1;
        if (!aUnread && bUnread) return 1;

        // Both same read status, sort by date (newest first)
        return new Date(b.date) - new Date(a.date);
    });

    if (sortedMessages.length === 0) {
        listContainer.innerHTML = `
            <div class="message-detail-empty">
                <span class="message-detail-empty-text">No messages</span>
            </div>
        `;
        return;
    }

    listContainer.innerHTML = sortedMessages.map(msg => {
        const isUnread = !readMessageIds.includes(msg.id);
        const isSelected = selectedMessageId === msg.id;
        const dateStr = formatMessageDate(msg.date);

        return `
            <div class="message-list-item ${isUnread ? 'unread' : ''} ${isSelected ? 'selected' : ''}"
                 data-message-id="${msg.id}"
                 role="button"
                 tabindex="0">
                <span class="message-unread-dot ${isUnread ? '' : 'read'}"></span>
                <div class="message-list-info">
                    <div class="message-list-title">${escapeHtml(msg.title)}</div>
                    <div class="message-list-date">${dateStr}</div>
                </div>
            </div>
        `;
    }).join('');

    // Add click handlers
    listContainer.querySelectorAll('.message-list-item').forEach(item => {
        item.addEventListener('click', () => {
            selectMessage(item.dataset.messageId);
        });
        item.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                selectMessage(item.dataset.messageId);
            }
        });
    });
}

/**
 * Select and display a message
 */
function selectMessage(messageId) {
    const message = messagesData.find(m => m.id === messageId);
    if (!message) return;

    selectedMessageId = messageId;

    // Mark as read
    markMessageAsRead(messageId);

    // Update list selection
    document.querySelectorAll('.message-list-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.messageId === messageId);
        // Also update the unread dot
        if (item.dataset.messageId === messageId) {
            item.classList.remove('unread');
            item.querySelector('.message-unread-dot')?.classList.add('read');
        }
    });

    // Show detail panel content
    const emptyState = document.getElementById('message-detail-empty');
    const header = document.getElementById('message-detail-header');
    const body = document.getElementById('message-detail-body');

    if (emptyState) emptyState.style.display = 'none';
    if (header) header.style.display = 'block';
    if (body) body.style.display = 'block';

    // Populate detail content
    document.getElementById('message-detail-title').textContent = message.title;

    const typeEl = document.getElementById('message-detail-type');
    if (typeEl) {
        typeEl.textContent = message.type || 'announcement';
        typeEl.className = 'message-detail-type' + (message.type === 'update' ? ' update' : '');
    }

    document.getElementById('message-detail-date').textContent = formatMessageDate(message.date);

    // Format content - convert line breaks and handle bullet points
    const contentEl = document.getElementById('message-detail-content');
    if (contentEl) {
        contentEl.innerHTML = formatMessageContent(message.content);
    }
}

/**
 * Clear message selection (show empty state)
 */
function clearMessageSelection() {
    selectedMessageId = null;

    document.querySelectorAll('.message-list-item').forEach(item => {
        item.classList.remove('selected');
    });

    const emptyState = document.getElementById('message-detail-empty');
    const header = document.getElementById('message-detail-header');
    const body = document.getElementById('message-detail-body');

    if (emptyState) emptyState.style.display = 'flex';
    if (header) header.style.display = 'none';
    if (body) body.style.display = 'none';
}

/**
 * Format a date for display in messages
 */
function formatMessageDate(dateStr) {
    if (!dateStr) return '';
    try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-AU', {
            day: 'numeric',
            month: 'short',
            year: date.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
        });
    } catch (e) {
        return dateStr;
    }
}

/**
 * Format message content - handle line breaks and bullet points
 */
function formatMessageContent(content) {
    if (!content) return '';

    // Escape HTML first
    let formatted = escapeHtml(content);

    // Convert lines starting with - to list items
    const lines = formatted.split('\n');
    let inList = false;
    let result = [];

    for (const line of lines) {
        const trimmed = line.trim();
        if (trimmed.startsWith('- ')) {
            if (!inList) {
                result.push('<ul>');
                inList = true;
            }
            result.push(`<li>${trimmed.substring(2)}</li>`);
        } else {
            if (inList) {
                result.push('</ul>');
                inList = false;
            }
            if (trimmed) {
                result.push(`<p>${trimmed}</p>`);
            }
        }
    }

    if (inList) {
        result.push('</ul>');
    }

    return result.join('');
}

/**
 * Escape HTML special characters
 */
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

/**
 * Check for new messages and auto-show dialog if needed
 */
function checkForNewMessages() {
    const unreadMessages = getUnreadMessages();
    if (unreadMessages.length > 0) {
        // Auto-show the messages dialog for new messages
        showMessagesDialog();
    }
}

/**
 * Initialize the messages system
 */
async function initMessages() {
    loadReadMessages();
    await loadMessages();
    updateMessageUI();

    // Check for new messages after a brief delay (after welcome dialog would show)
    setTimeout(() => {
        const welcomeOverlay = document.getElementById('welcome-overlay');
        const isWelcomeActive = welcomeOverlay?.classList.contains('active');

        // Only auto-show if welcome dialog is not showing
        if (!isWelcomeActive) {
            checkForNewMessages();
        }
    }, 500);
}

// ============================================
// LEVEL PREFERENCES
// ============================================

/**
 * Load level preferences from localStorage
 */
function loadLevelPrefs() {
    try {
        const saved = localStorage.getItem(LEVEL_PREFS_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            levelPrefs.displayMode = parsed.displayMode || 'emoji';
            levelPrefs.emojiProgression = parsed.emojiProgression || 0;
            levelPrefs.colors = parsed.colors || [...defaultLevelColors];
        }
    } catch (e) {
        console.warn('Failed to load level preferences:', e);
    }
    // Update the levelEmojis variable for compatibility
    levelEmojis = getLevelEmojis();
}

/**
 * Save level preferences to localStorage
 */
function saveLevelPrefs() {
    try {
        localStorage.setItem(LEVEL_PREFS_KEY, JSON.stringify(levelPrefs));
    } catch (e) {
        console.warn('Failed to save level preferences:', e);
    }
}

/**
 * Apply level colors to CSS custom properties
 */
function applyLevelColors() {
    const root = document.documentElement;
    levelPrefs.colors.forEach((color, i) => {
        root.style.setProperty(`--level-${i + 1}`, color);
        // Also set light versions (for backgrounds)
        root.style.setProperty(`--level-${i + 1}-light`, color + '20'); // 20 = ~12% opacity in hex
    });
}

/**
 * Update the level preferences UI to match current state
 */
function updateLevelPrefsUI() {
    // Update display mode selection
    document.querySelectorAll('.level-display-option').forEach(opt => {
        const mode = opt.dataset.mode;
        const input = opt.querySelector('input');
        if (mode === levelPrefs.displayMode) {
            opt.classList.add('active');
            if (input) input.checked = true;
        } else {
            opt.classList.remove('active');
            if (input) input.checked = false;
        }
    });
    
    // Update emoji progression select
    const emojiSelect = document.getElementById('emoji-progression-select');
    if (emojiSelect) {
        emojiSelect.value = levelPrefs.emojiProgression.toString();
    }
    
    // Update color pickers
    levelPrefs.colors.forEach((color, i) => {
        const picker = document.getElementById(`level-color-${i + 1}`);
        if (picker) picker.value = color;
    });
    
    // Update preview
    updateLevelPreview();
}

/**
 * Update the level preview display
 */
function updateLevelPreview() {
    const preview = document.getElementById('level-preview');
    if (!preview) return;
    
    const emojis = getLevelEmojis();
    
    preview.innerHTML = levelNames.map((name, i) => {
        const color = levelPrefs.colors[i];
        const emoji = emojis[i];
        
        let content = '';
        if (levelPrefs.displayMode === 'dots') {
            content = `<span class="level-preview-dot" style="background: ${color}"></span>`;
        } else if (levelPrefs.displayMode === 'emoji') {
            content = `<span class="level-preview-emoji">${emoji}</span>`;
        } else { // both
            content = `<span class="level-preview-dot" style="background: ${color}"></span><span class="level-preview-emoji">${emoji}</span>`;
        }
        
        return `<div class="level-preview-item" title="${name}">${content}</div>`;
    }).join('');
}

/**
 * Render all level legends with current emoji preferences
 */
function renderLevelLegends() {
    const emojis = getLevelEmojis();
    const legendIds = ['overview-level-legend', 'learning-level-legend'];
    
    legendIds.forEach(id => {
        const legend = document.getElementById(id);
        if (!legend) return;
        
        legend.innerHTML = levelNames.map((name, i) => `
            <div class="level-legend-item">
                <span class="level-legend-dot" data-level="${i + 1}"></span>
                <span>${emojis[i]} ${name}</span>
            </div>
        `).join('');
    });
}

/**
 * Handle display mode change
 */
function onDisplayModeChange(mode) {
    levelPrefs.displayMode = mode;
    
    // Update UI
    document.querySelectorAll('.level-display-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.mode === mode);
    });
    
    saveLevelPrefs();
    updateLevelPreview();
    renderLearningContentPreserveState(); // Re-render to apply change while preserving accordion state
}

/**
 * Handle emoji progression change
 */
function onEmojiProgressionChange(index) {
    levelPrefs.emojiProgression = parseInt(index);
    levelEmojis = getLevelEmojis();
    
    saveLevelPrefs();
    updateLevelPreview();
    renderLevelLegends();
    renderLearningContentPreserveState(); // Preserve accordion state when changing preferences
}

/**
 * Handle color picker change
 */
function onLevelColorChange(levelIndex, color) {
    levelPrefs.colors[levelIndex] = color;
    applyLevelColors();
    saveLevelPrefs();
    updateLevelPreview();
}

/**
 * Reset colors to defaults
 */
function resetLevelColors() {
    levelPrefs.colors = [...defaultLevelColors];
    applyLevelColors();
    saveLevelPrefs();
    updateLevelPrefsUI();
    showToast('Colors reset to defaults', 'info');
}

/**
 * Generate level indicator HTML based on current preferences
 */
function getLevelIndicatorHtml(level, showLabel = false) {
    const emojis = getLevelEmojis();
    const color = levelPrefs.colors[level - 1];
    const emoji = emojis[level - 1];
    const name = levelNames[level - 1];
    
    let content = '';
    if (levelPrefs.displayMode === 'dots') {
        content = `<span class="level-indicator-dot" style="background: ${color}; width: 12px; height: 12px; border-radius: 50%; display: inline-block;"></span>`;
    } else if (levelPrefs.displayMode === 'emoji') {
        content = emoji;
    } else { // both
        content = `<span class="level-indicator-dot" style="background: ${color}; width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 4px;"></span>${emoji}`;
    }
    
    if (showLabel) {
        content += ` ${name}`;
    }
    
    return content;
}

// ============================================
// CHECK-IN MODE
// ============================================
function getWasLevel(itemKey) {
    return checkinStartLevels[itemKey] || appState.learningItems[itemKey]?.level || 1;
}

function markItemReviewed(itemKey) {
    if (!checkinModeActive) return;
    
    checkinReviewedItems.add(itemKey);
    
    // Update progress display
    const totalItems = Object.keys(checkinStartLevels).length;
    const reviewedCount = checkinReviewedItems.size;
    
    const progressText = document.getElementById('checkin-progress-text');
    if (progressText) progressText.textContent = `${reviewedCount}/${totalItems} items reviewed`;
    
    const floatingProgress = document.getElementById('checkin-floating-progress');
    if (floatingProgress) floatingProgress.textContent = `${reviewedCount}/${totalItems}`;
    
    // Mark item visually
    const itemEl = document.querySelector(`.learning-item-simple[data-item-key="${itemKey}"]`);
    if (itemEl) itemEl.classList.add('reviewed');
}

/**
 * Calculate check-in duration based on number of learning points
 * @param {number} lpCount - Number of learning points
 * @returns {number} Duration in milliseconds
 */
function calculateCheckinDuration(lpCount) {
    const minutes = Math.min(
        CHECKIN_MAX_MINUTES,
        Math.max(CHECKIN_MIN_MINUTES, lpCount * CHECKIN_MINUTES_PER_LP)
    );
    return minutes * 60 * 1000;
}

function startCheckinMode(type) {
    if (!appState.topic) {
        showToast('Please load a topic first', 'warning');
        return;
    }

    currentCheckinType = type;
    checkinModeActive = true;
    checkinReviewedItems.clear();
    checkinStartLevels = {};

    // Capture starting levels for all items
    appState.topic.subtopics.forEach(subtopic => {
        if (!subtopic.items) return;
        subtopic.items.forEach(item => {
            const itemKey = getItemKey(subtopic.id, item.id);
            const itemData = appState.learningItems[itemKey] || { level: 1 };
            checkinStartLevels[itemKey] = itemData.level;
        });
    });

    // Calculate dynamic duration based on LP count
    const lpCount = Object.keys(checkinStartLevels).length;
    checkinDurationMs = calculateCheckinDuration(lpCount);

    // Start timer
    checkinStartTime = Date.now();
    updateCheckinTimer();
    checkinTimer = setInterval(updateCheckinTimer, 1000);
    
    // Show floating bar
    const floatingBar = document.getElementById('checkin-floating-bar');
    if (floatingBar) {
        floatingBar.classList.add('active');
        document.getElementById('checkin-floating-type').textContent = `${checkinTypeLabels[type]} Check-in`;
        document.getElementById('checkin-floating-progress').textContent = `0/${Object.keys(checkinStartLevels).length}`;
    }
    
    // Switch to learning tab and render
    switchTab('learning');
    renderLearningContent();
    
    showToast(`${checkinTypeLabels[type]} check-in started`, 'success');
}

function updateCheckinTimer() {
    const elapsed = Date.now() - checkinStartTime;
    const remaining = Math.max(0, checkinDurationMs - elapsed);

    const mins = Math.floor(remaining / 60000);
    const secs = Math.floor((remaining % 60000) / 1000);

    const timerEl = document.getElementById('checkin-floating-timer');
    if (timerEl) {
        timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Auto-stop when time runs out
    if (remaining === 0) {
        stopCheckinMode(true);
    }
}

function stopCheckinMode(autoStopped = false) {
    if (!checkinModeActive) return;

    // Clear timer
    if (checkinTimer) {
        clearInterval(checkinTimer);
        checkinTimer = null;
    }

    // Record check-in
    const checkin = {
        id: Date.now(),
        date: new Date().toISOString(),
        type: currentCheckinType,
        itemsReviewed: checkinReviewedItems.size,
        totalItems: Object.keys(checkinStartLevels).length,
        duration: Date.now() - checkinStartTime
    };

    appState.checkins.push(checkin);

    // Generate Growth Character
    const growthCharacter = generateGrowthCharacter(checkin.id, currentCheckinType);

    saveData();

    // Reset state
    checkinModeActive = false;
    checkinReviewedItems.clear();
    checkinStartLevels = {};

    // Hide floating bar
    const floatingBar = document.getElementById('checkin-floating-bar');
    if (floatingBar) floatingBar.classList.remove('active');

    // Re-render
    renderLearningContent();
    renderHistory();
    renderOverview();

    // Show post-check-in modal with Growth Character option
    showPostCheckinModal(checkin, growthCharacter, autoStopped);
}

function showCheckinStartModal() {
    if (!appState.topic) {
        showToast('Please load a topic first', 'warning');
        return;
    }
    document.getElementById('checkin-start-overlay').classList.add('active');
}

function hideCheckinStartModal() {
    document.getElementById('checkin-start-overlay').classList.remove('active');
}

// ============================================
// NAVIGATION
// ============================================

// Learning tab attention-pulse timers
let _learningPulseInitialTimer = null;
let _learningPulseIntervalTimer = null;
let _learningPulseRandomTimer = null;

/**
 * Clear all learning-tab pulse timers and remove the glow class.
 */
function clearLearningPulseTimers() {
    clearTimeout(_learningPulseInitialTimer);
    clearInterval(_learningPulseIntervalTimer);
    clearTimeout(_learningPulseRandomTimer);
    _learningPulseInitialTimer = null;
    _learningPulseIntervalTimer = null;
    _learningPulseRandomTimer = null;
    const tab = document.getElementById('learning-tab');
    if (tab) tab.classList.remove('pulse-glow');
}

/**
 * Fire a single 1-second glow pulse on the Learning Content tab.
 */
function fireLearningPulse() {
    const tab = document.getElementById('learning-tab');
    if (!tab) return;
    // Remove class first (in case a previous pulse is still running)
    tab.classList.remove('pulse-glow');
    // Force reflow so re-adding the class restarts the animation
    void tab.offsetWidth;
    tab.classList.add('pulse-glow');
    // Remove class after the 5s animation completes (1s fade-in + 3s pulse + 1s fade-out)
    setTimeout(() => tab.classList.remove('pulse-glow'), 5100);
}

/**
 * Start the learning-tab pulse cycle:
 *  ‚Äì Wait 20 s after leaving the Learning Content tab.
 *  ‚Äì Then every 30 s, fire one pulse at a random offset (0‚Äì29 s).
 */
function startLearningPulseTimers() {
    clearLearningPulseTimers();

    _learningPulseInitialTimer = setTimeout(() => {
        // First pulse immediately after the 20 s initial wait
        fireLearningPulse();

        // Then repeat: once per 30 s window at a random offset
        _learningPulseIntervalTimer = setInterval(() => {
            const randomDelay = Math.floor(Math.random() * 30000); // 0‚Äì29 999 ms
            _learningPulseRandomTimer = setTimeout(fireLearningPulse, randomDelay);
        }, 30000);
    }, 20000);
}

function switchTab(tabId) {
    // Update tab buttons
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.setAttribute('aria-selected', tab.id === `${tabId}-tab`);
    });

    // Update panels
    document.querySelectorAll('.panel-content').forEach(panel => {
        panel.classList.toggle('active', panel.id === `${tabId}-panel`);
    });

    // Learning-tab attention pulse: start when leaving, stop when returning
    if (tabId === 'learning') {
        clearLearningPulseTimers();
    } else {
        // Only start if not already running (switching between non-learning tabs)
        if (!_learningPulseInitialTimer && !_learningPulseIntervalTimer) {
            startLearningPulseTimers();
        }
    }
}

function navigateToLearningItem(itemKey) {
    // Switch to learning tab
    switchTab('learning');
    
    // Parse the itemKey to get subtopic and item IDs
    if (!appState.topic) return;
    
    const { subtopicId, itemId } = parseItemKey(itemKey);
    const subtopic = getSubtopicById(subtopicId);
    
    if (subtopic) {
        // Expand the subtopic
        const header = document.getElementById(`subtopic-${subtopic.id}-header`);
        if (header) {
            header.setAttribute('aria-expanded', 'true');
            const content = document.getElementById(`subtopic-${subtopic.id}-content`);
            if (content) content.classList.add('expanded');
        }
        
        // Scroll to item
        setTimeout(() => {
            const itemEl = document.querySelector(`.learning-item-simple[data-item-key="${itemKey}"]`);
            if (itemEl) {
                itemEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                itemEl.style.animation = 'none';
                itemEl.offsetHeight; // Trigger reflow
                itemEl.style.animation = 'highlightItem 1s ease-out';
            }
        }, 100);
    }
}

// ============================================
// GOALS & QUESTIONS
// ============================================
function addGoal() {
    const input = document.getElementById('new-goal-input');
    const text = input.value.trim();
    
    if (!text) {
        showToast('Please enter a goal', 'warning');
        return;
    }
    
    appState.goals.push({
        text,
        created: new Date().toISOString(),
        completed: false
    });
    
    input.value = '';
    saveData();
    renderGoals();
    updateBadges();
    showToast('Goal added', 'success');
}

function deleteGoal(index) {
    appState.goals.splice(index, 1);
    saveData();
    renderGoals();
    updateBadges();
}

function addQuestion() {
    const input = document.getElementById('new-question-input');
    const text = input.value.trim();

    if (!text) {
        showToast('Please enter a question', 'warning');
        return;
    }

    // Track question submission (Growth Character System)
    trackQuestionSubmission();

    appState.questions.push({
        text,
        context: '',
        created: new Date().toISOString(),
        status: 'pending'
    });

    input.value = '';
    saveData();
    renderQuestions();
    updateBadges();
    showToast('Question added', 'success');
}

function deleteQuestion(index) {
    appState.questions.splice(index, 1);
    saveData();
    renderQuestions();
    updateBadges();
}

// ============================================
// EXPORT FUNCTIONS
// ============================================

/**
 * Gather all metrics needed for export features (Email, Print, Backup)
 * Central data compilation function - single source of truth
 * @returns {object} Complete metrics object for all export purposes
 */
function gatherExportMetrics() {
    const stats = calculateStats();
    const streak = calculateStreak();
    const gc = getLatestGrowthCharacter();
    const errorMetrics = calculateErrorMetrics();

    // Calculate quiz performance stats
    let quizAttempts = 0;
    let quizCorrect = 0;
    let totalQuestions = 0;

    Object.values(appState.quizStats).forEach(lpStats => {
        Object.values(lpStats).forEach(q => {
            quizAttempts += q.attempts;
            quizCorrect += q.correct;
            totalQuestions++;
        });
    });

    const quizCorrectRate = quizAttempts > 0 ? Math.round((quizCorrect / quizAttempts) * 100) : 0;

    // Calculate total active days
    const totalActiveDays = Object.keys(appState.practiceCalendar || {}).filter(key => {
        const day = appState.practiceCalendar[key];
        return day && day.sessions > 0;
    }).length;

    // Calculate activity date range
    const checkinDates = appState.checkins.map(c => new Date(c.date)).sort((a, b) => a - b);
    const firstActivityDate = checkinDates.length > 0 ? checkinDates[0].toISOString().split('T')[0] : null;
    const lastActivityDate = checkinDates.length > 0 ? checkinDates[checkinDates.length - 1].toISOString().split('T')[0] : null;

    // Calculate subtopic breakdown
    const subtopicStats = [];
    if (appState.topic && appState.topic.subtopics) {
        appState.topic.subtopics.forEach(subtopic => {
            if (!subtopic.items) return;

            let totalLevel = 0;
            let securedCount = 0;
            let itemCount = 0;

            subtopic.items.forEach(item => {
                const itemKey = getItemKey(subtopic.id, item.id);
                const itemData = appState.learningItems[itemKey];
                if (itemData) {
                    totalLevel += itemData.level;
                    if (itemData.level === 5) securedCount++;
                    itemCount++;
                }
            });

            subtopicStats.push({
                name: subtopic.name,
                id: subtopic.id,
                totalItems: itemCount,
                avgLevel: itemCount > 0 ? Math.round((totalLevel / itemCount) * 10) / 10 : 1,
                securedCount: securedCount,
                securedPercent: itemCount > 0 ? Math.round((securedCount / itemCount) * 100) : 0
            });
        });
    }

    // Get focus areas (items at level 1-2, max 10)
    const focusAreas = [];
    if (appState.topic && appState.topic.subtopics) {
        appState.topic.subtopics.forEach(subtopic => {
            if (!subtopic.items) return;
            subtopic.items.forEach(item => {
                const itemKey = getItemKey(subtopic.id, item.id);
                const itemData = appState.learningItems[itemKey];
                if (itemData && itemData.level <= 2 && focusAreas.length < 10) {
                    focusAreas.push({
                        title: item.title,
                        subtopic: subtopic.name,
                        level: itemData.level
                    });
                }
            });
        });
    }

    // Get recent check-ins (last 10)
    const recentCheckins = appState.checkins.slice(-10).reverse().map(c => ({
        date: c.date,
        type: c.type || 'check-in',
        itemsReviewed: c.itemsReviewed || 0
    }));

    // Format Growth Character qualities (already stored as 0-100 values)
    const qualities = gc ? {
        foundation: Math.round(gc.qualities?.foundation || 0),
        momentum: Math.round(gc.qualities?.momentum || 0),
        steadiness: Math.round(gc.qualities?.steadiness || 0),
        engagedCuriosity: Math.round(gc.qualities?.engagedCuriosity || 0),
        persistence: Math.round(gc.qualities?.persistence || 0),
        learningHabits: Math.round(gc.qualities?.learningHabits || 0)
    } : null;

    const qualityLabels = gc?.qualityLabels || null;
    const narrative = gc?.narrative || null;

    return {
        // Metadata
        generated: new Date().toISOString(),
        reportVersion: '1.0',

        // Student info
        student: appState.student?.name || 'Student',
        studentClass: appState.student?.class || '',

        // Topic info
        topic: {
            name: appState.topic?.name || 'Unknown Topic',
            subject: appState.topic?.subject || '',
            yearLevel: appState.topic?.yearLevel || '',
            itemCount: stats.total
        },

        // Core metrics
        metrics: {
            overallPercent: stats.overallPercentage,
            avgLevel: Math.round(stats.avgLevel * 10) / 10,
            totalItems: stats.total,
            securedItems: stats.secured,
            checkinsCompleted: appState.checkins.length,
            currentStreak: streak.current,
            longestStreak: streak.longest,
            totalActiveDays: totalActiveDays,
            quizAttempts: quizAttempts,
            quizCorrect: quizCorrect,
            quizCorrectRate: quizCorrectRate,
            totalQuestions: totalQuestions,
            errorRate: Math.round(errorMetrics.errorRate * 100)
        },

        // Level distribution
        levelDistribution: {
            level1: stats.notStarted,
            level2: stats.beginning,
            level3: stats.developing,
            level4: stats.confident,
            level5: stats.secured
        },

        // Growth Character qualities and narrative
        qualities: qualities,
        qualityLabels: qualityLabels,
        narrative: narrative,

        // Activity date range
        activityRange: {
            firstDate: firstActivityDate,
            lastDate: lastActivityDate
        },

        // Detailed breakdowns
        subtopics: subtopicStats,
        focusAreas: focusAreas,
        recentCheckins: recentCheckins,

        // Last 7 days activity
        lastSevenDays: streak.lastSevenDays.map(d => ({
            date: d.date.toISOString().split('T')[0],
            hasActivity: d.hasActivity,
            isToday: d.isToday
        })),

        // Student questions and goals
        questions: appState.questions || [],
        goals: appState.goals || []
    };
}

/**
 * Generate and open a printable progress report in a new window
 */
function exportToPDF() {
    const metrics = gatherExportMetrics();
    const reportHTML = generatePrintReportHTML(metrics);

    // Open in new window for printing
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
        showToast('Please allow popups to print the report', 'error');
        return;
    }

    printWindow.document.write(reportHTML);
    printWindow.document.close();

    // Wait for content to load then trigger print
    printWindow.onload = function() {
        printWindow.focus();
        printWindow.print();
    };
}

/**
 * Generate the complete HTML for the print report
 * @param {object} metrics - Output from gatherExportMetrics()
 * @returns {string} Complete HTML document
 */
function generatePrintReportHTML(metrics) {
    const total = metrics.metrics.totalItems || 1;
    const reportDate = new Date().toLocaleDateString('en-AU', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });

    // Generate level distribution bars (using CSS, not ASCII)
    const levelBars = [
        { level: 5, name: 'Secured', count: metrics.levelDistribution.level5, color: '#8b5cf6' },
        { level: 4, name: 'Confident', count: metrics.levelDistribution.level4, color: '#22c55e' },
        { level: 3, name: 'Developing', count: metrics.levelDistribution.level3, color: '#eab308' },
        { level: 2, name: 'Beginning', count: metrics.levelDistribution.level2, color: '#06b6d4' },
        { level: 1, name: 'Not Started', count: metrics.levelDistribution.level1, color: '#94a3b8' }
    ].map(l => {
        const pct = Math.round((l.count / total) * 100);
        return `
            <div class="level-row">
                <span class="level-name">${l.name}</span>
                <div class="level-bar-container">
                    <div class="level-bar" style="width: ${pct}%; background: ${l.color};"></div>
                </div>
                <span class="level-count">${l.count}</span>
                <span class="level-pct">${pct}%</span>
            </div>
        `;
    }).join('');

    // Generate quality bars (if available)
    let qualitiesHTML = '';
    if (metrics.qualities) {
        const qualityItems = [
            { key: 'foundation', name: 'Foundation', desc: 'Starting knowledge depth' },
            { key: 'momentum', name: 'Momentum', desc: 'Rate of progress' },
            { key: 'steadiness', name: 'Steadiness', desc: 'Consistency of practice' },
            { key: 'engagedCuriosity', name: 'Engaged Curiosity', desc: 'Exploration of content' },
            { key: 'persistence', name: 'Persistence', desc: 'Recovery from setbacks' },
            { key: 'learningHabits', name: 'Learning Habits', desc: 'Regularity of check-ins' }
        ].map(q => {
            const value = metrics.qualities[q.key] || 0;
            const label = metrics.qualityLabels?.[q.key] || '';
            return `
                <div class="quality-row">
                    <div class="quality-header">
                        <span class="quality-name">${q.name}</span>
                        <span class="quality-value">${value}%</span>
                    </div>
                    <div class="quality-bar-container">
                        <div class="quality-bar" style="width: ${value}%;"></div>
                    </div>
                    <div class="quality-label">${label || q.desc}</div>
                </div>
            `;
        }).join('');

        // Add narrative if available
        const narrativeHTML = metrics.narrative ? `
            <div class="narrative-box">
                <p>${metrics.narrative}</p>
            </div>
        ` : '';

        qualitiesHTML = `
            <div class="section">
                <h2>Learning Character</h2>
                ${narrativeHTML}
                <div class="qualities-grid">
                    ${qualityItems}
                </div>
            </div>
        `;
    }

    // Generate focus areas (items needing attention)
    let focusAreasHTML = '';
    if (metrics.focusAreas && metrics.focusAreas.length > 0) {
        const focusItems = metrics.focusAreas.map(item => `
            <li>
                <span class="focus-subtopic">${item.subtopic}:</span>
                <span class="focus-title">${item.title}</span>
                <span class="focus-level level-${item.level}">Level ${item.level}</span>
            </li>
        `).join('');

        focusAreasHTML = `
            <div class="section">
                <h2>Focus Areas</h2>
                <p class="section-desc">Items that need more attention:</p>
                <ul class="focus-list">
                    ${focusItems}
                </ul>
            </div>
        `;
    }

    // Generate subtopic breakdown
    let subtopicsHTML = '';
    if (metrics.subtopics && metrics.subtopics.length > 0) {
        const subtopicRows = metrics.subtopics.map(st => `
            <tr>
                <td>${st.name}</td>
                <td class="center">${st.totalItems}</td>
                <td class="center">${st.avgLevel}/5</td>
                <td class="center">${st.securedCount}/${st.totalItems}</td>
                <td class="center">${st.securedPercent}%</td>
            </tr>
        `).join('');

        subtopicsHTML = `
            <div class="section">
                <h2>Subtopic Breakdown</h2>
                <table class="subtopic-table">
                    <thead>
                        <tr>
                            <th>Subtopic</th>
                            <th class="center">Items</th>
                            <th class="center">Avg Level</th>
                            <th class="center">Secured</th>
                            <th class="center">Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${subtopicRows}
                    </tbody>
                </table>
            </div>
        `;
    }

    // Generate recent activity
    let recentActivityHTML = '';
    if (metrics.recentCheckins && metrics.recentCheckins.length > 0) {
        const activityItems = metrics.recentCheckins.slice(0, 5).map(c => {
            const date = new Date(c.date).toLocaleDateString('en-AU', {
                day: 'numeric',
                month: 'short'
            });
            return `<li><strong>${date}</strong>: ${c.type} - ${c.itemsReviewed} items reviewed</li>`;
        }).join('');

        recentActivityHTML = `
            <div class="section section-small">
                <h2>Recent Activity</h2>
                <ul class="activity-list">
                    ${activityItems}
                </ul>
            </div>
        `;
    }

    // Build the complete HTML document
    return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Progress Report - ${metrics.student}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            color: #1f2937;
            padding: 20mm;
            max-width: 210mm;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 8mm;
            padding-bottom: 5mm;
            border-bottom: 2px solid #e5e7eb;
        }

        .header h1 {
            font-size: 18pt;
            font-weight: 600;
            margin-bottom: 2mm;
            color: #111827;
        }

        .header-meta {
            font-size: 10pt;
            color: #6b7280;
        }

        .header-meta span {
            margin: 0 8px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4mm;
            margin-bottom: 8mm;
        }

        .summary-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 4mm;
            text-align: center;
        }

        .summary-value {
            font-size: 20pt;
            font-weight: 700;
            color: #111827;
        }

        .summary-label {
            font-size: 9pt;
            color: #6b7280;
            margin-top: 1mm;
        }

        .section {
            margin-bottom: 8mm;
            page-break-inside: avoid;
        }

        .section-small {
            margin-bottom: 5mm;
        }

        .section h2 {
            font-size: 12pt;
            font-weight: 600;
            color: #374151;
            margin-bottom: 3mm;
            padding-bottom: 2mm;
            border-bottom: 1px solid #e5e7eb;
        }

        .section-desc {
            font-size: 9pt;
            color: #6b7280;
            margin-bottom: 3mm;
        }

        /* Narrative Box */
        .narrative-box {
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            border: 1px solid #ddd6fe;
            border-left: 4px solid #8b5cf6;
            border-radius: 4px;
            padding: 4mm;
            margin-bottom: 5mm;
        }

        .narrative-box p {
            font-size: 10pt;
            line-height: 1.6;
            color: #374151;
            margin: 0;
            font-style: italic;
        }

        /* Level Distribution */
        .level-row {
            display: flex;
            align-items: center;
            margin-bottom: 2mm;
            font-size: 10pt;
        }

        .level-name {
            width: 25mm;
            color: #374151;
        }

        .level-bar-container {
            flex: 1;
            height: 6mm;
            background: #f3f4f6;
            border-radius: 2px;
            margin: 0 3mm;
        }

        .level-bar {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .level-count {
            width: 8mm;
            text-align: right;
            color: #374151;
            font-weight: 500;
        }

        .level-pct {
            width: 12mm;
            text-align: right;
            color: #6b7280;
        }

        /* Qualities */
        .qualities-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4mm;
        }

        .quality-row {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 3mm;
        }

        .quality-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2mm;
        }

        .quality-name {
            font-weight: 500;
            color: #374151;
            font-size: 10pt;
        }

        .quality-value {
            font-weight: 600;
            color: #8b5cf6;
            font-size: 10pt;
        }

        .quality-bar-container {
            height: 4mm;
            background: #e5e7eb;
            border-radius: 2px;
            margin-bottom: 2mm;
        }

        .quality-bar {
            height: 100%;
            background: #8b5cf6;
            border-radius: 2px;
        }

        .quality-label {
            font-size: 8pt;
            color: #6b7280;
        }

        /* Focus Areas */
        .focus-list {
            list-style: none;
            font-size: 10pt;
        }

        .focus-list li {
            padding: 2mm 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .focus-list li:last-child {
            border-bottom: none;
        }

        .focus-subtopic {
            color: #6b7280;
        }

        .focus-title {
            color: #374151;
        }

        .focus-level {
            float: right;
            font-size: 8pt;
            padding: 1mm 2mm;
            border-radius: 2px;
            background: #f3f4f6;
            color: #6b7280;
        }

        .focus-level.level-1 { background: #f1f5f9; color: #64748b; }
        .focus-level.level-2 { background: #ecfeff; color: #0891b2; }

        /* Subtopic Table */
        .subtopic-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10pt;
        }

        .subtopic-table th,
        .subtopic-table td {
            padding: 2mm 3mm;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .subtopic-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            font-size: 9pt;
        }

        .subtopic-table .center {
            text-align: center;
        }

        /* Activity List */
        .activity-list {
            list-style: none;
            font-size: 10pt;
        }

        .activity-list li {
            padding: 1mm 0;
        }

        /* Footer */
        .footer {
            margin-top: 10mm;
            padding-top: 5mm;
            border-top: 1px solid #e5e7eb;
            text-align: center;
            font-size: 8pt;
            color: #9ca3af;
        }

        /* Guide Page */
        .guide-page {
            page-break-before: always;
            padding-top: 5mm;
        }

        .guide-page h1 {
            font-size: 16pt;
            font-weight: 600;
            color: #111827;
            margin-bottom: 6mm;
            padding-bottom: 3mm;
            border-bottom: 2px solid #e5e7eb;
        }

        .guide-section {
            margin-bottom: 6mm;
        }

        .guide-section h2 {
            font-size: 11pt;
            font-weight: 600;
            color: #374151;
            margin-bottom: 2mm;
        }

        .guide-section p {
            font-size: 10pt;
            color: #4b5563;
            margin-bottom: 2mm;
            line-height: 1.5;
        }

        .guide-example {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 3mm;
            margin: 2mm 0;
            font-size: 9pt;
        }

        .guide-example strong {
            color: #374151;
        }

        .guide-levels {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 2mm 4mm;
            font-size: 9pt;
            margin: 2mm 0;
        }

        .guide-level-name {
            font-weight: 500;
        }

        .guide-level-desc {
            color: #6b7280;
        }

        .guide-qualities {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3mm;
            margin: 2mm 0;
        }

        .guide-quality {
            font-size: 9pt;
        }

        .guide-quality strong {
            color: #374151;
        }

        .guide-quality span {
            color: #6b7280;
        }

        /* Print styles */
        @media print {
            body {
                padding: 15mm;
            }

            .section {
                page-break-inside: avoid;
            }

            .guide-page {
                page-break-before: always;
            }

            .summary-card,
            .quality-row {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .level-bar,
            .quality-bar {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        /* Grayscale-friendly alternatives */
        @media print and (monochrome) {
            .level-bar,
            .quality-bar {
                background: #374151 !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Learning Progress Report</h1>
        <div class="header-meta">
            <span><strong>${metrics.student}</strong></span>
            <span>|</span>
            <span>${metrics.topic.name}</span>
            <span>|</span>
            <span>${metrics.topic.subject || ''} ${metrics.topic.yearLevel || ''}</span>
            <span>|</span>
            <span>${reportDate}</span>
        </div>
    </div>

    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-value">${metrics.metrics.overallPercent}%</div>
            <div class="summary-label">Overall Progress</div>
        </div>
        <div class="summary-card">
            <div class="summary-value">${metrics.metrics.securedItems}/${metrics.metrics.totalItems}</div>
            <div class="summary-label">Items Secured</div>
        </div>
        <div class="summary-card">
            <div class="summary-value">${metrics.metrics.checkinsCompleted}</div>
            <div class="summary-label">Check-ins Completed</div>
        </div>
    </div>

    <div class="section">
        <h2>Level Distribution</h2>
        ${levelBars}
    </div>

    ${qualitiesHTML}

    ${focusAreasHTML}

    ${subtopicsHTML}

    ${recentActivityHTML}

    <div class="footer">
        Generated by Dynamic Learning Checklist &bull; ${reportDate}
        ${metrics.activityRange.firstDate ? `<br>Activity period: ${metrics.activityRange.firstDate} to ${metrics.activityRange.lastDate}` : ''}
    </div>

    <!-- How to Read This Report -->
    <div class="guide-page">
        <h1>How to Read This Report</h1>

        <div class="guide-section">
            <h2>Overall Progress</h2>
            <p>This percentage shows how far through the topic the student has progressed. It's calculated from the average of all learning item levels, where Level 5 (Secured) = 100% and Level 1 (Not Started) = 0%.</p>
            <div class="guide-example">
                <strong>Example:</strong> A student with 37% overall progress is roughly a third of the way through mastering this topic.
            </div>
        </div>

        <div class="guide-section">
            <h2>Understanding Levels</h2>
            <p>Each learning item is rated from Level 1 to Level 5 based on the student's demonstrated understanding:</p>
            <div class="guide-levels">
                <span class="guide-level-name">Level 1 - Not Started</span>
                <span class="guide-level-desc">Haven't engaged with this content yet</span>
                <span class="guide-level-name">Level 2 - Beginning</span>
                <span class="guide-level-desc">Starting to understand the basics</span>
                <span class="guide-level-name">Level 3 - Developing</span>
                <span class="guide-level-desc">Building understanding, can explain some concepts</span>
                <span class="guide-level-name">Level 4 - Confident</span>
                <span class="guide-level-desc">Solid understanding, can apply the knowledge</span>
                <span class="guide-level-name">Level 5 - Secured</span>
                <span class="guide-level-desc">Mastered this item, demonstrated through correct quiz answers</span>
            </div>
            <div class="guide-example">
                <strong>Example:</strong> If a student has 5 items at Level 5 and 9 at Level 1, they've secured about 18% of the content and have 32% still to begin.
            </div>
        </div>

        <div class="guide-section">
            <h2>Learning Character</h2>
            <p>The Learning Character provides insight into how the student learns, not just what they've learned. It's generated from their activity patterns over time.</p>
            <div class="guide-qualities">
                <div class="guide-quality"><strong>Foundation</strong> <span>‚Äî Where they started. Higher means they had prior knowledge.</span></div>
                <div class="guide-quality"><strong>Momentum</strong> <span>‚Äî Rate of improvement. Higher means faster progress.</span></div>
                <div class="guide-quality"><strong>Steadiness</strong> <span>‚Äî Consistency of practice. Higher means regular, even progress.</span></div>
                <div class="guide-quality"><strong>Engaged Curiosity</strong> <span>‚Äî Exploration of content. Higher means they read explanations and examples.</span></div>
                <div class="guide-quality"><strong>Persistence</strong> <span>‚Äî Recovery from mistakes. Higher means they retry after getting questions wrong.</span></div>
                <div class="guide-quality"><strong>Learning Habits</strong> <span>‚Äî Regularity of check-ins. Higher means consistent study routine.</span></div>
            </div>
            <div class="guide-example">
                <strong>Example:</strong> A student with high Persistence (85%) but low Foundation (20%) started with little prior knowledge but keeps trying when things get difficult.
            </div>
        </div>

        <div class="guide-section">
            <h2>Focus Areas</h2>
            <p>These are specific learning items at Level 1 or 2 that need more attention. Working on these items will have the biggest impact on overall progress.</p>
        </div>

        <div class="guide-section">
            <h2>Subtopic Breakdown</h2>
            <p>Shows progress within each section of the topic. The "Avg Level" column shows the average understanding (out of 5), and "Secured" shows how many items have reached Level 5.</p>
            <div class="guide-example">
                <strong>Example:</strong> "Wave Properties: 3/5 avg | 1/4 secured" means the student averages Level 3 understanding across 4 items, with 1 item fully mastered.
            </div>
        </div>

        <div class="guide-section">
            <h2>What This Report Doesn't Show</h2>
            <p>This report reflects self-assessed understanding and quiz performance within the app. It's one piece of the picture. It doesn't replace classroom assessment, and students may understand more (or less) than these numbers suggest. Use it as a conversation starter about learning progress, not a definitive measure of ability.</p>
        </div>
    </div>
</body>
</html>`;
}

/**
 * Export ALL data across all topics
 */
function exportAllData() {
    // Make sure current topic data is saved to the store first
    if (appState.currentTopicPath) {
        topicProgressStore[appState.currentTopicPath] = {
            learningItems: appState.learningItems,
            checkins: appState.checkins,
            goals: appState.goals,
            questions: appState.questions,
            sessions: appState.sessions,
            practiceCalendar: appState.practiceCalendar,
            quizStats: appState.quizStats,
            growthCharacters: appState.growthCharacters
        };
    }

    // Calculate total stats across all topics
    let totalCheckins = 0;
    let totalItems = 0;
    Object.values(topicProgressStore).forEach(topic => {
        totalCheckins += (topic.checkins || []).length;
        totalItems += Object.keys(topic.learningItems || {}).length;
    });

    const data = {
        exportType: 'full',
        exportVersion: '1.0',
        appVersion: '2.0',
        exportDate: new Date().toISOString(),

        // Student info
        student: appState.student,

        // All topics progress data
        topicProgressStore: topicProgressStore,

        // Current topic context (for convenience on restore)
        currentTopicPath: appState.currentTopicPath,
        currentTopic: appState.topic?.name || null,

        // Global settings
        settings: {
            theme: appState.theme,
            skipPreTopicQuestions: appState.skipPreTopicQuestions,
            // Level display preferences
            levelPrefs: {
                displayMode: levelPrefs.displayMode,
                emojiProgression: levelPrefs.emojiProgression,
                colors: levelPrefs.colors
            }
        },

        // Summary stats for preview
        summary: {
            topicCount: Object.keys(topicProgressStore).length,
            totalCheckins: totalCheckins,
            totalItems: totalItems,
            topicNames: Object.keys(topicProgressStore).map(path => {
                const parts = path.split('/');
                return parts[parts.length - 1].replace(/-/g, ' ');
            })
        }
    };

    // Create filename with student name
    const studentSlug = (appState.student?.name || 'student').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    const dateStr = new Date().toISOString().split('T')[0];
    const filename = `learning-backup-full-${studentSlug}-${dateStr}.json`;

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);

    showToast(`Full backup downloaded (${data.summary.topicCount} topics)`, 'success');
}

// ============================================
// EMAIL SUMMARY FUNCTIONS
// ============================================

/**
 * Generate email subject line
 * @param {object} metrics - Output from gatherExportMetrics()
 * @returns {string} Email subject line
 */
function generateEmailSubject(metrics) {
    const date = new Date().toISOString().split('T')[0];
    return `Learning Progress: ${metrics.student} - ${metrics.topic.name} - ${date}`;
}

/**
 * Show email summary preview panel
 */
function showEmailPreview() {
    const metrics = gatherExportMetrics();
    const emailText = generateEmailText(metrics);
    const subjectLine = generateEmailSubject(metrics);

    document.getElementById('email-subject-text').textContent = subjectLine;
    document.getElementById('email-preview-content').textContent = emailText;

    // Build prominent questions banner at the top of the preview
    const bannerEl = document.getElementById('email-questions-banner');
    const questions = metrics.questions || [];
    if (questions.length > 0) {
        const listItems = questions.map(q => {
            const qText = (typeof q === 'string') ? q : (q.text || '(empty question)');
            return `<li>${escapeHtml(qText)}</li>`;
        }).join('');
        bannerEl.innerHTML = `
            <div class="email-questions-banner has-questions">
                <h4>Questions for my teacher (${questions.length})</h4>
                <ol>${listItems}</ol>
            </div>`;
    } else {
        bannerEl.innerHTML = `
            <div class="email-questions-banner no-questions">
                <h4>No questions for teacher</h4>
                <p style="margin:0;">You haven't added any questions for your teacher yet. Go to the Goals tab to add questions before sending.</p>
            </div>`;
    }

    document.getElementById('email-preview-panel').style.display = 'block';

    // Scroll panel into view
    document.getElementById('email-preview-panel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

/**
 * Hide email summary preview panel
 */
function hideEmailPreview() {
    document.getElementById('email-preview-panel').style.display = 'none';
}

/**
 * Open email client with pre-populated subject and body
 */
function openEmailClient() {
    const metrics = gatherExportMetrics();
    const subject = generateEmailSubject(metrics);
    const body = generateEmailText(metrics);

    // Encode for mailto: URL
    const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

    window.location.href = mailtoUrl;
    hideEmailPreview();
    showToast('Opening email client...', 'success');
}

/**
 * Copy full email summary to clipboard
 */
function copyEmailSummary() {
    const metrics = gatherExportMetrics();
    const emailText = generateEmailText(metrics);

    navigator.clipboard.writeText(emailText).then(() => {
        showToast('Summary copied to clipboard', 'success');
        hideEmailPreview();
    }).catch(() => {
        showToast('Failed to copy to clipboard', 'error');
    });
}

/**
 * Copy only the JSON data block to clipboard (for teachers)
 */
function copyEmailJSON() {
    const metrics = gatherExportMetrics();
    const jsonData = generateEmailJSON(metrics);

    navigator.clipboard.writeText(JSON.stringify(jsonData, null, 2)).then(() => {
        showToast('JSON copied to clipboard', 'success');
        hideEmailPreview();
    }).catch(() => {
        showToast('Failed to copy to clipboard', 'error');
    });
}

/**
 * Generate ASCII bar for level distribution visualization
 * @param {number} count - Number of items at this level
 * @param {number} total - Total number of items
 * @param {number} maxWidth - Maximum bar width in characters
 * @returns {string} ASCII bar string
 */
function generateAsciiBar(count, total, maxWidth = 20) {
    if (total === 0) return '';
    const percent = count / total;
    const filled = Math.round(percent * maxWidth);
    return '‚ñà'.repeat(filled) + '‚ñë'.repeat(maxWidth - filled);
}

/**
 * Generate human-readable email text
 * @param {object} metrics - Output from gatherExportMetrics()
 * @returns {string} Formatted email text
 */
function generateEmailText(metrics) {
    const total = metrics.metrics.totalItems || 1;

    // Calculate percentages for level distribution
    const l5Pct = Math.round((metrics.levelDistribution.level5 / total) * 100);
    const l4Pct = Math.round((metrics.levelDistribution.level4 / total) * 100);
    const l3Pct = Math.round((metrics.levelDistribution.level3 / total) * 100);
    const l2Pct = Math.round((metrics.levelDistribution.level2 / total) * 100);
    const l1Pct = Math.round((metrics.levelDistribution.level1 / total) * 100);

    let text = `LEARNING PROGRESS REPORT
========================

Student: ${metrics.student}
Topic: ${metrics.topic.name}
Subject: ${metrics.topic.subject || 'N/A'} | Year: ${metrics.topic.yearLevel || 'N/A'}
Report Date: ${new Date().toISOString().split('T')[0]}
Period: ${metrics.activityRange.firstDate || 'N/A'} to ${metrics.activityRange.lastDate || 'N/A'}
`;

    // Questions for Teacher ‚Äî always shown, prominently, at the top of the report
    text += `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  QUESTIONS FOR MY TEACHER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

`;
    if (metrics.questions && metrics.questions.length > 0) {
        metrics.questions.forEach((q, i) => {
            // q is an object {text, context, created, status} ‚Äî use q.text
            const qText = (typeof q === 'string') ? q : (q.text || '(empty question)');
            text += `  ${i + 1}. ${qText}\n`;
        });
    } else {
        text += `  (No questions submitted for this report.)\n`;
    }
    text += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;

    // Add Learning Character narrative if available
    if (metrics.narrative) {
        text += `
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
LEARNING CHARACTER
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

${metrics.narrative}
`;
    }

    // Add Student Goals if any
    if (metrics.goals && metrics.goals.length > 0) {
        text += `
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
MY LEARNING GOALS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

`;
        metrics.goals.forEach((g, i) => {
            text += `${i + 1}. ${g}\n`;
        });
    }

    text += `
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SUMMARY METRICS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Overall Progress: ${metrics.metrics.overallPercent}%
Learning Points: ${metrics.metrics.securedItems}/${metrics.metrics.totalItems} secured
Check-ins Completed: ${metrics.metrics.checkinsCompleted}
Current Streak: ${metrics.metrics.currentStreak} days
Total Active Days: ${metrics.metrics.totalActiveDays}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
LEVEL DISTRIBUTION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

${generateAsciiBar(metrics.levelDistribution.level5, total)}\tSecured\t\t${metrics.levelDistribution.level5}\t(${l5Pct}%)
${generateAsciiBar(metrics.levelDistribution.level4, total)}\tConfident\t${metrics.levelDistribution.level4}\t(${l4Pct}%)
${generateAsciiBar(metrics.levelDistribution.level3, total)}\tDeveloping\t${metrics.levelDistribution.level3}\t(${l3Pct}%)
${generateAsciiBar(metrics.levelDistribution.level2, total)}\tBeginning\t${metrics.levelDistribution.level2}\t(${l2Pct}%)
${generateAsciiBar(metrics.levelDistribution.level1, total)}\tNot Started\t${metrics.levelDistribution.level1}\t(${l1Pct}%)
`;

    // Add Learning Qualities if available
    if (metrics.qualities) {
        text += `
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
LEARNING QUALITIES
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Foundation:        ${metrics.qualities.foundation}%${metrics.qualityLabels?.foundation ? ' - ' + metrics.qualityLabels.foundation : ''}
Momentum:          ${metrics.qualities.momentum}%${metrics.qualityLabels?.momentum ? ' - ' + metrics.qualityLabels.momentum : ''}
Steadiness:        ${metrics.qualities.steadiness}%${metrics.qualityLabels?.steadiness ? ' - ' + metrics.qualityLabels.steadiness : ''}
Engaged Curiosity: ${metrics.qualities.engagedCuriosity}%${metrics.qualityLabels?.engagedCuriosity ? ' - ' + metrics.qualityLabels.engagedCuriosity : ''}
Persistence:       ${metrics.qualities.persistence}%${metrics.qualityLabels?.persistence ? ' - ' + metrics.qualityLabels.persistence : ''}
Learning Habits:   ${metrics.qualities.learningHabits}%${metrics.qualityLabels?.learningHabits ? ' - ' + metrics.qualityLabels.learningHabits : ''}
`;
    }

    // Add Quiz Performance
    text += `
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
QUIZ PERFORMANCE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Total Questions Attempted: ${metrics.metrics.quizAttempts}
Correct Rate: ${metrics.metrics.quizCorrectRate}%
`;

    // Add Focus Areas
    if (metrics.focusAreas.length > 0) {
        text += `
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
FOCUS AREAS (Needs Attention)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

`;
        metrics.focusAreas.forEach(item => {
            text += `‚Ä¢ ${item.subtopic}: ${item.title} (Level ${item.level})\n`;
        });
    }

    // Add Subtopic Progress
    if (metrics.subtopics.length > 0) {
        text += `
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SUBTOPIC PROGRESS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

`;
        metrics.subtopics.forEach(st => {
            text += `${st.name}: ${st.avgLevel}/5 avg | ${st.securedCount}/${st.totalItems} secured\n`;
        });
    }

    // Add Recent Activity
    if (metrics.recentCheckins.length > 0) {
        text += `
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
RECENT ACTIVITY
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

`;
        metrics.recentCheckins.slice(0, 5).forEach(c => {
            const date = new Date(c.date).toLocaleDateString('en-AU');
            text += `${date}: ${c.type} - ${c.itemsReviewed} items reviewed\n`;
        });
    }

    // Add Machine-Readable JSON Block
    const jsonData = generateEmailJSON(metrics);
    text += `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
MACHINE-READABLE DATA (for aggregation)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

\`\`\`json
${JSON.stringify(jsonData, null, 2)}
\`\`\`

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Generated by Dynamic Learning Checklist
`;

    return text;
}

/**
 * Generate machine-readable JSON for teacher aggregation
 * @param {object} metrics - Output from gatherExportMetrics()
 * @returns {object} JSON-ready object
 */
function generateEmailJSON(metrics) {
    return {
        reportVersion: '1.0',
        generatedAt: metrics.generated,
        student: metrics.student,
        topic: {
            name: metrics.topic.name,
            subject: metrics.topic.subject,
            yearLevel: metrics.topic.yearLevel
        },
        metrics: {
            overallPercent: metrics.metrics.overallPercent,
            totalItems: metrics.metrics.totalItems,
            securedItems: metrics.metrics.securedItems,
            checkinsCompleted: metrics.metrics.checkinsCompleted,
            currentStreak: metrics.metrics.currentStreak,
            totalActiveDays: metrics.metrics.totalActiveDays,
            quizAttempts: metrics.metrics.quizAttempts,
            quizCorrectRate: metrics.metrics.quizCorrectRate
        },
        levelDistribution: metrics.levelDistribution,
        qualities: metrics.qualities,
        narrative: metrics.narrative || null,
        subtopics: metrics.subtopics.map(st => ({
            name: st.name,
            totalItems: st.totalItems,
            avgLevel: st.avgLevel,
            securedCount: st.securedCount
        })),
        questions: metrics.questions || [],
        goals: metrics.goals || []
    };
}

// ============================================
// RESTORE DATA FUNCTIONS
// ============================================

// Temporary storage for pending restore data
let pendingRestoreData = null;

/**
 * Handle file selection for restore
 */
function handleRestoreFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Check file type
    if (!file.name.endsWith('.json')) {
        showToast('Please select a JSON backup file', 'error');
        event.target.value = '';
        return;
    }

    // Check file size (warn if over 10MB)
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
        showToast('File is very large. This may take a moment...', 'warning');
    }

    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);

            // Basic sanity check - must be an object
            if (typeof data !== 'object' || data === null || Array.isArray(data)) {
                showToast('Invalid backup file structure', 'error');
                return;
            }

            validateAndPreviewRestore(data);
        } catch (err) {
            console.error('Restore parse error:', err);
            if (err instanceof SyntaxError) {
                showToast('File contains invalid JSON. It may be corrupted.', 'error');
            } else {
                showToast('Failed to read backup file. Please try again.', 'error');
            }
        }
    };

    reader.onerror = function() {
        showToast('Failed to read the file. Please try again.', 'error');
    };

    reader.readAsText(file);

    // Reset file input so same file can be selected again
    event.target.value = '';
}

/**
 * Validate restore data and show preview
 * Handles both full backups (exportType: 'full') and legacy single-topic backups
 */
function validateAndPreviewRestore(data) {
    // Check if this is a full backup or legacy single-topic backup
    const isFullBackup = data.exportType === 'full';

    // Basic validation
    if (!isFullBackup && !data.learningItems && !data.exportDate) {
        showToast('This file does not appear to be a valid backup', 'error');
        return;
    }

    if (isFullBackup && !data.topicProgressStore) {
        showToast('This full backup file appears to be corrupted', 'error');
        return;
    }

    // Version compatibility check
    const exportVersion = data.exportVersion || '0.0';
    const supportedVersions = ['1.0'];
    if (data.exportVersion && !supportedVersions.includes(exportVersion)) {
        showToast(`Backup version ${exportVersion} may not be fully compatible. Proceeding with caution.`, 'warning');
    }

    pendingRestoreData = data;

    const backupDate = data.exportDate ? new Date(data.exportDate).toLocaleDateString('en-AU') : 'Unknown';
    const appVersion = data.appVersion || 'Unknown';
    let previewHTML = '';
    let warningText = '';

    if (isFullBackup) {
        // Full backup preview
        const topicCount = data.summary?.topicCount || Object.keys(data.topicProgressStore).length;
        const topicNames = data.summary?.topicNames || Object.keys(data.topicProgressStore);
        const studentName = data.student?.name || 'Unknown';
        const totalCheckins = data.summary?.totalCheckins || 0;
        const totalItems = data.summary?.totalItems || 0;

        previewHTML = `
            <div class="restore-type-badge restore-type-full">Full Backup</div>
            <dl>
                <dt>Student:</dt>
                <dd>${studentName}</dd>
                <dt>Backup Date:</dt>
                <dd>${backupDate}</dd>
                <dt>App Version:</dt>
                <dd>${appVersion}</dd>
                <dt>Topics:</dt>
                <dd>${topicCount}</dd>
                <dt>Total Learning Items:</dt>
                <dd>${totalItems}</dd>
                <dt>Total Check-ins:</dt>
                <dd>${totalCheckins}</dd>
            </dl>
            <div class="restore-topics-list">
                <strong>Topics included:</strong>
                <ul>
                    ${topicNames.slice(0, 10).map(name => `<li>${name}</li>`).join('')}
                    ${topicNames.length > 10 ? `<li><em>...and ${topicNames.length - 10} more</em></li>` : ''}
                </ul>
            </div>
        `;
        warningText = '‚ö†Ô∏è This will replace ALL your learning data across all topics';
    } else {
        // Legacy single-topic backup preview
        const topicName = data.topicMeta?.name || data.topic || 'Unknown';
        const itemCount = data.learningItems ? Object.keys(data.learningItems).length : 0;
        const checkinCount = data.checkins ? data.checkins.length : 0;

        // Check for topic mismatch
        const currentTopic = appState.topic?.name || '';
        const topicMismatch = topicName !== currentTopic && currentTopic !== '';

        previewHTML = `
            <div class="restore-type-badge restore-type-single">Single Topic Backup</div>
            <dl>
                <dt>Topic:</dt>
                <dd>${topicName}</dd>
                <dt>Backup Date:</dt>
                <dd>${backupDate}</dd>
                <dt>Learning Items:</dt>
                <dd>${itemCount}</dd>
                <dt>Check-ins:</dt>
                <dd>${checkinCount}</dd>
            </dl>
        `;

        if (topicMismatch) {
            previewHTML += `
                <div class="restore-topic-mismatch">
                    ‚ö†Ô∏è Warning: This backup is for "${topicName}" but you currently have "${currentTopic}" loaded.
                </div>
            `;
        }
        warningText = '‚ö†Ô∏è This will replace data for the current topic only';
    }

    document.getElementById('restore-preview-content').innerHTML = previewHTML;
    document.getElementById('restore-preview-warning').textContent = warningText;
    document.getElementById('restore-preview-panel').style.display = 'block';
}

/**
 * Hide restore preview panel
 */
function hideRestorePreview() {
    document.getElementById('restore-preview-panel').style.display = 'none';
    pendingRestoreData = null;
}

/**
 * Execute the restore operation
 * Handles both full backups and legacy single-topic backups
 */
function executeRestore() {
    if (!pendingRestoreData) {
        showToast('No restore data available', 'error');
        return;
    }

    const data = pendingRestoreData;
    const isFullBackup = data.exportType === 'full';

    if (isFullBackup) {
        // Full restore - replace everything
        executeFullRestore(data);
    } else {
        // Legacy single-topic restore
        executeSingleTopicRestore(data);
    }
}

/**
 * Execute a full restore (all topics)
 */
function executeFullRestore(data) {
    // Restore student info
    if (data.student) {
        appState.student = data.student;
        document.getElementById('student-name-display').textContent = data.student.name || 'Student';
        document.getElementById('student-name-input').value = data.student.name || '';
        document.getElementById('class-input').value = data.student.class || '';
    }

    // Restore all topic progress data
    if (data.topicProgressStore) {
        topicProgressStore = data.topicProgressStore;
    }

    // Restore global settings
    if (data.settings) {
        if (data.settings.theme) {
            appState.theme = data.settings.theme;
            document.body.classList.toggle('dark-mode', data.settings.theme === 'dark');
            document.getElementById('dark-mode-toggle').checked = data.settings.theme === 'dark';
        }
        if (data.settings.skipPreTopicQuestions !== undefined) {
            appState.skipPreTopicQuestions = data.settings.skipPreTopicQuestions;
            document.getElementById('skip-pretopic-questions-toggle').checked = data.settings.skipPreTopicQuestions;
        }
        // Restore level display preferences
        if (data.settings.levelPrefs) {
            levelPrefs.displayMode = data.settings.levelPrefs.displayMode || 'emoji';
            levelPrefs.emojiProgression = data.settings.levelPrefs.emojiProgression || 0;
            levelPrefs.colors = data.settings.levelPrefs.colors || [...defaultLevelColors];
            saveLevelPreferences();
            applyLevelPreferences();
        }
    }

    // If a topic is currently loaded, refresh its data from the restored store
    if (appState.currentTopicPath && topicProgressStore[appState.currentTopicPath]) {
        const stored = topicProgressStore[appState.currentTopicPath];
        appState.learningItems = stored.learningItems || {};
        appState.checkins = stored.checkins || [];
        appState.goals = stored.goals || [];
        appState.questions = stored.questions || [];
        appState.sessions = stored.sessions || [];
        appState.practiceCalendar = stored.practiceCalendar || {};
        appState.quizStats = stored.quizStats || {};
        appState.growthCharacters = stored.growthCharacters || [];
    }

    // Save everything
    saveData();
    hideRestorePreview();

    // Refresh UI
    renderOverview();
    renderLearningContent();
    renderHistory();
    renderGoals();
    renderQuestions();
    updateBadges();

    const topicCount = Object.keys(topicProgressStore).length;
    showToast(`Full restore complete (${topicCount} topics)`, 'success');
}

/**
 * Execute a single-topic restore (legacy format)
 */
function executeSingleTopicRestore(data) {
    // Restore learning items
    if (data.learningItems) {
        appState.learningItems = data.learningItems;
    }

    // Restore check-ins
    if (data.checkins) {
        appState.checkins = data.checkins;
    }

    // Restore goals
    if (data.goals) {
        appState.goals = data.goals;
    }

    // Restore questions
    if (data.questions) {
        appState.questions = data.questions;
    }

    // Restore Growth Character data (if present)
    if (data.growthCharacters) {
        appState.growthCharacters = data.growthCharacters;
    }

    if (data.quizStats) {
        appState.quizStats = data.quizStats;
    }

    if (data.practiceCalendar) {
        appState.practiceCalendar = data.practiceCalendar;
    }

    if (data.sessions) {
        appState.sessions = data.sessions;
    }

    // Save and refresh
    saveData();
    hideRestorePreview();

    // Refresh UI
    renderOverview();
    renderLearningContent();
    renderHistory();
    renderGoals();
    renderQuestions();
    updateBadges();

    showToast('Data restored successfully', 'success');
}

// ============================================
// DATA MANAGEMENT
// ============================================

/**
 * Show inline confirmation for clearing topic progress
 */
function showClearTopicConfirm() {
    document.getElementById('clear-topic-action')?.classList.add('confirming');
}

/**
 * Hide inline confirmation for clearing topic progress
 */
function hideClearTopicConfirm() {
    document.getElementById('clear-topic-action')?.classList.remove('confirming');
}

/**
 * Execute clear progress for topic
 */
function executeClearProgressForTopic() {
    hideClearTopicConfirm();
    
    appState.learningItems = {};
    appState.checkins = [];
    initLearningItems();
    saveData();
    renderAll();
    showToast('Progress cleared for current topic', 'info');
}

/**
 * Show inline confirmation for clearing all data
 */
function showClearAllConfirm() {
    document.getElementById('clear-all-action')?.classList.add('confirming');
}

/**
 * Hide inline confirmation for clearing all data
 */
function hideClearAllConfirm() {
    document.getElementById('clear-all-action')?.classList.remove('confirming');
}

/**
 * Execute clear all data
 */
function executeClearAllData() {
    hideClearAllConfirm();
    
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(PROGRESS_STORE_KEY);
    localStorage.removeItem(QUIZ_STATE_KEY);
    localStorage.removeItem(DROPDOWN_SELECTION_KEY);
    localStorage.removeItem(TOPIC_AVAILABILITY_KEY);
    localStorage.removeItem(LEVEL_PREFS_KEY);
    localStorage.removeItem(FIRST_RUN_KEY);
    localStorage.removeItem(SELECTION_TIP_KEY);
    
    // Reset state
    appState = {
        student: { name: '', class: '' },
        topic: null,
        currentTopicId: null,
        currentTopicPath: null,
        learningItems: {},
        checkins: [],
        goals: [],
        questions: [],
        theme: 'light',
        skipPreTopicQuestions: false,
        lastSaved: null,
        // Growth Character System
        sessions: [],
        practiceCalendar: {},
        quizStats: {},
        growthCharacters: []
    };

    topicProgressStore = {};
    quizState = {};
    questionsCache = {};
    topicAvailabilityCache = {};

    // Reset session tracking
    currentSession = null;
    lastInteractionTime = null;
    if (sessionIdleTimeout) {
        clearTimeout(sessionIdleTimeout);
        sessionIdleTimeout = null;
    }
    levelPrefs = {
        displayMode: 'emoji',
        emojiProgression: 0,
        colors: [...defaultLevelColors]
    };
    
    // Reset level preferences UI
    applyLevelColors();
    updateLevelPrefsUI();
    
    // Reset skip pre-topic questions toggle
    const skipToggle = document.getElementById('skip-pretopic-questions-toggle');
    if (skipToggle) skipToggle.checked = false;
    
    renderAll();
    showToast('All data cleared', 'info');
}

// ============================================
// DEBUG FUNCTIONS
// ============================================

/**
 * Debug: Randomly increment learning item levels (triggered by q+w+e)
 */
function debugRandomizeLevels() {
    if (!appState.topic || Object.keys(appState.learningItems).length === 0) {
        showToast('No topic loaded for debug', 'warning');
        return;
    }
    
    const itemKeys = Object.keys(appState.learningItems);
    let changedCount = 0;
    
    // Randomly increment some items
    itemKeys.forEach(itemKey => {
        // ~40% chance to change each item
        if (Math.random() < 0.4) {
            const currentLevel = appState.learningItems[itemKey].level;
            if (currentLevel < 5) {
                // Random increment: 1 step (70%) or 2 steps (30%)
                const increment = Math.random() < 0.7 ? 1 : 2;
                const newLevel = Math.min(5, currentLevel + increment);
                
                appState.learningItems[itemKey].level = newLevel;
                appState.learningItems[itemKey].history.push({
                    date: new Date().toISOString(),
                    from: currentLevel,
                    to: newLevel,
                    reason: 'debug'
                });
                changedCount++;
            }
        }
    });
    
    if (changedCount > 0) {
        saveData();
        // Push each changed item to Google Sheet
        itemKeys.forEach(itemKey => {
            const item = appState.learningItems[itemKey];
            const lastHistory = item.history[item.history.length - 1];
            if (lastHistory && lastHistory.reason === 'debug') {
                pushProgressToServer('level-change', {
                    learningPointCode: itemKey,
                    currentLevel: item.level,
                    overallPercent: calculateStats()?.overallPercentage || 0
                });
            }
        });
        renderAll();
        showToast(`Debug: ${changedCount} items randomized`, 'info');
    } else {
        showToast('Debug: No changes made', 'info');
    }
}

/**
 * Debug: Select the correct answer in the current quiz
 */
function debugSelectCorrectAnswer() {
    if (!currentQuiz || currentQuiz.answered) return;
    
    if (currentQuiz.questionType === 'cloze') {
        // For cloze questions, select correct option for each blank
        currentQuiz.blankIds.forEach(blankId => {
            const options = currentQuiz[`blankOptions_${blankId}`];
            const correctOption = options.find(opt => opt.isCorrect);
            if (correctOption) {
                const select = document.querySelector(`.cloze-select[data-blank-id="${blankId}"]`);
                if (select) {
                    select.value = correctOption.value;
                    onClozeSelectChange(select);
                }
            }
        });
        showToast('Debug: Correct answers selected', 'info');
    } else {
        // For MC questions, find and select the correct option
        const correctIndex = currentQuiz.options.findIndex(opt => opt.isCorrect);
        if (correctIndex !== -1) {
            selectMCOption(correctIndex);
            showToast('Debug: Correct answer selected', 'info');
        }
    }
}

/**
 * Debug: Select a random wrong answer in the current quiz
 */
function debugSelectWrongAnswer() {
    if (!currentQuiz || currentQuiz.answered) return;
    
    if (currentQuiz.questionType === 'cloze') {
        // For cloze questions, select a wrong option for each blank
        currentQuiz.blankIds.forEach(blankId => {
            const options = currentQuiz[`blankOptions_${blankId}`];
            const wrongOptions = options.filter(opt => !opt.isCorrect);
            if (wrongOptions.length > 0) {
                const randomWrong = wrongOptions[Math.floor(Math.random() * wrongOptions.length)];
                const select = document.querySelector(`.cloze-select[data-blank-id="${blankId}"]`);
                if (select) {
                    select.value = randomWrong.value;
                    onClozeSelectChange(select);
                }
            }
        });
        showToast('Debug: Wrong answers selected', 'info');
    } else {
        // For MC questions, find and select a random wrong option
        const wrongIndices = currentQuiz.options
            .map((opt, i) => opt.isCorrect ? -1 : i)
            .filter(i => i !== -1);
        
        if (wrongIndices.length > 0) {
            const randomIndex = wrongIndices[Math.floor(Math.random() * wrongIndices.length)];
            selectMCOption(randomIndex);
            showToast('Debug: Wrong answer selected', 'info');
        }
    }
}

// ============================================
// TEXT SELECTION POPUP
// ============================================
function initSelectionPopup() {
    selectionPopup = document.getElementById('selection-popup');
    
    // Selection event
    document.addEventListener('mouseup', handleTextSelection);
    
    // Hide popup when clicking elsewhere
    document.addEventListener('mousedown', (e) => {
        if (!selectionPopup.contains(e.target)) {
            hideSelectionPopup();
        }
    });
    
    // Hide on scroll
    document.addEventListener('scroll', hideSelectionPopup, true);
    
    // Button handlers
    document.getElementById('popup-teacher-btn').addEventListener('click', () => {
        const text = window.getSelection().toString().trim();
        handleTeacherQuestion(text, getSelectionContext());
        hideSelectionPopup();
    });
    
    document.getElementById('popup-google-btn').addEventListener('click', () => {
        const text = window.getSelection().toString().trim();
        handleGoogleSearch(text, getSelectionContext());
        hideSelectionPopup();
    });
    
    document.getElementById('popup-chatgpt-btn').addEventListener('click', () => {
        const text = window.getSelection().toString().trim();
        handleChatGPT(text, getSelectionContext());
        hideSelectionPopup();
    });
}

function handleTextSelection(e) {
    if (selectionTimeout) {
        clearTimeout(selectionTimeout);
        selectionTimeout = null;
    }
    
    const selection = window.getSelection();
    const selectedText = selection.toString().trim();
    
    if (selectedText.length < 3) return;
    if (selectionPopup.contains(e.target)) return;
    
    // Check if in learning content
    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer;
    const element = container.nodeType === Node.ELEMENT_NODE ? container : container.parentElement;
    
    if (!element) return;
    
    const isInLearningTitle = element.closest('.learning-item-title');
    const isInHelpContent = element.closest('.help-content-inline');
    const isInSubtopicExplanation = element.closest('.explanation-content');
    
    if (!isInLearningTitle && !isInHelpContent && !isInSubtopicExplanation) return;
    
    // Show popup after delay
    selectionTimeout = setTimeout(() => {
        const currentSelection = window.getSelection();
        const currentText = currentSelection.toString().trim();
        
        if (currentText.length >= 3 && currentText === selectedText) {
            showSelectionPopup(currentSelection);
        }
    }, 1000);
}

function showSelectionPopup(selection) {
    if (!selection.rangeCount) return;
    
    const range = selection.getRangeAt(0);
    const rect = range.getBoundingClientRect();
    
    selectionPopup.style.display = 'flex';
    
    const popupRect = selectionPopup.getBoundingClientRect();
    let left = rect.left + (rect.width / 2) - (popupRect.width / 2);
    left = Math.max(8, Math.min(left, window.innerWidth - popupRect.width - 8));
    
    const spaceBelow = window.innerHeight - rect.bottom;
    let top;
    if (spaceBelow > popupRect.height + 10) {
        top = rect.bottom + window.scrollY + 8;
    } else {
        top = rect.top + window.scrollY - popupRect.height - 8;
    }
    
    selectionPopup.style.left = `${left}px`;
    selectionPopup.style.top = `${top}px`;
}

function hideSelectionPopup() {
    if (selectionPopup) selectionPopup.style.display = 'none';
    if (selectionTimeout) {
        clearTimeout(selectionTimeout);
        selectionTimeout = null;
    }
}

function getSelectionContext() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return null;
    
    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer;
    const itemEl = container.nodeType === Node.ELEMENT_NODE 
        ? container.closest('.learning-item-simple')
        : container.parentElement?.closest('.learning-item-simple');
    
    if (!itemEl) return { topic: appState.topic?.name || 'Unknown topic' };
    
    const itemKey = itemEl.dataset.itemKey;
    const item = getItemByKey(itemKey);
    const itemData = appState.learningItems[itemKey] || { level: 1 };
    
    return {
        itemKey,
        itemTitle: item?.title || 'Unknown item',
        itemWhat: item?.what || '',
        itemWhy: item?.why || '',
        itemExample: item?.example || '',
        level: itemData.level,
        levelName: levelNames[itemData.level - 1],
        topic: appState.topic?.name || 'Unknown topic',
        subject: appState.topic?.subject || '',
        yearLevel: appState.topic?.yearLevel || ''
    };
}

function handleTeacherQuestion(selectedText, context) {
    // Track question submission (Growth Character System)
    trackQuestionSubmission();

    switchTab('goals');

    let questionText = `I need help understanding: "${selectedText}"`;
    if (context?.itemTitle) {
        questionText += `\n\n(This is about: ${context.itemTitle})`;
    }

    appState.questions.push({
        text: questionText,
        context: context?.itemTitle || '',
        created: new Date().toISOString(),
        status: 'pending'
    });

    saveData();
    renderQuestions();
    updateBadges();
    showToast('Question added for your teacher.', 'success');
}

function handleGoogleSearch(selectedText, context) {
    // Track search activity (Growth Character System)
    trackSearchActivity();

    let query = `please explain "${selectedText}"`;
    if (context?.subject) query += ` ${context.subject}`;
    if (context?.yearLevel) query += ` ${context.yearLevel}`;

    window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
}

function handleChatGPT(selectedText, context) {
    let prompt = `I'm a student studying ${context?.subject || 'this topic'} at ${context?.yearLevel || 'school'} level.\n\n`;
    prompt += `I need help understanding: "${selectedText}"\n\n`;
    
    if (context?.topic) prompt += `Topic: ${context.topic}\n`;
    if (context?.itemTitle) prompt += `Learning goal: ${context.itemTitle}\n`;
    if (context?.levelName) prompt += `My current level: ${context.levelName}\n`;
    
    prompt += `\nPlease help me understand this by:\n1. Explaining it simply\n2. Giving me a clear example\n3. Asking me a question to check my understanding`;
    
    if (context?.itemWhat || context?.itemWhy || context?.itemExample) {
        prompt += `\n\nContext:\n`;
        if (context.itemWhat) prompt += `What: ${context.itemWhat}\n`;
        if (context.itemWhy) prompt += `Why: ${context.itemWhy}\n`;
        if (context.itemExample) prompt += `Example: ${context.itemExample}\n`;
    }
    
    window.open(`https://chatgpt.com/?prompt=${encodeURIComponent(prompt)}`, '_blank');
}

// ============================================
// EVENT LISTENERS SETUP
// ============================================
function setupEventListeners() {
    // Navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.id.replace('-tab', '');
            switchTab(tabId);
        });
    });
    
    // Welcome dialog
    document.getElementById('welcome-start-btn')?.addEventListener('click', hideWelcomeDialog);
    document.getElementById('welcome-skip-btn')?.addEventListener('click', hideWelcomeDialog);
    document.getElementById('welcome-next-btn')?.addEventListener('click', showWelcomePage2);
    document.getElementById('welcome-back-btn')?.addEventListener('click', showWelcomePage1);
    document.getElementById('welcome-next-2-btn')?.addEventListener('click', showWelcomePage3);
    document.getElementById('welcome-back-2-btn')?.addEventListener('click', showWelcomePage2);

    // Show welcome from utility tab
    document.getElementById('show-welcome-btn')?.addEventListener('click', showWelcomeDialog);

    // Messages dialog
    document.getElementById('message-icon-btn')?.addEventListener('click', showMessagesDialog);
    document.getElementById('settings-messages-btn')?.addEventListener('click', showMessagesDialog);
    document.getElementById('messages-close-btn')?.addEventListener('click', hideMessagesDialog);
    document.getElementById('mark-all-read-btn')?.addEventListener('click', markAllMessagesAsRead);

    // Close messages dialog on overlay click
    document.getElementById('messages-overlay')?.addEventListener('click', (e) => {
        if (e.target.id === 'messages-overlay') {
            hideMessagesDialog();
        }
    });

    // Close modals on Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            // Close Growth Character modal if open
            const gcOverlay = document.getElementById('growth-character-overlay');
            if (gcOverlay?.classList.contains('active')) {
                hideGrowthCharacterModal();
                return;
            }

            // Close post check-in modal if open
            const postCheckinOverlay = document.getElementById('post-checkin-overlay');
            if (postCheckinOverlay?.classList.contains('active')) {
                hidePostCheckinModal();
                return;
            }

            // Close quiz modal if open and cancel button is visible
            const quizOverlay = document.getElementById('quiz-overlay');
            const quizCancelBtn = document.getElementById('quiz-cancel-btn');
            if (quizOverlay?.classList.contains('active') && quizCancelBtn?.style.display !== 'none') {
                closeQuiz();
                return;
            }

            // Close messages dialog if open
            const messagesOverlay = document.getElementById('messages-overlay');
            if (messagesOverlay?.classList.contains('active')) {
                hideMessagesDialog();
            }
        }
    });

    // Dropdown changes
    document.getElementById('year-level-dropdown')?.addEventListener('change', onYearLevelChange);
    document.getElementById('subject-dropdown')?.addEventListener('change', (e) => {
        onSubjectChange(e);
        checkClassForTopic();
    });
    document.getElementById('topic-dropdown')?.addEventListener('change', (e) => {
        onTopicChange(e);
        checkClassForTopic();
    });

    // Class badge & mismatch modal
    document.getElementById('class-badge-display')?.addEventListener('click', () => {
        showClassMismatchModal('Select your class for this topic:');
    });
    document.getElementById('class-mismatch-dismiss')?.addEventListener('click', hideClassMismatchModal);
    document.getElementById('class-mismatch-confirm')?.addEventListener('click', confirmClassMismatch);
    document.getElementById('class-mismatch-overlay')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) hideClassMismatchModal();
    });
    
    // Topic refresh button
    document.getElementById('refresh-topics-btn')?.addEventListener('click', async (e) => {
        const btn = e.target;
        btn.classList.add('refreshing');
        btn.disabled = true;
        await refreshTopicAvailability();
        btn.classList.remove('refreshing');
        btn.disabled = false;
    });
    
    // Header buttons
    document.getElementById('new-checkin-btn')?.addEventListener('click', showCheckinStartModal);
    
    // Check-in modals
    document.getElementById('start-checkin-btn')?.addEventListener('click', showCheckinStartModal);
    document.getElementById('checkin-start-cancel')?.addEventListener('click', hideCheckinStartModal);
    document.getElementById('checkin-start-cancel-btn')?.addEventListener('click', hideCheckinStartModal);
    document.getElementById('checkin-start-confirm-btn')?.addEventListener('click', () => {
        const activeType = document.querySelector('.checkin-type-btn.active');
        const type = activeType?.dataset.type || 'weekly';
        hideCheckinStartModal();
        startCheckinMode(type);
    });
    
    // Check-in type selection
    document.querySelectorAll('.checkin-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.checkin-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });
    });
    
    // Floating bar stop
    document.getElementById('checkin-floating-stop')?.addEventListener('click', () => stopCheckinMode(false));
    
    // Quiz modal
    document.getElementById('quiz-submit-btn')?.addEventListener('click', submitQuizAnswer);
    document.getElementById('quiz-cancel-btn')?.addEventListener('click', closeQuiz);
    document.getElementById('quiz-cancel-btn-footer')?.addEventListener('click', closeQuiz);
    
    // Goals & Questions
    document.getElementById('add-goal-btn')?.addEventListener('click', addGoal);
    document.getElementById('add-question-btn')?.addEventListener('click', addQuestion);
    
    document.getElementById('new-goal-input')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            addGoal();
        }
    });
    
    document.getElementById('new-question-input')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            addQuestion();
        }
    });
    
    // Settings
    document.getElementById('dark-mode-toggle')?.addEventListener('change', toggleTheme);
    document.getElementById('skip-pretopic-questions-toggle')?.addEventListener('change', (e) => {
        appState.skipPreTopicQuestions = e.target.checked;
        saveData();
    });
    document.getElementById('student-name-input')?.addEventListener('change', (e) => {
        appState.student.name = e.target.value;
        saveData();
        renderStudentInfo();
    });
    document.getElementById('class-input')?.addEventListener('change', (e) => {
        appState.student.class = e.target.value;
        saveData();
        updateClassBadge();
    });
    
    // Level preferences - display mode
    document.querySelectorAll('.level-display-option').forEach(opt => {
        opt.addEventListener('click', () => {
            const mode = opt.dataset.mode;
            onDisplayModeChange(mode);
        });
    });
    
    // Level preferences - emoji progression
    document.getElementById('emoji-progression-select')?.addEventListener('change', (e) => {
        onEmojiProgressionChange(e.target.value);
    });
    
    // Level preferences - color pickers
    for (let i = 1; i <= 5; i++) {
        document.getElementById(`level-color-${i}`)?.addEventListener('input', (e) => {
            onLevelColorChange(i - 1, e.target.value);
        });
    }
    
    // Level preferences - reset colors
    document.getElementById('reset-colors-btn')?.addEventListener('click', resetLevelColors);
    
    // Data management - inline confirmations
    document.getElementById('clear-progress-btn')?.addEventListener('click', showClearTopicConfirm);
    document.getElementById('clear-topic-cancel')?.addEventListener('click', hideClearTopicConfirm);
    document.getElementById('clear-topic-delete')?.addEventListener('click', executeClearProgressForTopic);
    
    document.getElementById('clear-all-btn')?.addEventListener('click', showClearAllConfirm);
    document.getElementById('clear-all-cancel')?.addEventListener('click', hideClearAllConfirm);
    document.getElementById('clear-all-delete')?.addEventListener('click', executeClearAllData);
    
    // Export - Share Your Progress
    document.getElementById('export-pdf-btn')?.addEventListener('click', exportToPDF);
    document.getElementById('email-preview-btn')?.addEventListener('click', showEmailPreview);
    document.getElementById('email-copy-btn')?.addEventListener('click', copyEmailSummary);
    document.getElementById('email-send-btn')?.addEventListener('click', openEmailClient);
    document.getElementById('email-preview-close')?.addEventListener('click', hideEmailPreview);
    document.getElementById('email-copy-json-btn')?.addEventListener('click', copyEmailJSON);
    document.getElementById('email-copy-full-btn')?.addEventListener('click', copyEmailSummary);
    document.getElementById('email-open-btn')?.addEventListener('click', openEmailClient);

    // Export - Data Management
    document.getElementById('export-all-btn')?.addEventListener('click', exportAllData);
    document.getElementById('restore-browse-btn')?.addEventListener('click', () => {
        document.getElementById('restore-file-input')?.click();
    });
    document.getElementById('restore-file-input')?.addEventListener('change', handleRestoreFileSelect);
    document.getElementById('restore-preview-close')?.addEventListener('click', hideRestorePreview);
    document.getElementById('restore-cancel-btn')?.addEventListener('click', hideRestorePreview);
    document.getElementById('restore-confirm-btn')?.addEventListener('click', executeRestore);
    
    // Expand/Collapse all
    document.getElementById('expand-all-btn')?.addEventListener('click', () => {
        document.querySelectorAll('.topic-header').forEach(h => {
            h.setAttribute('aria-expanded', 'true');
            document.getElementById(h.getAttribute('aria-controls'))?.classList.add('expanded');
        });
    });
    
    document.getElementById('collapse-all-btn')?.addEventListener('click', () => {
        document.querySelectorAll('.topic-header').forEach(h => {
            h.setAttribute('aria-expanded', 'false');
            document.getElementById(h.getAttribute('aria-controls'))?.classList.remove('expanded');
        });
    });
    
    // Keyboard shortcuts
    const debugKeysPressed = { q: false, w: false, e: false, a: false, s: false, d: false };
    
    document.addEventListener('keydown', (e) => {
        // Track debug keys
        if (e.key === 'q') debugKeysPressed.q = true;
        if (e.key === 'w') debugKeysPressed.w = true;
        if (e.key === 'e') debugKeysPressed.e = true;
        if (e.key === 'a') debugKeysPressed.a = true;
        if (e.key === 's') debugKeysPressed.s = true;
        if (e.key === 'd') debugKeysPressed.d = true;
        
        // Check if quiz is active
        const quizActive = document.getElementById('quiz-overlay')?.classList.contains('active');
        
        // Check for q+w+e combo
        if (debugKeysPressed.q && debugKeysPressed.w && debugKeysPressed.e) {
            e.preventDefault();
            if (quizActive) {
                debugSelectCorrectAnswer();
            } else {
                debugRandomizeLevels();
            }
            // Reset to prevent repeated triggers
            debugKeysPressed.q = false;
            debugKeysPressed.w = false;
            debugKeysPressed.e = false;
        }
        
        // Check for a+s+d combo (wrong answer in quiz)
        if (debugKeysPressed.a && debugKeysPressed.s && debugKeysPressed.d) {
            e.preventDefault();
            if (quizActive) {
                debugSelectWrongAnswer();
            }
            // Reset to prevent repeated triggers
            debugKeysPressed.a = false;
            debugKeysPressed.s = false;
            debugKeysPressed.d = false;
        }
    });
    
    document.addEventListener('keyup', (e) => {
        if (e.key === 'q') debugKeysPressed.q = false;
        if (e.key === 'w') debugKeysPressed.w = false;
        if (e.key === 'e') debugKeysPressed.e = false;
        if (e.key === 'a') debugKeysPressed.a = false;
        if (e.key === 's') debugKeysPressed.s = false;
        if (e.key === 'd') debugKeysPressed.d = false;
    });
}

// ============================================
// INITIALIZATION
// ============================================
async function init() {
    console.log('Dynamic Learning Check List v2.0.0 initializing...');
    
    // Load saved data
    loadData();
    loadQuizState();
    loadAvailabilityCache();
    loadLevelPrefs();
    
    // Setup event listeners
    setupEventListeners();

    // Initialize session tracking (Growth Character System)
    initSessionTracking();

    // Initialize Growth Character UI listeners
    initGrowthCharacterListeners();

    // Initialize selection popup
    initSelectionPopup();
    
    // Apply theme
    applyTheme(appState.theme);
    
    // Apply skip pre-topic questions setting
    const skipToggle = document.getElementById('skip-pretopic-questions-toggle');
    if (skipToggle) {
        skipToggle.checked = appState.skipPreTopicQuestions || false;
    }
    
    // Apply level preferences
    applyLevelColors();
    updateLevelPrefsUI();
    
    // Load manifest
    await loadManifest();
    
    // Render everything
    renderAll();
    updateTopicCurrentDisplay();
    updateClassBadge();
    
    // Check for first run or schedule selection tip
    const firstRunComplete = localStorage.getItem(FIRST_RUN_KEY);
    if (!firstRunComplete) {
        showWelcomeDialog();
    } else {
        // Not first run - schedule selection tip if not shown yet
        scheduleSelectionTip();
    }

    // Initialize messages system
    await initMessages();

    // Start learning-tab pulse since initial tab is Overview (not Learning Content)
    startLearningPulseTimers();

    console.log('Initialization complete');
}

// Start when DOM is ready
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
