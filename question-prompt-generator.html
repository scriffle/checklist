<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Question Prompt Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Nunito:wght@600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Primary palette */
      --color-primary: #2d9d78;
      --color-primary-dark: #1e7d5e;
      --color-primary-pale: #e8f5f0;
      --color-primary-glow: rgba(45, 157, 120, 0.15);
      
      /* Neutrals */
      --color-bg: #f8fafb;
      --color-surface: #ffffff;
      --color-surface-raised: #ffffff;
      --color-border: #e2e8f0;
      --color-border-light: #f1f5f9;
      --color-text: #1e293b;
      --color-text-muted: #64748b;
      --color-text-faint: #94a3b8;
      
      /* Semantic */
      --color-success: #22c55e;
      --color-warning: #f59e0b;
      --color-error: #ef4444;
      --color-info: #3b82f6;
      
      /* Question types */
      --color-mc: #6366f1;
      --color-cloze: #8b5cf6;
      --color-tf: #ec4899;
      
      /* Levels */
      --level-2: #f97316;
      --level-3: #eab308;
      --level-4: #22c55e;
      --level-5: #8b5cf6;
      
      /* Typography */
      --font-display: 'Nunito', system-ui, sans-serif;
      --font-body: 'DM Sans', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      
      /* Spacing */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.5rem;
      --space-6: 2rem;
      --space-8: 3rem;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.04);
      
      /* Transitions */
      --transition-fast: 0.15s ease;
      --transition-normal: 0.25s ease;
      
      /* Layout */
      --header-height: 64px;
      --sidebar-width: 340px;
    }
    
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html {
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body {
      font-family: var(--font-body);
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
    .header {
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-4) var(--space-6);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      height: var(--header-height);
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-family: var(--font-display);
      font-weight: 800;
      font-size: 1.25rem;
      color: var(--color-primary);
    }
    
    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.25rem;
    }
    
    .topic-info {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding-left: var(--space-4);
      border-left: 1px solid var(--color-border);
      color: var(--color-text-muted);
      font-size: 0.9rem;
    }
    
    .topic-info:empty {
      display: none;
    }
    
    .topic-badge {
      background: var(--color-primary-pale);
      color: var(--color-primary-dark);
      padding: var(--space-1) var(--space-3);
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.8rem;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      border-radius: 8px;
      font-family: var(--font-body);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all var(--transition-fast);
      border: none;
      text-decoration: none;
    }
    
    .btn-primary {
      background: var(--color-primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--color-primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-secondary {
      background: var(--color-surface);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }
    
    .btn-secondary:hover {
      background: var(--color-bg);
      border-color: var(--color-text-muted);
    }
    
    .btn-ghost {
      background: transparent;
      color: var(--color-text-muted);
    }
    
    .btn-ghost:hover {
      background: var(--color-bg);
      color: var(--color-text);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .btn-sm {
      padding: var(--space-1) var(--space-3);
      font-size: 0.8rem;
    }
    
    .btn-icon {
      width: 36px;
      height: 36px;
      padding: 0;
      justify-content: center;
    }
    
    /* Main Layout */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .setup-section {
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-5) var(--space-6);
    }
    
    .setup-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-6);
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .setup-card {
      background: var(--color-bg);
      border-radius: 12px;
      padding: var(--space-5);
      border: 1px solid var(--color-border-light);
    }
    
    .setup-card-header {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }
    
    .setup-card-step {
      width: 28px;
      height: 28px;
      background: var(--color-primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
    }
    
    .setup-card-title {
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 1.1rem;
    }
    
    .setup-card-subtitle {
      color: var(--color-text-muted);
      font-size: 0.85rem;
      margin-top: var(--space-1);
    }
    
    /* File Import */
    .file-drop-zone {
      border: 2px dashed var(--color-border);
      border-radius: 10px;
      padding: var(--space-5);
      text-align: center;
      cursor: pointer;
      transition: all var(--transition-fast);
      background: var(--color-surface);
    }
    
    .file-drop-zone:hover,
    .file-drop-zone.drag-over {
      border-color: var(--color-primary);
      background: var(--color-primary-pale);
    }
    
    .file-drop-zone input {
      display: none;
    }
    
    .file-drop-icon {
      font-size: 2rem;
      margin-bottom: var(--space-2);
    }
    
    .file-drop-text {
      color: var(--color-text-muted);
      font-size: 0.9rem;
    }
    
    .file-drop-text strong {
      color: var(--color-primary);
    }
    
    .file-list {
      margin-top: var(--space-4);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    
    .file-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-2) var(--space-3);
      background: var(--color-surface);
      border-radius: 8px;
      font-size: 0.85rem;
      border: 1px solid var(--color-border-light);
    }
    
    .file-item-icon {
      color: var(--color-success);
    }
    
    .file-item-name {
      flex: 1;
      font-family: var(--font-mono);
      font-size: 0.8rem;
    }
    
    .file-item-meta {
      color: var(--color-text-muted);
      font-size: 0.75rem;
    }
    
    .file-item-remove {
      color: var(--color-text-faint);
      cursor: pointer;
      padding: var(--space-1);
      border-radius: 4px;
      transition: all var(--transition-fast);
    }
    
    .file-item-remove:hover {
      color: var(--color-error);
      background: rgba(239, 68, 68, 0.1);
    }
    
    /* Teacher Resources */
    .teacher-resources-textarea {
      width: 100%;
      min-height: 140px;
      padding: var(--space-3);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-family: var(--font-body);
      font-size: 0.9rem;
      resize: vertical;
      transition: border-color var(--transition-fast);
    }
    
    .teacher-resources-textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-glow);
    }
    
    .teacher-resources-textarea::placeholder {
      color: var(--color-text-faint);
    }
    
    /* Question Mix Sliders */
    .mix-section {
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-5) var(--space-6);
    }
    
    .mix-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .mix-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
    }
    
    .mix-title {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .mix-title h2 {
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 1.1rem;
    }
    
    .mix-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-4);
    }
    
    .mix-card {
      background: var(--color-bg);
      border-radius: 12px;
      padding: var(--space-4);
      border: 1px solid var(--color-border-light);
    }
    
    .mix-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-3);
    }
    
    .mix-level-name {
      font-weight: 700;
      font-size: 0.95rem;
    }
    
    .mix-level-tag {
      font-size: 0.7rem;
      padding: var(--space-1) var(--space-2);
      border-radius: 4px;
      font-weight: 600;
    }
    
    .mix-level-tag.level-2 { background: rgba(249, 115, 22, 0.15); color: var(--level-2); }
    .mix-level-tag.level-3 { background: rgba(234, 179, 8, 0.15); color: #b8860b; }
    .mix-level-tag.level-4 { background: rgba(34, 197, 94, 0.15); color: var(--level-4); }
    .mix-level-tag.level-5 { background: rgba(139, 92, 246, 0.15); color: var(--level-5); }
    
    .mix-sliders {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    
    .mix-slider-row {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .mix-slider-label {
      width: 50px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--color-text-muted);
    }
    
    .mix-slider-label.mc { color: var(--color-mc); }
    .mix-slider-label.cloze { color: var(--color-cloze); }
    .mix-slider-label.tf { color: var(--color-tf); }
    
    .mix-slider {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      border-radius: 3px;
      background: var(--color-border);
      cursor: pointer;
    }
    
    .mix-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--color-primary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: transform var(--transition-fast);
    }
    
    .mix-slider::-webkit-slider-thumb:hover {
      transform: scale(1.15);
    }
    
    .mix-slider.mc::-webkit-slider-thumb { background: var(--color-mc); }
    .mix-slider.cloze::-webkit-slider-thumb { background: var(--color-cloze); }
    .mix-slider.tf::-webkit-slider-thumb { background: var(--color-tf); }
    
    .mix-slider-value {
      width: 28px;
      text-align: center;
      font-weight: 700;
      font-size: 0.9rem;
      font-family: var(--font-mono);
    }
    
    .mix-total {
      text-align: center;
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      border-top: 1px solid var(--color-border-light);
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }
    
    .mix-total strong {
      color: var(--color-text);
    }
    
    .mix-total.invalid strong {
      color: var(--color-error);
    }
    
    /* Workspace */
    .workspace {
      flex: 1;
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr;
      min-height: 0;
    }
    
    /* Sidebar - LP List */
    .sidebar {
      background: var(--color-surface);
      border-right: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .sidebar-header {
      padding: var(--space-4);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .sidebar-title {
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 0.95rem;
    }
    
    .sidebar-actions {
      display: flex;
      gap: var(--space-2);
    }
    
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-3);
    }
    
    .subtopic-group {
      margin-bottom: var(--space-3);
    }
    
    .subtopic-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--color-bg);
      border-radius: 8px;
      cursor: pointer;
      transition: all var(--transition-fast);
      user-select: none;
    }
    
    .subtopic-header:hover {
      background: var(--color-primary-pale);
    }
    
    .subtopic-toggle {
      color: var(--color-text-muted);
      transition: transform var(--transition-fast);
    }
    
    .subtopic-group.collapsed .subtopic-toggle {
      transform: rotate(-90deg);
    }
    
    .subtopic-icon {
      font-size: 1.1rem;
    }
    
    .subtopic-name {
      flex: 1;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .subtopic-count {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      background: var(--color-surface);
      padding: var(--space-1) var(--space-2);
      border-radius: 10px;
    }
    
    .subtopic-items {
      padding: var(--space-2) 0 var(--space-2) var(--space-4);
    }
    
    .subtopic-group.collapsed .subtopic-items {
      display: none;
    }
    
    .lp-item {
      display: flex;
      align-items: flex-start;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      border-radius: 6px;
      cursor: pointer;
      transition: all var(--transition-fast);
      font-size: 0.85rem;
    }
    
    .lp-item:hover {
      background: var(--color-bg);
    }
    
    .lp-item.selected {
      background: var(--color-primary-pale);
      border-left: 3px solid var(--color-primary);
      margin-left: -3px;
    }
    
    .lp-checkbox {
      margin-top: 2px;
      accent-color: var(--color-primary);
    }
    
    .lp-code {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--color-text-faint);
      background: var(--color-surface);
      padding: 1px 4px;
      border-radius: 3px;
    }
    
    .lp-title {
      flex: 1;
      line-height: 1.4;
    }
    
    /* Main Content - Prompt Preview */
    .content {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--color-bg);
    }
    
    .content-header {
      padding: var(--space-4) var(--space-5);
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .content-title {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }
    
    .content-title h2 {
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 1rem;
    }
    
    .content-title span {
      color: var(--color-text-muted);
      font-size: 0.85rem;
    }
    
    .level-selector {
      display: flex;
      gap: var(--space-2);
    }
    
    .level-btn {
      padding: var(--space-2) var(--space-3);
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      transition: all var(--transition-fast);
    }
    
    .level-btn:hover {
      border-color: var(--color-text-muted);
    }
    
    .level-btn.active {
      color: white;
      border-color: transparent;
    }
    
    .level-btn.level-2.active { background: var(--level-2); }
    .level-btn.level-3.active { background: var(--level-3); color: #1e293b; }
    .level-btn.level-4.active { background: var(--level-4); }
    .level-btn.level-5.active { background: var(--level-5); }
    
    .content-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-5);
    }
    
    .prompt-preview {
      background: var(--color-surface);
      border-radius: 12px;
      border: 1px solid var(--color-border);
      overflow: hidden;
    }
    
    .prompt-preview-header {
      padding: var(--space-3) var(--space-4);
      background: var(--color-bg);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .prompt-preview-title {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--color-text-muted);
    }
    
    .prompt-preview-actions {
      display: flex;
      gap: var(--space-2);
    }
    
    .prompt-text {
      padding: var(--space-4);
      font-family: var(--font-mono);
      font-size: 0.8rem;
      line-height: 1.7;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 60vh;
      overflow-y: auto;
      color: var(--color-text);
    }
    
    .prompt-text .section-header {
      color: var(--color-primary);
      font-weight: 600;
    }
    
    /* Empty States */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-8);
      text-align: center;
      color: var(--color-text-muted);
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: var(--space-4);
      opacity: 0.5;
    }
    
    .empty-state h3 {
      font-family: var(--font-display);
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: var(--space-2);
    }
    
    .empty-state p {
      font-size: 0.9rem;
      max-width: 300px;
    }
    
    /* Export Panel */
    .export-panel {
      padding: var(--space-4) var(--space-5);
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .export-info {
      font-size: 0.85rem;
      color: var(--color-text-muted);
    }
    
    .export-info strong {
      color: var(--color-text);
    }
    
    .export-buttons {
      display: flex;
      gap: var(--space-3);
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: var(--space-5);
      right: var(--space-5);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      z-index: 1000;
    }
    
    .toast {
      background: var(--color-text);
      color: white;
      padding: var(--space-3) var(--space-4);
      border-radius: 8px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      box-shadow: var(--shadow-lg);
      animation: slideIn 0.3s ease;
    }
    
    .toast.success {
      background: var(--color-success);
    }
    
    .toast.error {
      background: var(--color-error);
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .setup-grid {
        grid-template-columns: 1fr;
      }
      
      .mix-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 900px) {
      .workspace {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        display: none;
      }
      
      .mix-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--color-bg);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--color-text-muted);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="logo">
        <div class="logo-icon">ğŸ“</div>
        <span>Question Prompt Generator</span>
      </div>
      <div class="topic-info" id="topicInfo"></div>
    </div>
    <div class="header-right">
      <button class="btn btn-secondary" id="resetBtn" title="Clear all data">
        â†» Reset
      </button>
    </div>
  </header>
  
  <!-- Setup Section -->
  <section class="setup-section">
    <div class="setup-grid">
      <!-- File Import -->
      <div class="setup-card">
        <div class="setup-card-header">
          <div class="setup-card-step">1</div>
          <div>
            <div class="setup-card-title">Import JSON Files</div>
            <div class="setup-card-subtitle">Select topic.json + subtopic JSON files</div>
          </div>
        </div>
        <div class="file-drop-zone" id="fileDropZone">
          <input type="file" id="fileInput" accept=".json" multiple>
          <div class="file-drop-icon">ğŸ“</div>
          <div class="file-drop-text">
            <strong>Click to select</strong> or drag & drop JSON files
          </div>
        </div>
        <div class="file-list" id="fileList"></div>
      </div>
      
      <!-- Teacher Resources -->
      <div class="setup-card">
        <div class="setup-card-header">
          <div class="setup-card-step">2</div>
          <div>
            <div class="setup-card-title">Teacher Resources</div>
            <div class="setup-card-subtitle">Optional â€” applies to all prompts</div>
          </div>
        </div>
        <textarea 
          class="teacher-resources-textarea" 
          id="teacherResources"
          placeholder="Paste lesson notes, textbook excerpts, curriculum emphasis, common misconceptions, exam style guidance, etc.

This content will be included in all generated prompts to provide additional context for question generation."
        ></textarea>
      </div>
    </div>
  </section>
  
  <!-- Question Mix Section -->
  <section class="mix-section">
    <div class="mix-container">
      <div class="mix-header">
        <div class="mix-title">
          <div class="setup-card-step">3</div>
          <h2>Question Type Mix</h2>
        </div>
        <button class="btn btn-ghost btn-sm" id="resetMixBtn">Reset Defaults</button>
      </div>
      <div class="mix-grid" id="mixGrid">
        <!-- Generated by JS -->
      </div>
    </div>
  </section>
  
  <!-- Workspace -->
  <div class="workspace">
    <!-- Sidebar - LP List -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Learning Points</div>
        <div class="sidebar-actions">
          <button class="btn btn-ghost btn-sm" id="selectAllBtn">Select All</button>
          <button class="btn btn-ghost btn-sm" id="deselectAllBtn">Deselect</button>
        </div>
      </div>
      <div class="sidebar-content" id="lpList">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“‹</div>
          <h3>No files loaded</h3>
          <p>Import JSON files to see learning points</p>
        </div>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="content">
      <div class="content-header">
        <div class="content-title">
          <h2 id="selectedLpTitle">Select a Learning Point</h2>
          <span id="selectedLpSubtopic"></span>
        </div>
        <div class="level-selector" id="levelSelector">
          <button class="level-btn level-2 active" data-level="toLevel2">toLevel2</button>
          <button class="level-btn level-3" data-level="toLevel3">toLevel3</button>
          <button class="level-btn level-4" data-level="toLevel4">toLevel4</button>
          <button class="level-btn level-5" data-level="toLevel5">toLevel5</button>
        </div>
      </div>
      
      <div class="content-body">
        <div class="prompt-preview" id="promptPreview">
          <div class="prompt-preview-header">
            <div class="prompt-preview-title">
              <span>ğŸ“„</span>
              <span id="promptFilename">prompt-preview.txt</span>
            </div>
            <div class="prompt-preview-actions">
              <button class="btn btn-secondary btn-sm" id="copyPromptBtn" disabled>
                ğŸ“‹ Copy Prompt
              </button>
              <button class="btn btn-secondary btn-sm" id="copyAllLevelsBtn" disabled>
                ğŸ“‹ Copy All 4 Levels
              </button>
            </div>
          </div>
          <div class="prompt-text" id="promptText">
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“</div>
              <h3>No prompt generated</h3>
              <p>Select a learning point from the sidebar to preview its prompt</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="export-panel">
        <div class="export-info">
          <span id="exportStats">0 learning points selected â€¢ 0 prompts ready</span>
        </div>
        <div class="export-buttons">
          <button class="btn btn-secondary" id="exportTxtBtn" disabled>
            ğŸ“„ Single Text File
          </button>
          <button class="btn btn-secondary" id="exportSeparateBtn" disabled>
            ğŸ“ Separate LP Files
          </button>
          <button class="btn btn-primary" id="exportJsonBtn" disabled>
            ğŸ“¦ JSON Bundle
          </button>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================
    
    const state = {
      topic: null,
      subtopics: [],
      learningPoints: [],
      selectedLpUuid: null,
      selectedLevel: 'toLevel2',
      teacherResources: '',
      questionMix: {
        toLevel2: { mc: 5, cloze: 3, tf: 2 },
        toLevel3: { mc: 6, cloze: 3, tf: 1 },
        toLevel4: { mc: 7, cloze: 3, tf: 0 },
        toLevel5: { mc: 8, cloze: 2, tf: 0 }
      },
      selectedLps: new Set()
    };
    
    const DEFAULT_MIX = JSON.parse(JSON.stringify(state.questionMix));
    
    // ============================================================================
    // QUALITY SPECIFICATIONS (Condensed)
    // ============================================================================
    
    const SPECS = {
      mc: `MC QUESTION SPEC:
FORMAT: 4 options (A-D). One unambiguous correct answer.
STEM: Clear, focused, no ambiguity. Novel scenarios preferred over verbatim recall.

LENGTH PARITY (CRITICAL - common AI failure):
- Correct answer must NOT be longer than distractors. This is a major test-taking giveaway.
- Students learn "longest answer = correct" â€” do not reinforce this pattern.
- EITHER keep correct answer pithy and concise (preferred)
- OR extend ALL distractors to match correct answer's length/detail
- All options within Â±20% character count. Measure and verify.
- If correct answer needs qualification, add similar qualifiers to distractors.
- Example BAD: Correct="The mitochondria converts glucose into ATP through cellular respiration" vs Distractor="The nucleus"
- Example GOOD: Correct="Mitochondria" / Distractors="Nucleus", "Ribosome", "Chloroplast" (all single words)
- Example GOOD: All options are full sentences of similar length with similar detail level.

OPTIONS: Grammatically parallel with stem. Same semantic category. Shuffleable without grammatical tells.
DISTRACTORS: Must represent real student misconceptions. Each should attract 5-25% of uninformed test-takers. Plausible in context/scope/magnitude. Match complexity and detail level of correct answer.
PROHIBITED: "All of the above", "None of the above", joke answers, obviously wrong options, trick wording.
CORRECT ANSWER: Position varies across questions (don't cluster on one letter).
EXPLANATIONS: Required for correct answer AND each distractor. Address specific misconception.`,
      
      cloze: `CLOZE QUESTION SPEC:
FORMAT: Sentence(s) with {{blank:N}} placeholders. Exactly 3 options per blank (1 correct + 2 distractors).
BLANK SELECTION - MUST blank: Key terminology, central concepts, cause-effect words, process steps, relationship indicators.
BLANK SELECTION - NEVER blank: Articles (a/an/the), prepositions (in/on/at), conjunctions (and/but/or), pronouns (it/they), high-frequency verbs (is/are/has).
TEST: "Can student answer using ONLY grammar/syntax?" â†’ YES = bad blank. "Does answering require content knowledge?" â†’ YES = good blank.
GRAMMATICAL PARALLELISM - ALL options must match: Part of speech. Verb tense/person/number. Article agreement. Singular/plural.
LENGTH PARITY (CRITICAL): All options must be similar length (within 20%). The correct answer must NOT be longer than distractorsâ€”this is a common flaw that makes the answer obvious. Solutions: (1) Keep correct answer pithy/concise, OR (2) Extend distractors to match correct answer length by adding plausible detail. Example of FAILURE: correct="membrane-bound organelles" vs distractors "ribosomes", "DNA" â€” length disparity reveals the answer. Example of SUCCESS: correct="membrane-bound organelles" vs distractors "free-floating ribosomes", "circular DNA molecules".
DISTRACTORS: Same rules as MCâ€”real misconceptions, plausible, same semantic category. Pad distractors with plausible qualifiers if needed for length parity.
DENSITY: Max 1-2 blanks per sentence. Never blank first or last sentence of passage.
PROHIBITED: Blanking function words, absurd options, multiple defensible answers, correct answer noticeably longer than distractors.`,
      
      tf: `TF QUESTION SPEC:
FORMAT: Statement + "True" or "False" as correct answer. One distractor (the opposite).
STATEMENT: Unambiguously true or false. No "trick" wording.
AVOID: Absolutes ("always", "never") unless genuinely absolute. Double negatives. Compound statements.
DISTRACTORS: Explanation must address why students might believe the wrong answer.
BEST FOR: Simple factual claims, common misconceptions to directly confront.`
    };
    
    const COGNITIVE_LEVELS = {
      toLevel2: {
        name: "Remember",
        description: `TARGET: Basic recall and recognition.
TEST: Can student retrieve relevant knowledge from memory?
QUESTION TYPES: Define terms, identify components, recall facts, match definitions.
STEMS: "What is...", "Which of the following is...", "The term for... is...", "Identify the..."
AVOID: Application, inference, or synthesis. Test recognition, not deeper understanding.`
      },
      toLevel3: {
        name: "Understand",
        description: `TARGET: Demonstrate comprehension of concepts.
TEST: Can student explain ideas in their own words or recognise examples?
QUESTION TYPES: Explain concepts, interpret meanings, classify examples, summarise relationships.
STEMS: "Which statement best explains...", "What does X mean...", "An example of X would be...", "Why does..."
AVOID: Direct recall of definitions. Require paraphrasing or recognition in new contexts.`
      },
      toLevel4: {
        name: "Apply",
        description: `TARGET: Use knowledge in new situations.
TEST: Can student use procedures, concepts, or principles in unfamiliar contexts?
QUESTION TYPES: Predict outcomes, solve problems, apply procedures, use in scenarios.
STEMS: "What would happen if...", "In this situation, you would...", "Apply X to solve...", "Predict the result..."
REQUIRE: Novel scenarios not seen in teaching materials. Test transfer of learning.`
      },
      toLevel5: {
        name: "Analyze & Evaluate",
        description: `TARGET: Break down relationships, make judgments, assess validity.
TEST: Can student compare, contrast, infer, critique, or synthesise?
QUESTION TYPES: Compare/contrast, identify relationships, evaluate claims, infer from data, critique reasoning.
STEMS: "Which conclusion is supported by...", "Compare X and Y...", "The evidence suggests...", "Evaluate the claim that..."
REQUIRE: Multi-step reasoning. May include data, scenarios, or competing claims to evaluate.`
      }
    };
    
    // ============================================================================
    // DOM ELEMENTS
    // ============================================================================
    
    const elements = {
      fileInput: document.getElementById('fileInput'),
      fileDropZone: document.getElementById('fileDropZone'),
      fileList: document.getElementById('fileList'),
      teacherResources: document.getElementById('teacherResources'),
      topicInfo: document.getElementById('topicInfo'),
      mixGrid: document.getElementById('mixGrid'),
      lpList: document.getElementById('lpList'),
      levelSelector: document.getElementById('levelSelector'),
      selectedLpTitle: document.getElementById('selectedLpTitle'),
      selectedLpSubtopic: document.getElementById('selectedLpSubtopic'),
      promptFilename: document.getElementById('promptFilename'),
      promptText: document.getElementById('promptText'),
      exportStats: document.getElementById('exportStats'),
      copyPromptBtn: document.getElementById('copyPromptBtn'),
      copyAllLevelsBtn: document.getElementById('copyAllLevelsBtn'),
      exportTxtBtn: document.getElementById('exportTxtBtn'),
      exportSeparateBtn: document.getElementById('exportSeparateBtn'),
      exportJsonBtn: document.getElementById('exportJsonBtn'),
      resetBtn: document.getElementById('resetBtn'),
      resetMixBtn: document.getElementById('resetMixBtn'),
      selectAllBtn: document.getElementById('selectAllBtn'),
      deselectAllBtn: document.getElementById('deselectAllBtn'),
      toastContainer: document.getElementById('toastContainer')
    };
    
    // ============================================================================
    // FILE HANDLING
    // ============================================================================
    
    function handleFiles(files) {
      Array.from(files).forEach(file => {
        if (!file.name.endsWith('.json')) {
          showToast('Only JSON files are accepted', 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            processJsonFile(file.name, data);
          } catch (err) {
            showToast(`Error parsing ${file.name}: ${err.message}`, 'error');
          }
        };
        reader.readAsText(file);
      });
    }
    
    function processJsonFile(filename, data) {
      // Check if it's a topic.json file
      if (data.subtopics && data.id && data.name && !data.items) {
        state.topic = data;
        updateTopicInfo();
        showToast(`Topic loaded: ${data.name}`, 'success');
      }
      // Check if it's a subtopic file (has items array with learning points)
      else if (data.items && Array.isArray(data.items)) {
        // Check if already loaded
        const existing = state.subtopics.findIndex(s => s.id === data.id);
        if (existing >= 0) {
          state.subtopics[existing] = data;
        } else {
          state.subtopics.push(data);
        }
        
        // Extract learning points with subtopic context
        data.items.forEach(lp => {
          const existingLp = state.learningPoints.findIndex(l => l.uuid === lp.uuid);
          const lpWithContext = {
            ...lp,
            subtopic: {
              id: data.id,
              name: data.name,
              icon: data.icon,
              what: data.what,
              why: data.why
            }
          };
          
          if (existingLp >= 0) {
            state.learningPoints[existingLp] = lpWithContext;
          } else {
            state.learningPoints.push(lpWithContext);
            state.selectedLps.add(lp.uuid);
          }
        });
        
        showToast(`Loaded: ${data.name} (${data.items.length} LPs)`, 'success');
      }
      else {
        showToast(`Unrecognized file format: ${filename}`, 'error');
        return;
      }
      
      updateFileList();
      renderLpList();
      updateExportStats();
    }
    
    function updateFileList() {
      const files = [];
      
      if (state.topic) {
        files.push({
          name: 'topic.json',
          meta: state.topic.name,
          type: 'topic'
        });
      }
      
      state.subtopics.forEach(st => {
        files.push({
          name: `${st.id}.json`,
          meta: `${st.items.length} LPs`,
          type: 'subtopic',
          id: st.id
        });
      });
      
      if (files.length === 0) {
        elements.fileList.innerHTML = '';
        return;
      }
      
      elements.fileList.innerHTML = files.map(f => `
        <div class="file-item" data-type="${f.type}" data-id="${f.id || ''}">
          <span class="file-item-icon">âœ“</span>
          <span class="file-item-name">${f.name}</span>
          <span class="file-item-meta">${f.meta}</span>
          <span class="file-item-remove" onclick="removeFile('${f.type}', '${f.id || ''}')">âœ•</span>
        </div>
      `).join('');
    }
    
    function removeFile(type, id) {
      if (type === 'topic') {
        state.topic = null;
        updateTopicInfo();
      } else if (type === 'subtopic') {
        state.subtopics = state.subtopics.filter(s => s.id !== id);
        state.learningPoints = state.learningPoints.filter(lp => lp.subtopic.id !== id);
        state.selectedLps = new Set([...state.selectedLps].filter(uuid => 
          state.learningPoints.some(lp => lp.uuid === uuid)
        ));
      }
      
      updateFileList();
      renderLpList();
      updateExportStats();
      
      if (state.selectedLpUuid && !state.learningPoints.some(lp => lp.uuid === state.selectedLpUuid)) {
        state.selectedLpUuid = null;
        renderPromptPreview();
      }
    }
    
    function updateTopicInfo() {
      if (state.topic) {
        elements.topicInfo.innerHTML = `
          <span class="topic-badge">${state.topic.subject}</span>
          <span>${state.topic.name}</span>
          <span style="color: var(--color-text-faint)">|</span>
          <span>${state.topic.yearLevel}</span>
        `;
      } else {
        elements.topicInfo.innerHTML = '';
      }
    }
    
    // ============================================================================
    // QUESTION MIX SLIDERS
    // ============================================================================
    
    function renderMixSliders() {
      const levels = ['toLevel2', 'toLevel3', 'toLevel4', 'toLevel5'];
      const levelNames = {
        toLevel2: 'Remember',
        toLevel3: 'Understand',
        toLevel4: 'Apply',
        toLevel5: 'Analyze'
      };
      
      elements.mixGrid.innerHTML = levels.map((level, idx) => {
        const mix = state.questionMix[level];
        const total = mix.mc + mix.cloze + mix.tf;
        const isValid = total === 10;
        
        return `
          <div class="mix-card">
            <div class="mix-card-header">
              <span class="mix-level-name">${level}</span>
              <span class="mix-level-tag level-${idx + 2}">${levelNames[level]}</span>
            </div>
            <div class="mix-sliders">
              <div class="mix-slider-row">
                <span class="mix-slider-label mc">MC</span>
                <input type="range" class="mix-slider mc" 
                       min="0" max="10" value="${mix.mc}"
                       data-level="${level}" data-type="mc">
                <span class="mix-slider-value" id="mix-${level}-mc">${mix.mc}</span>
              </div>
              <div class="mix-slider-row">
                <span class="mix-slider-label cloze">Cloze</span>
                <input type="range" class="mix-slider cloze" 
                       min="0" max="10" value="${mix.cloze}"
                       data-level="${level}" data-type="cloze">
                <span class="mix-slider-value" id="mix-${level}-cloze">${mix.cloze}</span>
              </div>
              <div class="mix-slider-row">
                <span class="mix-slider-label tf">TF</span>
                <input type="range" class="mix-slider tf" 
                       min="0" max="10" value="${mix.tf}"
                       data-level="${level}" data-type="tf">
                <span class="mix-slider-value" id="mix-${level}-tf">${mix.tf}</span>
              </div>
            </div>
            <div class="mix-total ${isValid ? '' : 'invalid'}">
              Total: <strong>${total}/10</strong>
            </div>
          </div>
        `;
      }).join('');
      
      // Add event listeners
      document.querySelectorAll('.mix-slider').forEach(slider => {
        slider.addEventListener('input', handleSliderChange);
      });
    }
    
    function handleSliderChange(e) {
      const level = e.target.dataset.level;
      const type = e.target.dataset.type;
      const value = parseInt(e.target.value);
      
      state.questionMix[level][type] = value;
      
      // Update display
      document.getElementById(`mix-${level}-${type}`).textContent = value;
      
      // Update total
      const mix = state.questionMix[level];
      const total = mix.mc + mix.cloze + mix.tf;
      const totalEl = e.target.closest('.mix-card').querySelector('.mix-total');
      totalEl.innerHTML = `Total: <strong>${total}/10</strong>`;
      totalEl.classList.toggle('invalid', total !== 10);
      
      // Re-render prompt if viewing this level
      if (state.selectedLpUuid && state.selectedLevel === level) {
        renderPromptPreview();
      }
    }
    
    // ============================================================================
    // LEARNING POINTS LIST
    // ============================================================================
    
    function renderLpList() {
      if (state.subtopics.length === 0) {
        elements.lpList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <h3>No files loaded</h3>
            <p>Import JSON files to see learning points</p>
          </div>
        `;
        return;
      }
      
      elements.lpList.innerHTML = state.subtopics.map(subtopic => {
        const items = state.learningPoints.filter(lp => lp.subtopic.id === subtopic.id);
        
        return `
          <div class="subtopic-group" data-id="${subtopic.id}">
            <div class="subtopic-header" onclick="toggleSubtopic('${subtopic.id}')">
              <span class="subtopic-toggle">â–¼</span>
              <span class="subtopic-icon">${subtopic.icon || 'ğŸ“š'}</span>
              <span class="subtopic-name">${subtopic.name}</span>
              <span class="subtopic-count">${items.length}</span>
            </div>
            <div class="subtopic-items">
              ${items.map(lp => `
                <div class="lp-item ${state.selectedLpUuid === lp.uuid ? 'selected' : ''}" 
                     data-uuid="${lp.uuid}"
                     onclick="selectLp('${lp.uuid}')">
                  <input type="checkbox" class="lp-checkbox" 
                         ${state.selectedLps.has(lp.uuid) ? 'checked' : ''}
                         onclick="event.stopPropagation(); toggleLpSelection('${lp.uuid}')">
                  <span class="lp-code">${lp.code}</span>
                  <span class="lp-title">${lp.title}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function toggleSubtopic(id) {
      const group = document.querySelector(`.subtopic-group[data-id="${id}"]`);
      group.classList.toggle('collapsed');
    }
    
    function selectLp(uuid) {
      state.selectedLpUuid = uuid;
      renderLpList();
      renderPromptPreview();
    }
    
    function toggleLpSelection(uuid) {
      if (state.selectedLps.has(uuid)) {
        state.selectedLps.delete(uuid);
      } else {
        state.selectedLps.add(uuid);
      }
      updateExportStats();
    }
    
    // ============================================================================
    // PROMPT GENERATION
    // ============================================================================
    
    function generatePrompt(lp, level) {
      const mix = state.questionMix[level];
      const cogLevel = COGNITIVE_LEVELS[level];
      const topic = state.topic || { name: 'Unknown Topic', subject: 'Unknown', yearLevel: 'Unknown', description: '' };
      const teacherRes = state.teacherResources.trim();
      
      // Build specs based on mix
      const specs = [];
      if (mix.mc > 0) specs.push(SPECS.mc);
      if (mix.cloze > 0) specs.push(SPECS.cloze);
      if (mix.tf > 0) specs.push(SPECS.tf);
      
      const prompt = `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
QUESTION GENERATION PROMPT
Learning Point: ${lp.title}
Level: ${level} | Output: q-${lp.uuid}.json
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TASK: Generate exactly 10 assessment questions for the ${level} progression level.

QUESTION MIX REQUIRED:
- Multiple Choice: ${mix.mc}
- Cloze (dropdown): ${mix.cloze}
- True/False: ${mix.tf}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
LEARNING POINT CONTEXT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

TITLE: ${lp.title}
CODE: ${lp.code}

WHAT (concept explanation):
${lp.what}

WHY (importance):
${lp.why}

EXAMPLE (concrete illustration):
${lp.example}

SUBTOPIC: ${lp.subtopic.name}
SUBTOPIC CONTEXT: ${lp.subtopic.what}
SUBTOPIC RELEVANCE: ${lp.subtopic.why}

TOPIC: ${topic.name}
SUBJECT: ${topic.subject} | YEAR LEVEL: ${topic.yearLevel}
TOPIC DESCRIPTION: ${topic.description}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TEACHER RESOURCES (additional context)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${teacherRes || 'No additional resources provided.'}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COGNITIVE LEVEL: ${level} (${cogLevel.name})
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${cogLevel.description}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
QUALITY SPECIFICATIONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${specs.join('\n\n')}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
OUTPUT REQUIREMENTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Output ONLY valid JSON. No markdown, no explanation, no preamble.
Filename: q-${lp.uuid}.json

SCHEMA:
{
  "_link": {
    "uuid": "${lp.uuid}",
    "version": ${lp.version || 1},
    "contentHash": "${lp.contentHash || 'hash-unknown'}",
    "title": "${lp.title}",
    "generatedAt": "[ISO 8601 timestamp]"
  },
  "${level}": [
    // MC question schema (include ${mix.mc} of these):
    {
      "type": "mc",
      "question": "Question text?",
      "correct": "Correct answer text",
      "correctExplanation": "Why this is correct (1-2 sentences)",
      "distractors": [
        { "answer": "Wrong option A", "explanation": "Misconception addressed" },
        { "answer": "Wrong option B", "explanation": "Misconception addressed" },
        { "answer": "Wrong option C", "explanation": "Misconception addressed" }
      ]
    },
    // TF question schema (include ${mix.tf} of these):
    {
      "type": "tf",
      "question": "Statement to evaluate.",
      "correct": "True" or "False",
      "correctExplanation": "Why this is correct",
      "distractors": [
        { "answer": "False" or "True", "explanation": "Why students might think this" }
      ]
    },
    // Cloze question schema (include ${mix.cloze} of these):
    {
      "type": "cloze",
      "prompt": "Instruction to student",
      "sentence": "Sentence with {{blank:1}} and optional {{blank:2}} placeholders.",
      "blanks": {
        "1": {
          "correct": "correct word/phrase",
          "correctExplanation": "Why correct",
          "distractors": [
            { "answer": "wrong option 1", "explanation": "Misconception addressed" },
            { "answer": "wrong option 2", "explanation": "Misconception addressed" }
          ]
        }
      }
    }
  ]
}

CRITICAL REMINDERS:
- Exactly 10 questions total matching the specified mix (${mix.mc} MC, ${mix.cloze} Cloze, ${mix.tf} TF)
- LENGTH PARITY: All MC options must be similar length. Do NOT make correct answer longer than distractors. Keep correct answers pithy OR extend all distractors to match.
- All distractors must be real misconceptions, never absurd
- Verify factual accuracyâ€”do not hallucinate
- One unambiguous correct answer per question
- Include the _link block exactly as shown with actual values
- Output raw JSON only

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;

      return prompt;
    }
    
    function renderPromptPreview() {
      const lp = state.learningPoints.find(l => l.uuid === state.selectedLpUuid);
      
      if (!lp) {
        elements.selectedLpTitle.textContent = 'Select a Learning Point';
        elements.selectedLpSubtopic.textContent = '';
        elements.promptFilename.textContent = 'prompt-preview.txt';
        elements.promptText.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“</div>
            <h3>No prompt generated</h3>
            <p>Select a learning point from the sidebar to preview its prompt</p>
          </div>
        `;
        elements.copyPromptBtn.disabled = true;
        elements.copyAllLevelsBtn.disabled = true;
        return;
      }
      
      elements.selectedLpTitle.textContent = lp.title;
      elements.selectedLpSubtopic.textContent = `${lp.subtopic.name} â€¢ ${lp.code}`;
      elements.promptFilename.textContent = `prompt-${lp.uuid}-${state.selectedLevel}.txt`;
      
      const prompt = generatePrompt(lp, state.selectedLevel);
      elements.promptText.textContent = prompt;
      
      elements.copyPromptBtn.disabled = false;
      elements.copyAllLevelsBtn.disabled = false;
    }
    
    // ============================================================================
    // LEVEL SELECTOR
    // ============================================================================
    
    function setupLevelSelector() {
      elements.levelSelector.addEventListener('click', (e) => {
        const btn = e.target.closest('.level-btn');
        if (!btn) return;
        
        document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        state.selectedLevel = btn.dataset.level;
        renderPromptPreview();
      });
    }
    
    // ============================================================================
    // EXPORT FUNCTIONS
    // ============================================================================
    
    function updateExportStats() {
      const selectedCount = state.selectedLps.size;
      const promptCount = selectedCount * 4;
      
      elements.exportStats.textContent = `${selectedCount} learning points selected â€¢ ${promptCount} prompts ready`;
      
      const hasPrompts = selectedCount > 0;
      elements.exportTxtBtn.disabled = !hasPrompts;
      elements.exportSeparateBtn.disabled = !hasPrompts;
      elements.exportJsonBtn.disabled = !hasPrompts;
    }
    
    function getSelectedLps() {
      return state.learningPoints.filter(lp => state.selectedLps.has(lp.uuid));
    }
    
    function exportSingleTextFile() {
      const lps = getSelectedLps();
      const topicId = state.topic?.id || 'unknown';
      const date = new Date().toISOString().split('T')[0];
      
      let content = `QUESTION GENERATION PROMPTS
Topic: ${state.topic?.name || 'Unknown'}
Generated: ${new Date().toLocaleString()}
Learning Points: ${lps.length}
Total Prompts: ${lps.length * 4}

`;
      
      lps.forEach(lp => {
        content += `\n${'='.repeat(80)}\n`;
        content += `LEARNING POINT: ${lp.title}\n`;
        content += `UUID: ${lp.uuid}\n`;
        content += `${'='.repeat(80)}\n`;
        
        ['toLevel2', 'toLevel3', 'toLevel4', 'toLevel5'].forEach(level => {
          content += `\n--- ${level} (${COGNITIVE_LEVELS[level].name}) ---\n\n`;
          content += generatePrompt(lp, level);
          content += '\n';
        });
      });
      
      downloadFile(`question-prompts-${topicId}-${date}.txt`, content, 'text/plain');
      showToast('Exported single text file', 'success');
    }
    
    function exportSeparateLpFiles() {
      const lps = getSelectedLps();
      
      // Create a zip-like structure using multiple downloads
      // For simplicity, we'll create a combined file with clear separators
      // In production, you'd use JSZip library
      
      lps.forEach(lp => {
        let content = `PROMPTS FOR: ${lp.title}\n`;
        content += `UUID: ${lp.uuid}\n`;
        content += `Subtopic: ${lp.subtopic.name}\n`;
        content += `Generated: ${new Date().toLocaleString()}\n\n`;
        
        ['toLevel2', 'toLevel3', 'toLevel4', 'toLevel5'].forEach(level => {
          content += `\n${'â”€'.repeat(80)}\n`;
          content += `${level} (${COGNITIVE_LEVELS[level].name})\n`;
          content += `${'â”€'.repeat(80)}\n\n`;
          content += generatePrompt(lp, level);
          content += '\n';
        });
        
        downloadFile(`prompt-${lp.uuid}.txt`, content, 'text/plain');
      });
      
      showToast(`Exported ${lps.length} separate files`, 'success');
    }
    
    function exportJsonBundle() {
      const lps = getSelectedLps();
      const topicId = state.topic?.id || 'unknown';
      const date = new Date().toISOString().split('T')[0];
      
      const bundle = {
        _meta: {
          generatedAt: new Date().toISOString(),
          topicId: state.topic?.id || null,
          topicName: state.topic?.name || 'Unknown',
          subject: state.topic?.subject || 'Unknown',
          yearLevel: state.topic?.yearLevel || 'Unknown',
          totalLPs: lps.length,
          totalPrompts: lps.length * 4,
          teacherResourcesIncluded: !!state.teacherResources.trim(),
          questionMix: state.questionMix
        },
        prompts: lps.map(lp => ({
          uuid: lp.uuid,
          version: lp.version || 1,
          contentHash: lp.contentHash || 'hash-unknown',
          title: lp.title,
          code: lp.code,
          subtopic: lp.subtopic.name,
          levels: {
            toLevel2: { 
              prompt: generatePrompt(lp, 'toLevel2'), 
              questionMix: state.questionMix.toLevel2 
            },
            toLevel3: { 
              prompt: generatePrompt(lp, 'toLevel3'), 
              questionMix: state.questionMix.toLevel3 
            },
            toLevel4: { 
              prompt: generatePrompt(lp, 'toLevel4'), 
              questionMix: state.questionMix.toLevel4 
            },
            toLevel5: { 
              prompt: generatePrompt(lp, 'toLevel5'), 
              questionMix: state.questionMix.toLevel5 
            }
          }
        }))
      };
      
      const content = JSON.stringify(bundle, null, 2);
      downloadFile(`question-prompts-${topicId}-${date}.json`, content, 'application/json');
      showToast('Exported JSON bundle', 'success');
    }
    
    function downloadFile(filename, content, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // ============================================================================
    // COPY FUNCTIONS
    // ============================================================================
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard', 'success');
      }).catch(err => {
        showToast('Failed to copy', 'error');
      });
    }
    
    function copyCurrentPrompt() {
      const lp = state.learningPoints.find(l => l.uuid === state.selectedLpUuid);
      if (!lp) return;
      
      const prompt = generatePrompt(lp, state.selectedLevel);
      copyToClipboard(prompt);
    }
    
    function copyAllLevelsForLp() {
      const lp = state.learningPoints.find(l => l.uuid === state.selectedLpUuid);
      if (!lp) return;
      
      let content = `PROMPTS FOR: ${lp.title}\n`;
      content += `UUID: ${lp.uuid}\n\n`;
      
      ['toLevel2', 'toLevel3', 'toLevel4', 'toLevel5'].forEach(level => {
        content += `\n${'â•'.repeat(80)}\n`;
        content += `${level}\n`;
        content += `${'â•'.repeat(80)}\n\n`;
        content += generatePrompt(lp, level);
        content += '\n';
      });
      
      copyToClipboard(content);
    }
    
    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹'}</span> ${message}`;
      elements.toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    function resetAll() {
      if (!confirm('Clear all loaded data and reset settings?')) return;
      
      state.topic = null;
      state.subtopics = [];
      state.learningPoints = [];
      state.selectedLpUuid = null;
      state.selectedLps = new Set();
      state.teacherResources = '';
      state.questionMix = JSON.parse(JSON.stringify(DEFAULT_MIX));
      
      elements.teacherResources.value = '';
      
      updateTopicInfo();
      updateFileList();
      renderMixSliders();
      renderLpList();
      renderPromptPreview();
      updateExportStats();
      
      showToast('All data cleared', 'success');
    }
    
    function resetMix() {
      state.questionMix = JSON.parse(JSON.stringify(DEFAULT_MIX));
      renderMixSliders();
      renderPromptPreview();
      showToast('Question mix reset to defaults', 'success');
    }
    
    function selectAllLps() {
      state.learningPoints.forEach(lp => state.selectedLps.add(lp.uuid));
      renderLpList();
      updateExportStats();
    }
    
    function deselectAllLps() {
      state.selectedLps.clear();
      renderLpList();
      updateExportStats();
    }
    
    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    
    function setupEventListeners() {
      // File input
      elements.fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
        e.target.value = ''; // Reset to allow same file
      });
      
      // Drag and drop
      elements.fileDropZone.addEventListener('click', () => elements.fileInput.click());
      
      elements.fileDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        elements.fileDropZone.classList.add('drag-over');
      });
      
      elements.fileDropZone.addEventListener('dragleave', () => {
        elements.fileDropZone.classList.remove('drag-over');
      });
      
      elements.fileDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        elements.fileDropZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
      });
      
      // Teacher resources
      elements.teacherResources.addEventListener('input', (e) => {
        state.teacherResources = e.target.value;
        // Debounce prompt re-render
        clearTimeout(window.teacherResourcesTimeout);
        window.teacherResourcesTimeout = setTimeout(() => {
          if (state.selectedLpUuid) renderPromptPreview();
        }, 500);
      });
      
      // Buttons
      elements.resetBtn.addEventListener('click', resetAll);
      elements.resetMixBtn.addEventListener('click', resetMix);
      elements.selectAllBtn.addEventListener('click', selectAllLps);
      elements.deselectAllBtn.addEventListener('click', deselectAllLps);
      elements.copyPromptBtn.addEventListener('click', copyCurrentPrompt);
      elements.copyAllLevelsBtn.addEventListener('click', copyAllLevelsForLp);
      elements.exportTxtBtn.addEventListener('click', exportSingleTextFile);
      elements.exportSeparateBtn.addEventListener('click', exportSeparateLpFiles);
      elements.exportJsonBtn.addEventListener('click', exportJsonBundle);
      
      // Level selector
      setupLevelSelector();
    }
    
    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    
    function init() {
      renderMixSliders();
      renderLpList();
      renderPromptPreview();
      updateExportStats();
      setupEventListeners();
    }
    
    // Start the app
    init();
  </script>
</body>
</html>
