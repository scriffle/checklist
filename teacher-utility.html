<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Utility - Dynamic Learning Checklist</title>
    <style>
/* ============================================
   CSS VARIABLES & RESET
   ============================================ */
:root {
    /* Colors */
    --color-primary: #2d9d78;
    --color-primary-dark: #1e7d5e;
    --color-primary-pale: #e8f5f0;
    --color-primary-glow: rgba(45, 157, 120, 0.15);

    --color-bg: #f8fafb;
    --color-bg-card: #ffffff;
    --color-bg-warm: #f5f7f6;
    --color-bg-hover: rgba(45, 157, 120, 0.08);

    --color-text: #1e293b;
    --color-text-secondary: #4a5f58;
    --color-text-muted: #64748b;
    --color-text-faint: #94a3b8;
    --color-text-inverse: #ffffff;

    --color-border: #e2e8f0;
    --color-border-light: #f1f5f9;

    --color-success: #22c55e;
    --color-warning: #f59e0b;
    --color-error: #ef4444;
    --color-info: #3b82f6;

    /* Levels */
    --level-1: #cbd5e1;
    --level-2: #f97316;
    --level-3: #eab308;
    --level-4: #22c55e;
    --level-5: #8b5cf6;

    /* Qualities */
    --quality-foundation: #6366f1;
    --quality-momentum: #f59e0b;
    --quality-steadiness: #22c55e;
    --quality-curiosity: #3b82f6;
    --quality-persistence: #8b5cf6;
    --quality-habits: #2d9d78;

    /* Typography */
    --font-display: 'Segoe UI', system-ui, -apple-system, sans-serif;
    --font-body: 'Segoe UI', system-ui, -apple-system, sans-serif;
    --font-mono: 'SF Mono', 'Consolas', 'Monaco', monospace;

    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;

    /* Spacing */
    --space-1: 0.25rem;
    --space-2: 0.5rem;
    --space-3: 0.75rem;
    --space-4: 1rem;
    --space-5: 1.5rem;
    --space-6: 2rem;
    --space-8: 3rem;

    /* Borders & Shadows */
    --radius-sm: 6px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;

    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.04);

    /* Transitions */
    --transition-fast: 0.15s ease;
    --transition-normal: 0.25s ease;
}

/* Dark Mode */
[data-theme="dark"] {
    --color-bg: #0f1714;
    --color-bg-card: #1a2420;
    --color-bg-warm: #1f2d28;
    --color-bg-hover: rgba(45, 157, 120, 0.15);

    --color-text: #e8f0ed;
    --color-text-secondary: #a8b8b2;
    --color-text-muted: #6a7a74;
    --color-text-faint: #4a5a54;

    --color-border: #2d3d36;
    --color-border-light: #243029;

    --color-primary-pale: rgba(45, 157, 120, 0.2);
}

/* Reset */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html {
    font-size: 15px;
    -webkit-font-smoothing: antialiased;
}

body {
    font-family: var(--font-body);
    font-size: var(--text-base);
    line-height: 1.6;
    color: var(--color-text);
    background: var(--color-bg);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* ============================================
   LAYOUT
   ============================================ */
.app-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.app-header {
    background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 100%);
    color: var(--color-text-inverse);
    padding: var(--space-4) var(--space-5);
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.app-title {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.app-subtitle {
    font-size: var(--text-sm);
    opacity: 0.9;
    font-weight: 400;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.header-btn {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--color-text-inverse);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: var(--text-sm);
    transition: all var(--transition-fast);
}

.header-btn:hover {
    background: rgba(255, 255, 255, 0.25);
}

/* ============================================
   TABS
   ============================================ */
.tab-bar {
    background: var(--color-bg-card);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    gap: var(--space-1);
    padding: 0 var(--space-5);
}

.tab-btn {
    padding: var(--space-3) var(--space-5);
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text-muted);
    background: none;
    border: none;
    cursor: pointer;
    position: relative;
    transition: all var(--transition-fast);
}

.tab-btn:hover {
    color: var(--color-text);
}

.tab-btn.active {
    color: var(--color-primary);
}

.tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--color-primary);
    border-radius: 3px 3px 0 0;
}

.tab-icon {
    margin-right: var(--space-2);
}

/* ============================================
   MAIN CONTENT
   ============================================ */
.main-content {
    flex: 1;
    max-width: 1400px;
    width: 100%;
    margin: 0 auto;
    padding: var(--space-5);
}

.tab-panel {
    display: none;
}

.tab-panel.active {
    display: block;
}

/* ============================================
   CARDS
   ============================================ */
.card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    margin-bottom: var(--space-4);
}

.card-header {
    margin-bottom: var(--space-4);
}

.card-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.card-description {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin-top: var(--space-2);
}

/* ============================================
   SETUP CARDS
   ============================================ */
.setup-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-5);
}

.setup-card {
    background: var(--color-bg-warm);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    border: 1px solid var(--color-border-light);
}

.setup-card-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
}

.setup-card-step {
    width: 28px;
    height: 28px;
    background: var(--color-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
    flex-shrink: 0;
}

.setup-card-title {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 1.1rem;
}

.setup-card-subtitle {
    color: var(--color-text-muted);
    font-size: 0.85rem;
    margin-top: var(--space-1);
}

/* ============================================
   TEXTAREA INPUT
   ============================================ */
.email-textarea {
    width: 100%;
    min-height: 250px;
    padding: var(--space-4);
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    resize: vertical;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.email-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-glow);
}

.email-textarea::placeholder {
    color: var(--color-text-faint);
}

/* ============================================
   BUTTONS
   ============================================ */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-5);
    font-size: var(--text-sm);
    font-weight: 600;
    font-family: var(--font-body);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    border: none;
}

.btn-primary {
    background: var(--color-primary);
    color: var(--color-text-inverse);
}

.btn-primary:hover {
    background: var(--color-primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.btn-secondary {
    background: var(--color-bg-warm);
    color: var(--color-text);
    border: 1px solid var(--color-border);
}

.btn-secondary:hover {
    background: var(--color-bg-hover);
    border-color: var(--color-primary);
}

.btn-large {
    padding: var(--space-4) var(--space-6);
    font-size: var(--text-base);
}

.btn-small {
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-xs);
}

.btn-icon {
    font-size: 1.1em;
}

.btn-group {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
}

/* ============================================
   STATS BAR
   ============================================ */
.stats-bar {
    display: flex;
    gap: var(--space-5);
    padding: var(--space-4);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-5);
    flex-wrap: wrap;
}

.stat-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.stat-value {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--color-primary);
}

.stat-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* ============================================
   STUDENT CARDS
   ============================================ */
.students-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: var(--space-4);
}

.student-card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all var(--transition-fast);
}

.student-card:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
}

.student-card-header {
    padding: var(--space-4);
    background: var(--color-bg-warm);
    border-bottom: 1px solid var(--color-border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.student-info {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.student-avatar {
    width: 40px;
    height: 40px;
    background: var(--color-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: var(--text-base);
}

.student-name {
    font-weight: 700;
    font-size: var(--text-base);
}

.student-class {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.student-progress-badge {
    padding: var(--space-1) var(--space-3);
    border-radius: 20px;
    font-size: var(--text-sm);
    font-weight: 700;
}

.student-card-body {
    padding: var(--space-4);
}

.student-topic {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin-bottom: var(--space-3);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.student-topic strong {
    color: var(--color-text);
}

/* ============================================
   PROGRESS BAR
   ============================================ */
.progress-section {
    margin-bottom: var(--space-4);
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
}

.progress-label {
    font-size: var(--text-sm);
    font-weight: 600;
}

.progress-value {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-primary);
}

.progress-bar {
    height: 8px;
    background: var(--color-border);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--color-primary);
    border-radius: 4px;
    transition: width var(--transition-normal);
}

/* ============================================
   LEVEL DISTRIBUTION
   ============================================ */
.level-distribution {
    display: flex;
    gap: var(--space-1);
    margin-bottom: var(--space-4);
}

.level-segment {
    height: 6px;
    border-radius: 3px;
    transition: all var(--transition-fast);
}

.level-segment:hover {
    transform: scaleY(1.5);
}

.level-segment.level-5 { background: var(--level-5); }
.level-segment.level-4 { background: var(--level-4); }
.level-segment.level-3 { background: var(--level-3); }
.level-segment.level-2 { background: var(--level-2); }
.level-segment.level-1 { background: var(--level-1); }

.level-legend {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
}

.level-legend-item {
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.level-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.level-dot.level-5 { background: var(--level-5); }
.level-dot.level-4 { background: var(--level-4); }
.level-dot.level-3 { background: var(--level-3); }
.level-dot.level-2 { background: var(--level-2); }
.level-dot.level-1 { background: var(--level-1); }

/* ============================================
   LEARNING CHARACTER
   ============================================ */
.learning-character {
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-3);
}

.character-title {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-muted);
    margin-bottom: var(--space-2);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.character-narrative {
    font-size: var(--text-sm);
    color: var(--color-text);
    font-style: italic;
    line-height: 1.5;
}

.qualities-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-2);
    margin-top: var(--space-3);
}

.quality-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
}

.quality-bar-container {
    flex: 1;
    height: 4px;
    background: var(--color-border);
    border-radius: 2px;
    overflow: hidden;
}

.quality-bar {
    height: 100%;
    border-radius: 2px;
    transition: width var(--transition-normal);
}

.quality-bar.foundation { background: var(--quality-foundation); }
.quality-bar.momentum { background: var(--quality-momentum); }
.quality-bar.steadiness { background: var(--quality-steadiness); }
.quality-bar.engagedCuriosity { background: var(--quality-curiosity); }
.quality-bar.persistence { background: var(--quality-persistence); }
.quality-bar.learningHabits { background: var(--quality-habits); }

.quality-value {
    font-weight: 600;
    min-width: 32px;
    text-align: right;
}

/* ============================================
   METRICS ROW
   ============================================ */
.metrics-row {
    display: flex;
    gap: var(--space-4);
    padding-top: var(--space-3);
    border-top: 1px solid var(--color-border-light);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.metric-item {
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.metric-item strong {
    color: var(--color-text);
}

/* ============================================
   EMPTY STATE
   ============================================ */
.empty-state {
    text-align: center;
    padding: var(--space-8);
    color: var(--color-text-muted);
}

.empty-state-icon {
    font-size: 48px;
    opacity: 0.5;
    margin-bottom: var(--space-3);
}

.empty-state-title {
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-2);
}

.empty-state-text {
    font-size: var(--text-sm);
    max-width: 400px;
    margin: 0 auto;
}

/* ============================================
   SORT & FILTER BAR
   ============================================ */
.toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
}

.toolbar-left {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.toolbar-right {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.filter-select {
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    cursor: pointer;
}

.filter-select:focus {
    outline: none;
    border-color: var(--color-primary);
}

.search-input {
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    min-width: 200px;
}

.search-input:focus {
    outline: none;
    border-color: var(--color-primary);
}

/* ============================================
   CLASS SUMMARY
   ============================================ */
.class-summary {
    background: linear-gradient(135deg, var(--color-primary-pale) 0%, var(--color-bg-card) 100%);
    border: 1px solid var(--color-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    margin-bottom: var(--space-5);
}

.class-summary-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-4);
}

.class-summary-title {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-primary-dark);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.class-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-4);
}

.class-stat {
    background: var(--color-bg-card);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    text-align: center;
}

.class-stat-value {
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--color-primary);
}

.class-stat-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-1);
}

/* ============================================
   TOAST
   ============================================ */
.toast-container {
    position: fixed;
    bottom: var(--space-5);
    right: var(--space-5);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.toast {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-3) var(--space-4);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    animation: slideIn 0.3s ease;
    max-width: 350px;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.toast-success { border-left: 3px solid var(--color-success); }
.toast-error { border-left: 3px solid var(--color-error); }
.toast-info { border-left: 3px solid var(--color-primary); }
.toast-warning { border-left: 3px solid var(--color-warning); }

.toast-message {
    font-size: var(--text-sm);
    color: var(--color-text);
    flex: 1;
}

.toast-close {
    background: none;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    padding: var(--space-1);
    font-size: var(--text-lg);
    line-height: 1;
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 900px) {
    .setup-grid {
        grid-template-columns: 1fr;
    }

    .students-grid {
        grid-template-columns: 1fr;
    }

    .toolbar {
        flex-direction: column;
        align-items: stretch;
    }

    .toolbar-left, .toolbar-right {
        flex-wrap: wrap;
    }
}

@media (max-width: 600px) {
    .main-content {
        padding: var(--space-3);
    }

    .card {
        padding: var(--space-4);
    }

    .header-content {
        flex-direction: column;
        text-align: center;
    }

    .qualities-grid {
        grid-template-columns: 1fr;
    }
}

/* Scrollbar styling */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--color-bg);
}

::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
}

/* ============================================
   MESSAGE MANAGER STYLES
   ============================================ */
.messages-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
}

.messages-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.message-card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all var(--transition-fast);
}

.message-card:hover {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-md);
}

.message-card.inactive {
    opacity: 0.6;
}

.message-card-header {
    padding: var(--space-4);
    background: var(--color-bg-warm);
    border-bottom: 1px solid var(--color-border-light);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-3);
}

.message-header-left {
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
    flex: 1;
}

.message-type-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.message-type-icon.seasonal { background: rgba(234, 179, 8, 0.15); }
.message-type-icon.update { background: rgba(59, 130, 246, 0.15); }
.message-type-icon.alert { background: rgba(239, 68, 68, 0.15); }
.message-type-icon.tip { background: rgba(34, 197, 94, 0.15); }
.message-type-icon.general { background: rgba(100, 116, 139, 0.15); }

.message-title-section {
    flex: 1;
}

.message-title {
    font-weight: 700;
    font-size: var(--text-base);
    margin-bottom: var(--space-1);
}

.message-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.message-meta-item {
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.message-badges {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
}

.message-badge {
    padding: var(--space-1) var(--space-2);
    border-radius: 12px;
    font-size: var(--text-xs);
    font-weight: 600;
}

.message-badge.active {
    background: rgba(34, 197, 94, 0.15);
    color: var(--color-success);
}

.message-badge.inactive {
    background: rgba(100, 116, 139, 0.15);
    color: var(--color-text-muted);
}

.message-badge.type {
    background: var(--color-primary-pale);
    color: var(--color-primary-dark);
}

.message-card-body {
    padding: var(--space-4);
}

.message-content {
    font-size: var(--text-sm);
    line-height: 1.7;
    white-space: pre-wrap;
    color: var(--color-text-secondary);
}

.message-card-footer {
    padding: var(--space-3) var(--space-4);
    background: var(--color-bg-warm);
    border-top: 1px solid var(--color-border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
}

.message-audience {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.message-actions {
    display: flex;
    gap: var(--space-2);
}

/* Message Form / Modal */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    padding: var(--space-4);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-fast);
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal {
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    transform: translateY(20px);
    transition: transform var(--transition-fast);
}

.modal-overlay.active .modal {
    transform: translateY(0);
}

.modal-header {
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    font-size: var(--text-lg);
    font-weight: 700;
}

.modal-close {
    background: none;
    border: none;
    font-size: var(--text-xl);
    color: var(--color-text-muted);
    cursor: pointer;
    padding: var(--space-1);
    line-height: 1;
}

.modal-close:hover {
    color: var(--color-text);
}

.modal-body {
    padding: var(--space-5);
}

.modal-footer {
    padding: var(--space-4) var(--space-5);
    border-top: 1px solid var(--color-border);
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
}

/* Form Styles */
.form-group {
    margin-bottom: var(--space-4);
}

.form-label {
    display: block;
    font-size: var(--text-sm);
    font-weight: 600;
    margin-bottom: var(--space-2);
    color: var(--color-text);
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: var(--space-3);
    font-size: var(--text-sm);
    font-family: var(--font-body);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-glow);
}

.form-textarea {
    min-height: 120px;
    resize: vertical;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
}

.form-hint {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-1);
}

.form-checkbox-group {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.form-checkbox {
    width: 18px;
    height: 18px;
    accent-color: var(--color-primary);
}

/* JSON Preview */
.json-preview {
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    white-space: pre-wrap;
    word-break: break-all;
    max-height: 300px;
    overflow-y: auto;
}

.btn-danger {
    background: var(--color-error);
    color: var(--color-text-inverse);
}

.btn-danger:hover {
    opacity: 0.9;
}

@media (max-width: 600px) {
    .form-row {
        grid-template-columns: 1fr;
    }

    .message-card-header {
        flex-direction: column;
    }

    .message-badges {
        margin-top: var(--space-2);
    }
}
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <div>
                    <h1 class="app-title">
                        <span>üìä</span>
                        <span>Teacher Utility</span>
                    </h1>
                    <p class="app-subtitle">Aggregate student progress and manage announcements</p>
                </div>
                <div class="header-actions">
                    <button class="header-btn" id="theme-toggle" title="Toggle dark mode">üåô</button>
                </div>
            </div>
        </header>

        <div class="tab-bar">
            <button class="tab-btn active" data-tab="aggregator">
                <span class="tab-icon">üìà</span>Progress Aggregator
            </button>
            <button class="tab-btn" data-tab="messages">
                <span class="tab-icon">üì¢</span>Message Manager
            </button>
        </div>

        <main class="main-content">
            <!-- AGGREGATOR TAB -->
            <div class="tab-panel active" id="aggregator-panel">

                <!-- Input Section -->
                <div class="card">
                    <div class="setup-grid">
                        <div class="setup-card">
                            <div class="setup-card-header">
                                <div class="setup-card-step">1</div>
                                <div>
                                    <div class="setup-card-title">Paste Student Emails</div>
                                    <div class="setup-card-subtitle">Paste one or more student email reports</div>
                                </div>
                            </div>
                            <textarea
                                class="email-textarea"
                                id="email-input"
                                placeholder="Paste student email content here...

The system will automatically find and extract JSON data blocks wrapped in:
\`\`\`json
{ ... }
\`\`\`

You can paste multiple emails at once - just separate them with blank lines."
                            ></textarea>
                        </div>

                        <div class="setup-card">
                            <div class="setup-card-header">
                                <div class="setup-card-step">2</div>
                                <div>
                                    <div class="setup-card-title">Parse & Aggregate</div>
                                    <div class="setup-card-subtitle">Extract student data and view summaries</div>
                                </div>
                            </div>

                            <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                                <button class="btn btn-primary btn-large" id="parse-btn" style="width: 100%;">
                                    <span class="btn-icon">üîç</span>
                                    Parse Email Data
                                </button>

                                <div class="btn-group">
                                    <button class="btn btn-secondary" id="clear-input-btn">
                                        <span class="btn-icon">üóëÔ∏è</span>
                                        Clear Input
                                    </button>
                                    <button class="btn btn-secondary" id="clear-all-btn">
                                        <span class="btn-icon">‚Üª</span>
                                        Reset All
                                    </button>
                                </div>

                                <div id="parse-status" style="font-size: var(--text-sm); color: var(--color-text-muted);"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="results-section" style="display: none;">

                    <!-- Class Summary -->
                    <div class="class-summary" id="class-summary">
                        <div class="class-summary-header">
                            <h2 class="class-summary-title">
                                <span>üìä</span>
                                <span>Class Overview</span>
                            </h2>
                        </div>
                        <div class="class-stats-grid" id="class-stats-grid">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Toolbar -->
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <input type="text" class="search-input" id="search-input" placeholder="Search students...">
                            <select class="filter-select" id="topic-filter">
                                <option value="">All Topics</option>
                            </select>
                        </div>
                        <div class="toolbar-right">
                            <select class="filter-select" id="sort-select">
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="progress-desc">Progress (High-Low)</option>
                                <option value="progress-asc">Progress (Low-High)</option>
                                <option value="date-desc">Most Recent</option>
                            </select>
                            <button class="btn btn-secondary btn-small" id="export-summary-btn">
                                <span class="btn-icon">üìÑ</span>
                                Export Summary
                            </button>
                        </div>
                    </div>

                    <!-- Student Cards -->
                    <div class="students-grid" id="students-grid">
                        <!-- Populated by JS -->
                    </div>

                </div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state">
                    <div class="empty-state-icon">üì¨</div>
                    <h3 class="empty-state-title">No Student Data Yet</h3>
                    <p class="empty-state-text">
                        Paste student email reports in the input area above, then click "Parse Email Data" to aggregate their progress.
                    </p>
                </div>

            </div>

            <!-- MESSAGES TAB -->
            <div class="tab-panel" id="messages-panel">

                <!-- Import/Export Section -->
                <div class="card">
                    <div class="setup-grid">
                        <div class="setup-card">
                            <div class="setup-card-header">
                                <div class="setup-card-step">1</div>
                                <div>
                                    <div class="setup-card-title">Load Messages</div>
                                    <div class="setup-card-subtitle">Import existing message.json or start fresh</div>
                                </div>
                            </div>
                            <div class="btn-group" style="margin-bottom: var(--space-3);">
                                <button class="btn btn-secondary" id="load-messages-btn">
                                    <span class="btn-icon">üìÇ</span>
                                    Load message.json
                                </button>
                                <button class="btn btn-secondary" id="paste-messages-btn">
                                    <span class="btn-icon">üìã</span>
                                    Paste JSON
                                </button>
                            </div>
                            <input type="file" id="messages-file-input" accept=".json" style="display: none;">
                            <div id="messages-load-status" style="font-size: var(--text-sm); color: var(--color-text-muted);"></div>
                        </div>

                        <div class="setup-card">
                            <div class="setup-card-header">
                                <div class="setup-card-step">2</div>
                                <div>
                                    <div class="setup-card-title">Export Messages</div>
                                    <div class="setup-card-subtitle">Download or copy the message.json file</div>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary" id="export-messages-btn">
                                    <span class="btn-icon">üíæ</span>
                                    Download message.json
                                </button>
                                <button class="btn btn-secondary" id="copy-messages-btn">
                                    <span class="btn-icon">üìã</span>
                                    Copy JSON
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages Toolbar -->
                <div class="messages-toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-primary" id="add-message-btn">
                            <span class="btn-icon">‚ûï</span>
                            Add Message
                        </button>
                        <select class="filter-select" id="messages-type-filter">
                            <option value="">All Types</option>
                            <option value="seasonal">Seasonal</option>
                            <option value="update">Update</option>
                            <option value="alert">Alert</option>
                            <option value="tip">Tip</option>
                            <option value="general">General</option>
                        </select>
                        <select class="filter-select" id="messages-status-filter">
                            <option value="">All Status</option>
                            <option value="active">Active Only</option>
                            <option value="inactive">Inactive Only</option>
                        </select>
                    </div>
                    <div class="toolbar-right">
                        <span id="messages-count" style="font-size: var(--text-sm); color: var(--color-text-muted);">0 messages</span>
                    </div>
                </div>

                <!-- Messages List -->
                <div class="messages-list" id="messages-list">
                    <!-- Empty state shown when no messages -->
                </div>

                <!-- Empty State for Messages -->
                <div id="messages-empty-state" class="empty-state">
                    <div class="empty-state-icon">üì¢</div>
                    <h3 class="empty-state-title">No Messages Yet</h3>
                    <p class="empty-state-text">
                        Load an existing message.json file or click "Add Message" to create your first announcement.
                    </p>
                </div>

            </div>

        </main>
    </div>

    <!-- Message Edit Modal -->
    <div class="modal-overlay" id="message-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Add Message</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="message-form">
                    <input type="hidden" id="msg-id">

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="msg-type">Type</label>
                            <select class="form-select" id="msg-type" required>
                                <option value="seasonal">üåü Seasonal</option>
                                <option value="update">üîî Update</option>
                                <option value="alert">‚ö†Ô∏è Alert</option>
                                <option value="tip">üí° Tip</option>
                                <option value="general">üìå General</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="msg-active">Status</label>
                            <div class="form-checkbox-group" style="height: 42px; align-items: center;">
                                <input type="checkbox" class="form-checkbox" id="msg-active" checked>
                                <label for="msg-active">Active (visible to students)</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="msg-title">Title</label>
                        <input type="text" class="form-input" id="msg-title" placeholder="Message title..." required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="msg-content">Content</label>
                        <textarea class="form-textarea" id="msg-content" placeholder="Write your message here..." required></textarea>
                        <p class="form-hint">Supports plain text. Keep messages concise and student-friendly.</p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="msg-start-date">Start Date (optional)</label>
                            <input type="date" class="form-input" id="msg-start-date">
                            <p class="form-hint">Message appears from this date</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="msg-end-date">End Date (optional)</label>
                            <input type="date" class="form-input" id="msg-end-date">
                            <p class="form-hint">Message hidden after this date</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="msg-audience">Audience</label>
                        <select class="form-select" id="msg-audience">
                            <option value="all">All Students</option>
                            <option value="year7">Year 7 Only</option>
                            <option value="year8">Year 8 Only</option>
                            <option value="year9">Year 9 Only</option>
                            <option value="year10">Year 10 Only</option>
                            <option value="year11">Year 11 Only</option>
                            <option value="year12">Year 12 Only</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="msg-directive">Teacher Directive (optional)</label>
                        <input type="text" class="form-input" id="msg-directive" placeholder="Internal note for teachers...">
                        <p class="form-hint">Not shown to students. Use for internal notes or context.</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
                <button class="btn btn-danger" id="modal-delete" style="display: none;">Delete</button>
                <button class="btn btn-primary" id="modal-save">Save Message</button>
            </div>
        </div>
    </div>

    <!-- JSON Paste Modal -->
    <div class="modal-overlay" id="paste-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Paste JSON</h3>
                <button class="modal-close" id="paste-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Paste message.json content:</label>
                    <textarea class="form-textarea" id="paste-json-input" style="min-height: 200px; font-family: var(--font-mono);" placeholder='[
  {
    "id": 1,
    "type": "seasonal",
    "title": "Welcome!",
    "date": "2025-01-01",
    "content": "Message content here...",
    "active": true
  }
]'></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="paste-modal-cancel">Cancel</button>
                <button class="btn btn-primary" id="paste-modal-import">Import</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
// ============================================
// STATE
// ============================================
let currentTheme = 'light';
let students = [];
let filteredStudents = [];

// Message Manager State
let messages = [];
let editingMessageId = null;

// Quality label thresholds (from student app)
const QUALITY_LABELS = {
    foundation: [
        [30, "Starting fresh"],
        [50, "Some prior knowledge"],
        [70, "Good foundation"],
        [85, "Strong foundation"],
        [100, "Very strong foundation"]
    ],
    momentum: [
        [30, "Getting started"],
        [50, "Building momentum"],
        [70, "Good progress rate"],
        [85, "Strong momentum"],
        [100, "Exceptional momentum"]
    ],
    steadiness: [
        [30, "Variable practice"],
        [50, "Becoming more regular"],
        [70, "Consistent practice"],
        [85, "Very consistent"],
        [100, "Rock-solid consistency"]
    ],
    engagedCuriosity: [
        [30, "Focused approach"],
        [50, "Exploring content"],
        [70, "Actively exploring"],
        [85, "Highly curious"],
        [100, "Deeply curious"]
    ],
    persistence: [
        [30, "Building resilience"],
        [50, "Growing determination"],
        [70, "Good persistence"],
        [85, "Resilient and determined"],
        [100, "Highly persistent"]
    ],
    learningHabits: [
        [30, "Building study habits"],
        [50, "Developing learning strategies"],
        [70, "Good learning approach"],
        [85, "Strong learning habits"],
        [100, "Excellent learning strategies"]
    ]
};

// ============================================
// INITIALIZATION
// ============================================
function init() {
    // Theme
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        setTheme('dark');
    }

    setupEventListeners();
}

function setupEventListeners() {
    // Theme toggle
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    // Parse button
    document.getElementById('parse-btn').addEventListener('click', parseEmails);

    // Clear buttons
    document.getElementById('clear-input-btn').addEventListener('click', () => {
        document.getElementById('email-input').value = '';
        document.getElementById('parse-status').textContent = '';
    });

    document.getElementById('clear-all-btn').addEventListener('click', resetAll);

    // Search and filter
    document.getElementById('search-input').addEventListener('input', filterAndRenderStudents);
    document.getElementById('topic-filter').addEventListener('change', filterAndRenderStudents);
    document.getElementById('sort-select').addEventListener('change', filterAndRenderStudents);

    // Export
    document.getElementById('export-summary-btn').addEventListener('click', exportSummary);

    // ========== MESSAGE MANAGER EVENTS ==========

    // Load/Export messages
    document.getElementById('load-messages-btn').addEventListener('click', () => {
        document.getElementById('messages-file-input').click();
    });

    document.getElementById('messages-file-input').addEventListener('change', handleMessagesFileLoad);

    document.getElementById('paste-messages-btn').addEventListener('click', openPasteModal);
    document.getElementById('export-messages-btn').addEventListener('click', exportMessagesFile);
    document.getElementById('copy-messages-btn').addEventListener('click', copyMessagesJson);

    // Message filters
    document.getElementById('messages-type-filter').addEventListener('change', renderMessagesList);
    document.getElementById('messages-status-filter').addEventListener('change', renderMessagesList);

    // Add message
    document.getElementById('add-message-btn').addEventListener('click', () => openMessageModal());

    // Message modal
    document.getElementById('modal-close').addEventListener('click', closeMessageModal);
    document.getElementById('modal-cancel').addEventListener('click', closeMessageModal);
    document.getElementById('modal-save').addEventListener('click', saveMessage);
    document.getElementById('modal-delete').addEventListener('click', deleteMessage);

    // Close modal on overlay click
    document.getElementById('message-modal').addEventListener('click', (e) => {
        if (e.target.id === 'message-modal') closeMessageModal();
    });

    // Paste modal
    document.getElementById('paste-modal-close').addEventListener('click', closePasteModal);
    document.getElementById('paste-modal-cancel').addEventListener('click', closePasteModal);
    document.getElementById('paste-modal-import').addEventListener('click', importPastedJson);

    document.getElementById('paste-modal').addEventListener('click', (e) => {
        if (e.target.id === 'paste-modal') closePasteModal();
    });

    // Initial render for messages
    renderMessagesList();
}

// ============================================
// THEME
// ============================================
function setTheme(theme) {
    currentTheme = theme;
    document.documentElement.setAttribute('data-theme', theme);
    document.getElementById('theme-toggle').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}

function toggleTheme() {
    setTheme(currentTheme === 'dark' ? 'light' : 'dark');
}

// ============================================
// TAB SWITCHING
// ============================================
function switchTab(tabId) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabId);
    });

    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.toggle('active', panel.id === `${tabId}-panel`);
    });

    // Re-render content when switching tabs to ensure fresh data
    requestAnimationFrame(() => {
        if (tabId === 'messages') {
            renderMessagesList();
        } else if (tabId === 'aggregator' && students.length > 0) {
            filterAndRenderStudents();
            renderClassSummary();
        }
    });
}

// ============================================
// PARSE EMAILS
// ============================================
function parseEmails() {
    const input = document.getElementById('email-input').value.trim();

    if (!input) {
        showToast('Please paste email content first', 'warning');
        return;
    }

    // Find all JSON blocks wrapped in ```json ... ```
    const jsonPattern = /```json\s*([\s\S]*?)```/gi;
    const matches = [...input.matchAll(jsonPattern)];

    if (matches.length === 0) {
        showToast('No JSON data blocks found. Look for content wrapped in ```json ... ```', 'error');
        document.getElementById('parse-status').textContent = 'No valid JSON blocks found';
        return;
    }

    let parsed = 0;
    let errors = 0;
    const newStudents = [];

    matches.forEach((match, index) => {
        try {
            const jsonStr = match[1].trim();
            const data = JSON.parse(jsonStr);

            // Validate it has the expected structure
            if (data.student && data.metrics) {
                // Get normalized student name for comparison
                const newStudentName = typeof data.student === 'string' ? data.student : data.student?.name;

                // Check if student already exists (by name + topic)
                const existingIndex = students.findIndex(s => {
                    const existingName = typeof s.student === 'string' ? s.student : s.student?.name;
                    return existingName === newStudentName && s.topic?.name === data.topic?.name;
                });

                if (existingIndex >= 0) {
                    // Update existing (keep most recent)
                    const existingDate = new Date(students[existingIndex].generatedAt);
                    const newDate = new Date(data.generatedAt);
                    if (newDate > existingDate) {
                        students[existingIndex] = data;
                    }
                } else {
                    newStudents.push(data);
                }
                parsed++;
            } else {
                console.warn('JSON block missing expected structure:', data);
                errors++;
            }
        } catch (e) {
            console.error('Failed to parse JSON block:', e);
            errors++;
        }
    });

    // Add new students
    students = [...students, ...newStudents];

    // Update status
    const statusMsg = `Parsed ${parsed} report(s)${errors > 0 ? `, ${errors} error(s)` : ''}`;
    document.getElementById('parse-status').textContent = statusMsg;

    if (parsed > 0) {
        showToast(`Successfully parsed ${parsed} student report(s)`, 'success');
        // Use requestAnimationFrame to ensure DOM updates are applied
        requestAnimationFrame(() => {
            updateTopicFilter();
            filterAndRenderStudents();
            renderClassSummary();
            document.getElementById('results-section').style.display = 'block';
            document.getElementById('empty-state').style.display = 'none';
        });
    } else {
        showToast('No valid student reports found', 'error');
    }
}

// ============================================
// FILTER AND SORT
// ============================================
function filterAndRenderStudents() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const topicFilter = document.getElementById('topic-filter').value;
    const sortOption = document.getElementById('sort-select').value;

    // Filter
    filteredStudents = students.filter(s => {
        const studentInfo = getStudentInfo(s);
        const matchesSearch = !searchTerm ||
            studentInfo.name?.toLowerCase().includes(searchTerm) ||
            studentInfo.class?.toLowerCase().includes(searchTerm);

        const matchesTopic = !topicFilter || s.topic?.name === topicFilter;

        return matchesSearch && matchesTopic;
    });

    // Sort
    filteredStudents.sort((a, b) => {
        const aStudent = getStudentInfo(a);
        const bStudent = getStudentInfo(b);
        switch (sortOption) {
            case 'name-asc':
                return (aStudent.name || '').localeCompare(bStudent.name || '');
            case 'name-desc':
                return (bStudent.name || '').localeCompare(aStudent.name || '');
            case 'progress-desc':
                return (b.metrics?.overallPercent || 0) - (a.metrics?.overallPercent || 0);
            case 'progress-asc':
                return (a.metrics?.overallPercent || 0) - (b.metrics?.overallPercent || 0);
            case 'date-desc':
                return new Date(b.generatedAt || 0) - new Date(a.generatedAt || 0);
            default:
                return 0;
        }
    });

    renderStudentsGrid();
}

function updateTopicFilter() {
    const topics = [...new Set(students.map(s => s.topic?.name).filter(Boolean))];
    const select = document.getElementById('topic-filter');
    select.innerHTML = '<option value="">All Topics</option>' +
        topics.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
}

// ============================================
// RENDER CLASS SUMMARY
// ============================================
function renderClassSummary() {
    if (students.length === 0) return;

    // Calculate averages
    const avgProgress = students.reduce((sum, s) => sum + (s.metrics?.overallPercent || 0), 0) / students.length;
    const totalSecured = students.reduce((sum, s) => sum + (s.metrics?.securedItems || 0), 0);
    const totalItems = students.reduce((sum, s) => sum + (s.metrics?.totalItems || 0), 0);
    const avgStreak = students.reduce((sum, s) => sum + (s.metrics?.currentStreak || 0), 0) / students.length;
    const avgQuizRate = students.reduce((sum, s) => sum + (s.metrics?.quizCorrectRate || 0), 0) / students.length;

    // Count by progress level
    const atRisk = students.filter(s => (s.metrics?.overallPercent || 0) < 25).length;
    const onTrack = students.filter(s => {
        const p = s.metrics?.overallPercent || 0;
        return p >= 25 && p < 75;
    }).length;
    const excelling = students.filter(s => (s.metrics?.overallPercent || 0) >= 75).length;

    document.getElementById('class-stats-grid').innerHTML = `
        <div class="class-stat">
            <div class="class-stat-value">${students.length}</div>
            <div class="class-stat-label">Students</div>
        </div>
        <div class="class-stat">
            <div class="class-stat-value">${Math.round(avgProgress)}%</div>
            <div class="class-stat-label">Avg Progress</div>
        </div>
        <div class="class-stat">
            <div class="class-stat-value">${totalSecured}/${totalItems}</div>
            <div class="class-stat-label">Items Secured</div>
        </div>
        <div class="class-stat">
            <div class="class-stat-value">${avgStreak.toFixed(1)}</div>
            <div class="class-stat-label">Avg Streak</div>
        </div>
        <div class="class-stat">
            <div class="class-stat-value">${Math.round(avgQuizRate)}%</div>
            <div class="class-stat-label">Avg Quiz Rate</div>
        </div>
        <div class="class-stat" style="background: rgba(239, 68, 68, 0.1);">
            <div class="class-stat-value" style="color: var(--color-error);">${atRisk}</div>
            <div class="class-stat-label">At Risk (&lt;25%)</div>
        </div>
        <div class="class-stat" style="background: rgba(234, 179, 8, 0.1);">
            <div class="class-stat-value" style="color: var(--color-warning);">${onTrack}</div>
            <div class="class-stat-label">On Track (25-75%)</div>
        </div>
        <div class="class-stat" style="background: rgba(34, 197, 94, 0.1);">
            <div class="class-stat-value" style="color: var(--color-success);">${excelling}</div>
            <div class="class-stat-label">Excelling (&gt;75%)</div>
        </div>
    `;
}

// ============================================
// RENDER STUDENTS GRID
// ============================================
function renderStudentsGrid() {
    const grid = document.getElementById('students-grid');

    if (filteredStudents.length === 0) {
        grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
                <div class="empty-state-icon">üîç</div>
                <h3 class="empty-state-title">No Matching Students</h3>
                <p class="empty-state-text">Try adjusting your search or filters.</p>
            </div>
        `;
        return;
    }

    grid.innerHTML = filteredStudents.map(s => renderStudentCard(s)).join('');
}

function renderStudentCard(data) {
    const student = getStudentInfo(data);
    const metrics = data.metrics || {};
    const topic = data.topic || {};
    const qualities = data.qualities || {};
    const levelDist = data.levelDistribution || {};
    const narrative = data.narrative || '';

    const progress = metrics.overallPercent || 0;
    const initials = getInitials(student.name);

    // Progress badge color
    let badgeColor = 'var(--color-error)';
    let badgeBg = 'rgba(239, 68, 68, 0.1)';
    if (progress >= 75) {
        badgeColor = 'var(--color-success)';
        badgeBg = 'rgba(34, 197, 94, 0.1)';
    } else if (progress >= 25) {
        badgeColor = 'var(--color-warning)';
        badgeBg = 'rgba(234, 179, 8, 0.1)';
    }

    // Level distribution segments
    const total = (levelDist.level1 || 0) + (levelDist.level2 || 0) + (levelDist.level3 || 0) +
                  (levelDist.level4 || 0) + (levelDist.level5 || 0);
    const levelSegments = total > 0 ? `
        <div class="level-distribution">
            ${levelDist.level5 ? `<div class="level-segment level-5" style="flex: ${levelDist.level5};" title="Secured: ${levelDist.level5}"></div>` : ''}
            ${levelDist.level4 ? `<div class="level-segment level-4" style="flex: ${levelDist.level4};" title="Confident: ${levelDist.level4}"></div>` : ''}
            ${levelDist.level3 ? `<div class="level-segment level-3" style="flex: ${levelDist.level3};" title="Developing: ${levelDist.level3}"></div>` : ''}
            ${levelDist.level2 ? `<div class="level-segment level-2" style="flex: ${levelDist.level2};" title="Beginning: ${levelDist.level2}"></div>` : ''}
            ${levelDist.level1 ? `<div class="level-segment level-1" style="flex: ${levelDist.level1};" title="Not Started: ${levelDist.level1}"></div>` : ''}
        </div>
    ` : '';

    // Qualities
    const qualitiesHtml = Object.keys(qualities).length > 0 ? `
        <div class="qualities-grid">
            ${Object.entries(qualities).map(([key, value]) => `
                <div class="quality-item">
                    <span style="width: 70px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${formatQualityName(key)}</span>
                    <div class="quality-bar-container">
                        <div class="quality-bar ${key}" style="width: ${value}%;"></div>
                    </div>
                    <span class="quality-value">${value}%</span>
                </div>
            `).join('')}
        </div>
    ` : '';

    return `
        <div class="student-card">
            <div class="student-card-header">
                <div class="student-info">
                    <div class="student-avatar">${initials}</div>
                    <div>
                        <div class="student-name">${escapeHtml(student.name || 'Unknown')}</div>
                        <div class="student-class">${escapeHtml(student.class || '')}</div>
                    </div>
                </div>
                <div class="student-progress-badge" style="background: ${badgeBg}; color: ${badgeColor};">
                    ${progress}%
                </div>
            </div>
            <div class="student-card-body">
                <div class="student-topic">
                    <span>üìö</span>
                    <strong>${escapeHtml(topic.name || 'Unknown Topic')}</strong>
                    <span style="color: var(--color-text-faint);">‚Ä¢</span>
                    <span>${escapeHtml(topic.subject || '')} ${escapeHtml(topic.yearLevel || '')}</span>
                </div>

                <div class="progress-section">
                    <div class="progress-header">
                        <span class="progress-label">Overall Progress</span>
                        <span class="progress-value">${metrics.securedItems || 0}/${metrics.totalItems || 0} secured</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%;"></div>
                    </div>
                </div>

                ${levelSegments}

                <div class="level-legend">
                    <div class="level-legend-item"><span class="level-dot level-5"></span> Secured (${levelDist.level5 || 0})</div>
                    <div class="level-legend-item"><span class="level-dot level-4"></span> Confident (${levelDist.level4 || 0})</div>
                    <div class="level-legend-item"><span class="level-dot level-3"></span> Developing (${levelDist.level3 || 0})</div>
                    <div class="level-legend-item"><span class="level-dot level-2"></span> Beginning (${levelDist.level2 || 0})</div>
                    <div class="level-legend-item"><span class="level-dot level-1"></span> Not Started (${levelDist.level1 || 0})</div>
                </div>

                ${narrative ? `
                    <div class="learning-character">
                        <div class="character-title">Learning Character</div>
                        <div class="character-narrative">"${escapeHtml(narrative)}"</div>
                        ${qualitiesHtml}
                    </div>
                ` : ''}

                <div class="metrics-row">
                    <div class="metric-item">
                        <span>üî•</span>
                        <strong>${metrics.currentStreak || 0}</strong> day streak
                    </div>
                    <div class="metric-item">
                        <span>‚úÖ</span>
                        <strong>${metrics.checkinsCompleted || 0}</strong> check-ins
                    </div>
                    <div class="metric-item">
                        <span>üìù</span>
                        <strong>${metrics.quizCorrectRate || 0}%</strong> quiz rate
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ============================================
// EXPORT
// ============================================
function exportSummary() {
    if (students.length === 0) {
        showToast('No data to export', 'warning');
        return;
    }

    // Build summary text
    let summary = `CLASS PROGRESS SUMMARY
Generated: ${new Date().toLocaleString()}
Total Students: ${students.length}

${'‚ïê'.repeat(60)}
CLASS OVERVIEW
${'‚ïê'.repeat(60)}

`;

    // Calculate class stats
    const avgProgress = students.reduce((sum, s) => sum + (s.metrics?.overallPercent || 0), 0) / students.length;
    summary += `Average Progress: ${Math.round(avgProgress)}%\n`;
    summary += `At Risk (<25%): ${students.filter(s => (s.metrics?.overallPercent || 0) < 25).length} students\n`;
    summary += `On Track (25-75%): ${students.filter(s => { const p = s.metrics?.overallPercent || 0; return p >= 25 && p < 75; }).length} students\n`;
    summary += `Excelling (>75%): ${students.filter(s => (s.metrics?.overallPercent || 0) >= 75).length} students\n`;

    summary += `\n${'‚ïê'.repeat(60)}\nINDIVIDUAL STUDENTS\n${'‚ïê'.repeat(60)}\n\n`;

    // Sort by name for export
    const sorted = [...students].sort((a, b) => {
        const aInfo = getStudentInfo(a);
        const bInfo = getStudentInfo(b);
        return (aInfo.name || '').localeCompare(bInfo.name || '');
    });

    sorted.forEach(s => {
        const studentInfo = getStudentInfo(s);
        summary += `${'‚îÄ'.repeat(40)}\n`;
        summary += `${studentInfo.name || 'Unknown'} (${studentInfo.class || 'No class'})\n`;
        summary += `Topic: ${s.topic?.name || 'Unknown'}\n`;
        summary += `Progress: ${s.metrics?.overallPercent || 0}% (${s.metrics?.securedItems || 0}/${s.metrics?.totalItems || 0} secured)\n`;
        summary += `Streak: ${s.metrics?.currentStreak || 0} days | Check-ins: ${s.metrics?.checkinsCompleted || 0} | Quiz: ${s.metrics?.quizCorrectRate || 0}%\n`;

        if (s.narrative) {
            summary += `\nLearning Character:\n"${s.narrative}"\n`;
        }

        if (s.qualities) {
            summary += `\nQualities:\n`;
            Object.entries(s.qualities).forEach(([key, value]) => {
                summary += `  ${formatQualityName(key)}: ${value}%\n`;
            });
        }

        summary += '\n';
    });

    // Download
    const blob = new Blob([summary], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `class-summary-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showToast('Summary exported', 'success');
}

// ============================================
// RESET
// ============================================
function resetAll() {
    if (students.length > 0 && !confirm('Clear all student data?')) return;

    students = [];
    filteredStudents = [];
    document.getElementById('email-input').value = '';
    document.getElementById('parse-status').textContent = '';
    document.getElementById('search-input').value = '';
    document.getElementById('topic-filter').innerHTML = '<option value="">All Topics</option>';
    document.getElementById('sort-select').value = 'name-asc';
    document.getElementById('results-section').style.display = 'none';
    document.getElementById('empty-state').style.display = 'block';

    showToast('All data cleared', 'info');
}

// ============================================
// UTILITIES
// ============================================
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;

    const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è' };

    toast.innerHTML = `
        <span>${icons[type] || icons.info}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
    `;

    container.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getInitials(name) {
    if (!name) return '?';
    const parts = name.trim().split(/\s+/);
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
}

// Normalize student field - can be string or object
function getStudentInfo(data) {
    if (typeof data.student === 'string') {
        return { name: data.student, class: '' };
    }
    return data.student || { name: '', class: '' };
}

function formatQualityName(key) {
    const names = {
        foundation: 'Foundation',
        momentum: 'Momentum',
        steadiness: 'Steadiness',
        engagedCuriosity: 'Curiosity',
        persistence: 'Persistence',
        learningHabits: 'Habits'
    };
    return names[key] || key;
}

function getQualityLabel(quality, value) {
    const thresholds = QUALITY_LABELS[quality];
    if (!thresholds) return '';

    for (const [threshold, label] of thresholds) {
        if (value <= threshold) return label;
    }
    return thresholds[thresholds.length - 1][1];
}

// ============================================
// MESSAGE MANAGER FUNCTIONS
// ============================================

function handleMessagesFileLoad(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const data = JSON.parse(event.target.result);
            if (Array.isArray(data)) {
                messages = data;
                // Use requestAnimationFrame to ensure DOM updates are applied
                requestAnimationFrame(() => {
                    renderMessagesList();
                    document.getElementById('messages-load-status').textContent = `Loaded ${messages.length} messages from ${file.name}`;
                    showToast(`Loaded ${messages.length} messages`, 'success');
                });
            } else {
                throw new Error('Invalid format - expected array');
            }
        } catch (err) {
            showToast('Failed to parse JSON: ' + err.message, 'error');
            document.getElementById('messages-load-status').textContent = 'Error loading file';
        }
    };
    reader.readAsText(file);
    e.target.value = ''; // Reset input
}

function openPasteModal() {
    document.getElementById('paste-json-input').value = '';
    document.getElementById('paste-modal').classList.add('active');
}

function closePasteModal() {
    document.getElementById('paste-modal').classList.remove('active');
}

function importPastedJson() {
    const input = document.getElementById('paste-json-input').value.trim();
    if (!input) {
        showToast('Please paste JSON content', 'warning');
        return;
    }

    try {
        const data = JSON.parse(input);
        if (Array.isArray(data)) {
            messages = data;
            closePasteModal();
            // Use requestAnimationFrame to ensure DOM updates are applied after modal closes
            requestAnimationFrame(() => {
                renderMessagesList();
                document.getElementById('messages-load-status').textContent = `Imported ${messages.length} messages`;
                showToast(`Imported ${messages.length} messages`, 'success');
            });
        } else {
            throw new Error('Invalid format - expected array');
        }
    } catch (err) {
        showToast('Invalid JSON: ' + err.message, 'error');
    }
}

function exportMessagesFile() {
    if (messages.length === 0) {
        showToast('No messages to export', 'warning');
        return;
    }

    const json = JSON.stringify(messages, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'message.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showToast('message.json downloaded', 'success');
}

function copyMessagesJson() {
    if (messages.length === 0) {
        showToast('No messages to copy', 'warning');
        return;
    }

    const json = JSON.stringify(messages, null, 2);
    navigator.clipboard.writeText(json).then(() => {
        showToast('JSON copied to clipboard', 'success');
    }).catch(() => {
        showToast('Failed to copy', 'error');
    });
}

function renderMessagesList() {
    const typeFilter = document.getElementById('messages-type-filter').value;
    const statusFilter = document.getElementById('messages-status-filter').value;

    // Filter messages
    let filtered = messages.filter(msg => {
        const matchesType = !typeFilter || msg.type === typeFilter;
        const matchesStatus = !statusFilter ||
            (statusFilter === 'active' && msg.active !== false) ||
            (statusFilter === 'inactive' && msg.active === false);
        return matchesType && matchesStatus;
    });

    // Sort by ID descending (newest first)
    filtered.sort((a, b) => (b.id || 0) - (a.id || 0));

    // Update count
    document.getElementById('messages-count').textContent = `${filtered.length} message${filtered.length !== 1 ? 's' : ''}`;

    // Show/hide empty state
    const emptyState = document.getElementById('messages-empty-state');
    const list = document.getElementById('messages-list');

    if (messages.length === 0) {
        emptyState.style.display = 'block';
        list.innerHTML = '';
        return;
    }

    emptyState.style.display = 'none';

    if (filtered.length === 0) {
        list.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <h3 class="empty-state-title">No Matching Messages</h3>
                <p class="empty-state-text">Try adjusting your filters.</p>
            </div>
        `;
        return;
    }

    list.innerHTML = filtered.map(msg => renderMessageCard(msg)).join('');

    // Add click handlers for edit buttons
    list.querySelectorAll('.edit-message-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Keep ID as original type (could be string or number)
            let id = btn.dataset.id;
            // Try to convert to number if it looks like one
            if (!isNaN(id) && id !== '') {
                id = Number(id);
            }
            openMessageModal(id);
        });
    });
}

function renderMessageCard(msg) {
    const typeIcons = {
        seasonal: 'üåü',
        update: 'üîî',
        alert: '‚ö†Ô∏è',
        tip: 'üí°',
        general: 'üìå'
    };

    const typeLabels = {
        seasonal: 'Seasonal',
        update: 'Update',
        alert: 'Alert',
        tip: 'Tip',
        general: 'General'
    };

    const audienceLabels = {
        all: 'All Students',
        year7: 'Year 7',
        year8: 'Year 8',
        year9: 'Year 9',
        year10: 'Year 10',
        year11: 'Year 11',
        year12: 'Year 12'
    };

    const isActive = msg.active !== false;
    const icon = typeIcons[msg.type] || 'üìå';
    const typeLabel = typeLabels[msg.type] || msg.type;

    // Date display
    let dateDisplay = '';
    if (msg.date) {
        dateDisplay = formatDate(msg.date);
    }
    if (msg.startDate || msg.endDate) {
        const start = msg.startDate ? formatDate(msg.startDate) : 'Any';
        const end = msg.endDate ? formatDate(msg.endDate) : 'Ongoing';
        dateDisplay = `${start} ‚Üí ${end}`;
    }

    return `
        <div class="message-card ${isActive ? '' : 'inactive'}">
            <div class="message-card-header">
                <div class="message-header-left">
                    <div class="message-type-icon ${msg.type || 'general'}">${icon}</div>
                    <div class="message-title-section">
                        <div class="message-title">${escapeHtml(msg.title || 'Untitled')}</div>
                        <div class="message-meta">
                            ${dateDisplay ? `<span class="message-meta-item">üìÖ ${dateDisplay}</span>` : ''}
                            <span class="message-meta-item">üÜî ID: ${msg.id || 'N/A'}</span>
                        </div>
                    </div>
                </div>
                <div class="message-badges">
                    <span class="message-badge ${isActive ? 'active' : 'inactive'}">${isActive ? 'Active' : 'Inactive'}</span>
                    <span class="message-badge type">${typeLabel}</span>
                </div>
            </div>
            <div class="message-card-body">
                <div class="message-content">${escapeHtml(msg.content || '')}</div>
                ${msg.directive ? `
                    <div style="margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px dashed var(--color-border);">
                        <span style="font-size: var(--text-xs); color: var(--color-text-muted);">üìù Teacher Note:</span>
                        <span style="font-size: var(--text-sm); color: var(--color-text-muted); font-style: italic;"> ${escapeHtml(msg.directive)}</span>
                    </div>
                ` : ''}
            </div>
            <div class="message-card-footer">
                <div class="message-audience">
                    <span>üë•</span>
                    <span>${audienceLabels[msg.audience] || 'All Students'}</span>
                </div>
                <div class="message-actions">
                    <button class="btn btn-secondary btn-small edit-message-btn" data-id="${msg.id}">
                        <span class="btn-icon">‚úèÔ∏è</span>
                        Edit
                    </button>
                </div>
            </div>
        </div>
    `;
}

function openMessageModal(messageId = null) {
    editingMessageId = messageId;
    const modal = document.getElementById('message-modal');
    const title = document.getElementById('modal-title');
    const deleteBtn = document.getElementById('modal-delete');

    // Reset form
    document.getElementById('message-form').reset();

    if (messageId !== null) {
        // Editing existing message - use loose equality to match string/number IDs
        const msg = messages.find(m => m.id == messageId);
        if (!msg) {
            console.error('Message not found. Looking for ID:', messageId, 'Available IDs:', messages.map(m => m.id));
            showToast('Message not found', 'error');
            return;
        }
        // Store the actual ID from the message for later use
        editingMessageId = msg.id;

        title.textContent = 'Edit Message';
        deleteBtn.style.display = 'inline-flex';

        // Populate form
        document.getElementById('msg-id').value = msg.id;
        document.getElementById('msg-type').value = msg.type || 'general';
        document.getElementById('msg-active').checked = msg.active !== false;
        document.getElementById('msg-title').value = msg.title || '';
        document.getElementById('msg-content').value = msg.content || '';
        document.getElementById('msg-start-date').value = msg.startDate || '';
        document.getElementById('msg-end-date').value = msg.endDate || '';
        document.getElementById('msg-audience').value = msg.audience || 'all';
        document.getElementById('msg-directive').value = msg.directive || '';
    } else {
        // Adding new message
        title.textContent = 'Add Message';
        deleteBtn.style.display = 'none';

        // Set default values
        document.getElementById('msg-type').value = 'general';
        document.getElementById('msg-active').checked = true;
        document.getElementById('msg-audience').value = 'all';
    }

    modal.classList.add('active');
}

function closeMessageModal() {
    document.getElementById('message-modal').classList.remove('active');
    editingMessageId = null;
}

function saveMessage() {
    const form = document.getElementById('message-form');

    // Validate required fields
    const title = document.getElementById('msg-title').value.trim();
    const content = document.getElementById('msg-content').value.trim();

    if (!title || !content) {
        showToast('Title and content are required', 'warning');
        return;
    }

    const messageData = {
        id: editingMessageId !== null ? editingMessageId : getNextMessageId(),
        type: document.getElementById('msg-type').value,
        title: title,
        content: content,
        active: document.getElementById('msg-active').checked,
        audience: document.getElementById('msg-audience').value,
        date: new Date().toISOString().split('T')[0] // Today's date
    };

    // Add optional fields
    const startDate = document.getElementById('msg-start-date').value;
    const endDate = document.getElementById('msg-end-date').value;
    const directive = document.getElementById('msg-directive').value.trim();

    if (startDate) messageData.startDate = startDate;
    if (endDate) messageData.endDate = endDate;
    if (directive) messageData.directive = directive;

    if (editingMessageId !== null) {
        // Update existing - use loose equality for ID comparison
        const index = messages.findIndex(m => m.id == editingMessageId);
        if (index >= 0) {
            messages[index] = messageData;
            showToast('Message updated', 'success');
        }
    } else {
        // Add new
        messages.push(messageData);
        showToast('Message added', 'success');
    }

    closeMessageModal();
    // Use requestAnimationFrame to ensure DOM updates after modal animation
    requestAnimationFrame(() => renderMessagesList());
}

function deleteMessage() {
    if (editingMessageId === null) return;

    if (!confirm('Are you sure you want to delete this message?')) return;

    // Use loose equality for ID comparison
    messages = messages.filter(m => m.id != editingMessageId);
    showToast('Message deleted', 'info');
    closeMessageModal();
    // Use requestAnimationFrame to ensure DOM updates after modal animation
    requestAnimationFrame(() => renderMessagesList());
}

function getNextMessageId() {
    if (messages.length === 0) return 1;
    return Math.max(...messages.map(m => m.id || 0)) + 1;
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-AU', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
        });
    } catch {
        return dateStr;
    }
}

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
