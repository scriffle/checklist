<!DOCTYPE html>
<html lang="en" data-theme="light" data-version="2.0.0">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Dynamic Learning Check List - Track your understanding and growth through structured check-ins">
    <title>Dynamic Learning Check List</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
/* ============================================
   CSS VARIABLES
   ============================================ */
:root {
    /* Primary palette - Growth/Nature themed */
    --color-primary: #2d9d78;
    --color-primary-dark: #1e7d5e;
    --color-primary-light: #4db896;
    --color-primary-pale: #e8f5f0;
    
    /* Secondary - Warm accent */
    --color-secondary: #f59e0b;
    --color-secondary-dark: #d97706;
    --color-secondary-light: #fbbf24;
    
    /* Understanding levels */
    --level-1: #94a3b8;  /* Not started - Neutral grey */
    --level-2: #06b6d4;  /* Beginning - Cyan blue */
    --level-3: #eab308;  /* Developing - Yellow */
    --level-4: #22c55e;  /* Confident - Green */
    --level-5: #8b5cf6;  /* Mastered - Purple star */
    
    /* Understanding levels - Light/pale backgrounds */
    --level-1-light: #f1f5f9;
    --level-2-light: #ecfeff;
    --level-3-light: #fefce8;
    --level-4-light: #f0fdf4;
    --level-5-light: #faf5ff;
    
    /* Backgrounds */
    --color-bg: #fafdf9;
    --color-bg-warm: #f0f7f4;
    --color-bg-card: #ffffff;
    --color-bg-hover: #e8f0ed;
    --color-bg-active: #d4e5de;
    
    /* Text */
    --color-text: #1e3a32;
    --color-text-secondary: #4a6358;
    --color-text-muted: #7a9088;
    --color-text-inverse: #ffffff;
    
    /* Borders */
    --color-border: #d4e5de;
    --color-border-light: #e8f0ed;
    --color-border-focus: var(--color-primary);
    
    /* Status colors */
    --color-success: #22c55e;
    --color-success-bg: #dcfce7;
    --color-warning: #f59e0b;
    --color-warning-bg: #fef3c7;
    --color-info: #3b82f6;
    --color-info-bg: #dbeafe;
    --color-error: #ef4444;
    --color-error-bg: #fee2e2;
    
    /* Spacing - Compact */
    --space-1: 0.125rem;
    --space-2: 0.25rem;
    --space-3: 0.375rem;
    --space-4: 0.5rem;
    --space-5: 0.75rem;
    --space-6: 1rem;
    --space-7: 1.25rem;
    --space-8: 1.5rem;
    --space-9: 2rem;
    --space-10: 2.5rem;
    
    /* Typography */
    --font-display: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    --text-xs: 0.75rem;
    --text-sm: 0.85rem;
    --text-base: 0.95rem;
    --text-lg: 1.05rem;
    --text-xl: 1.2rem;
    --text-2xl: 1.4rem;
    --text-3xl: 1.75rem;
    --line-height-tight: 1.25;
    --line-height-normal: 1.5;
    --line-height-relaxed: 1.65;
    
    /* Effects */
    --shadow-sm: 0 1px 2px rgba(30, 58, 50, 0.04);
    --shadow-md: 0 4px 8px rgba(30, 58, 50, 0.06), 0 2px 4px rgba(30, 58, 50, 0.04);
    --shadow-lg: 0 12px 24px rgba(30, 58, 50, 0.1), 0 4px 8px rgba(30, 58, 50, 0.05);
    --shadow-focus: 0 0 0 3px rgba(45, 157, 120, 0.25);
    
    /* Borders */
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 14px;
    --radius-xl: 20px;
    --radius-full: 9999px;
    
    /* Transitions */
    --transition-fast: 0.15s ease;
    --transition-normal: 0.25s ease;
    --transition-slow: 0.4s ease;
    --transition-bounce: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* Dark Mode */
[data-theme="dark"] {
    --color-primary: #4db896;
    --color-primary-dark: #2d9d78;
    --color-primary-light: #6fcfaa;
    --color-primary-pale: #1a2f28;
    
    --color-bg: #0f1714;
    --color-bg-warm: #162420;
    --color-bg-card: #1c2d27;
    --color-bg-hover: #243832;
    --color-bg-active: #2d453d;
    
    --color-text: #e8f5f0;
    --color-text-secondary: #a8c4ba;
    --color-text-muted: #6b8f82;
    
    --color-border: #2d453d;
    --color-border-light: #243832;
    
    --color-success-bg: #14301e;
    --color-warning-bg: #302814;
    --color-info-bg: #142030;
    --color-error-bg: #301414;
    
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
    --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.25), 0 2px 4px rgba(0, 0, 0, 0.15);
    --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.3), 0 4px 8px rgba(0, 0, 0, 0.2);
    
    --level-5: #a78bfa;
    --level-5-light: #2d2640;
}

/* Dark mode purple glow */
[data-theme="dark"] .level-notch[data-level="5"],
[data-theme="dark"] .level-segment[data-level="5"],
[data-theme="dark"] .level-was-value[data-level="5"],
[data-theme="dark"] [style*="var(--level-5)"] {
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.3), 0 0 2px rgba(255, 255, 255, 0.2);
}

[data-theme="dark"] .level-notch.active[data-level="5"] {
    box-shadow: 0 0 8px rgba(167, 139, 250, 0.4), 0 0 2px rgba(255, 255, 255, 0.2);
}

/* ============================================
   RESET & BASE
   ============================================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { 
    font-size: 16px; 
    scroll-behavior: smooth;
    height: 100%;
}

@media (prefers-reduced-motion: reduce) {
    html { scroll-behavior: auto; }
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

body {
    font-family: var(--font-body);
    font-size: var(--text-base);
    line-height: var(--line-height-normal);
    color: var(--color-text);
    background: var(--color-bg);
    min-height: 100vh;
    min-height: 100dvh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* ============================================
   ACCESSIBILITY
   ============================================ */
.skip-link {
    position: absolute;
    top: -100%;
    left: var(--space-4);
    padding: var(--space-3) var(--space-5);
    background: var(--color-primary);
    color: var(--color-text-inverse);
    border-radius: var(--radius-md);
    text-decoration: none;
    font-weight: 600;
    z-index: 10000;
    transition: top var(--transition-fast);
}
.skip-link:focus { top: var(--space-4); outline: none; }

:focus-visible {
    outline: 2px solid var(--color-border-focus);
    outline-offset: 2px;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* ============================================
   APP LAYOUT
   ============================================ */
.app-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    min-height: 100dvh;
}

/* ============================================
   HEADER
   ============================================ */
.app-header {
    background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 50%, #3aa882 100%);
    color: var(--color-text-inverse);
    padding: var(--space-3) var(--space-4);
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-md);
}

.header-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.app-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 800;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.app-title-icon {
    font-size: 1.2rem;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-2px); }
}

.header-actions {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.header-btn {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--color-text-inverse);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: var(--text-xs);
    font-weight: 600;
    font-family: var(--font-body);
    transition: all var(--transition-fast);
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
}

.header-btn:hover { background: rgba(255, 255, 255, 0.25); }
.header-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.student-info {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    background: rgba(255, 255, 255, 0.1);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
}

.student-avatar {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-base);
}

/* ============================================
   TOPIC SELECTOR BAR
   ============================================ */
.topic-selector-bar {
    background: var(--color-bg-warm);
    border-bottom: 1px solid var(--color-border);
    padding: var(--space-2) var(--space-4);
}

.topic-selector-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.topic-selector-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.topic-selector-dropdowns {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
    flex: 1;
}

.topic-dropdown {
    padding: var(--space-2) var(--space-3);
    padding-right: var(--space-5);
    font-size: var(--text-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    cursor: pointer;
    min-width: 80px;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    transition: width 0.15s ease;
}

/* Hidden element for measuring dropdown text width */
.dropdown-measure {
    position: absolute;
    visibility: hidden;
    height: auto;
    width: auto;
    white-space: nowrap;
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    font-family: inherit;
    pointer-events: none;
}

.topic-dropdown:hover {
    border-color: var(--color-primary);
}

.topic-dropdown:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px var(--color-primary-pale);
}

.topic-dropdown:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: var(--color-bg-warm);
}

.topic-dropdown option.unavailable {
    color: var(--color-text-muted);
    font-style: italic;
}

.topic-dropdown option:disabled {
    color: var(--color-text-muted);
    background-color: var(--color-bg-warm);
}

.topic-refresh-btn {
    padding: var(--space-1) var(--space-2);
    font-size: var(--text-xs);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-bg-card);
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all 0.15s ease;
}

.topic-refresh-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
    background: var(--color-primary-pale);
}

.topic-refresh-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.topic-refresh-btn.refreshing {
    pointer-events: none;
}

.topic-refresh-btn.refreshing::after {
    content: '...';
    animation: ellipsis 1s infinite;
}

@keyframes ellipsis {
    0% { content: '.'; }
    33% { content: '..'; }
    66% { content: '...'; }
}

.topic-dropdown-separator {
    color: var(--color-text-muted);
    font-size: var(--text-sm);
}

.topic-current-display {
    margin-left: auto;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.topic-current-name {
    font-weight: 600;
    color: var(--color-text);
}

.topic-loading-indicator {
    display: none;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.topic-loading-indicator.active {
    display: flex;
}

.topic-loading-spinner {
    width: 14px;
    height: 14px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ============================================
   SUB NAVIGATION (TABS)
   ============================================ */
.sub-nav {
    background: var(--color-bg-card);
    border-bottom: 1px solid var(--color-border);
    padding: 0 var(--space-4);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.sub-nav::-webkit-scrollbar { display: none; }

.sub-nav-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    gap: var(--space-1);
}

.nav-tab {
    background: transparent;
    border: none;
    padding: var(--space-2) var(--space-3);
    font-family: var(--font-display);
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-muted);
    cursor: pointer;
    position: relative;
    transition: color var(--transition-fast);
    white-space: nowrap;
    min-height: 36px;
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.nav-tab:hover { color: var(--color-text); }

.nav-tab[aria-selected="true"] { color: var(--color-primary); }

.nav-tab[aria-selected="true"]::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: var(--space-1);
    right: var(--space-1);
    height: 2px;
    background: var(--color-primary);
    border-radius: 2px 2px 0 0;
}

.nav-tab-icon { font-size: 1em; }

.nav-tab-badge {
    background: var(--color-primary);
    color: white;
    font-size: 10px;
    padding: 0 5px;
    border-radius: var(--radius-full);
    font-weight: 700;
}

/* ============================================
   MAIN CONTENT AREA
   ============================================ */
.main-content {
    flex: 1;
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    padding: var(--space-3);
}

/* Panel Content */
.panel-content {
    display: none;
    animation: fadeSlideIn var(--transition-normal);
}

.panel-content.active { display: block; }

@keyframes fadeSlideIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ============================================
   CARDS
   ============================================ */
.card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin-bottom: var(--space-3);
    box-shadow: var(--shadow-sm);
    transition: box-shadow var(--transition-fast);
}

.card:hover { box-shadow: var(--shadow-md); }

.card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-3);
    gap: var(--space-2);
    flex-wrap: wrap;
}

.card-title {
    font-family: var(--font-display);
    font-size: var(--text-base);
    font-weight: 700;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.card-title-icon { font-size: 1.1em; }

.card-subtitle {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-1);
}

/* ============================================
   PROGRESS OVERVIEW CARD
   ============================================ */
.progress-overview {
    background: linear-gradient(135deg, var(--color-primary-pale) 0%, var(--color-bg-warm) 100%);
    border: 1px solid var(--color-primary);
    border-left: 4px solid var(--color-primary);
}

.progress-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--space-3);
    margin-top: var(--space-3);
}

.progress-stat {
    background: var(--color-bg-card);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    text-align: center;
    border: 1px solid var(--color-border-light);
}

.progress-stat-value {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    font-weight: 800;
    color: var(--color-primary);
    line-height: 1;
}

.progress-stat-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-2);
    font-weight: 500;
}

.progress-bar-container {
    margin-top: var(--space-4);
}

.progress-bar-label {
    display: flex;
    justify-content: space-between;
    font-size: var(--text-sm);
    margin-bottom: var(--space-2);
}

.progress-bar {
    height: 12px;
    background: var(--color-bg-card);
    border-radius: var(--radius-full);
    overflow: hidden;
    border: 1px solid var(--color-border-light);
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-primary-light));
    border-radius: var(--radius-full);
    transition: width 0.5s ease-out;
}

/* ============================================
   LEVEL LEGEND
   ============================================ */
.level-legend {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
}

.level-legend-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-text-secondary);
}

.level-legend-dot {
    width: 12px;
    height: 12px;
    border-radius: var(--radius-sm);
}

.level-legend-dot[data-level="1"] { background: var(--level-1); }
.level-legend-dot[data-level="2"] { background: var(--level-2); }
.level-legend-dot[data-level="3"] { background: var(--level-3); }
.level-legend-dot[data-level="4"] { background: var(--level-4); }
.level-legend-dot[data-level="5"] { background: var(--level-5); }

/* ============================================
   TOPIC SECTIONS (SUBTOPICS)
   ============================================ */
.topic-section {
    margin-bottom: var(--space-3);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--color-bg-card);
}

.topic-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3) var(--space-4);
    background: var(--color-bg-warm);
    cursor: pointer;
    gap: var(--space-3);
    transition: background var(--transition-fast);
}

.topic-header:hover {
    background: var(--color-bg-hover);
}

.topic-header-left {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex: 1;
    min-width: 0;
}

.topic-icon {
    font-size: 1.3rem;
    flex-shrink: 0;
}

.topic-info {
    min-width: 0;
}

.topic-title {
    font-family: var(--font-display);
    font-size: var(--text-base);
    font-weight: 700;
    color: var(--color-text);
}

.topic-meta {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-1);
}

.topic-progress {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-shrink: 0;
}

.topic-progress-bar {
    width: 80px;
    height: 6px;
    background: var(--color-border);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.topic-progress-fill {
    height: 100%;
    background: var(--color-primary);
    border-radius: var(--radius-full);
    transition: width 0.3s ease;
}

.topic-progress-text {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-primary);
    min-width: 35px;
    text-align: right;
}

.topic-toggle {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    transition: transform var(--transition-fast);
}

.topic-header[aria-expanded="true"] .topic-toggle {
    transform: rotate(180deg);
}

.topic-content {
    display: none;
    padding: var(--space-3);
    border-top: 1px solid var(--color-border-light);
}

.topic-content.expanded {
    display: block;
}

/* Subtopic Explanation */
.subtopic-explanation-wrapper {
    margin-bottom: var(--space-3);
}

.subtopic-explanation-toggle {
    width: 100%;
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    transition: all var(--transition-fast);
}

.subtopic-explanation-toggle:hover {
    background: var(--color-bg-hover);
    border-color: var(--color-primary);
}

.explanation-toggle-icon {
    font-size: var(--text-xs);
    transition: transform var(--transition-fast);
}

.explanation-toggle[aria-expanded="true"] .explanation-toggle-icon {
    transform: rotate(180deg);
}

.explanation-content {
    display: none;
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-top: none;
    border-radius: 0 0 var(--radius-md) var(--radius-md);
}

.explanation-content.expanded {
    display: block;
}

.explanation-section {
    margin-bottom: var(--space-3);
}

.explanation-section:last-child {
    margin-bottom: 0;
}

.explanation-heading {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-1);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.explanation-heading-icon {
    font-size: 1em;
}

.explanation-text {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
}

/* ============================================
   LEARNING ITEMS
   ============================================ */
.learning-item-simple {
    position: relative;
    padding: var(--space-3);
    border-left: 4px solid var(--level-1);
    background: var(--color-bg-card);
    margin-bottom: var(--space-2);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    transition: all var(--transition-fast);
}

.learning-item-simple:last-child {
    margin-bottom: 0;
}

.learning-item-simple:hover {
    background: var(--color-bg-hover);
}

.learning-item-simple[data-level="1"] { border-left-color: var(--level-1); }
.learning-item-simple[data-level="2"] { border-left-color: var(--level-2); }
.learning-item-simple[data-level="3"] { border-left-color: var(--level-3); }
.learning-item-simple[data-level="4"] { border-left-color: var(--level-4); }
.learning-item-simple[data-level="5"] { border-left-color: var(--level-5); }

.learning-item-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.learning-item-left {
    flex: 1;
    min-width: 200px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-2);
}

.learning-item-title {
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text);
    flex: 1 1 100%;
}

.learning-item-code {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    background: var(--color-bg-warm);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-family: var(--font-body);
}

.learning-item-updated {
    font-size: 10px;
    color: var(--color-text-muted);
}

.learning-item-right {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-shrink: 0;
}

/* No quiz badge */
.no-quiz-badge {
    font-size: 10px;
    color: var(--color-text-muted);
    background: var(--color-bg-warm);
    padding: 2px 6px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    gap: 3px;
}

/* Help toggle inline */
.help-toggle-inline {
    font-size: var(--text-xs);
    color: var(--color-secondary);
    background: var(--color-warning-bg);
    border: 1px solid transparent;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    transition: all var(--transition-fast);
}

.help-toggle-inline:hover {
    background: var(--color-secondary);
    color: white;
}

.help-toggle-inline[aria-expanded="true"] {
    background: var(--color-secondary);
    color: white;
}

/* Help content inline */
.help-content-inline {
    display: none;
    margin-top: var(--space-3);
    padding: var(--space-3);
    background: var(--color-warning-bg);
    border-radius: var(--radius-md);
    border: 1px solid rgba(245, 158, 11, 0.2);
}

.help-content-inline.expanded {
    display: block;
}

.help-inline-item {
    display: block;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
    line-height: var(--line-height-relaxed);
}

.help-inline-item:last-child {
    margin-bottom: 0;
}

.help-inline-item strong {
    color: var(--color-text);
}

/* ============================================
   LEVEL NOTCHES (5-LEVEL SELECTOR)
   ============================================ */
.level-notches {
    display: flex;
    gap: 3px;
    padding: 2px;
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
}

.level-notch {
    width: 28px;
    height: 28px;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-card);
    opacity: 0.4;
    transition: all var(--transition-fast);
    position: relative;
}

.level-notch:hover {
    opacity: 0.7;
    transform: scale(1.1);
}

.level-notch.filled {
    opacity: 0.7;
}

.level-notch.active {
    opacity: 1;
    transform: scale(1.15);
    box-shadow: var(--shadow-md);
}

.level-notch.locked {
    cursor: not-allowed;
    opacity: 0.3;
}

.level-notch.locked::after {
    content: 'ðŸ”’';
    position: absolute;
    font-size: 8px;
    bottom: -2px;
    right: -2px;
}

.level-notch[data-level="1"] { background: var(--level-1-light); }
.level-notch[data-level="2"] { background: var(--level-2-light); }
.level-notch[data-level="3"] { background: var(--level-3-light); }
.level-notch[data-level="4"] { background: var(--level-4-light); }
.level-notch[data-level="5"] { background: var(--level-5-light); }

.level-notch.filled[data-level="1"],
.level-notch.active[data-level="1"] { background: var(--level-1); color: white; }
.level-notch.filled[data-level="2"],
.level-notch.active[data-level="2"] { background: var(--level-2); color: white; }
.level-notch.filled[data-level="3"],
.level-notch.active[data-level="3"] { background: var(--level-3); color: white; }
.level-notch.filled[data-level="4"],
.level-notch.active[data-level="4"] { background: var(--level-4); color: white; }
.level-notch.filled[data-level="5"],
.level-notch.active[data-level="5"] { background: var(--level-5); color: white; }

/* Notch content elements for different display modes */
.notch-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
}

.notch-emoji {
    font-size: 12px;
    margin-left: 2px;
}

.level-notch .notch-dot {
    border: 1px solid rgba(255,255,255,0.3);
}

.level-notch:not(.filled):not(.active) .notch-dot {
    opacity: 0.5;
}

/* Check-in mode level controls */
.level-controls-checkin {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.level-was {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.level-was-value {
    font-weight: 600;
}

.level-was-value[data-level="1"] { color: var(--level-1); }
.level-was-value[data-level="2"] { color: var(--level-2); }
.level-was-value[data-level="3"] { color: var(--level-3); }
.level-was-value[data-level="4"] { color: var(--level-4); }
.level-was-value[data-level="5"] { color: var(--level-5); }

/* ============================================
   BUTTONS
   ============================================ */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: 600;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    border: 1px solid transparent;
    text-decoration: none;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-primary {
    background: var(--color-primary);
    color: var(--color-text-inverse);
    border-color: var(--color-primary);
}

.btn-primary:hover:not(:disabled) {
    background: var(--color-primary-dark);
    border-color: var(--color-primary-dark);
}

.btn-secondary {
    background: var(--color-bg-card);
    color: var(--color-text);
    border-color: var(--color-border);
}

.btn-secondary:hover:not(:disabled) {
    background: var(--color-bg-hover);
    border-color: var(--color-primary);
}

.btn-sm {
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
}

.btn-lg {
    padding: var(--space-3) var(--space-5);
    font-size: var(--text-base);
}

/* ============================================
   FORMS
   ============================================ */
.form-group {
    margin-bottom: var(--space-4);
}

.form-label {
    display: block;
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-2);
}

.form-input,
.form-textarea {
    width: 100%;
    padding: var(--space-2) var(--space-3);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.form-input:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px var(--color-primary-pale);
}

.form-textarea {
    resize: vertical;
    min-height: 80px;
}

.notes-input-group {
    display: flex;
    gap: var(--space-2);
    align-items: flex-start;
}

.notes-input-group .form-textarea {
    flex: 1;
}

/* ============================================
   EMPTY STATE
   ============================================ */
.empty-state {
    text-align: center;
    padding: var(--space-6);
    color: var(--color-text-muted);
}

.empty-state-icon {
    font-size: 2.5rem;
    margin-bottom: var(--space-3);
    opacity: 0.5;
}

.empty-state-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
}

.empty-state-desc {
    font-size: var(--text-sm);
    max-width: 300px;
    margin: 0 auto;
}

/* ============================================
   TOAST NOTIFICATIONS
   ============================================ */
.toast-container {
    position: fixed;
    bottom: var(--space-4);
    right: var(--space-4);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.toast {
    padding: var(--space-3) var(--space-4);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    font-size: var(--text-sm);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    animation: toastIn 0.3s ease-out;
    max-width: 300px;
}

.toast.success { border-left: 3px solid var(--color-success); }
.toast.error { border-left: 3px solid var(--color-error); }
.toast.info { border-left: 3px solid var(--color-info); }
.toast.warning { border-left: 3px solid var(--color-warning); }

.toast.selection-tip-toast {
    max-width: 380px;
    background: linear-gradient(135deg, var(--color-bg-card) 0%, var(--color-primary-pale) 100%);
    border-left: 3px solid var(--color-primary);
}

@keyframes toastIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
}

.toast-exit {
    animation: toastOut 0.2s ease-in forwards;
}

@keyframes toastOut {
    to { opacity: 0; transform: translateX(20px); }
}

/* ============================================
   QUIZ OVERLAY & MODAL
   ============================================ */
.quiz-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 500;
    display: none;
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
    backdrop-filter: blur(2px);
}

.quiz-overlay.active {
    display: flex;
}

.quiz-modal {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    animation: modalIn 0.3s ease-out;
}

@keyframes modalIn {
    from { opacity: 0; transform: scale(0.95) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

.quiz-header {
    padding: var(--space-4);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.quiz-header-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.quiz-close-btn {
    background: none;
    border: none;
    font-size: var(--text-xl);
    cursor: pointer;
    color: var(--color-text-muted);
    padding: var(--space-1);
    line-height: 1;
}

.quiz-close-btn:hover {
    color: var(--color-text);
}

.quiz-body {
    padding: var(--space-4);
}

.quiz-context {
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-4);
}

.quiz-item-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-2);
}

.quiz-level-transition {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

.quiz-level-arrow {
    color: var(--color-primary);
}

.quiz-question {
    margin-bottom: var(--space-4);
}

.quiz-question-text {
    font-size: var(--text-base);
    font-weight: 500;
    color: var(--color-text);
    line-height: var(--line-height-relaxed);
}

/* Quiz options for MC */
.quiz-options {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
}

.quiz-option {
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg-card);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    text-align: left;
    transition: all var(--transition-fast);
    font-family: var(--font-body);
    font-size: var(--text-sm);
}

.quiz-option:hover:not(:disabled) {
    border-color: var(--color-primary);
    background: var(--color-bg-hover);
}

.quiz-option.selected {
    border-color: var(--color-primary);
    background: var(--color-primary-pale);
}

.quiz-option.correct {
    border-color: var(--color-success);
    background: var(--color-success-bg);
}

.quiz-option.incorrect {
    border-color: var(--color-error);
    background: var(--color-error-bg);
}

.quiz-option:disabled {
    cursor: default;
}

.quiz-option-marker {
    width: 24px;
    height: 24px;
    border-radius: var(--radius-sm);
    background: var(--color-bg-warm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: var(--text-xs);
    flex-shrink: 0;
}

.quiz-option.selected .quiz-option-marker {
    background: var(--color-primary);
    color: white;
}

.quiz-option.correct .quiz-option-marker {
    background: var(--color-success);
    color: white;
}

.quiz-option.incorrect .quiz-option-marker {
    background: var(--color-error);
    color: white;
}

.quiz-option-text {
    flex: 1;
    line-height: var(--line-height-normal);
}

/* Quiz result feedback */
.quiz-result {
    display: none;
    padding: var(--space-3);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
}

.quiz-result.visible {
    display: block;
}

.quiz-result.correct {
    background: var(--color-success-bg);
    border: 1px solid var(--color-success);
}

.quiz-result.incorrect {
    background: var(--color-error-bg);
    border: 1px solid var(--color-error);
}

.quiz-result-header {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
}

.quiz-result-icon {
    font-size: var(--text-lg);
    font-weight: 700;
}

.quiz-result.correct .quiz-result-icon { color: var(--color-success); }
.quiz-result.incorrect .quiz-result-icon { color: var(--color-error); }

.quiz-result-text {
    font-weight: 600;
    font-size: var(--text-sm);
}

.quiz-result.correct .quiz-result-text { color: var(--color-success); }
.quiz-result.incorrect .quiz-result-text { color: var(--color-error); }

.quiz-result-explanation {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
    white-space: pre-wrap;
}

/* Quiz streak info */
.quiz-streak-info {
    background: var(--color-info-bg);
    border: 1px solid var(--color-info);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-4);
    text-align: center;
}

.quiz-streak-text {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
}

.quiz-streak-progress {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
}

.quiz-streak-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--color-border);
    transition: all var(--transition-fast);
}

.quiz-streak-dot.filled {
    background: var(--color-success);
    transform: scale(1.2);
}

/* Quiz footer */
.quiz-footer {
    padding: var(--space-4);
    border-top: 1px solid var(--color-border);
    display: flex;
    justify-content: flex-end;
    gap: var(--space-2);
}
/* ============================================
   CLOZE QUESTION STYLES
   ============================================ */
.cloze-sentence {
    font-size: var(--text-base);
    line-height: 2;
    color: var(--color-text);
    margin-bottom: var(--space-4);
}

.cloze-blank {
    display: inline-block;
    vertical-align: middle;
}

.cloze-select {
    padding: var(--space-1) var(--space-3);
    padding-right: var(--space-5);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    min-width: 120px;
    transition: all var(--transition-fast);
}

.cloze-select:hover {
    border-color: var(--color-primary);
}

.cloze-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px var(--color-primary-pale);
}

.cloze-select.answered {
    background-color: var(--color-primary-pale);
    border-color: var(--color-primary);
}

.cloze-select.correct {
    background-color: var(--color-success-bg);
    border-color: var(--color-success);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%2322c55e' stroke-width='3'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
}

.cloze-select.incorrect {
    background-color: var(--color-error-bg);
    border-color: var(--color-error);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23ef4444' stroke-width='3'%3E%3Cline x1='18' y1='6' x2='6' y2='18'%3E%3C/line%3E%3Cline x1='6' y1='6' x2='18' y2='18'%3E%3C/line%3E%3C/svg%3E");
}

.cloze-select:disabled {
    cursor: default;
    opacity: 1;
}

/* Cloze feedback per blank */
.cloze-feedback {
    margin-top: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
}

.cloze-feedback-item {
    margin-bottom: var(--space-2);
    padding-left: var(--space-3);
    border-left: 3px solid var(--color-border);
}

.cloze-feedback-item:last-child {
    margin-bottom: 0;
}

.cloze-feedback-item.correct {
    border-left-color: var(--color-success);
}

.cloze-feedback-item.incorrect {
    border-left-color: var(--color-error);
}

.cloze-feedback-label {
    font-weight: 600;
    margin-bottom: var(--space-1);
}

.cloze-feedback-correct {
    color: var(--color-success);
}

.cloze-feedback-text {
    color: var(--color-text-secondary);
}

/* ============================================
   CHECK-IN MODE STYLES
   ============================================ */
.checkin-mode-active {
    position: relative;
    border: 3px solid var(--color-primary);
    border-radius: var(--radius-lg);
    animation: checkinBorderPulse 1.5s ease-in-out infinite;
}

.checkin-mode-active::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(45, 157, 120, 0.12);
    border-radius: var(--radius-lg);
    pointer-events: none;
    animation: checkinPulse 1.5s ease-in-out infinite;
    z-index: 0;
}

@keyframes checkinPulse {
    0%, 100% { background: rgba(45, 157, 120, 0.08); }
    50% { background: rgba(45, 157, 120, 0.18); }
}

@keyframes checkinBorderPulse {
    0%, 100% { 
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0 rgba(45, 157, 120, 0.4);
    }
    50% { 
        border-color: #1a7a5a;
        box-shadow: 0 0 20px 5px rgba(45, 157, 120, 0.3);
    }
}

.checkin-mode-active > * {
    position: relative;
    z-index: 1;
}

/* Check-in Mode Banner */
.checkin-mode-banner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background: linear-gradient(135deg, var(--color-primary), #228b6b);
    color: white;
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.checkin-mode-info {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.checkin-mode-type {
    font-weight: 600;
    font-size: var(--text-sm);
}

.checkin-mode-progress {
    font-size: var(--text-xs);
    opacity: 0.9;
}

.checkin-stop-btn {
    padding: var(--space-2) var(--space-3);
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-md);
    color: white;
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.checkin-stop-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Floating Check-in Status Bar */
.checkin-floating-bar {
    position: fixed;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) var(--space-4);
    background: linear-gradient(135deg, var(--color-primary), #1a7a5a);
    color: white;
    border-radius: var(--radius-full);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    animation: floatIn 0.3s ease-out, floatingPulse 2s ease-in-out infinite;
}

.checkin-floating-bar.active {
    display: flex;
}

@keyframes floatIn {
    from { opacity: 0; transform: translateX(-50%) translateY(20px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

@keyframes floatingPulse {
    0%, 100% { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); }
    50% { box-shadow: 0 4px 30px rgba(45, 157, 120, 0.5); }
}

.checkin-floating-icon {
    font-size: 1rem;
    animation: iconPulse 1s ease-in-out infinite;
}

@keyframes iconPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

.checkin-floating-text {
    font-weight: 600;
    font-size: 11px;
}

.checkin-floating-progress {
    font-size: 10px;
    opacity: 0.9;
}

.checkin-floating-timer {
    font-size: 10px;
    background: rgba(255, 255, 255, 0.2);
    padding: 2px 6px;
    border-radius: var(--radius-full);
}

.checkin-floating-stop {
    padding: var(--space-1) var(--space-3);
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-full);
    color: white;
    font-size: var(--text-xs);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.checkin-floating-stop:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Item reviewed indicator */
.learning-item-simple.reviewed {
    background: rgba(45, 157, 120, 0.05);
}

.learning-item-simple.reviewed::after {
    content: 'âœ“';
    position: absolute;
    top: var(--space-2);
    right: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-primary);
    opacity: 0.7;
}

/* ============================================
   DASHBOARD CARDS
   ============================================ */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-4);
}

.checkin-card {
    background: linear-gradient(135deg, var(--color-primary-pale), var(--color-bg-warm));
    border: 1px solid var(--color-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    text-align: center;
}

.checkin-icon {
    font-size: 2rem;
    margin-bottom: var(--space-3);
}

.checkin-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: var(--space-2);
}

.checkin-desc {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-4);
}

.stat-card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
}

.stat-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-3);
}

.stat-card-title {
    font-family: var(--font-display);
    font-size: var(--text-base);
    font-weight: 700;
    color: var(--color-text);
}

.stat-card-icon {
    font-size: 1.2rem;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--color-border-light);
}

.stat-row:last-child {
    border-bottom: none;
}

.stat-label {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

.stat-value {
    font-weight: 600;
    color: var(--color-text);
}

/* Goal items */
.goal-item {
    padding: var(--space-3);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-left: 4px solid var(--color-primary);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    margin-bottom: var(--space-2);
}

.goal-item:last-child {
    margin-bottom: 0;
}

.goal-text {
    font-size: var(--text-sm);
    color: var(--color-text);
    margin-bottom: var(--space-1);
}

.goal-meta {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.focus-area-link {
    cursor: pointer;
    transition: background var(--transition-fast);
}

.focus-area-link:hover {
    background: var(--color-bg-hover);
}

/* ============================================
   HISTORY / PROGRESS VISUALIZATION
   ============================================ */
.overall-progress {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-3);
}

.overall-progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
}

.overall-progress-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
}

.overall-progress-percent {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-primary);
}

.overall-progress-bar {
    height: 12px;
    background: var(--color-bg-warm);
    border-radius: var(--radius-full);
    overflow: hidden;
    margin-bottom: var(--space-2);
}

.overall-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-primary-light));
    border-radius: var(--radius-full);
    transition: width 0.5s ease-out;
}

.overall-progress-stats {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
}

.overall-stat {
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.overall-stat-value {
    font-weight: 600;
    color: var(--color-text);
}

/* Level Distribution */
.level-distribution {
    display: flex;
    height: 20px;
    border-radius: var(--radius-sm);
    overflow: hidden;
    background: var(--color-bg-warm);
    margin-bottom: var(--space-1);
}

.level-segment {
    height: 100%;
    transition: width 0.4s ease-out;
    position: relative;
    min-width: 0;
}

.level-segment[data-level="1"] { background: var(--level-1); }
.level-segment[data-level="2"] { background: var(--level-2); }
.level-segment[data-level="3"] { background: var(--level-3); }
.level-segment[data-level="4"] { background: var(--level-4); }
.level-segment[data-level="5"] { background: var(--level-5); }

.level-segment:hover {
    filter: brightness(1.1);
}

/* Subtopic Progress Cards */
.subtopic-progress {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: var(--space-2) var(--space-3);
    margin-bottom: var(--space-2);
}

.subtopic-progress:last-child {
    margin-bottom: 0;
}

.subtopic-progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
}

.subtopic-progress-name {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.subtopic-progress-change {
    font-size: 10px;
}

.level-distribution-legend {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    font-size: 9px;
    color: var(--color-text-muted);
}

/* ============================================
   CHECK-IN TYPE BUTTONS
   ============================================ */
.checkin-type-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    gap: var(--space-2);
    margin-bottom: var(--space-3);
}

.checkin-type-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-3);
    background: var(--color-bg-card);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-align: center;
}

.checkin-type-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-bg-hover);
}

.checkin-type-btn.active {
    border-color: var(--color-primary);
    background: rgba(45, 157, 120, 0.1);
}

.checkin-type-icon {
    font-size: 1.2rem;
}

.checkin-type-name {
    font-weight: 600;
    font-size: var(--text-xs);
    color: var(--color-text);
}

.checkin-type-desc {
    font-size: 10px;
    color: var(--color-text-muted);
    line-height: 1.2;
}

/* ============================================
   SETTINGS
   ============================================ */
.settings-section {
    margin-bottom: var(--space-6);
}

.settings-section:last-child { margin-bottom: 0; }

.settings-section-title {
    font-size: var(--text-xs);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    margin-bottom: var(--space-3);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--color-border-light);
}

.settings-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--color-border-light);
}

.settings-row:last-child {
    border-bottom: none;
}

.settings-label {
    font-size: var(--text-sm);
    color: var(--color-text);
}

/* Utility help card */
.utility-help-card {
    margin-bottom: var(--space-4);
    background: linear-gradient(135deg, var(--color-bg-card) 0%, var(--color-primary-pale) 100%);
    border: 1px solid var(--color-primary);
    border-left: 4px solid var(--color-primary);
}

.utility-help-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
    padding: var(--space-4);
    flex-wrap: wrap;
}

.utility-help-text {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.utility-help-icon {
    font-size: 28px;
}

.utility-help-text strong {
    display: block;
    font-size: var(--text-base);
    color: var(--color-text);
    margin-bottom: 2px;
}

.utility-help-text span {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

/* Inline confirmation dialogs for data management */
.data-action-item {
    margin-bottom: var(--space-3);
}

.data-action-item:last-child {
    margin-bottom: 0;
}

.data-action-confirm {
    display: none;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    margin-top: var(--space-2);
    animation: confirmSlideIn 0.2s ease;
}

@keyframes confirmSlideIn {
    from {
        opacity: 0;
        transform: translateY(-8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.data-action-item.confirming .data-action-main {
    display: none;
}

.data-action-item.confirming .data-action-confirm {
    display: flex;
}

.confirm-message {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

.confirm-message.confirm-danger {
    color: var(--color-error);
    font-weight: 500;
}

.confirm-buttons {
    display: flex;
    gap: var(--space-2);
    flex-shrink: 0;
}

.btn-small {
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
}

.btn-ghost {
    background: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-text-secondary);
}

.btn-ghost:hover {
    background: var(--color-bg-hover);
    border-color: var(--color-text-muted);
}

.btn-danger {
    background: var(--color-error);
    border: 1px solid var(--color-error);
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
    border-color: #dc2626;
}

/* Toggle switch */
.toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: var(--color-border);
    border-radius: var(--radius-full);
    transition: all var(--transition-fast);
}

.toggle-slider::before {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    left: 3px;
    bottom: 3px;
    background: white;
    border-radius: 50%;
    transition: all var(--transition-fast);
}

.toggle-switch input:checked + .toggle-slider {
    background: var(--color-primary);
}

.toggle-switch input:checked + .toggle-slider::before {
    transform: translateX(20px);
}

/* Level customization settings */
.level-display-options {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
}

.level-display-option {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-3);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    cursor: pointer;
    font-size: var(--text-sm);
    transition: all 0.15s ease;
}

.level-display-option:hover {
    border-color: var(--color-primary);
}

.level-display-option.active {
    border-color: var(--color-primary);
    background: var(--color-primary-pale);
}

.level-display-option input {
    display: none;
}

.emoji-progression-select {
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    cursor: pointer;
    min-width: 200px;
}

.emoji-progression-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px var(--color-primary-pale);
}

.level-colors-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: var(--space-3);
    margin-top: var(--space-2);
}

.level-color-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-1);
}

.level-color-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-align: center;
}

.level-color-picker {
    width: 40px;
    height: 40px;
    padding: 0;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    background: transparent;
}

.level-color-picker::-webkit-color-swatch-wrapper {
    padding: 2px;
}

.level-color-picker::-webkit-color-swatch {
    border: none;
    border-radius: var(--radius-sm);
}

.level-color-picker::-moz-color-swatch {
    border: none;
    border-radius: var(--radius-sm);
}

.level-color-picker:hover {
    border-color: var(--color-primary);
}

.level-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    margin-top: var(--space-3);
}

.level-preview-item {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--text-sm);
}

.level-preview-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.level-preview-emoji {
    font-size: var(--text-base);
}

.settings-subsection {
    margin-top: var(--space-4);
    padding-top: var(--space-3);
    border-top: 1px dashed var(--color-border-light);
}

.settings-subsection-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
}

.reset-colors-btn {
    margin-top: var(--space-3);
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-xs);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all 0.15s ease;
}

.reset-colors-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
}

@media (max-width: 600px) {
    .level-colors-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .level-preview {
        flex-wrap: wrap;
    }
}

/* ============================================
   STATUS BAR (FOOTER)
   ============================================ */
.status-bar {
    background: var(--color-bg-card);
    border-top: 1px solid var(--color-border);
    padding: var(--space-2) var(--space-5);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 50;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.status-indicator::before {
    content: '';
    width: 8px;
    height: 8px;
    background: var(--color-success);
    border-radius: var(--radius-full);
}

/* ============================================
   TEXT SELECTION POPUP
   ============================================ */
.selection-popup {
    position: absolute;
    z-index: 1000;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    padding: var(--space-1);
    display: none;
    flex-direction: column;
    gap: 2px;
    min-width: 180px;
    animation: popupFadeIn 0.15s ease-out;
}

@keyframes popupFadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
}

.selection-popup-btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    color: var(--color-text);
    cursor: pointer;
    text-align: left;
    transition: background var(--transition-fast);
}

.selection-popup-btn:hover {
    background: var(--color-bg-hover);
}

.selection-popup-btn .popup-icon {
    font-size: 14px;
    width: 20px;
    text-align: center;
}

.selection-popup-btn .popup-label {
    flex: 1;
}

.selection-popup-btn.teacher { color: var(--color-primary); }
.selection-popup-btn.google { color: #4285f4; }
.selection-popup-btn.chatgpt { color: #10a37f; }

.selection-popup-btn.teacher:hover { background: var(--color-primary-pale); }
.selection-popup-btn.google:hover { background: rgba(66, 133, 244, 0.1); }
.selection-popup-btn.chatgpt:hover { background: rgba(16, 163, 127, 0.1); }

/* ============================================
   LOADING STATE
   ============================================ */
.loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: var(--space-3);
}

[data-theme="dark"] .loading-overlay {
    background: rgba(15, 23, 20, 0.9);
}

.loading-overlay.active {
    display: flex;
}

.loading-spinner-large {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

.loading-text {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

/* ============================================
   WELCOME DIALOG
   ============================================ */
.welcome-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: var(--space-4);
    backdrop-filter: blur(4px);
}

.welcome-overlay.active {
    display: flex;
}

.welcome-dialog {
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    max-width: 540px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    animation: welcomeSlideIn 0.3s ease;
}

@keyframes welcomeSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.welcome-header {
    padding: var(--space-6) var(--space-6) var(--space-4);
    text-align: center;
    border-bottom: 1px solid var(--color-border-light);
}

.welcome-icon {
    font-size: 48px;
    display: block;
    margin-bottom: var(--space-3);
}

.welcome-title {
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-text);
    margin: 0;
}

.welcome-body {
    padding: var(--space-5) var(--space-6);
}

.welcome-intro {
    font-size: var(--text-base);
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin: 0 0 var(--space-5);
}

.welcome-features {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.welcome-feature {
    display: flex;
    gap: var(--space-3);
    align-items: flex-start;
}

.welcome-feature-icon {
    font-size: 24px;
    flex-shrink: 0;
    width: 32px;
    text-align: center;
}

.welcome-feature-text {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.welcome-feature-text strong {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
}

.welcome-feature-text span {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.5;
}

.welcome-user-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-5);
}

.welcome-form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
}

.welcome-form-label {
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text);
}

.welcome-form-input {
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-base);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
}

.welcome-form-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-pale);
}

.welcome-form-input::placeholder {
    color: var(--color-text-muted);
}

.welcome-footer-text {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin: var(--space-5) 0 0;
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border-light);
    text-align: center;
}

.welcome-footer {
    padding: var(--space-4) var(--space-6) var(--space-6);
    display: flex;
    justify-content: space-between;
    gap: var(--space-3);
}

.welcome-footer .btn {
    min-width: 120px;
}

.welcome-start-btn {
    min-width: 160px;
    padding: var(--space-3) var(--space-6);
    font-size: var(--text-base);
}

/* Welcome pages */
.welcome-page {
    display: none;
}

.welcome-page.active {
    display: block;
}

/* Tutorial steps */
.tutorial-steps {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.tutorial-step {
    display: flex;
    gap: var(--space-3);
    align-items: flex-start;
}

.tutorial-step-number {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--color-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-sm);
    font-weight: 700;
    flex-shrink: 0;
}

.tutorial-step-content {
    flex: 1;
}

.tutorial-step-content strong {
    display: block;
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-1);
}

.tutorial-step-content p {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.5;
    margin: 0;
}

.tutorial-demo {
    display: flex;
    gap: var(--space-2);
    margin-top: var(--space-2);
    padding: var(--space-2);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    justify-content: center;
}

.tutorial-demo-level {
    font-size: 18px;
    padding: var(--space-1);
}

/* ============================================
   MOBILE RESPONSIVE
   ============================================ */
@media (max-width: 768px) {
    .header-content { flex-wrap: wrap; }
    .app-title { font-size: var(--text-xl); }
    .student-info { display: none; }
    .main-content { padding: var(--space-3); }
    
    .topic-selector-bar {
        padding: var(--space-2);
    }
    
    .topic-selector-content {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-2);
    }
    
    .topic-selector-label {
        display: none;
    }
    
    .topic-selector-dropdowns {
        flex-direction: column;
        gap: var(--space-2);
    }
    
    .topic-dropdown {
        width: 100%;
        min-width: unset;
    }
    
    .topic-dropdown-separator {
        display: none;
    }
    
    .topic-current-display {
        margin-left: 0;
        justify-content: center;
        padding-top: var(--space-2);
        border-top: 1px solid var(--color-border);
    }
    
    .topic-header { flex-wrap: wrap; gap: var(--space-2); }
    .topic-progress { width: 100%; justify-content: flex-end; }
    
    .progress-stats { grid-template-columns: repeat(2, 1fr); }
    
    .dashboard-grid { grid-template-columns: 1fr; }
    
    .learning-item-row {
        flex-direction: column;
        gap: var(--space-2);
    }
    
    .learning-item-right {
        width: 100%;
        justify-content: flex-end;
    }
    
    .quiz-modal {
        max-height: 100vh;
        border-radius: var(--radius-lg);
        margin: var(--space-2);
    }
    
    .checkin-floating-bar {
        left: var(--space-2);
        right: var(--space-2);
        transform: none;
        border-radius: var(--radius-lg);
        justify-content: space-between;
    }
}

/* ============================================
   PRINT STYLES
   ============================================ */
@media print {
    .app-header, .sub-nav, .header-actions, .status-bar,
    .toast-container, .quiz-overlay, .btn, .level-notches,
    .checkin-floating-bar, .selection-popup { 
        display: none !important; 
    }
    
    body { 
        background: white; 
        color: black; 
        font-size: 11pt; 
    }
    
    .main-content { 
        max-width: none; 
        padding: 0; 
    }
    
    .card, .topic-section { 
        break-inside: avoid; 
        border: 1px solid #ccc; 
        box-shadow: none; 
    }
    
    .topic-content, .help-content-inline { 
        display: block !important; 
    }
}
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div class="app-container">
        <!-- Header -->
        <header class="app-header" role="banner">
            <div class="header-content">
                <h1 class="app-title">
                    <span class="app-title-icon">🌱</span>
                    <span>Dynamic Learning Check List</span>
                </h1>
                
                <div class="student-info" id="student-info">
                    <span class="student-avatar">ðŸ‘¤</span>
                    <span id="student-name-display">Student</span>
                </div>
                
                <div class="header-actions">
                    <button class="header-btn" id="new-checkin-btn" title="Start a new check-in">
                        <span>📋</span> Check In
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Topic Selector Bar -->
        <div class="topic-selector-bar">
            <div class="topic-selector-content">
                <span class="topic-selector-label">Topic:</span>
                <div class="topic-selector-dropdowns">
                    <select class="topic-dropdown" id="year-level-dropdown" aria-label="Select year level">
                        <option value="">Select Year Level</option>
                    </select>
                    <span class="topic-dropdown-separator">›</span>
                    <select class="topic-dropdown" id="subject-dropdown" aria-label="Select subject" disabled>
                        <option value="">Select Subject</option>
                    </select>
                    <span class="topic-dropdown-separator">›</span>
                    <select class="topic-dropdown" id="topic-dropdown" aria-label="Select topic" disabled>
                        <option value="">Select Topic</option>
                    </select>
                    <button class="topic-refresh-btn" id="refresh-topics-btn" title="Refresh topic availability" aria-label="Refresh topic availability">↻</button>
                    <span class="dropdown-measure" id="dropdown-measure" aria-hidden="true"></span>
                </div>
                <div class="topic-loading-indicator" id="topic-loading-indicator">
                    <div class="topic-loading-spinner"></div>
                    <span>Loading...</span>
                </div>
                <div class="topic-current-display">
                    <span id="topic-current-name">No topic selected</span>
                </div>
            </div>
        </div>
        
        <!-- Sub Navigation (Tabs) -->
        <nav class="sub-nav" role="tablist" aria-label="Main sections">
            <div class="sub-nav-content">
                <button class="nav-tab" id="overview-tab" role="tab" aria-selected="true" aria-controls="overview-panel">
                    <span class="nav-tab-icon">📊</span> Overview
                </button>
                <button class="nav-tab" id="learning-tab" role="tab" aria-selected="false" aria-controls="learning-panel">
                    <span class="nav-tab-icon">📚</span> Learning Content
                </button>
                <button class="nav-tab" id="history-tab" role="tab" aria-selected="false" aria-controls="history-panel">
                    <span class="nav-tab-icon">📅</span> History
                </button>
                <button class="nav-tab" id="goals-tab" role="tab" aria-selected="false" aria-controls="goals-panel">
                    <span class="nav-tab-icon">🎯</span> Goals
                    <span class="nav-tab-badge" id="goals-badge" style="display: none;">0</span>
                </button>
                <button class="nav-tab" id="export-tab" role="tab" aria-selected="false" aria-controls="export-panel">
                    <span class="nav-tab-icon">⚙️</span> Utility
                </button>
            </div>
        </nav>
        
        <!-- Main Content Area -->
        <main class="main-content" id="main-content">
            
            <!-- Overview Panel -->
            <div class="panel-content active" id="overview-panel" role="tabpanel" aria-labelledby="overview-tab">
                
                <!-- Progress Overview Card -->
                <div class="card progress-overview">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">📈</span>
                            <span id="topic-name-display">Your Progress</span>
                        </h2>
                    </div>
                    
                    <div class="progress-bar-container">
                        <div class="progress-bar-label">
                            <span>Overall Progress</span>
                            <span id="overall-percentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="overall-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="progress-stats" id="progress-stats">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <!-- Level Legend -->
                <div class="level-legend" id="overview-level-legend">
                    <!-- Dynamically populated -->
                </div>
                
                <!-- Quick Actions -->
                <div class="dashboard-grid">
                    <div class="checkin-card" id="next-checkin-card">
                        <div class="checkin-icon">📋</div>
                        <h3 class="checkin-title">Ready for your next check-in?</h3>
                        <p class="checkin-desc">Track your progress by checking in on your understanding</p>
                        <button class="btn btn-primary btn-lg" id="start-checkin-btn">Start Check-in</button>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h3 class="stat-card-title">Quick Stats</h3>
                            <span class="stat-card-icon">📈</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total check-ins</span>
                            <span class="stat-value" id="total-checkins">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Items mastered</span>
                            <span class="stat-value" id="items-mastered">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Last check-in</span>
                            <span class="stat-value" id="last-checkin-date">—</span>
                        </div>
                    </div>
                </div>
                
                <!-- Areas to Focus -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">🎯</span>
                            Focus Areas
                        </h2>
                    </div>
                    <div id="focus-areas">
                        <p class="empty-state-desc">Complete your first check-in to see your focus areas.</p>
                    </div>
                </div>
                
            </div>
            
            <!-- Learning Content Panel -->
            <div class="panel-content" id="learning-panel" role="tabpanel" aria-labelledby="learning-tab">
                
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">
                                <span class="card-title-icon">📚</span>
                                <span id="topic-title">Learning Content</span>
                            </h2>
                            <p class="card-subtitle" id="curriculum-code">Select a topic to begin</p>
                        </div>
                        <div>
                            <button class="btn btn-secondary btn-sm" id="expand-all-btn">Expand All</button>
                            <button class="btn btn-secondary btn-sm" id="collapse-all-btn">Collapse All</button>
                        </div>
                    </div>
                    
                    <!-- Level Legend -->
                    <div class="level-legend" id="learning-level-legend">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <div id="topics-container">
                    <!-- Dynamically populated subtopics and learning items -->
                    <div class="empty-state">
                        <div class="empty-state-icon">📚</div>
                        <div class="empty-state-title">No topic loaded</div>
                        <p class="empty-state-desc">Select a year level, subject, and topic from the dropdowns above to get started.</p>
                    </div>
                </div>
                
            </div>
            
            <!-- History Panel -->
            <div class="panel-content" id="history-panel" role="tabpanel" aria-labelledby="history-tab">
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">📅</span>
                            Check-in History
                        </h2>
                    </div>
                    
                    <div class="checkin-timeline" id="checkin-timeline">
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <div class="empty-state-title">No check-ins yet</div>
                            <p class="empty-state-desc">Start your first check-in to track your learning journey over time.</p>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Goals Panel -->
            <div class="panel-content" id="goals-panel" role="tabpanel" aria-labelledby="goals-tab">
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">🎯</span>
                            My Learning Goals
                        </h2>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="new-goal-input">Add a new goal</label>
                        <div class="notes-input-group">
                            <textarea id="new-goal-input" class="form-textarea" placeholder="What do you want to achieve? (e.g., 'I want to be confident in all plasma membrane concepts by Friday')" rows="2"></textarea>
                            <button class="btn btn-primary" id="add-goal-btn">Add Goal</button>
                        </div>
                    </div>
                    
                    <div id="goals-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">🎯</div>
                            <div class="empty-state-title">No goals set</div>
                            <p class="empty-state-desc">Set goals to help focus your learning!</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">â“</span>
                            Questions for My Teacher
                        </h2>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="new-question-input">Ask a question</label>
                        <div class="notes-input-group">
                            <textarea id="new-question-input" class="form-textarea" placeholder="What would you like to ask your teacher?" rows="2"></textarea>
                            <button class="btn btn-primary" id="add-question-btn">Add Question</button>
                        </div>
                    </div>
                    
                    <div id="questions-list">
                        <div class="empty-state">
                            <p class="empty-state-desc">No questions yet. If you're stuck, ask here!</p>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Export Panel -->
            <div class="panel-content" id="export-panel" role="tabpanel" aria-labelledby="export-tab">
                
                <!-- Help & Guide Section -->
                <div class="card utility-help-card">
                    <div class="utility-help-content">
                        <div class="utility-help-text">
                            <span class="utility-help-icon">📖</span>
                            <div>
                                <strong>Need help?</strong>
                                <span>View the welcome guide and learn how to use this app</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary" id="show-welcome-btn">Show Welcome Guide</button>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h3 class="stat-card-title">Export Your Progress</h3>
                            <span class="stat-card-icon">📤</span>
                        </div>
                        <p style="color: var(--color-text-secondary); font-size: var(--text-sm); margin-bottom: var(--space-4);">
                            Share your learning progress with your teacher or parents.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                            <button class="btn btn-primary" id="export-pdf-btn">📄 Print Report</button>
                            <button class="btn btn-secondary" id="export-json-btn">💾 Backup Data (JSON)</button>
                            <button class="btn btn-secondary" id="email-report-btn">âœ‰ï¸ Email Summary</button>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h3 class="stat-card-title">Data Summary</h3>
                            <span class="stat-card-icon">📊</span>
                        </div>
                        <div id="data-summary">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>
                
                <!-- Settings Section (moved here for simplicity) -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">⚙️</span>
                            Settings
                        </h2>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title">Your Details</div>
                        <div class="form-group">
                            <label class="form-label" for="student-name-input">Your Name</label>
                            <input type="text" id="student-name-input" class="form-input" placeholder="Enter your name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="class-input">Your Classes</label>
                            <input type="text" id="class-input" class="form-input" placeholder="e.g., VCE Biology U3, Year 7 English">
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title">Appearance</div>
                        <div class="settings-row">
                            <span class="settings-label">Dark Mode</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="dark-mode-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title">Level Indicators</div>
                        
                        <!-- Display Mode -->
                        <div class="settings-subsection">
                            <div class="settings-subsection-title">Display Mode</div>
                            <div class="level-display-options">
                                <label class="level-display-option active" data-mode="emoji">
                                    <input type="radio" name="level-display-mode" value="emoji" checked>
                                    <span>🌱 Emoji Only</span>
                                </label>
                                <label class="level-display-option" data-mode="dots">
                                    <input type="radio" name="level-display-mode" value="dots">
                                    <span>â— Dots Only</span>
                                </label>
                                <label class="level-display-option" data-mode="both">
                                    <input type="radio" name="level-display-mode" value="both">
                                    <span>â— 🌱 Both</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Emoji Progression -->
                        <div class="settings-subsection">
                            <div class="settings-subsection-title">Emoji Style</div>
                            <select class="emoji-progression-select" id="emoji-progression-select">
                                <option value="0">🌱 🌿 🌳 🌲 ⭐ Growth</option>
                                <option value="1">📖 ✏️ 📝 📚 ðŸŽ“ Learning</option>
                                <option value="2">○ ◔ â—‘ â—• â— Fill Circles</option>
                                <option value="3">1️⃣ 2️⃣ 3️⃣ 4️⃣ 5️⃣ Numbers</option>
                                <option value="4">🥉 🥈 🥇 ðŸ† ðŸ‘‘ Achievement</option>
                                <option value="5">â„ï¸ 🌧️ ⛅ ☀️ 🌟 Weather</option>
                            </select>
                        </div>
                        
                        <!-- Color Customization -->
                        <div class="settings-subsection">
                            <div class="settings-subsection-title">Level Colors</div>
                            <div class="level-colors-grid">
                                <div class="level-color-item">
                                    <input type="color" class="level-color-picker" id="level-color-1" value="#94a3b8">
                                    <span class="level-color-label">Not Started</span>
                                </div>
                                <div class="level-color-item">
                                    <input type="color" class="level-color-picker" id="level-color-2" value="#06b6d4">
                                    <span class="level-color-label">Beginning</span>
                                </div>
                                <div class="level-color-item">
                                    <input type="color" class="level-color-picker" id="level-color-3" value="#eab308">
                                    <span class="level-color-label">Developing</span>
                                </div>
                                <div class="level-color-item">
                                    <input type="color" class="level-color-picker" id="level-color-4" value="#22c55e">
                                    <span class="level-color-label">Confident</span>
                                </div>
                                <div class="level-color-item">
                                    <input type="color" class="level-color-picker" id="level-color-5" value="#8b5cf6">
                                    <span class="level-color-label">Mastered</span>
                                </div>
                            </div>
                            <button class="reset-colors-btn" id="reset-colors-btn">↺ Reset to Default Colors</button>
                        </div>
                        
                        <!-- Preview -->
                        <div class="settings-subsection">
                            <div class="settings-subsection-title">Preview</div>
                            <div class="level-preview" id="level-preview">
                                <!-- Filled dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-section-title">Data Management</div>
                        
                        <!-- Clear Topic Progress -->
                        <div class="data-action-item" id="clear-topic-action">
                            <div class="data-action-main">
                                <button class="btn btn-secondary" id="clear-progress-btn">Clear Progress for Current Topic</button>
                            </div>
                            <div class="data-action-confirm" id="clear-topic-confirm">
                                <span class="confirm-message">Clear all progress for this topic?</span>
                                <div class="confirm-buttons">
                                    <button class="btn btn-small btn-ghost" id="clear-topic-cancel">Cancel</button>
                                    <button class="btn btn-small btn-danger" id="clear-topic-delete">Delete</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Clear All Data -->
                        <div class="data-action-item" id="clear-all-action">
                            <div class="data-action-main">
                                <button class="btn btn-secondary" id="clear-all-btn" style="color: var(--color-error);">Clear All Data</button>
                            </div>
                            <div class="data-action-confirm" id="clear-all-confirm">
                                <span class="confirm-message confirm-danger">Delete ALL data including progress, goals, and settings?</span>
                                <div class="confirm-buttons">
                                    <button class="btn btn-small btn-ghost" id="clear-all-cancel">Cancel</button>
                                    <button class="btn btn-small btn-danger" id="clear-all-delete">Delete Everything</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            
        </main>
        
        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-indicator">
                <span id="save-status">All changes saved</span>
            </div>
            <div>
                <span id="version-display">v2.0.0</span>
            </div>
        </footer>
        
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Quiz Modal Overlay -->
    <div class="quiz-overlay" id="quiz-overlay">
        <div class="quiz-modal" role="dialog" aria-labelledby="quiz-header-title" aria-modal="true">
            <div class="quiz-header">
                <h2 class="quiz-header-title" id="quiz-header-title">
                    <span>ðŸ”</span> Quick Check
                </h2>
                <button class="quiz-close-btn" id="quiz-cancel-btn" aria-label="Close quiz">×</button>
            </div>
            <div class="quiz-body">
                <div class="quiz-context">
                    <div class="quiz-item-title" id="quiz-item-title">Learning point title</div>
                    <div class="quiz-level-transition">
                        <span id="quiz-from-level">🌱 Not started</span>
                        <span class="quiz-level-arrow">→</span>
                        <span id="quiz-to-level">🌿 Beginning</span>
                    </div>
                </div>
                
                <div class="quiz-streak-info" id="quiz-streak-info" style="display: none;">
                    <div class="quiz-streak-text" id="quiz-streak-text">You need 2 correct answers to advance</div>
                    <div class="quiz-streak-progress" id="quiz-streak-progress">
                        <!-- Filled dynamically -->
                    </div>
                </div>
                
                <div class="quiz-question">
                    <p class="quiz-question-text" id="quiz-question-text">Question text goes here</p>
                </div>
                
                <!-- For MC questions -->
                <div class="quiz-options" id="quiz-options">
                    <!-- Dynamically populated -->
                </div>
                
                <!-- For Cloze questions -->
                <div class="cloze-sentence" id="cloze-sentence" style="display: none;">
                    <!-- Dynamically populated with inline selects -->
                </div>
                
                <div class="quiz-result" id="quiz-result">
                    <div class="quiz-result-header">
                        <span class="quiz-result-icon" id="quiz-result-icon">âœ“</span>
                        <span class="quiz-result-text" id="quiz-result-text">Correct</span>
                    </div>
                    <p class="quiz-result-explanation" id="quiz-result-explanation">Explanation text</p>
                </div>
                
                <!-- Cloze feedback area -->
                <div class="cloze-feedback" id="cloze-feedback" style="display: none;">
                    <!-- Dynamically populated -->
                </div>
            </div>
            <div class="quiz-footer">
                <button class="btn btn-secondary" id="quiz-cancel-btn-footer">Cancel</button>
                <button class="btn btn-primary" id="quiz-submit-btn" disabled>Check Answer</button>
            </div>
        </div>
    </div>
    
    <!-- Check-in Mode Floating Bar -->
    <div class="checkin-floating-bar" id="checkin-floating-bar">
        <span class="checkin-floating-icon">📋</span>
        <span class="checkin-floating-text" id="checkin-floating-type">Check-in Mode</span>
        <span class="checkin-floating-progress" id="checkin-floating-progress">0/0 reviewed</span>
        <span class="checkin-floating-timer" id="checkin-floating-timer">10:00</span>
        <button class="checkin-floating-stop" id="checkin-floating-stop">Stop</button>
    </div>
    
    <!-- Check-in Start Modal -->
    <div class="quiz-overlay" id="checkin-start-overlay">
        <div class="quiz-modal">
            <div class="quiz-header">
                <h2 class="quiz-header-title">
                    <span>📋</span> Start Check-in
                </h2>
                <button class="quiz-close-btn" id="checkin-start-cancel">×</button>
            </div>
            <div class="quiz-body">
                <p style="margin-bottom: var(--space-4); color: var(--color-text-secondary);">
                    Choose the type of check-in you want to do:
                </p>
                
                <div class="checkin-type-grid" id="checkin-type-grid">
                    <button class="checkin-type-btn active" data-type="pre">
                        <span class="checkin-type-icon">🌅</span>
                        <span class="checkin-type-name">Pre-Topic</span>
                        <span class="checkin-type-desc">Before starting a new topic</span>
                    </button>
                    <button class="checkin-type-btn" data-type="weekly">
                        <span class="checkin-type-icon">ðŸ“†</span>
                        <span class="checkin-type-name">Weekly</span>
                        <span class="checkin-type-desc">Regular weekly review</span>
                    </button>
                    <button class="checkin-type-btn" data-type="revision">
                        <span class="checkin-type-icon">📖</span>
                        <span class="checkin-type-name">Revision</span>
                        <span class="checkin-type-desc">Before a test or exam</span>
                    </button>
                    <button class="checkin-type-btn" data-type="post">
                        <span class="checkin-type-icon">âœ…</span>
                        <span class="checkin-type-name">Post-Test</span>
                        <span class="checkin-type-desc">After completing assessment</span>
                    </button>
                </div>
                
                <div class="checkin-instructions" style="margin-top: var(--space-3);">
                    <p><strong>Instructions:</strong></p>
                    <p>• Go through each learning point and rate your understanding</p>
                    <p>• Be honest - this helps identify where to focus</p>
                    <p>• You have 10 minutes to complete the check-in</p>
                </div>
            </div>
            <div class="quiz-footer">
                <button class="btn btn-secondary" id="checkin-start-cancel-btn">Cancel</button>
                <button class="btn btn-primary" id="checkin-start-confirm-btn">Start Check-in</button>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner-large"></div>
        <div class="loading-text" id="loading-text">Loading topic...</div>
    </div>
    
    <!-- Text Selection Popup -->
    <div class="selection-popup" id="selection-popup">
        <button class="selection-popup-btn teacher" id="popup-teacher-btn">
            <span class="popup-icon">âœ‹</span>
            <span class="popup-label">Ask my teacher</span>
        </button>
        <button class="selection-popup-btn google" id="popup-google-btn">
            <span class="popup-icon">ðŸ”</span>
            <span class="popup-label">Search Google</span>
        </button>
        <button class="selection-popup-btn chatgpt" id="popup-chatgpt-btn">
            <span class="popup-icon">🤖</span>
            <span class="popup-label">Ask ChatGPT</span>
        </button>
    </div>

    <!-- Welcome Dialog (First Run) -->
    <div class="welcome-overlay" id="welcome-overlay">
        <div class="welcome-dialog" role="dialog" aria-labelledby="welcome-title" aria-modal="true">
            
            <!-- Page 1: Welcome -->
            <div class="welcome-page active" id="welcome-page-1">
                <div class="welcome-header">
                    <span class="welcome-icon">📚</span>
                    <h2 class="welcome-title" id="welcome-title">Welcome to Your Learning Check List</h2>
                </div>
                <div class="welcome-body">
                    <p class="welcome-intro">This app helps you track your understanding of each topic as you learn. It is designed to support your learning journey, not to test you.</p>
                    
                    <!-- User Info Section -->
                    <div class="welcome-user-info">
                        <div class="welcome-form-group">
                            <label class="welcome-form-label" for="welcome-name-input">Your name</label>
                            <input type="text" id="welcome-name-input" class="welcome-form-input" placeholder="Enter your name">
                        </div>
                        <div class="welcome-form-group">
                            <label class="welcome-form-label" for="welcome-class-input">Your classes</label>
                            <input type="text" id="welcome-class-input" class="welcome-form-input" placeholder="e.g., VCE Biology U3, Year 7 English">
                        </div>
                    </div>
                    
                    <div class="welcome-features">
                        <div class="welcome-feature">
                            <span class="welcome-feature-icon">🎯</span>
                            <div class="welcome-feature-text">
                                <strong>Rate your understanding</strong>
                                <span>For each learning point, select the level that best describes where you are right now. Be honest with yourself - this is for your benefit.</span>
                            </div>
                        </div>
                        <div class="welcome-feature">
                            <span class="welcome-feature-icon">📋</span>
                            <div class="welcome-feature-text">
                                <strong>Regular check-ins</strong>
                                <span>Use check-ins to review your progress over time. You can do a pre-topic check-in before starting, and weekly reviews as you learn.</span>
                            </div>
                        </div>
                        <div class="welcome-feature">
                            <span class="welcome-feature-icon">📖</span>
                            <div class="welcome-feature-text">
                                <strong>What, Why, Example</strong>
                                <span>Click these buttons on any learning point to see explanations that help you understand the content better.</span>
                            </div>
                        </div>
                        <div class="welcome-feature">
                            <span class="welcome-feature-icon">ðŸŽ“</span>
                            <div class="welcome-feature-text">
                                <strong>Quick checks</strong>
                                <span>When you move to a higher level, you may be asked a quick question to confirm your understanding. This helps ensure your self-assessment is accurate.</span>
                            </div>
                        </div>
                    </div>
                    
                    <p class="welcome-footer-text">Your progress is saved automatically and stays private on your device.</p>
                </div>
                <div class="welcome-footer">
                    <button class="btn btn-ghost" id="welcome-skip-btn">Skip</button>
                    <button class="btn btn-primary" id="welcome-next-btn">Show Me How →</button>
                </div>
            </div>
            
            <!-- Page 2: Tutorial -->
            <div class="welcome-page" id="welcome-page-2">
                <div class="welcome-header">
                    <span class="welcome-icon">ðŸŽ“</span>
                    <h2 class="welcome-title">Quick Tour</h2>
                </div>
                <div class="welcome-body">
                    <div class="tutorial-steps">
                        <div class="tutorial-step">
                            <div class="tutorial-step-number">1</div>
                            <div class="tutorial-step-content">
                                <strong>Select your topic</strong>
                                <p>Use the dropdowns at the top to choose your year level, subject, and topic. The content will load automatically.</p>
                            </div>
                        </div>
                        
                        <div class="tutorial-step">
                            <div class="tutorial-step-number">2</div>
                            <div class="tutorial-step-content">
                                <strong>Rate each learning point</strong>
                                <p>Click the level buttons to indicate your understanding. The levels go from "Not started" through to "Mastered".</p>
                                <div class="tutorial-demo">
                                    <span class="tutorial-demo-level">🌱</span>
                                    <span class="tutorial-demo-level">🌿</span>
                                    <span class="tutorial-demo-level">🌳</span>
                                    <span class="tutorial-demo-level">🌲</span>
                                    <span class="tutorial-demo-level">⭐</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tutorial-step">
                            <div class="tutorial-step-number">3</div>
                            <div class="tutorial-step-content">
                                <strong>Start a check-in</strong>
                                <p>Click the "Check In" button to begin a timed review session. This helps you track progress over time.</p>
                            </div>
                        </div>
                        
                        <div class="tutorial-step">
                            <div class="tutorial-step-number">4</div>
                            <div class="tutorial-step-content">
                                <strong>Select text to get help</strong>
                                <p>Highlight any text in the learning content to quickly search Google, ask AI, or note it for your teacher.</p>
                            </div>
                        </div>
                        
                        <div class="tutorial-step">
                            <div class="tutorial-step-number">5</div>
                            <div class="tutorial-step-content">
                                <strong>Explore the tabs</strong>
                                <p>Use the tabs to view your overview, learning content, history, goals, and settings.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="welcome-footer">
                    <button class="btn btn-ghost" id="welcome-back-btn">← Back</button>
                    <button class="btn btn-primary" id="welcome-start-btn">Get Started</button>
                </div>
            </div>
            
        </div>
    </div>

    <script>
// ============================================
// CONSTANTS
// ============================================
const STORAGE_KEY = 'dynamicLearningCheckin_v2';
const PROGRESS_STORE_KEY = 'learning-checkin-progress-store';
const QUIZ_STATE_KEY = 'learning-checkin-quiz-state';
const DROPDOWN_SELECTION_KEY = 'learning-checkin-dropdown-selection';
const TOPIC_AVAILABILITY_KEY = 'learning-checkin-topic-availability';
const LEVEL_PREFS_KEY = 'learning-checkin-level-prefs';
const FIRST_RUN_KEY = 'learning-checkin-first-run-complete';
const SELECTION_TIP_KEY = 'learning-checkin-selection-tip-shown';
const QUIZ_LOCKOUT_DURATION = 5 * 60 * 1000; // 5 minutes
const AVAILABILITY_CACHE_DURATION = 60 * 60 * 1000; // 1 hour
const SELECTION_TIP_DELAY = 3 * 60 * 1000; // 3 minutes

const levelNames = ['Not started', 'Beginning', 'Developing', 'Confident', 'Mastered'];

// Emoji progression options
const emojiProgressions = [
    ['🌱', '🌿', '🌳', '🌲', '⭐'],  // Growth
    ['📖', '✏️', '📝', '📚', '🎓'],  // Learning
    ['○', '◔', '◑', '◕', '●'],      // Fill circles
    ['1️⃣', '2️⃣', '3️⃣', '4️⃣', '5️⃣'],  // Numbers
    ['🥉', '🥈', '🥇', '🏆', '👑'],  // Achievement
    ['❄️', '🌧️', '⛅', '☀️', '🌟']   // Weather
];

// Default colors (cyan for level 2)
const defaultLevelColors = ['#94a3b8', '#06b6d4', '#eab308', '#22c55e', '#8b5cf6'];

// Level display preferences (loaded from localStorage)
let levelPrefs = {
    displayMode: 'emoji',  // 'emoji', 'dots', 'both'
    emojiProgression: 0,   // index into emojiProgressions
    colors: [...defaultLevelColors]
};

// Dynamic getter for current emojis based on selected progression
function getLevelEmojis() {
    return emojiProgressions[levelPrefs.emojiProgression] || emojiProgressions[0];
}

// For backwards compatibility - will be replaced by getLevelEmojis() calls
let levelEmojis = emojiProgressions[0];

const checkinTypeLabels = {
    pre: 'Pre-Topic',
    weekly: 'Weekly',
    revision: 'Revision',
    post: 'Post-Test'
};

// ============================================
// STATE MANAGEMENT
// ============================================
let appState = {
    student: {
        name: '',
        class: ''
    },
    topic: null,
    currentTopicId: null,
    currentTopicPath: null, // Store the base path for loading subtopics/questions
    learningItems: {},
    checkins: [],
    goals: [],
    questions: [],
    theme: 'light',
    lastSaved: null
};

// Manifest data (loaded from manifest.json)
let manifest = null;

// Topic availability cache: { path: { available: bool, checkedAt: timestamp } }
let topicAvailabilityCache = {};

// Per-topic progress storage
let topicProgressStore = {};

// Currently selected dropdown values
let selectedYearLevel = null;
let selectedSubject = null;

// Quiz state
let quizState = {};
let currentQuiz = null;

// Questions cache - keyed by item UUID
let questionsCache = {};

// Check-in mode state
let checkinModeActive = false;
let currentCheckinType = 'weekly';
let checkinStartLevels = {};
let checkinReviewedItems = new Set();
let checkinTimer = null;
let checkinStartTime = null;

// Text selection popup
let selectionPopup = null;
let selectionTimeout = null;

// ============================================
// STORAGE FUNCTIONS
// ============================================
function saveData() {
    appState.lastSaved = new Date().toISOString();
    try {
        // Save current topic's progress to the per-topic store (use path as unique key)
        if (appState.currentTopicPath) {
            topicProgressStore[appState.currentTopicPath] = {
                learningItems: appState.learningItems,
                checkins: appState.checkins,
                goals: appState.goals,
                questions: appState.questions
            };
        }
        
        // Save app state
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            student: appState.student,
            currentTopicId: appState.currentTopicId,
            currentTopicPath: appState.currentTopicPath,
            topic: appState.topic,
            learningItems: appState.learningItems,
            checkins: appState.checkins,
            goals: appState.goals,
            questions: appState.questions,
            theme: appState.theme,
            lastSaved: appState.lastSaved
        }));
        
        // Save per-topic progress store
        localStorage.setItem(PROGRESS_STORE_KEY, JSON.stringify(topicProgressStore));
        
        updateSaveStatus();
    } catch (e) {
        console.error('Save failed:', e);
        showToast('Failed to save changes', 'error');
    }
}

function loadData() {
    try {
        // Load per-topic progress store
        const progressStore = localStorage.getItem(PROGRESS_STORE_KEY);
        if (progressStore) {
            topicProgressStore = JSON.parse(progressStore);
        }
        
        // Load app state
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            appState.student = parsed.student || appState.student;
            appState.currentTopicId = parsed.currentTopicId || null;
            appState.currentTopicPath = parsed.currentTopicPath || null;
            appState.topic = parsed.topic || null;
            appState.learningItems = parsed.learningItems || {};
            appState.checkins = parsed.checkins || [];
            appState.goals = parsed.goals || [];
            appState.questions = parsed.questions || [];
            appState.theme = parsed.theme || 'light';
            
            if (appState.theme) applyTheme(appState.theme);
        }
    } catch (e) {
        console.error('Load failed:', e);
    }
    
    // Initialize learning items for current topic
    initLearningItems();
}

function initLearningItems() {
    if (!appState.topic || !appState.topic.subtopics) return;
    
    appState.topic.subtopics.forEach(subtopic => {
        if (subtopic.items) {
            subtopic.items.forEach(item => {
                const itemKey = getItemKey(subtopic.id, item.id);
                if (!appState.learningItems[itemKey]) {
                    appState.learningItems[itemKey] = {
                        level: 1,
                        history: [],
                        notes: []
                    };
                }
            });
        }
    });
}

function updateSaveStatus() {
    const el = document.getElementById('save-status');
    if (el) el.textContent = 'All changes saved';
}

// ============================================
// QUIZ STATE MANAGEMENT
// ============================================
function saveQuizState() {
    try {
        localStorage.setItem(QUIZ_STATE_KEY, JSON.stringify(quizState));
    } catch (e) {
        console.error('Failed to save quiz state:', e);
    }
}

function loadQuizState() {
    try {
        const saved = localStorage.getItem(QUIZ_STATE_KEY);
        if (saved) {
            quizState = JSON.parse(saved);
            // Clean up expired lockouts
            const now = Date.now();
            Object.keys(quizState).forEach(key => {
                if (quizState[key].lockedUntil && quizState[key].lockedUntil < now) {
                    quizState[key] = {
                        usedQuestions: [],
                        wrongCount: 0,
                        correctStreak: 0,
                        requiredCorrect: 1,
                        lockedUntil: null
                    };
                }
            });
            saveQuizState();
        }
    } catch (e) {
        console.error('Failed to load quiz state:', e);
        quizState = {};
    }
}

// ============================================
// TOPIC LOADING - PHASE 1 CORE
// ============================================

/**
 * Show/hide loading indicator
 */
function showTopicLoading(show, text = 'Loading...') {
    const indicator = document.getElementById('topic-loading-indicator');
    const overlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    
    if (indicator) {
        indicator.classList.toggle('active', show);
    }
    
    if (overlay) {
        overlay.classList.toggle('active', show);
    }
    
    if (loadingText) {
        loadingText.textContent = text;
    }
}

/**
 * Update the current topic display in the header
 */
function updateTopicCurrentDisplay() {
    const display = document.getElementById('topic-current-name');
    if (display) {
        if (appState.topic) {
            display.textContent = `${appState.topic.name} (${appState.topic.yearLevel})`;
        } else {
            display.textContent = 'No topic selected';
        }
    }
}

/**
 * Load manifest.json from server
 */
async function loadManifest() {
    try {
        showTopicLoading(true, 'Loading curriculum...');
        
        const response = await fetch('manifest.json');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        manifest = await response.json();
        
        // Populate year level dropdown
        populateYearLevelDropdown();
        
        // Try to restore previous selection
        restoreDropdownSelection();
        
        // Resize dropdowns to fit content
        resizeAllDropdowns();
        
        console.log('Manifest loaded:', manifest.yearLevels?.length, 'year levels');
        
    } catch (error) {
        console.log('Manifest not available:', error.message);
        showToast('Could not load curriculum manifest', 'warning');
        
        // Hide the topic selector if no manifest
        const selectorBar = document.querySelector('.topic-selector-bar');
        if (selectorBar) {
            selectorBar.style.display = 'none';
        }
    } finally {
        showTopicLoading(false);
    }
}

/**
 * Load a topic from server - fetches topic.json and all subtopic files
 * @param {string} topicPath - Base path like "topics/vce-unit3/biology/"
 * @returns {object|null} - Merged topic data with subtopics populated
 */
async function loadTopicFromServer(topicPath) {
    try {
        showTopicLoading(true, 'Loading topic...');
        
        // Ensure path ends with /
        if (!topicPath.endsWith('/')) {
            topicPath += '/';
        }
        
        // 1. Load topic.json
        const topicUrl = `${topicPath}topic.json`;
        console.log('Loading topic from:', topicUrl);
        
        const topicResponse = await fetch(topicUrl);
        if (!topicResponse.ok) {
            throw new Error(`Could not load topic.json (HTTP ${topicResponse.status})`);
        }
        
        const topicData = await topicResponse.json();
        
        // Validate basic structure
        if (!topicData.name || !topicData.subtopics || !Array.isArray(topicData.subtopics)) {
            throw new Error('Invalid topic format: missing name or subtopics');
        }
        
        console.log('Topic loaded:', topicData.name, 'with', topicData.subtopics.length, 'subtopics');
        
        // 2. Load each subtopic file
        showTopicLoading(true, 'Loading subtopics...');
        
        const subtopicsWithItems = await Promise.all(
            topicData.subtopics.map(async (subtopicRef) => {
                try {
                    const subtopicUrl = `${topicPath}subtopics/${subtopicRef.file || subtopicRef.id + '.json'}`;
                    console.log('Loading subtopic:', subtopicUrl);
                    
                    const subtopicResponse = await fetch(subtopicUrl);
                    if (!subtopicResponse.ok) {
                        console.warn(`Could not load subtopic ${subtopicRef.id}: HTTP ${subtopicResponse.status}`);
                        // Return a minimal subtopic with no items
                        return {
                            id: subtopicRef.id,
                            name: subtopicRef.name,
                            icon: subtopicRef.icon || '📄',
                            what: '',
                            why: '',
                            items: [],
                            _loadError: true
                        };
                    }
                    
                    const subtopicData = await subtopicResponse.json();
                    
                    // Merge ref data with file data (file takes precedence)
                    return {
                        id: subtopicData.id || subtopicRef.id,
                        name: subtopicData.name || subtopicRef.name,
                        icon: subtopicData.icon || subtopicRef.icon || '📄',
                        what: subtopicData.what || '',
                        why: subtopicData.why || '',
                        items: subtopicData.items || []
                    };
                    
                } catch (error) {
                    console.error(`Error loading subtopic ${subtopicRef.id}:`, error);
                    return {
                        id: subtopicRef.id,
                        name: subtopicRef.name,
                        icon: subtopicRef.icon || '📄',
                        what: '',
                        why: '',
                        items: [],
                        _loadError: true
                    };
                }
            })
        );
        
        // 3. Merge subtopics into topic data
        topicData.subtopics = subtopicsWithItems;
        
        // Count total items
        const totalItems = subtopicsWithItems.reduce((sum, st) => sum + (st.items?.length || 0), 0);
        console.log('Topic fully loaded:', totalItems, 'learning points');
        
        return topicData;
        
    } catch (error) {
        console.error('Failed to load topic:', error);
        showToast(`Failed to load topic: ${error.message}`, 'error');
        return null;
    } finally {
        showTopicLoading(false);
    }
}

/**
 * Load questions for a specific learning point
 * @param {string} uuid - The learning point UUID
 * @returns {object|null} - Question data or null if not available
 */
async function loadQuestionsForItem(uuid) {
    // Check cache first
    if (questionsCache[uuid]) {
        return questionsCache[uuid];
    }
    
    if (!appState.currentTopicPath) {
        return null;
    }
    
    try {
        const questionUrl = `${appState.currentTopicPath}questions/q-${uuid}.json`;
        const response = await fetch(questionUrl);
        
        if (!response.ok) {
            // Questions don't exist - this is normal, not an error
            console.log(`No questions for ${uuid} (HTTP ${response.status})`);
            questionsCache[uuid] = null;
            return null;
        }
        
        const questionData = await response.json();
        questionsCache[uuid] = questionData;
        return questionData;
        
    } catch (error) {
        console.log(`Could not load questions for ${uuid}:`, error.message);
        questionsCache[uuid] = null;
        return null;
    }
}

/**
 * Check if questions exist for a learning point (from cache or fetch)
 */
async function hasQuestionsForItem(uuid) {
    const questions = await loadQuestionsForItem(uuid);
    return questions !== null;
}

/**
 * Get questions for a specific level transition
 */
async function getQuestionsForLevel(itemKey, toLevel) {
    // Find the item to get its UUID
    const item = getItemByKey(itemKey);
    if (!item || !item.uuid) {
        return [];
    }
    
    const questionData = await loadQuestionsForItem(item.uuid);
    if (!questionData) {
        return [];
    }
    
    const levelKey = `toLevel${toLevel}`;
    return questionData[levelKey] || [];
}

/**
 * Get an item by its numeric ID
 */
function getItemById(itemId) {
    if (!appState.topic) return null;
    for (const subtopic of appState.topic.subtopics) {
        const item = subtopic.items?.find(i => i.id === itemId);
        if (item) return item;
    }
    return null;
}

/**
 * Switch to a new topic
 */
async function switchTopic(topicId, topicPath) {
    // Save current progress before switching
    saveCurrentTopicProgress();
    
    // Clear questions cache for new topic
    questionsCache = {};
    
    // Load topic data from server
    const topicData = await loadTopicFromServer(topicPath);
    
    if (topicData) {
        // Set new topic
        appState.topic = topicData;
        appState.currentTopicId = topicId;
        appState.currentTopicPath = topicPath.endsWith('/') ? topicPath : topicPath + '/';
        
        // Update class from topic if provided
        if (topicData.class) {
            appState.student.class = topicData.class;
            const classInput = document.getElementById('class-input');
            if (classInput) classInput.value = topicData.class;
        }
        
        // Restore or initialize progress for this topic (use path as unique key)
        restoreTopicProgress(appState.currentTopicPath);
        
        // Initialize any new learning items
        initLearningItems();
        
        // Save and render
        saveData();
        renderAll();
        updateTopicCurrentDisplay();
        
        showToast(`Loaded: ${topicData.name}`, 'success');
    }
}

/**
 * Save current topic progress before switching
 */
function saveCurrentTopicProgress() {
    if (appState.currentTopicPath) {
        topicProgressStore[appState.currentTopicPath] = {
            learningItems: { ...appState.learningItems },
            checkins: [...appState.checkins],
            goals: [...appState.goals],
            questions: [...appState.questions]
        };
    }
}

/**
 * Restore progress for a topic (or initialize fresh)
 */
function restoreTopicProgress(topicPath) {
    if (topicProgressStore[topicPath]) {
        const stored = topicProgressStore[topicPath];
        appState.learningItems = stored.learningItems || {};
        appState.checkins = stored.checkins || [];
        appState.goals = stored.goals || [];
        appState.questions = stored.questions || [];
    } else {
        // Fresh start for this topic
        appState.learningItems = {};
        appState.checkins = [];
        appState.goals = [];
        appState.questions = [];
    }
}

// ============================================
// DROPDOWN POPULATION
// ============================================

function populateYearLevelDropdown() {
    const dropdown = document.getElementById('year-level-dropdown');
    if (!dropdown || !manifest) return;
    
    dropdown.innerHTML = '<option value="">Select Year Level</option>';
    
    manifest.yearLevels.forEach(yearLevel => {
        const option = document.createElement('option');
        option.value = yearLevel.id;
        option.textContent = yearLevel.name;
        dropdown.appendChild(option);
    });
}

function populateSubjectDropdown(yearLevelId) {
    const dropdown = document.getElementById('subject-dropdown');
    const topicDropdown = document.getElementById('topic-dropdown');
    
    if (!dropdown || !manifest) return;
    
    // Reset subject and topic dropdowns
    dropdown.innerHTML = '<option value="">Select Subject</option>';
    dropdown.disabled = true;
    topicDropdown.innerHTML = '<option value="">Select Topic</option>';
    topicDropdown.disabled = true;
    selectedSubject = null;
    
    if (!yearLevelId) return;
    
    const yearLevel = manifest.yearLevels.find(y => y.id === yearLevelId);
    if (!yearLevel) return;
    
    yearLevel.subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject.id;
        option.textContent = `${subject.icon || ''} ${subject.name}`.trim();
        dropdown.appendChild(option);
    });
    
    dropdown.disabled = false;
}

function populateTopicDropdown(yearLevelId, subjectId) {
    const dropdown = document.getElementById('topic-dropdown');
    
    if (!dropdown || !manifest) return;
    
    dropdown.innerHTML = '<option value="">Select Topic</option>';
    dropdown.disabled = true;
    
    if (!yearLevelId || !subjectId) return;
    
    const yearLevel = manifest.yearLevels.find(y => y.id === yearLevelId);
    if (!yearLevel) return;
    
    const subject = yearLevel.subjects.find(s => s.id === subjectId);
    if (!subject || !subject.topics) return;
    
    // Add topics with availability status
    subject.topics.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic.id;
        option.dataset.path = topic.path;
        
        const availability = topicAvailabilityCache[topic.path];
        if (availability && availability.available === false) {
            // Topic confirmed unavailable
            option.textContent = `${topic.name} (unavailable)`;
            option.disabled = true;
            option.classList.add('unavailable');
        } else if (availability && availability.available === true) {
            // Topic confirmed available
            option.textContent = topic.name;
        } else {
            // Unknown - show as pending check
            option.textContent = `${topic.name}`;
        }
        
        dropdown.appendChild(option);
    });
    
    dropdown.disabled = false;
    
    // Check availability for unchecked topics in background
    checkTopicsAvailability(subject.topics);
}

// ============================================
// TOPIC AVAILABILITY CHECKING
// ============================================

/**
 * Load availability cache from localStorage
 */
function loadAvailabilityCache() {
    try {
        const saved = localStorage.getItem(TOPIC_AVAILABILITY_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            // Filter out expired entries
            const now = Date.now();
            Object.keys(parsed).forEach(path => {
                if (parsed[path].checkedAt && (now - parsed[path].checkedAt) < AVAILABILITY_CACHE_DURATION) {
                    topicAvailabilityCache[path] = parsed[path];
                }
            });
        }
    } catch (e) {
        console.warn('Failed to load availability cache:', e);
        topicAvailabilityCache = {};
    }
}

/**
 * Save availability cache to localStorage
 */
function saveAvailabilityCache() {
    try {
        localStorage.setItem(TOPIC_AVAILABILITY_KEY, JSON.stringify(topicAvailabilityCache));
    } catch (e) {
        console.warn('Failed to save availability cache:', e);
    }
}

/**
 * Check if a single topic is available (has topic.json)
 */
async function checkTopicAvailability(topicPath) {
    const normalizedPath = topicPath.endsWith('/') ? topicPath : topicPath + '/';
    const topicJsonUrl = normalizedPath + 'topic.json';
    
    try {
        const response = await fetch(topicJsonUrl, { method: 'HEAD' });
        const available = response.ok;
        
        topicAvailabilityCache[topicPath] = {
            available,
            checkedAt: Date.now()
        };
        
        saveAvailabilityCache();
        return available;
    } catch (e) {
        // Network error - mark as unavailable
        topicAvailabilityCache[topicPath] = {
            available: false,
            checkedAt: Date.now()
        };
        saveAvailabilityCache();
        return false;
    }
}

/**
 * Check availability for multiple topics (in background)
 */
async function checkTopicsAvailability(topics) {
    const uncheckedTopics = topics.filter(topic => {
        const cached = topicAvailabilityCache[topic.path];
        // Check if not cached or cache expired
        if (!cached) return true;
        if ((Date.now() - cached.checkedAt) > AVAILABILITY_CACHE_DURATION) return true;
        return false;
    });
    
    if (uncheckedTopics.length === 0) return;
    
    // Check each topic and update dropdown as results come in
    for (const topic of uncheckedTopics) {
        await checkTopicAvailability(topic.path);
        updateTopicOptionStatus(topic);
    }
}

/**
 * Update a single topic option in the dropdown after availability check
 */
function updateTopicOptionStatus(topic) {
    const dropdown = document.getElementById('topic-dropdown');
    if (!dropdown) return;
    
    const option = dropdown.querySelector(`option[data-path="${topic.path}"]`);
    if (!option) return;
    
    const availability = topicAvailabilityCache[topic.path];
    if (availability && availability.available === false) {
        option.textContent = `${topic.name} (unavailable)`;
        option.disabled = true;
        option.classList.add('unavailable');
    } else if (availability && availability.available === true) {
        option.textContent = topic.name;
        option.disabled = false;
        option.classList.remove('unavailable');
    }
}

/**
 * Force refresh availability for all topics in current subject
 */
async function refreshTopicAvailability() {
    if (!selectedYearLevel || !selectedSubject || !manifest) {
        showToast('Select a year level and subject first', 'warning');
        return;
    }
    
    const yearLevel = manifest.yearLevels.find(y => y.id === selectedYearLevel);
    if (!yearLevel) return;
    
    const subject = yearLevel.subjects.find(s => s.id === selectedSubject);
    if (!subject || !subject.topics) return;
    
    // Clear cache for these topics
    subject.topics.forEach(topic => {
        delete topicAvailabilityCache[topic.path];
    });
    saveAvailabilityCache();
    
    // Re-populate dropdown (will trigger fresh checks)
    populateTopicDropdown(selectedYearLevel, selectedSubject);
    
    showToast('Refreshing topic availability...', 'info');
}

/**
 * Refresh all topic availability (for settings/manual refresh)
 */
async function refreshAllTopicAvailability() {
    topicAvailabilityCache = {};
    saveAvailabilityCache();
    
    // Re-populate current dropdown if applicable
    if (selectedYearLevel && selectedSubject) {
        populateTopicDropdown(selectedYearLevel, selectedSubject);
    }
    
    showToast('Topic availability cache cleared', 'info');
}

// Dropdown event handlers
function onYearLevelChange(event) {
    selectedYearLevel = event.target.value;
    populateSubjectDropdown(selectedYearLevel);
    clearCurrentTopic();
    saveDropdownSelection();
    resizeAllDropdowns();
}

function onSubjectChange(event) {
    selectedSubject = event.target.value;
    populateTopicDropdown(selectedYearLevel, selectedSubject);
    clearCurrentTopic();
    saveDropdownSelection();
    resizeAllDropdowns();
}

function onTopicChange(event) {
    const select = event.target;
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption && selectedOption.value) {
        const topicId = selectedOption.value;
        const topicPath = selectedOption.dataset.path;
        saveDropdownSelection();
        switchTopic(topicId, topicPath);
    } else {
        // "Select Topic" placeholder selected - clear current topic
        clearCurrentTopic();
        saveDropdownSelection();
    }
    resizeDropdownToFit('topic-dropdown');
}

/**
 * Clear the current topic and update UI
 */
function clearCurrentTopic() {
    // Save progress for current topic before clearing
    saveCurrentTopicProgress();
    
    // Clear topic state
    appState.topic = null;
    appState.currentTopicId = null;
    appState.currentTopicPath = null;
    appState.learningItems = {};
    appState.checkins = [];
    appState.goals = [];
    appState.questions = [];
    
    // Update UI
    renderLearningContent();
    renderOverview();
    renderHistory();
    renderGoals();
    renderQuestions();
    updateTopicCurrentDisplay();
}

// Save/restore dropdown selection
function saveDropdownSelection() {
    const selection = {
        yearLevel: selectedYearLevel,
        subject: selectedSubject,
        topicId: document.getElementById('topic-dropdown')?.value || null
    };
    localStorage.setItem(DROPDOWN_SELECTION_KEY, JSON.stringify(selection));
}

function restoreDropdownSelection() {
    try {
        const saved = localStorage.getItem(DROPDOWN_SELECTION_KEY);
        if (!saved || !manifest) return;
        
        const selection = JSON.parse(saved);
        
        // Restore year level
        if (selection.yearLevel) {
            const yearDropdown = document.getElementById('year-level-dropdown');
            if (yearDropdown) {
                yearDropdown.value = selection.yearLevel;
                selectedYearLevel = selection.yearLevel;
                populateSubjectDropdown(selection.yearLevel);
            }
        }
        
        // Restore subject
        if (selection.subject) {
            const subjectDropdown = document.getElementById('subject-dropdown');
            if (subjectDropdown) {
                subjectDropdown.value = selection.subject;
                selectedSubject = selection.subject;
                populateTopicDropdown(selection.yearLevel, selection.subject);
            }
        }
        
        // Restore topic selection (visual only - if topic already loaded, don't reload)
        if (selection.topicId && appState.currentTopicId === selection.topicId) {
            const topicDropdown = document.getElementById('topic-dropdown');
            if (topicDropdown) {
                topicDropdown.value = selection.topicId;
            }
        }
        
        // Resize dropdowns to fit restored selections
        resizeAllDropdowns();
    } catch (e) {
        console.log('Could not restore dropdown selection:', e);
    }
}
// ============================================
// CALCULATIONS
// ============================================
function calculateStats() {
    const items = Object.values(appState.learningItems);
    const total = items.length || 1;
    
    const counts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    let totalScore = 0;
    
    items.forEach(item => {
        counts[item.level]++;
        totalScore += item.level;
    });
    
    const avgLevel = totalScore / total;
    const overallPercentage = Math.round(((avgLevel - 1) / 4) * 100);
    
    return {
        total,
        counts,
        avgLevel,
        overallPercentage,
        mastered: counts[5],
        confident: counts[4],
        developing: counts[3],
        beginning: counts[2],
        notStarted: counts[1]
    };
}

function calculateSubtopicProgress(subtopic) {
    let totalScore = 0;
    let count = 0;
    
    if (!subtopic.items) return 0;
    
    subtopic.items.forEach(item => {
        const itemKey = getItemKey(subtopic.id, item.id);
        const itemData = appState.learningItems[itemKey];
        if (itemData) {
            totalScore += itemData.level;
            count++;
        }
    });
    
    if (count === 0) return 0;
    const avgLevel = totalScore / count;
    return Math.round(((avgLevel - 1) / 4) * 100);
}

function getFocusAreas() {
    const items = [];
    
    if (!appState.topic || !appState.topic.subtopics) return items;
    
    appState.topic.subtopics.forEach(subtopic => {
        if (!subtopic.items) return;
        subtopic.items.forEach(item => {
            const itemKey = getItemKey(subtopic.id, item.id);
            const itemData = appState.learningItems[itemKey];
            if (itemData && itemData.level <= 2) {
                items.push({
                    ...item,
                    itemKey: itemKey, // Store the composite key
                    subtopicId: subtopic.id,
                    subtopic: subtopic.name,
                    level: itemData.level
                });
            }
        });
    });
    
    return items.slice(0, 5);
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

/**
 * Create a unique key for a learning item (combines subtopic + item IDs)
 */
function getItemKey(subtopicId, itemId) {
    return `${subtopicId}__${itemId}`;
}

/**
 * Parse a composite item key back into subtopicId and itemId
 */
function parseItemKey(key) {
    const parts = key.split('__');
    return {
        subtopicId: parts[0],
        itemId: parseInt(parts[1])
    };
}

/**
 * Get an item by its composite key
 */
function getItemByKey(itemKey) {
    if (!appState.topic) return null;
    const { subtopicId, itemId } = parseItemKey(itemKey);
    
    const subtopic = appState.topic.subtopics.find(st => st.id === subtopicId);
    if (!subtopic || !subtopic.items) return null;
    
    return subtopic.items.find(i => i.id === itemId);
}

/**
 * Get subtopic by its ID
 */
function getSubtopicById(subtopicId) {
    if (!appState.topic) return null;
    return appState.topic.subtopics.find(st => st.id === subtopicId);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

/**
 * Measure and resize a dropdown to fit its current selection
 */
function resizeDropdownToFit(selectId) {
    const select = document.getElementById(selectId);
    const measure = document.getElementById('dropdown-measure');
    
    if (!select || !measure) return;
    
    // Get the text of the selected option
    const selectedOption = select.options[select.selectedIndex];
    const text = selectedOption ? selectedOption.textContent : '';
    
    // Measure the text width
    measure.textContent = text;
    const textWidth = measure.offsetWidth;
    
    // Add space for dropdown arrow and padding (35px)
    const minWidth = 80;
    const arrowPadding = 35;
    const newWidth = Math.max(minWidth, textWidth + arrowPadding);
    
    select.style.width = newWidth + 'px';
}

/**
 * Resize all topic dropdowns to fit their selections
 */
function resizeAllDropdowns() {
    resizeDropdownToFit('year-level-dropdown');
    resizeDropdownToFit('subject-dropdown');
    resizeDropdownToFit('topic-dropdown');
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <span>${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : type === 'warning' ? 'âš ' : 'ℹ'}</span>
        <span>${escapeHtml(message)}</span>
    `;
    
    container.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 200);
    }, 3000);
}

// ============================================
// RENDERING - MAIN
// ============================================
function renderAll() {
    renderStudentInfo();
    renderOverview();
    renderLearningContent();
    renderHistory();
    renderGoals();
    renderQuestions();
    renderDataSummary();
    renderLevelLegends();
    updateBadges();
}

function renderStudentInfo() {
    const nameDisplay = document.getElementById('student-name-display');
    if (nameDisplay) {
        nameDisplay.textContent = appState.student.name || 'Student';
    }
    
    const nameInput = document.getElementById('student-name-input');
    if (nameInput) nameInput.value = appState.student.name || '';
    
    const classInput = document.getElementById('class-input');
    if (classInput) classInput.value = appState.student.class || '';
}

function renderOverview() {
    // Topic info
    const topicNameEl = document.getElementById('topic-name-display');
    if (topicNameEl) {
        topicNameEl.textContent = appState.topic 
            ? `${appState.topic.name} • ${appState.topic.yearLevel}` 
            : 'Your Progress';
    }
    
    // Stats
    const stats = calculateStats();
    
    const overallPercentEl = document.getElementById('overall-percentage');
    if (overallPercentEl) overallPercentEl.textContent = stats.overallPercentage + '%';
    
    const progressFillEl = document.getElementById('overall-progress-fill');
    if (progressFillEl) progressFillEl.style.width = stats.overallPercentage + '%';
    
    const progressStatsEl = document.getElementById('progress-stats');
    if (progressStatsEl) {
        progressStatsEl.innerHTML = `
            <div class="progress-stat">
                <div class="progress-stat-value" style="color: var(--level-1)">${stats.notStarted}</div>
                <div class="progress-stat-label">Not Started</div>
            </div>
            <div class="progress-stat">
                <div class="progress-stat-value" style="color: var(--level-2)">${stats.beginning}</div>
                <div class="progress-stat-label">Beginning</div>
            </div>
            <div class="progress-stat">
                <div class="progress-stat-value" style="color: var(--level-3)">${stats.developing}</div>
                <div class="progress-stat-label">Developing</div>
            </div>
            <div class="progress-stat">
                <div class="progress-stat-value" style="color: var(--level-4)">${stats.confident}</div>
                <div class="progress-stat-label">Confident</div>
            </div>
            <div class="progress-stat">
                <div class="progress-stat-value" style="color: var(--level-5)">${stats.mastered}</div>
                <div class="progress-stat-label">Mastered</div>
            </div>
        `;
    }
    
    // Quick stats
    const totalCheckinsEl = document.getElementById('total-checkins');
    if (totalCheckinsEl) totalCheckinsEl.textContent = appState.checkins.length;
    
    const itemsMasteredEl = document.getElementById('items-mastered');
    if (itemsMasteredEl) itemsMasteredEl.textContent = stats.mastered;
    
    // Last check-in
    const lastCheckinEl = document.getElementById('last-checkin-date');
    if (lastCheckinEl) {
        if (appState.checkins.length > 0) {
            const lastCheckin = appState.checkins[appState.checkins.length - 1];
            lastCheckinEl.textContent = new Date(lastCheckin.date).toLocaleDateString();
        } else {
            lastCheckinEl.textContent = '—';
        }
    }
    
    // Focus areas
    const focusAreas = getFocusAreas();
    const focusContainer = document.getElementById('focus-areas');
    
    if (focusContainer) {
        if (!appState.topic) {
            focusContainer.innerHTML = `
                <div class="empty-state" style="padding: var(--space-4);">
                    <p class="empty-state-desc">Select a topic to see your focus areas.</p>
                </div>
            `;
        } else if (focusAreas.length === 0) {
            focusContainer.innerHTML = `
                <div class="empty-state" style="padding: var(--space-4);">
                    <p class="empty-state-desc">
                        ${stats.total === stats.mastered ? 
                            'ðŸŽ‰ Amazing! You\'ve mastered all content!' : 
                            'Complete a check-in to identify your focus areas.'}
                    </p>
                </div>
            `;
        } else {
            focusContainer.innerHTML = focusAreas.map(item => `
                <div class="goal-item focus-area-link" style="border-left-color: var(--level-${item.level}); cursor: pointer;" 
                     data-item-key="${item.itemKey}" 
                     title="Click to go to this item">
                    <div class="goal-text">${escapeHtml(item.title)}</div>
                    <div class="goal-meta">${escapeHtml(item.subtopic)} • ${escapeHtml(item.code)} <span style="color: var(--color-primary);">→ Go</span></div>
                </div>
            `).join('');
            
            // Add click handlers
            focusContainer.querySelectorAll('.focus-area-link').forEach(el => {
                el.addEventListener('click', () => {
                    const itemKey = el.dataset.itemKey;
                    navigateToLearningItem(itemKey);
                });
            });
        }
    }
}

// ============================================
// RENDERING - LEARNING CONTENT
// ============================================
function renderLearningContent() {
    const container = document.getElementById('topics-container');
    const learningPanel = document.getElementById('learning-panel');
    
    // Add/remove check-in mode styling
    if (learningPanel) {
        learningPanel.classList.toggle('checkin-mode-active', checkinModeActive);
    }
    
    if (!appState.topic || !appState.topic.subtopics) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📚</div>
                <div class="empty-state-title">No topic loaded</div>
                <p class="empty-state-desc">Select a year level, subject, and topic from the dropdowns above to get started.</p>
            </div>
        `;
        return;
    }
    
    // Update header
    const topicTitleEl = document.getElementById('topic-title');
    if (topicTitleEl) topicTitleEl.textContent = appState.topic.name;
    
    const curriculumCodeEl = document.getElementById('curriculum-code');
    if (curriculumCodeEl) {
        curriculumCodeEl.textContent = `${appState.topic.subject} • ${appState.topic.yearLevel}${appState.topic.curriculumCode ? ' • ' + appState.topic.curriculumCode : ''}`;
    }
    
    // Check-in mode banner
    const checkinBanner = checkinModeActive ? `
        <div class="checkin-mode-banner">
            <div class="checkin-mode-info">
                <span class="checkin-mode-type">${checkinTypeLabels[currentCheckinType]} Check-in</span>
                <span class="checkin-mode-progress" id="checkin-progress-text">0/${Object.keys(checkinStartLevels).length} items reviewed</span>
            </div>
            <button class="checkin-stop-btn" onclick="stopCheckinMode(false)">⏹ Stop Check-in</button>
        </div>
    ` : '';
    
    // Render subtopics
    container.innerHTML = checkinBanner + appState.topic.subtopics.map(subtopic => {
        const progress = calculateSubtopicProgress(subtopic);
        const headerId = `subtopic-${subtopic.id}-header`;
        const contentId = `subtopic-${subtopic.id}-content`;
        const hasSubtopicExplanation = subtopic.what || subtopic.why;
        
        // Check for load error
        const loadErrorBadge = subtopic._loadError ? `<span class="no-quiz-badge" title="Could not load subtopic content">âš ï¸ Load error</span>` : '';
        
        return `
            <div class="topic-section" data-subtopic-id="${subtopic.id}">
                <div class="topic-header" id="${headerId}" aria-expanded="${checkinModeActive ? 'true' : 'false'}" aria-controls="${contentId}">
                    <div class="topic-header-left">
                        <div class="topic-icon">${subtopic.icon || '📄'}</div>
                        <div class="topic-info">
                            <div class="topic-title">${escapeHtml(subtopic.name)} ${loadErrorBadge}</div>
                            <div class="topic-meta">
                                <span>${subtopic.items?.length || 0} learning outcomes</span>
                            </div>
                        </div>
                    </div>
                    <div class="topic-progress">
                        <div class="topic-progress-bar">
                            <div class="topic-progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="topic-progress-text">${progress}%</div>
                    </div>
                    <span class="topic-toggle">â–¼</span>
                </div>
                <div class="topic-content ${checkinModeActive ? 'expanded' : ''}" id="${contentId}">
                    ${hasSubtopicExplanation ? renderSubtopicExplanation(subtopic) : ''}
                    ${(subtopic.items || []).map(item => renderLearningItem(item, subtopic)).join('')}
                </div>
            </div>
        `;
    }).join('');
    
    setupLearningContentListeners();
}

function renderSubtopicExplanation(subtopic) {
    const explanationId = `subtopic-explanation-${subtopic.id}`;
    const explanationContentId = `subtopic-explanation-content-${subtopic.id}`;
    
    return `
        <div class="subtopic-explanation-wrapper">
            <button class="explanation-toggle subtopic-explanation-toggle" id="${explanationId}" aria-expanded="false" aria-controls="${explanationContentId}">
                <span class="explanation-toggle-icon">â–¼</span>
                <span>📖 What is this section about & Why does it matter?</span>
            </button>
            <div class="explanation-content subtopic-explanation-content" id="${explanationContentId}">
                ${subtopic.what ? `
                    <div class="explanation-section">
                        <div class="explanation-heading">
                            <span class="explanation-heading-icon">📖</span> What is this section?
                        </div>
                        <p class="explanation-text">${escapeHtml(subtopic.what)}</p>
                    </div>
                ` : ''}
                ${subtopic.why ? `
                    <div class="explanation-section">
                        <div class="explanation-heading">
                            <span class="explanation-heading-icon">💡</span> Why does it matter?
                        </div>
                        <p class="explanation-text">${escapeHtml(subtopic.why)}</p>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function renderLearningItem(item, subtopic) {
    const itemKey = getItemKey(subtopic.id, item.id);
    const data = appState.learningItems[itemKey] || { level: 1, history: [], notes: [] };
    const explanationId = `explanation-${subtopic.id}-${item.id}`;
    const explanationContentId = `explanation-content-${subtopic.id}-${item.id}`;
    
    const hasExplanation = item.what || item.why || item.example;
    
    // Get last change date
    const lastChange = data.history.length > 0 ? data.history[data.history.length - 1] : null;
    const lastChangeText = lastChange 
        ? `${new Date(lastChange.date).toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })} ${new Date(lastChange.date).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' })}`
        : '';
    
    // Check-in mode: get "was" level
    const wasLevel = getWasLevel(itemKey);
    const isReviewed = checkinReviewedItems.has(itemKey);
    
    // Get current emojis based on preference
    const emojis = getLevelEmojis();
    
    // Build notch content based on display mode
    const getNotchContent = (level) => {
        const emoji = emojis[level - 1];
        const color = levelPrefs.colors[level - 1];
        
        if (levelPrefs.displayMode === 'dots') {
            return `<span class="notch-dot" style="background: ${color}"></span>`;
        } else if (levelPrefs.displayMode === 'emoji') {
            return emoji;
        } else { // both
            return `<span class="notch-dot" style="background: ${color}"></span><span class="notch-emoji">${emoji}</span>`;
        }
    };
    
    // Build notch selector
    const notchesHtml = `
        <div class="level-notches" data-item-key="${itemKey}" role="radiogroup" aria-label="Understanding level">
            ${[1, 2, 3, 4, 5].map(level => {
                const isFilled = level <= data.level;
                const isActive = level === data.level;
                const isLocked = level > data.level && isLevelLocked(itemKey, level);
                return `<button class="level-notch ${isFilled ? 'filled' : ''} ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}" 
                    data-level="${level}" 
                    data-label="${levelNames[level - 1]}"
                    role="radio"
                    aria-checked="${isActive}"
                    aria-label="${emojis[level - 1]} ${levelNames[level - 1]}${isLocked ? ' (locked)' : ''}"
                    tabindex="${isActive ? '0' : '-1'}">${getNotchContent(level)}</button>`;
            }).join('')}
        </div>
    `;
    
    // Build "was" level display
    const getWasLevelDisplay = (level) => {
        const emoji = emojis[level - 1];
        const color = levelPrefs.colors[level - 1];
        const name = levelNames[level - 1];
        
        if (levelPrefs.displayMode === 'dots') {
            return `<span class="notch-dot" style="background: ${color}"></span> ${name}`;
        } else if (levelPrefs.displayMode === 'emoji') {
            return `${emoji} ${name}`;
        } else {
            return `<span class="notch-dot" style="background: ${color}"></span> ${emoji} ${name}`;
        }
    };
    
    // Build controls based on mode
    let controlsHtml;
    if (checkinModeActive) {
        controlsHtml = `
            <div class="level-controls-checkin">
                <div class="level-was">Was: <span class="level-was-value" data-level="${wasLevel}">${getWasLevelDisplay(wasLevel)}</span></div>
                ${notchesHtml}
            </div>
        `;
    } else {
        controlsHtml = notchesHtml;
    }
    
    return `
        <div class="learning-item-simple ${isReviewed ? 'reviewed' : ''}" data-level="${data.level}" data-item-key="${itemKey}" data-uuid="${item.uuid || ''}">
            <div class="learning-item-row">
                <div class="learning-item-left">
                    <span class="learning-item-title">${escapeHtml(item.title)}</span>
                    <span class="learning-item-code">${escapeHtml(item.code)}</span>
                    ${hasExplanation ? `<button class="help-toggle-inline" id="${explanationId}" aria-expanded="false" aria-controls="${explanationContentId}">What Why Example</button>` : ''}
                    ${lastChangeText ? `<span class="learning-item-updated">${lastChangeText}</span>` : ''}
                </div>
                <div class="learning-item-right">
                    ${controlsHtml}
                </div>
            </div>
            ${hasExplanation ? `
                <div class="help-content-inline" id="${explanationContentId}">
                    ${item.what ? `<span class="help-inline-item"><strong>📖 What:</strong> ${escapeHtml(item.what)}</span>` : ''}
                    ${item.why ? `<span class="help-inline-item"><strong>💡 Why:</strong> ${escapeHtml(item.why)}</span>` : ''}
                    ${item.example ? `<span class="help-inline-item"><strong>✏️ Example:</strong> ${escapeHtml(item.example)}</span>` : ''}
                </div>
            ` : ''}
        </div>
    `;
}

function setupLearningContentListeners() {
    // Topic headers (subtopic collapsing)
    document.querySelectorAll('.topic-header').forEach(header => {
        header.addEventListener('click', () => {
            const expanded = header.getAttribute('aria-expanded') === 'true';
            header.setAttribute('aria-expanded', !expanded);
            document.getElementById(header.getAttribute('aria-controls')).classList.toggle('expanded', !expanded);
        });
    });
    
    // Level notches - main interaction
    document.querySelectorAll('.level-notch').forEach(notch => {
        notch.addEventListener('click', (e) => {
            e.stopPropagation();
            const notchContainer = notch.closest('.level-notches');
            const itemKey = notchContainer.dataset.itemKey;
            const level = parseInt(notch.dataset.level);
            
            // Check if this level is locked
            if (notch.classList.contains('locked')) {
                const remaining = getLockoutRemainingTime(itemKey, level);
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                showToast(`Locked for ${mins}:${secs.toString().padStart(2, '0')}`, 'error');
                return;
            }
            
            // Mark as reviewed in check-in mode
            if (checkinModeActive) {
                markItemReviewed(itemKey);
            }
            
            // Update level (may trigger quiz for upward moves)
            handleLevelChange(itemKey, level);
        });
        
        // Keyboard navigation
        notch.addEventListener('keydown', (e) => {
            const notchContainer = notch.closest('.level-notches');
            const notches = Array.from(notchContainer.querySelectorAll('.level-notch'));
            const currentIndex = notches.indexOf(notch);
            
            let newIndex = currentIndex;
            if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
                newIndex = Math.min(currentIndex + 1, notches.length - 1);
                e.preventDefault();
            } else if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
                newIndex = Math.max(currentIndex - 1, 0);
                e.preventDefault();
            }
            
            if (newIndex !== currentIndex) {
                notches[newIndex].focus();
                notches[newIndex].click();
            }
        });
    });
    
    // Help toggles
    document.querySelectorAll('.help-toggle-inline').forEach(toggle => {
        toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const expanded = toggle.getAttribute('aria-expanded') === 'true';
            toggle.setAttribute('aria-expanded', !expanded);
            const content = document.getElementById(toggle.getAttribute('aria-controls'));
            if (content) content.classList.toggle('expanded', !expanded);
        });
    });
    
    // Subtopic explanation toggles
    document.querySelectorAll('.explanation-toggle').forEach(toggle => {
        toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const expanded = toggle.getAttribute('aria-expanded') === 'true';
            toggle.setAttribute('aria-expanded', !expanded);
            const content = document.getElementById(toggle.getAttribute('aria-controls'));
            if (content) content.classList.toggle('expanded', !expanded);
        });
    });
}

// ============================================
// RENDERING - HISTORY
// ============================================
function renderHistory() {
    const container = document.getElementById('checkin-timeline');
    
    if (!appState.topic || !appState.topic.subtopics) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">📊</div>
                <div class="empty-state-title">No topic loaded</div>
                <p class="empty-state-desc">Load a topic to see progress.</p>
            </div>
        `;
        return;
    }
    
    // Calculate stats
    let totalItems = 0;
    let totalPoints = 0;
    let maxPoints = 0;
    let levelCounts = [0, 0, 0, 0, 0];
    
    appState.topic.subtopics.forEach(subtopic => {
        if (!subtopic.items) return;
        subtopic.items.forEach(item => {
            const itemKey = getItemKey(subtopic.id, item.id);
            const itemData = appState.learningItems[itemKey] || { level: 1 };
            levelCounts[itemData.level - 1]++;
            totalPoints += itemData.level;
            totalItems++;
            maxPoints += 5;
        });
    });
    
    const overallPercentage = maxPoints > 0 ? Math.round((totalPoints / maxPoints) * 100) : 0;
    
    // Get current emojis
    const emojis = getLevelEmojis();
    
    // Build level distribution
    const levelDistributionHtml = levelCounts.map((count, i) => {
        const percent = totalItems > 0 ? (count / totalItems * 100) : 0;
        if (percent === 0) return '';
        return `<div class="level-segment" data-level="${i + 1}" style="width: ${percent}%" title="${emojis[i]} ${levelNames[i]}: ${count}"></div>`;
    }).join('');
    
    // Render
    container.innerHTML = `
        <div class="overall-progress">
            <div class="overall-progress-header">
                <div class="overall-progress-title">📈 Overall Progress</div>
                <div class="overall-progress-percent">${overallPercentage}%</div>
            </div>
            <div class="overall-progress-bar">
                <div class="overall-progress-fill" style="width: ${overallPercentage}%"></div>
            </div>
            <div class="overall-progress-stats">
                <div class="overall-stat"><span class="overall-stat-value">${totalItems}</span> items</div>
                <div class="overall-stat"><span class="overall-stat-value">${levelCounts[4]}</span> mastered</div>
                <div class="overall-stat"><span class="overall-stat-value">${levelCounts[3]}</span> confident</div>
            </div>
        </div>
        
        <div class="card" style="margin-bottom: var(--space-3);">
            <div class="card-title" style="margin-bottom: var(--space-2);">Level Distribution</div>
            <div class="level-distribution">${levelDistributionHtml}</div>
            <div class="level-distribution-legend">
                ${levelCounts.map((count, i) => count > 0 ? `
                    <div class="level-legend-item">
                        <span class="level-legend-dot" data-level="${i + 1}"></span>
                        <span>${emojis[i]} ${count}</span>
                    </div>
                ` : '').join('')}
            </div>
        </div>
        
        ${appState.checkins.length === 0 ? `
            <div class="empty-state">
                <div class="empty-state-icon">📋</div>
                <div class="empty-state-title">No check-ins recorded</div>
                <p class="empty-state-desc">Start a check-in to track your progress over time.</p>
            </div>
        ` : `
            <div class="card">
                <div class="card-title">Check-in History</div>
                ${appState.checkins.slice().reverse().slice(0, 10).map(checkin => `
                    <div class="goal-item" style="border-left-color: var(--color-primary);">
                        <div class="goal-text">${checkinTypeLabels[checkin.type] || 'Check-in'}</div>
                        <div class="goal-meta">${new Date(checkin.date).toLocaleDateString()} • ${checkin.itemsReviewed || 0} items reviewed</div>
                    </div>
                `).join('')}
            </div>
        `}
    `;
}

// ============================================
// RENDERING - GOALS & QUESTIONS
// ============================================
function renderGoals() {
    const container = document.getElementById('goals-list');
    
    if (appState.goals.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">🎯</div>
                <div class="empty-state-title">No goals set</div>
                <p class="empty-state-desc">Set goals to help focus your learning!</p>
            </div>
        `;
    } else {
        container.innerHTML = appState.goals.map((goal, index) => `
            <div class="goal-item" data-index="${index}">
                <div class="goal-text">${escapeHtml(goal.text)}</div>
                <div class="goal-meta">
                    Added ${new Date(goal.created).toLocaleDateString()}
                    <button class="btn btn-sm btn-secondary" style="padding: 2px 8px; margin-left: 8px;" onclick="deleteGoal(${index})">×</button>
                </div>
            </div>
        `).join('');
    }
}

function renderQuestions() {
    const container = document.getElementById('questions-list');
    
    if (appState.questions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p class="empty-state-desc">No questions yet. If you're stuck, ask here!</p>
            </div>
        `;
    } else {
        container.innerHTML = appState.questions.map((question, index) => `
            <div class="goal-item" style="border-left-color: var(--color-info);" data-index="${index}">
                <div class="goal-text">${escapeHtml(question.text)}</div>
                <div class="goal-meta">
                    ${question.context ? `About: ${escapeHtml(question.context)} • ` : ''}
                    ${new Date(question.created).toLocaleDateString()}
                    <button class="btn btn-sm btn-secondary" style="padding: 2px 8px; margin-left: 8px;" onclick="deleteQuestion(${index})">×</button>
                </div>
            </div>
        `).join('');
    }
}

function renderDataSummary() {
    const container = document.getElementById('data-summary');
    if (!container) return;
    
    const stats = calculateStats();
    
    container.innerHTML = `
        <div class="stat-row">
            <span class="stat-label">Current topic</span>
            <span class="stat-value">${appState.topic?.name || 'None'}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Learning items</span>
            <span class="stat-value">${stats.total}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Check-ins completed</span>
            <span class="stat-value">${appState.checkins.length}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Goals set</span>
            <span class="stat-value">${appState.goals.length}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Questions asked</span>
            <span class="stat-value">${appState.questions.length}</span>
        </div>
    `;
}

function updateBadges() {
    const goalsBadge = document.getElementById('goals-badge');
    if (goalsBadge) {
        const count = appState.goals.length + appState.questions.length;
        goalsBadge.textContent = count;
        goalsBadge.style.display = count > 0 ? 'inline' : 'none';
    }
}
// ============================================
// QUIZ STATE HELPERS
// ============================================
function getQuizStateKey(itemKey, toLevel) {
    return `${appState.currentTopicPath || 'default'}-${itemKey}-toLevel${toLevel}`;
}

function getQuizStateForItem(itemKey, toLevel) {
    const key = getQuizStateKey(itemKey, toLevel);
    if (!quizState[key]) {
        quizState[key] = {
            usedQuestions: [],
            wrongCount: 0,
            correctStreak: 0,
            requiredCorrect: 1,
            lockedUntil: null
        };
    }
    return quizState[key];
}

function isLevelLocked(itemKey, toLevel) {
    const state = getQuizStateForItem(itemKey, toLevel);
    if (state.lockedUntil) {
        if (Date.now() < state.lockedUntil) {
            return true;
        } else {
            // Lockout expired, reset
            state.usedQuestions = [];
            state.wrongCount = 0;
            state.correctStreak = 0;
            state.requiredCorrect = 1;
            state.lockedUntil = null;
            saveQuizState();
        }
    }
    return false;
}

function getLockoutRemainingTime(itemKey, toLevel) {
    const state = getQuizStateForItem(itemKey, toLevel);
    if (state.lockedUntil && Date.now() < state.lockedUntil) {
        return Math.ceil((state.lockedUntil - Date.now()) / 1000);
    }
    return 0;
}

// ============================================
// LEVEL CHANGE HANDLING
// ============================================
async function handleLevelChange(itemKey, newLevel) {
    const currentLevel = appState.learningItems[itemKey]?.level || 1;
    
    // Pre-topic check-in: allow free level changes without quizzes
    const isPreTopicCheckin = checkinModeActive && currentCheckinType === 'pre';
    
    if (newLevel > currentLevel) {
        // Moving UP - check if quiz needed (unless pre-topic check-in)
        if (isPreTopicCheckin) {
            // Pre-topic: skip quiz, allow immediate change
            applyLevelChange(itemKey, newLevel);
        } else {
            const questions = await getQuestionsForLevel(itemKey, newLevel);
            
            if (questions.length > 0) {
                // Show quiz
                showQuiz(itemKey, currentLevel, newLevel);
            } else {
                // No questions available - allow immediate change
                applyLevelChange(itemKey, newLevel);
            }
        }
    } else if (newLevel < currentLevel) {
        // Moving DOWN - allow immediately
        applyLevelChange(itemKey, newLevel);
    }
    // Same level - do nothing
}

function applyLevelChange(itemKey, level) {
    if (!appState.learningItems[itemKey]) {
        appState.learningItems[itemKey] = { level: 1, history: [], notes: [] };
    }
    
    const oldLevel = appState.learningItems[itemKey].level;
    
    if (oldLevel !== level) {
        appState.learningItems[itemKey].level = level;
        appState.learningItems[itemKey].history.push({
            date: new Date().toISOString(),
            level: level,
            previousLevel: oldLevel
        });
        
        // Update visuals immediately
        const notchContainer = document.querySelector(`.level-notches[data-item-key="${itemKey}"]`);
        if (notchContainer) {
            notchContainer.querySelectorAll('.level-notch').forEach(notch => {
                const notchLevel = parseInt(notch.dataset.level);
                notch.classList.toggle('filled', notchLevel <= level);
                notch.classList.toggle('active', notchLevel === level);
                notch.setAttribute('aria-checked', notchLevel === level);
                notch.setAttribute('tabindex', notchLevel === level ? '0' : '-1');
            });
        }
        
        // Update item border color
        const itemEl = document.querySelector(`.learning-item-simple[data-item-key="${itemKey}"]`);
        if (itemEl) {
            itemEl.dataset.level = level;
        }
        
        saveData();
        renderOverview();
        renderHistory();
    }
}

// ============================================
// QUIZ DISPLAY - MAIN ENTRY
// ============================================
async function showQuiz(itemKey, fromLevel, toLevel) {
    const item = getItemByKey(itemKey);
    if (!item) return false;
    
    const questions = await getQuestionsForLevel(itemKey, toLevel);
    if (questions.length === 0) return false;
    
    const state = getQuizStateForItem(itemKey, toLevel);
    
    // Select a random question
    const questionData = selectRandomQuestion(questions, state);
    if (!questionData) return false;
    
    const { question, index } = questionData;
    
    // Determine question type (default to MC for backwards compatibility)
    const questionType = question.type || 'mc';
    
    // Store current quiz data
    currentQuiz = {
        itemKey,
        fromLevel,
        toLevel,
        questionIndex: index,
        question,
        questionType,
        selectedIndex: null,
        clozeAnswers: {},
        answered: false
    };
    
    // Update header UI
    document.getElementById('quiz-item-title').textContent = item.title;
    const emojis = getLevelEmojis();
    document.getElementById('quiz-from-level').innerHTML = getLevelIndicatorHtml(fromLevel, true);
    document.getElementById('quiz-to-level').innerHTML = getLevelIndicatorHtml(toLevel, true);
    
    // Show streak info if required > 1
    const streakInfo = document.getElementById('quiz-streak-info');
    if (state.requiredCorrect > 1) {
        streakInfo.style.display = 'block';
        document.getElementById('quiz-streak-text').textContent = 
            `You need ${state.requiredCorrect} correct answer${state.requiredCorrect > 1 ? 's' : ''} to advance`;
        
        // Render progress dots
        const progressContainer = document.getElementById('quiz-streak-progress');
        let dotsHtml = '';
        for (let i = 0; i < state.requiredCorrect; i++) {
            const filled = i < state.correctStreak;
            dotsHtml += `<span class="quiz-streak-dot ${filled ? 'filled' : ''}"></span>`;
        }
        progressContainer.innerHTML = dotsHtml;
    } else {
        streakInfo.style.display = 'none';
    }
    
    // Render based on question type
    if (questionType === 'cloze') {
        renderClozeQuestion(question);
    } else {
        renderMCQuestion(question);
    }
    
    // Reset result section
    document.getElementById('quiz-result').classList.remove('visible', 'correct', 'incorrect');
    document.getElementById('cloze-feedback').style.display = 'none';
    document.getElementById('quiz-submit-btn').disabled = true;
    document.getElementById('quiz-submit-btn').textContent = 'Check Answer';
    document.getElementById('quiz-cancel-btn').style.display = '';
    document.getElementById('quiz-cancel-btn-footer').style.display = '';
    
    // Show overlay
    document.getElementById('quiz-overlay').classList.add('active');
    
    return true;
}

function selectRandomQuestion(questions, state) {
    if (questions.length === 0) return null;
    
    // Find unused questions
    let availableIndices = [];
    for (let i = 0; i < questions.length; i++) {
        if (!state.usedQuestions.includes(i)) {
            availableIndices.push(i);
        }
    }
    
    // If all used, reshuffle
    if (availableIndices.length === 0) {
        state.usedQuestions = [];
        availableIndices = questions.map((_, i) => i);
        saveQuizState();
    }
    
    // Pick random
    const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
    return { question: questions[randomIndex], index: randomIndex };
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

// ============================================
// MC QUESTION RENDERING
// ============================================
function renderMCQuestion(question) {
    // Hide cloze, show MC
    document.getElementById('cloze-sentence').style.display = 'none';
    document.getElementById('quiz-options').style.display = 'flex';
    
    // Set question text
    document.getElementById('quiz-question-text').textContent = question.question;
    
    // Build options array
    const options = [
        { text: question.correct, isCorrect: true, explanation: question.correctExplanation || 'That is correct.' }
    ];
    
    question.distractors.forEach(d => {
        if (typeof d === 'string') {
            options.push({ text: d, isCorrect: false, explanation: '' });
        } else {
            options.push({ text: d.answer, isCorrect: false, explanation: d.explanation || '' });
        }
    });
    
    // Shuffle options
    const shuffledOptions = shuffleArray(options);
    currentQuiz.options = shuffledOptions;
    
    // Render options
    const optionsContainer = document.getElementById('quiz-options');
    optionsContainer.innerHTML = shuffledOptions.map((opt, i) => `
        <button class="quiz-option" data-index="${i}">
            <span class="quiz-option-marker">${String.fromCharCode(65 + i)}</span>
            <span class="quiz-option-text">${escapeHtml(opt.text)}</span>
        </button>
    `).join('');
    
    // Add click listeners
    optionsContainer.querySelectorAll('.quiz-option').forEach(btn => {
        btn.addEventListener('click', () => selectMCOption(parseInt(btn.dataset.index)));
    });
}

function selectMCOption(index) {
    if (currentQuiz.answered) return;
    
    currentQuiz.selectedIndex = index;
    
    // Update visual selection
    document.querySelectorAll('.quiz-option').forEach((btn, i) => {
        btn.classList.toggle('selected', i === index);
    });
    
    document.getElementById('quiz-submit-btn').disabled = false;
}

// ============================================
// CLOZE QUESTION RENDERING
// ============================================
function renderClozeQuestion(question) {
    // Hide MC, show cloze
    document.getElementById('quiz-options').style.display = 'none';
    document.getElementById('cloze-sentence').style.display = 'block';
    
    // Set prompt/question text
    document.getElementById('quiz-question-text').textContent = question.prompt || 'Complete the sentence:';
    
    // Parse sentence and create dropdowns
    const sentence = question.sentence;
    const blanks = question.blanks;
    
    // Replace {{blank:id}} with select elements
    let html = escapeHtml(sentence);
    
    // Find all blank placeholders
    const blankRegex = /\{\{blank:([^}]+)\}\}/g;
    let match;
    const blankIds = [];
    
    while ((match = blankRegex.exec(sentence)) !== null) {
        blankIds.push(match[1]);
    }
    
    // Store blank data for validation
    currentQuiz.blanks = blanks;
    currentQuiz.blankIds = blankIds;
    currentQuiz.clozeAnswers = {};
    
    // Build HTML with dropdowns
    html = sentence.replace(blankRegex, (match, blankId) => {
        const blankData = blanks[blankId];
        if (!blankData) return match; // Invalid blank reference
        
        // Build options: correct + distractors, shuffled
        const options = [
            { value: blankData.correct, isCorrect: true }
        ];
        
        blankData.distractors.forEach(d => {
            if (typeof d === 'string') {
                options.push({ value: d, isCorrect: false });
            } else {
                options.push({ value: d.answer, isCorrect: false });
            }
        });
        
        const shuffledOptions = shuffleArray(options);
        
        // Store shuffled options for later validation
        currentQuiz[`blankOptions_${blankId}`] = shuffledOptions;
        
        // Create select HTML
        const optionsHtml = shuffledOptions.map(opt => 
            `<option value="${escapeHtml(opt.value)}">${escapeHtml(opt.value)}</option>`
        ).join('');
        
        return `<span class="cloze-blank"><select class="cloze-select" data-blank-id="${blankId}" aria-label="Blank ${blankId}">
            <option value="">select</option>
            ${optionsHtml}
        </select></span>`;
    });
    
    document.getElementById('cloze-sentence').innerHTML = html;
    
    // Add change listeners to dropdowns
    document.querySelectorAll('.cloze-select').forEach(select => {
        select.addEventListener('change', () => onClozeSelectChange(select));
    });
}

function onClozeSelectChange(select) {
    if (currentQuiz.answered) return;
    
    const blankId = select.dataset.blankId;
    const value = select.value;
    
    currentQuiz.clozeAnswers[blankId] = value;
    
    // Visual feedback for answered
    select.classList.toggle('answered', value !== '');
    
    // Check if all blanks filled
    const allFilled = currentQuiz.blankIds.every(id => 
        currentQuiz.clozeAnswers[id] && currentQuiz.clozeAnswers[id] !== ''
    );
    
    document.getElementById('quiz-submit-btn').disabled = !allFilled;
}

// ============================================
// QUIZ SUBMISSION
// ============================================
function submitQuizAnswer() {
    if (!currentQuiz || currentQuiz.answered) return;
    
    if (currentQuiz.questionType === 'cloze') {
        submitClozeAnswer();
    } else {
        submitMCAnswer();
    }
}

function submitMCAnswer() {
    if (currentQuiz.selectedIndex === null) return;
    
    currentQuiz.answered = true;
    const selectedOption = currentQuiz.options[currentQuiz.selectedIndex];
    const isCorrect = selectedOption.isCorrect;
    
    processQuizResult(isCorrect, selectedOption.explanation);
    
    // Update options visual state
    document.querySelectorAll('.quiz-option').forEach((btn, i) => {
        btn.disabled = true;
        if (currentQuiz.options[i].isCorrect) {
            btn.classList.add('correct');
        } else if (i === currentQuiz.selectedIndex) {
            btn.classList.add('incorrect');
        }
    });
}

function submitClozeAnswer() {
    // Check if all blanks filled
    const allFilled = currentQuiz.blankIds.every(id => 
        currentQuiz.clozeAnswers[id] && currentQuiz.clozeAnswers[id] !== ''
    );
    
    if (!allFilled) return;
    
    currentQuiz.answered = true;
    
    // Check each blank
    const results = [];
    let allCorrect = true;
    
    currentQuiz.blankIds.forEach(blankId => {
        const blankData = currentQuiz.blanks[blankId];
        const userAnswer = currentQuiz.clozeAnswers[blankId];
        const isCorrect = userAnswer === blankData.correct;
        
        if (!isCorrect) allCorrect = false;
        
        // Find explanation for wrong answer
        let explanation = '';
        if (isCorrect) {
            explanation = blankData.correctExplanation || 'Correct!';
        } else {
            // Find the distractor explanation
            const distractor = blankData.distractors.find(d => 
                (typeof d === 'string' ? d : d.answer) === userAnswer
            );
            if (distractor && typeof distractor === 'object') {
                explanation = distractor.explanation || '';
            }
        }
        
        results.push({
            blankId,
            userAnswer,
            correctAnswer: blankData.correct,
            isCorrect,
            explanation
        });
    });
    
    // Update dropdown visuals
    document.querySelectorAll('.cloze-select').forEach(select => {
        const blankId = select.dataset.blankId;
        const result = results.find(r => r.blankId === blankId);
        
        select.disabled = true;
        select.classList.remove('answered');
        select.classList.add(result.isCorrect ? 'correct' : 'incorrect');
    });
    
    // Show feedback for each blank
    const feedbackContainer = document.getElementById('cloze-feedback');
    feedbackContainer.style.display = 'block';
    feedbackContainer.innerHTML = results.map(result => `
        <div class="cloze-feedback-item ${result.isCorrect ? 'correct' : 'incorrect'}">
            <div class="cloze-feedback-label">
                ${result.isCorrect ? 'âœ“' : 'âœ—'} 
                ${result.isCorrect ? 'Correct' : `Incorrect - correct answer: "${escapeHtml(result.correctAnswer)}"`}
            </div>
            ${result.explanation ? `<div class="cloze-feedback-text">${escapeHtml(result.explanation)}</div>` : ''}
        </div>
    `).join('');
    
    // For cloze with scoring: "all", all must be correct
    const scoring = currentQuiz.question.scoring || 'all';
    const isCorrect = scoring === 'all' ? allCorrect : allCorrect; // Future: handle partial
    
    // Build overall explanation
    const overallExplanation = allCorrect 
        ? (currentQuiz.question.feedback?.allCorrect || 'All blanks correct!')
        : (currentQuiz.question.feedback?.partial || 'Review the feedback above.');
    
    processQuizResult(isCorrect, overallExplanation);
}

function processQuizResult(isCorrect, explanation) {
    const state = getQuizStateForItem(currentQuiz.itemKey, currentQuiz.toLevel);
    
    // Mark question as used
    if (!state.usedQuestions.includes(currentQuiz.questionIndex)) {
        state.usedQuestions.push(currentQuiz.questionIndex);
    }
    
    // Show result
    const resultEl = document.getElementById('quiz-result');
    resultEl.classList.remove('correct', 'incorrect');
    resultEl.classList.add('visible', isCorrect ? 'correct' : 'incorrect');
    
    document.getElementById('quiz-result-icon').textContent = isCorrect ? 'âœ“' : 'âœ—';
    document.getElementById('quiz-result-text').textContent = isCorrect ? 'Correct' : 'Incorrect';
    document.getElementById('quiz-result-explanation').textContent = explanation;
    
    if (isCorrect) {
        state.correctStreak++;
        state.wrongCount = 0;
        
        // Update streak dots
        const dots = document.querySelectorAll('.quiz-streak-dot');
        dots.forEach((dot, i) => {
            if (i < state.correctStreak) {
                dot.classList.add('filled');
            }
        });
        
        // Check if earned the level
        if (state.correctStreak >= state.requiredCorrect) {
            // Success! Capture values before closeQuiz nullifies currentQuiz
            const itemKey = currentQuiz.itemKey;
            const toLevel = currentQuiz.toLevel;
            
            document.getElementById('quiz-submit-btn').textContent = 'Continue';
            document.getElementById('quiz-submit-btn').disabled = false;
            document.getElementById('quiz-submit-btn').onclick = () => {
                closeQuiz();
                applyLevelChange(itemKey, toLevel);
                // Reset state
                state.usedQuestions = [];
                state.wrongCount = 0;
                state.correctStreak = 0;
                state.requiredCorrect = 1;
                saveQuizState();
            };
            document.getElementById('quiz-cancel-btn').style.display = 'none';
            document.getElementById('quiz-cancel-btn-footer').style.display = 'none';
        } else {
            // Need more correct - capture values before closeQuiz nullifies currentQuiz
            const itemKey = currentQuiz.itemKey;
            const fromLevel = currentQuiz.fromLevel;
            const toLevel = currentQuiz.toLevel;
            
            document.getElementById('quiz-submit-btn').textContent = 'Next Question';
            document.getElementById('quiz-submit-btn').disabled = false;
            document.getElementById('quiz-submit-btn').onclick = () => {
                saveQuizState();
                closeQuiz();
                setTimeout(() => {
                    showQuiz(itemKey, fromLevel, toLevel);
                }, 100);
            };
        }
    } else {
        state.wrongCount++;
        state.correctStreak = 0;
        
        if (state.wrongCount >= 3) {
            // Lockout
            state.lockedUntil = Date.now() + QUIZ_LOCKOUT_DURATION;
            state.usedQuestions = [];
            state.requiredCorrect = 1;
            
            document.getElementById('quiz-result-explanation').textContent = 
                explanation + '\n\nThis level is now locked for 5 minutes. Take some time to review this concept.';
            
            document.getElementById('quiz-submit-btn').textContent = 'Close';
            document.getElementById('quiz-submit-btn').disabled = false;
            document.getElementById('quiz-submit-btn').onclick = () => {
                saveQuizState();
                closeQuiz();
                renderLearningContent(); // Re-render to show locked state
            };
            document.getElementById('quiz-cancel-btn').style.display = 'none';
            document.getElementById('quiz-cancel-btn-footer').style.display = 'none';
        } else {
            // Increase required
            state.requiredCorrect = state.wrongCount + 1;
            
            document.getElementById('quiz-submit-btn').textContent = 'Try Again';
            document.getElementById('quiz-submit-btn').disabled = false;
            document.getElementById('quiz-submit-btn').onclick = () => {
                saveQuizState();
                closeQuiz();
            };
        }
    }
    
    saveQuizState();
}

function closeQuiz() {
    document.getElementById('quiz-overlay').classList.remove('active');
    currentQuiz = null;
    
    // Clear custom onclick handler - addEventListener handles default submission
    document.getElementById('quiz-submit-btn').onclick = null;
}

// ============================================
// THEME
// ============================================
function applyTheme(theme) {
    appState.theme = theme;
    document.documentElement.setAttribute('data-theme', theme);
    const toggle = document.getElementById('dark-mode-toggle');
    if (toggle) {
        toggle.checked = (theme === 'dark');
    }
}

function toggleTheme() {
    const toggle = document.getElementById('dark-mode-toggle');
    applyTheme(toggle && toggle.checked ? 'dark' : 'light');
    saveData();
}

// ============================================
// FIRST RUN WELCOME & TIPS
// ============================================

/**
 * Check if this is the first run and show welcome dialog
 */
function checkFirstRun() {
    const firstRunComplete = localStorage.getItem(FIRST_RUN_KEY);
    if (!firstRunComplete) {
        showWelcomeDialog();
    }
}

/**
 * Show the welcome dialog
 */
function showWelcomeDialog() {
    const overlay = document.getElementById('welcome-overlay');
    if (overlay) {
        // Reset to first page
        document.getElementById('welcome-page-1')?.classList.add('active');
        document.getElementById('welcome-page-2')?.classList.remove('active');
        
        // Populate fields with existing data if available
        const welcomeNameInput = document.getElementById('welcome-name-input');
        const welcomeClassInput = document.getElementById('welcome-class-input');
        if (welcomeNameInput) welcomeNameInput.value = appState.student.name || '';
        if (welcomeClassInput) welcomeClassInput.value = appState.student.class || '';
        
        overlay.classList.add('active');
    }
}

/**
 * Hide the welcome dialog and mark first run as complete
 */
function hideWelcomeDialog() {
    // Save user info from welcome form
    const welcomeNameInput = document.getElementById('welcome-name-input');
    const welcomeClassInput = document.getElementById('welcome-class-input');
    
    if (welcomeNameInput && welcomeNameInput.value.trim()) {
        appState.student.name = welcomeNameInput.value.trim();
    }
    if (welcomeClassInput && welcomeClassInput.value.trim()) {
        appState.student.class = welcomeClassInput.value.trim();
    }
    
    // Sync with settings inputs
    const settingsNameInput = document.getElementById('student-name-input');
    const settingsClassInput = document.getElementById('class-input');
    if (settingsNameInput) settingsNameInput.value = appState.student.name || '';
    if (settingsClassInput) settingsClassInput.value = appState.student.class || '';
    
    // Save and update display
    saveData();
    renderStudentInfo();
    
    // Hide overlay
    const overlay = document.getElementById('welcome-overlay');
    if (overlay) {
        overlay.classList.remove('active');
    }
    localStorage.setItem(FIRST_RUN_KEY, 'true');
    
    // Start the selection tip timer after welcome is closed
    scheduleSelectionTip();
}

/**
 * Navigate to the next welcome page (tutorial)
 */
function showWelcomeTutorial() {
    document.getElementById('welcome-page-1')?.classList.remove('active');
    document.getElementById('welcome-page-2')?.classList.add('active');
}

/**
 * Navigate back to the first welcome page
 */
function showWelcomeIntro() {
    document.getElementById('welcome-page-2')?.classList.remove('active');
    document.getElementById('welcome-page-1')?.classList.add('active');
}

/**
 * Schedule the selection tip to show after 3 minutes
 */
function scheduleSelectionTip() {
    const tipShown = localStorage.getItem(SELECTION_TIP_KEY);
    if (tipShown) return;
    
    setTimeout(() => {
        showSelectionTip();
    }, SELECTION_TIP_DELAY);
}

/**
 * Show the selection tip toast
 */
function showSelectionTip() {
    const tipShown = localStorage.getItem(SELECTION_TIP_KEY);
    if (tipShown) return;
    
    // Create a longer-lasting toast for the tip
    const container = document.getElementById('toast-container');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = 'toast info selection-tip-toast';
    toast.innerHTML = `
        <span>💡</span>
        <span>Tip: Select any text in the learning content to quickly ask your teacher, search Google, or ask AI about it.</span>
    `;
    
    container.appendChild(toast);
    
    // Mark as shown
    localStorage.setItem(SELECTION_TIP_KEY, 'true');
    
    // Remove after 8 seconds (longer than normal toasts)
    setTimeout(() => {
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 200);
    }, 8000);
}

// ============================================
// LEVEL PREFERENCES
// ============================================

/**
 * Load level preferences from localStorage
 */
function loadLevelPrefs() {
    try {
        const saved = localStorage.getItem(LEVEL_PREFS_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            levelPrefs.displayMode = parsed.displayMode || 'emoji';
            levelPrefs.emojiProgression = parsed.emojiProgression || 0;
            levelPrefs.colors = parsed.colors || [...defaultLevelColors];
        }
    } catch (e) {
        console.warn('Failed to load level preferences:', e);
    }
    // Update the levelEmojis variable for compatibility
    levelEmojis = getLevelEmojis();
}

/**
 * Save level preferences to localStorage
 */
function saveLevelPrefs() {
    try {
        localStorage.setItem(LEVEL_PREFS_KEY, JSON.stringify(levelPrefs));
    } catch (e) {
        console.warn('Failed to save level preferences:', e);
    }
}

/**
 * Apply level colors to CSS custom properties
 */
function applyLevelColors() {
    const root = document.documentElement;
    levelPrefs.colors.forEach((color, i) => {
        root.style.setProperty(`--level-${i + 1}`, color);
        // Also set light versions (for backgrounds)
        root.style.setProperty(`--level-${i + 1}-light`, color + '20'); // 20 = ~12% opacity in hex
    });
}

/**
 * Update the level preferences UI to match current state
 */
function updateLevelPrefsUI() {
    // Update display mode selection
    document.querySelectorAll('.level-display-option').forEach(opt => {
        const mode = opt.dataset.mode;
        const input = opt.querySelector('input');
        if (mode === levelPrefs.displayMode) {
            opt.classList.add('active');
            if (input) input.checked = true;
        } else {
            opt.classList.remove('active');
            if (input) input.checked = false;
        }
    });
    
    // Update emoji progression select
    const emojiSelect = document.getElementById('emoji-progression-select');
    if (emojiSelect) {
        emojiSelect.value = levelPrefs.emojiProgression.toString();
    }
    
    // Update color pickers
    levelPrefs.colors.forEach((color, i) => {
        const picker = document.getElementById(`level-color-${i + 1}`);
        if (picker) picker.value = color;
    });
    
    // Update preview
    updateLevelPreview();
}

/**
 * Update the level preview display
 */
function updateLevelPreview() {
    const preview = document.getElementById('level-preview');
    if (!preview) return;
    
    const emojis = getLevelEmojis();
    
    preview.innerHTML = levelNames.map((name, i) => {
        const color = levelPrefs.colors[i];
        const emoji = emojis[i];
        
        let content = '';
        if (levelPrefs.displayMode === 'dots') {
            content = `<span class="level-preview-dot" style="background: ${color}"></span>`;
        } else if (levelPrefs.displayMode === 'emoji') {
            content = `<span class="level-preview-emoji">${emoji}</span>`;
        } else { // both
            content = `<span class="level-preview-dot" style="background: ${color}"></span><span class="level-preview-emoji">${emoji}</span>`;
        }
        
        return `<div class="level-preview-item" title="${name}">${content}</div>`;
    }).join('');
}

/**
 * Render all level legends with current emoji preferences
 */
function renderLevelLegends() {
    const emojis = getLevelEmojis();
    const legendIds = ['overview-level-legend', 'learning-level-legend'];
    
    legendIds.forEach(id => {
        const legend = document.getElementById(id);
        if (!legend) return;
        
        legend.innerHTML = levelNames.map((name, i) => `
            <div class="level-legend-item">
                <span class="level-legend-dot" data-level="${i + 1}"></span>
                <span>${emojis[i]} ${name}</span>
            </div>
        `).join('');
    });
}

/**
 * Handle display mode change
 */
function onDisplayModeChange(mode) {
    levelPrefs.displayMode = mode;
    
    // Update UI
    document.querySelectorAll('.level-display-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.mode === mode);
    });
    
    saveLevelPrefs();
    updateLevelPreview();
    renderLearningContent(); // Re-render to apply change
}

/**
 * Handle emoji progression change
 */
function onEmojiProgressionChange(index) {
    levelPrefs.emojiProgression = parseInt(index);
    levelEmojis = getLevelEmojis();
    
    saveLevelPrefs();
    updateLevelPreview();
    renderLevelLegends();
    renderLearningContent();
}

/**
 * Handle color picker change
 */
function onLevelColorChange(levelIndex, color) {
    levelPrefs.colors[levelIndex] = color;
    applyLevelColors();
    saveLevelPrefs();
    updateLevelPreview();
}

/**
 * Reset colors to defaults
 */
function resetLevelColors() {
    levelPrefs.colors = [...defaultLevelColors];
    applyLevelColors();
    saveLevelPrefs();
    updateLevelPrefsUI();
    showToast('Colors reset to defaults', 'info');
}

/**
 * Generate level indicator HTML based on current preferences
 */
function getLevelIndicatorHtml(level, showLabel = false) {
    const emojis = getLevelEmojis();
    const color = levelPrefs.colors[level - 1];
    const emoji = emojis[level - 1];
    const name = levelNames[level - 1];
    
    let content = '';
    if (levelPrefs.displayMode === 'dots') {
        content = `<span class="level-indicator-dot" style="background: ${color}; width: 12px; height: 12px; border-radius: 50%; display: inline-block;"></span>`;
    } else if (levelPrefs.displayMode === 'emoji') {
        content = emoji;
    } else { // both
        content = `<span class="level-indicator-dot" style="background: ${color}; width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 4px;"></span>${emoji}`;
    }
    
    if (showLabel) {
        content += ` ${name}`;
    }
    
    return content;
}

// ============================================
// CHECK-IN MODE
// ============================================
function getWasLevel(itemKey) {
    return checkinStartLevels[itemKey] || appState.learningItems[itemKey]?.level || 1;
}

function markItemReviewed(itemKey) {
    if (!checkinModeActive) return;
    
    checkinReviewedItems.add(itemKey);
    
    // Update progress display
    const totalItems = Object.keys(checkinStartLevels).length;
    const reviewedCount = checkinReviewedItems.size;
    
    const progressText = document.getElementById('checkin-progress-text');
    if (progressText) progressText.textContent = `${reviewedCount}/${totalItems} items reviewed`;
    
    const floatingProgress = document.getElementById('checkin-floating-progress');
    if (floatingProgress) floatingProgress.textContent = `${reviewedCount}/${totalItems}`;
    
    // Mark item visually
    const itemEl = document.querySelector(`.learning-item-simple[data-item-key="${itemKey}"]`);
    if (itemEl) itemEl.classList.add('reviewed');
}

function startCheckinMode(type) {
    if (!appState.topic) {
        showToast('Please load a topic first', 'warning');
        return;
    }
    
    currentCheckinType = type;
    checkinModeActive = true;
    checkinReviewedItems.clear();
    checkinStartLevels = {};
    
    // Capture starting levels for all items
    appState.topic.subtopics.forEach(subtopic => {
        if (!subtopic.items) return;
        subtopic.items.forEach(item => {
            const itemKey = getItemKey(subtopic.id, item.id);
            const itemData = appState.learningItems[itemKey] || { level: 1 };
            checkinStartLevels[itemKey] = itemData.level;
        });
    });
    
    // Start timer (10 minutes)
    checkinStartTime = Date.now();
    updateCheckinTimer();
    checkinTimer = setInterval(updateCheckinTimer, 1000);
    
    // Show floating bar
    const floatingBar = document.getElementById('checkin-floating-bar');
    if (floatingBar) {
        floatingBar.classList.add('active');
        document.getElementById('checkin-floating-type').textContent = `${checkinTypeLabels[type]} Check-in`;
        document.getElementById('checkin-floating-progress').textContent = `0/${Object.keys(checkinStartLevels).length}`;
    }
    
    // Switch to learning tab and render
    switchTab('learning');
    renderLearningContent();
    
    showToast(`${checkinTypeLabels[type]} check-in started`, 'success');
}

function updateCheckinTimer() {
    const elapsed = Date.now() - checkinStartTime;
    const remaining = Math.max(0, 10 * 60 * 1000 - elapsed);
    
    const mins = Math.floor(remaining / 60000);
    const secs = Math.floor((remaining % 60000) / 1000);
    
    const timerEl = document.getElementById('checkin-floating-timer');
    if (timerEl) {
        timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Auto-stop after 10 minutes
    if (remaining === 0) {
        stopCheckinMode(true);
    }
}

function stopCheckinMode(autoStopped = false) {
    if (!checkinModeActive) return;
    
    // Clear timer
    if (checkinTimer) {
        clearInterval(checkinTimer);
        checkinTimer = null;
    }
    
    // Record check-in
    const checkin = {
        id: Date.now(),
        date: new Date().toISOString(),
        type: currentCheckinType,
        itemsReviewed: checkinReviewedItems.size,
        totalItems: Object.keys(checkinStartLevels).length,
        duration: Date.now() - checkinStartTime
    };
    
    appState.checkins.push(checkin);
    saveData();
    
    // Reset state
    checkinModeActive = false;
    checkinReviewedItems.clear();
    checkinStartLevels = {};
    
    // Hide floating bar
    const floatingBar = document.getElementById('checkin-floating-bar');
    if (floatingBar) floatingBar.classList.remove('active');
    
    // Re-render
    renderLearningContent();
    renderHistory();
    renderOverview();
    
    if (autoStopped) {
        showToast('Check-in time ended', 'info');
    } else {
        showToast(`Check-in completed: ${checkin.itemsReviewed} items reviewed`, 'success');
    }
}

function showCheckinStartModal() {
    if (!appState.topic) {
        showToast('Please load a topic first', 'warning');
        return;
    }
    document.getElementById('checkin-start-overlay').classList.add('active');
}

function hideCheckinStartModal() {
    document.getElementById('checkin-start-overlay').classList.remove('active');
}

// ============================================
// NAVIGATION
// ============================================
function switchTab(tabId) {
    // Update tab buttons
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.setAttribute('aria-selected', tab.id === `${tabId}-tab`);
    });
    
    // Update panels
    document.querySelectorAll('.panel-content').forEach(panel => {
        panel.classList.toggle('active', panel.id === `${tabId}-panel`);
    });
}

function navigateToLearningItem(itemKey) {
    // Switch to learning tab
    switchTab('learning');
    
    // Parse the itemKey to get subtopic and item IDs
    if (!appState.topic) return;
    
    const { subtopicId, itemId } = parseItemKey(itemKey);
    const subtopic = getSubtopicById(subtopicId);
    
    if (subtopic) {
        // Expand the subtopic
        const header = document.getElementById(`subtopic-${subtopic.id}-header`);
        if (header) {
            header.setAttribute('aria-expanded', 'true');
            const content = document.getElementById(`subtopic-${subtopic.id}-content`);
            if (content) content.classList.add('expanded');
        }
        
        // Scroll to item
        setTimeout(() => {
            const itemEl = document.querySelector(`.learning-item-simple[data-item-key="${itemKey}"]`);
            if (itemEl) {
                itemEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                itemEl.style.animation = 'none';
                itemEl.offsetHeight; // Trigger reflow
                itemEl.style.animation = 'highlightItem 1s ease-out';
            }
        }, 100);
    }
}

// ============================================
// GOALS & QUESTIONS
// ============================================
function addGoal() {
    const input = document.getElementById('new-goal-input');
    const text = input.value.trim();
    
    if (!text) {
        showToast('Please enter a goal', 'warning');
        return;
    }
    
    appState.goals.push({
        text,
        created: new Date().toISOString(),
        completed: false
    });
    
    input.value = '';
    saveData();
    renderGoals();
    updateBadges();
    showToast('Goal added', 'success');
}

function deleteGoal(index) {
    appState.goals.splice(index, 1);
    saveData();
    renderGoals();
    updateBadges();
}

function addQuestion() {
    const input = document.getElementById('new-question-input');
    const text = input.value.trim();
    
    if (!text) {
        showToast('Please enter a question', 'warning');
        return;
    }
    
    appState.questions.push({
        text,
        context: '',
        created: new Date().toISOString(),
        status: 'pending'
    });
    
    input.value = '';
    saveData();
    renderQuestions();
    updateBadges();
    showToast('Question added', 'success');
}

function deleteQuestion(index) {
    appState.questions.splice(index, 1);
    saveData();
    renderQuestions();
    updateBadges();
}

// ============================================
// EXPORT FUNCTIONS
// ============================================
function exportToPDF() {
    window.print();
}

function exportToJSON() {
    const data = {
        exportDate: new Date().toISOString(),
        student: appState.student,
        topic: appState.topic?.name,
        learningItems: appState.learningItems,
        checkins: appState.checkins,
        goals: appState.goals,
        questions: appState.questions
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `learning-progress-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('Data exported', 'success');
}

function emailReport() {
    const stats = calculateStats();
    const subject = encodeURIComponent(`Learning Progress Report - ${appState.topic?.name || 'My Progress'}`);
    const body = encodeURIComponent(`
Learning Progress Report
========================
Student: ${appState.student.name || 'Unknown'}
Topic: ${appState.topic?.name || 'Unknown'}
Date: ${new Date().toLocaleDateString()}

Overall Progress: ${stats.overallPercentage}%

Level Breakdown:
- Mastered: ${stats.mastered}
- Confident: ${stats.confident}
- Developing: ${stats.developing}
- Beginning: ${stats.beginning}
- Not Started: ${stats.notStarted}

Total Check-ins: ${appState.checkins.length}
Goals Set: ${appState.goals.length}
Questions Asked: ${appState.questions.length}
    `.trim());
    
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
}

// ============================================
// DATA MANAGEMENT
// ============================================

/**
 * Show inline confirmation for clearing topic progress
 */
function showClearTopicConfirm() {
    document.getElementById('clear-topic-action')?.classList.add('confirming');
}

/**
 * Hide inline confirmation for clearing topic progress
 */
function hideClearTopicConfirm() {
    document.getElementById('clear-topic-action')?.classList.remove('confirming');
}

/**
 * Execute clear progress for topic
 */
function executeClearProgressForTopic() {
    hideClearTopicConfirm();
    
    appState.learningItems = {};
    appState.checkins = [];
    initLearningItems();
    saveData();
    renderAll();
    showToast('Progress cleared for current topic', 'info');
}

/**
 * Show inline confirmation for clearing all data
 */
function showClearAllConfirm() {
    document.getElementById('clear-all-action')?.classList.add('confirming');
}

/**
 * Hide inline confirmation for clearing all data
 */
function hideClearAllConfirm() {
    document.getElementById('clear-all-action')?.classList.remove('confirming');
}

/**
 * Execute clear all data
 */
function executeClearAllData() {
    hideClearAllConfirm();
    
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(PROGRESS_STORE_KEY);
    localStorage.removeItem(QUIZ_STATE_KEY);
    localStorage.removeItem(DROPDOWN_SELECTION_KEY);
    localStorage.removeItem(TOPIC_AVAILABILITY_KEY);
    localStorage.removeItem(LEVEL_PREFS_KEY);
    localStorage.removeItem(FIRST_RUN_KEY);
    localStorage.removeItem(SELECTION_TIP_KEY);
    
    // Reset state
    appState = {
        student: { name: '', class: '' },
        topic: null,
        currentTopicId: null,
        currentTopicPath: null,
        learningItems: {},
        checkins: [],
        goals: [],
        questions: [],
        theme: 'light',
        lastSaved: null
    };
    
    topicProgressStore = {};
    quizState = {};
    questionsCache = {};
    topicAvailabilityCache = {};
    levelPrefs = {
        displayMode: 'emoji',
        emojiProgression: 0,
        colors: [...defaultLevelColors]
    };
    
    // Reset level preferences UI
    applyLevelColors();
    updateLevelPrefsUI();
    
    renderAll();
    showToast('All data cleared', 'info');
}

// ============================================
// DEBUG FUNCTIONS
// ============================================

/**
 * Debug: Randomly increment learning item levels (triggered by q+w+e)
 */
function debugRandomizeLevels() {
    if (!appState.topic || Object.keys(appState.learningItems).length === 0) {
        showToast('No topic loaded for debug', 'warning');
        return;
    }
    
    const itemKeys = Object.keys(appState.learningItems);
    let changedCount = 0;
    
    // Randomly increment some items
    itemKeys.forEach(itemKey => {
        // ~40% chance to change each item
        if (Math.random() < 0.4) {
            const currentLevel = appState.learningItems[itemKey].level;
            if (currentLevel < 5) {
                // Random increment: 1 step (70%) or 2 steps (30%)
                const increment = Math.random() < 0.7 ? 1 : 2;
                const newLevel = Math.min(5, currentLevel + increment);
                
                appState.learningItems[itemKey].level = newLevel;
                appState.learningItems[itemKey].history.push({
                    date: new Date().toISOString(),
                    from: currentLevel,
                    to: newLevel,
                    reason: 'debug'
                });
                changedCount++;
            }
        }
    });
    
    if (changedCount > 0) {
        saveData();
        renderAll();
        showToast(`Debug: ${changedCount} items randomized`, 'info');
    } else {
        showToast('Debug: No changes made', 'info');
    }
}

/**
 * Debug: Select the correct answer in the current quiz
 */
function debugSelectCorrectAnswer() {
    if (!currentQuiz || currentQuiz.answered) return;
    
    if (currentQuiz.questionType === 'cloze') {
        // For cloze questions, select correct option for each blank
        currentQuiz.blankIds.forEach(blankId => {
            const options = currentQuiz[`blankOptions_${blankId}`];
            const correctOption = options.find(opt => opt.isCorrect);
            if (correctOption) {
                const select = document.querySelector(`.cloze-select[data-blank-id="${blankId}"]`);
                if (select) {
                    select.value = correctOption.value;
                    onClozeSelectChange(select);
                }
            }
        });
        showToast('Debug: Correct answers selected', 'info');
    } else {
        // For MC questions, find and select the correct option
        const correctIndex = currentQuiz.options.findIndex(opt => opt.isCorrect);
        if (correctIndex !== -1) {
            selectMCOption(correctIndex);
            showToast('Debug: Correct answer selected', 'info');
        }
    }
}

/**
 * Debug: Select a random wrong answer in the current quiz
 */
function debugSelectWrongAnswer() {
    if (!currentQuiz || currentQuiz.answered) return;
    
    if (currentQuiz.questionType === 'cloze') {
        // For cloze questions, select a wrong option for each blank
        currentQuiz.blankIds.forEach(blankId => {
            const options = currentQuiz[`blankOptions_${blankId}`];
            const wrongOptions = options.filter(opt => !opt.isCorrect);
            if (wrongOptions.length > 0) {
                const randomWrong = wrongOptions[Math.floor(Math.random() * wrongOptions.length)];
                const select = document.querySelector(`.cloze-select[data-blank-id="${blankId}"]`);
                if (select) {
                    select.value = randomWrong.value;
                    onClozeSelectChange(select);
                }
            }
        });
        showToast('Debug: Wrong answers selected', 'info');
    } else {
        // For MC questions, find and select a random wrong option
        const wrongIndices = currentQuiz.options
            .map((opt, i) => opt.isCorrect ? -1 : i)
            .filter(i => i !== -1);
        
        if (wrongIndices.length > 0) {
            const randomIndex = wrongIndices[Math.floor(Math.random() * wrongIndices.length)];
            selectMCOption(randomIndex);
            showToast('Debug: Wrong answer selected', 'info');
        }
    }
}

// ============================================
// TEXT SELECTION POPUP
// ============================================
function initSelectionPopup() {
    selectionPopup = document.getElementById('selection-popup');
    
    // Selection event
    document.addEventListener('mouseup', handleTextSelection);
    
    // Hide popup when clicking elsewhere
    document.addEventListener('mousedown', (e) => {
        if (!selectionPopup.contains(e.target)) {
            hideSelectionPopup();
        }
    });
    
    // Hide on scroll
    document.addEventListener('scroll', hideSelectionPopup, true);
    
    // Button handlers
    document.getElementById('popup-teacher-btn').addEventListener('click', () => {
        const text = window.getSelection().toString().trim();
        handleTeacherQuestion(text, getSelectionContext());
        hideSelectionPopup();
    });
    
    document.getElementById('popup-google-btn').addEventListener('click', () => {
        const text = window.getSelection().toString().trim();
        handleGoogleSearch(text, getSelectionContext());
        hideSelectionPopup();
    });
    
    document.getElementById('popup-chatgpt-btn').addEventListener('click', () => {
        const text = window.getSelection().toString().trim();
        handleChatGPT(text, getSelectionContext());
        hideSelectionPopup();
    });
}

function handleTextSelection(e) {
    if (selectionTimeout) {
        clearTimeout(selectionTimeout);
        selectionTimeout = null;
    }
    
    const selection = window.getSelection();
    const selectedText = selection.toString().trim();
    
    if (selectedText.length < 3) return;
    if (selectionPopup.contains(e.target)) return;
    
    // Check if in learning content
    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer;
    const element = container.nodeType === Node.ELEMENT_NODE ? container : container.parentElement;
    
    if (!element) return;
    
    const isInLearningTitle = element.closest('.learning-item-title');
    const isInHelpContent = element.closest('.help-content-inline');
    const isInSubtopicExplanation = element.closest('.explanation-content');
    
    if (!isInLearningTitle && !isInHelpContent && !isInSubtopicExplanation) return;
    
    // Show popup after delay
    selectionTimeout = setTimeout(() => {
        const currentSelection = window.getSelection();
        const currentText = currentSelection.toString().trim();
        
        if (currentText.length >= 3 && currentText === selectedText) {
            showSelectionPopup(currentSelection);
        }
    }, 1000);
}

function showSelectionPopup(selection) {
    if (!selection.rangeCount) return;
    
    const range = selection.getRangeAt(0);
    const rect = range.getBoundingClientRect();
    
    selectionPopup.style.display = 'flex';
    
    const popupRect = selectionPopup.getBoundingClientRect();
    let left = rect.left + (rect.width / 2) - (popupRect.width / 2);
    left = Math.max(8, Math.min(left, window.innerWidth - popupRect.width - 8));
    
    const spaceBelow = window.innerHeight - rect.bottom;
    let top;
    if (spaceBelow > popupRect.height + 10) {
        top = rect.bottom + window.scrollY + 8;
    } else {
        top = rect.top + window.scrollY - popupRect.height - 8;
    }
    
    selectionPopup.style.left = `${left}px`;
    selectionPopup.style.top = `${top}px`;
}

function hideSelectionPopup() {
    if (selectionPopup) selectionPopup.style.display = 'none';
    if (selectionTimeout) {
        clearTimeout(selectionTimeout);
        selectionTimeout = null;
    }
}

function getSelectionContext() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return null;
    
    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer;
    const itemEl = container.nodeType === Node.ELEMENT_NODE 
        ? container.closest('.learning-item-simple')
        : container.parentElement?.closest('.learning-item-simple');
    
    if (!itemEl) return { topic: appState.topic?.name || 'Unknown topic' };
    
    const itemKey = itemEl.dataset.itemKey;
    const item = getItemByKey(itemKey);
    const itemData = appState.learningItems[itemKey] || { level: 1 };
    
    return {
        itemKey,
        itemTitle: item?.title || 'Unknown item',
        itemWhat: item?.what || '',
        itemWhy: item?.why || '',
        itemExample: item?.example || '',
        level: itemData.level,
        levelName: levelNames[itemData.level - 1],
        topic: appState.topic?.name || 'Unknown topic',
        subject: appState.topic?.subject || '',
        yearLevel: appState.topic?.yearLevel || ''
    };
}

function handleTeacherQuestion(selectedText, context) {
    switchTab('goals');
    
    let questionText = `I need help understanding: "${selectedText}"`;
    if (context?.itemTitle) {
        questionText += `\n\n(This is about: ${context.itemTitle})`;
    }
    
    appState.questions.push({
        text: questionText,
        context: context?.itemTitle || '',
        created: new Date().toISOString(),
        status: 'pending'
    });
    
    saveData();
    renderQuestions();
    updateBadges();
    showToast('Question added for your teacher!', 'success');
}

function handleGoogleSearch(selectedText, context) {
    let query = `please explain "${selectedText}"`;
    if (context?.subject) query += ` ${context.subject}`;
    if (context?.yearLevel) query += ` ${context.yearLevel}`;
    
    window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
}

function handleChatGPT(selectedText, context) {
    let prompt = `I'm a student studying ${context?.subject || 'this topic'} at ${context?.yearLevel || 'school'} level.\n\n`;
    prompt += `I need help understanding: "${selectedText}"\n\n`;
    
    if (context?.topic) prompt += `Topic: ${context.topic}\n`;
    if (context?.itemTitle) prompt += `Learning goal: ${context.itemTitle}\n`;
    if (context?.levelName) prompt += `My current level: ${context.levelName}\n`;
    
    prompt += `\nPlease help me understand this by:\n1. Explaining it simply\n2. Giving me a clear example\n3. Asking me a question to check my understanding`;
    
    if (context?.itemWhat || context?.itemWhy || context?.itemExample) {
        prompt += `\n\nContext:\n`;
        if (context.itemWhat) prompt += `What: ${context.itemWhat}\n`;
        if (context.itemWhy) prompt += `Why: ${context.itemWhy}\n`;
        if (context.itemExample) prompt += `Example: ${context.itemExample}\n`;
    }
    
    window.open(`https://chatgpt.com/?prompt=${encodeURIComponent(prompt)}`, '_blank');
}

// ============================================
// EVENT LISTENERS SETUP
// ============================================
function setupEventListeners() {
    // Navigation tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.id.replace('-tab', '');
            switchTab(tabId);
        });
    });
    
    // Welcome dialog
    document.getElementById('welcome-start-btn')?.addEventListener('click', hideWelcomeDialog);
    document.getElementById('welcome-skip-btn')?.addEventListener('click', hideWelcomeDialog);
    document.getElementById('welcome-next-btn')?.addEventListener('click', showWelcomeTutorial);
    document.getElementById('welcome-back-btn')?.addEventListener('click', showWelcomeIntro);
    
    // Show welcome from utility tab
    document.getElementById('show-welcome-btn')?.addEventListener('click', showWelcomeDialog);
    
    // Dropdown changes
    document.getElementById('year-level-dropdown')?.addEventListener('change', onYearLevelChange);
    document.getElementById('subject-dropdown')?.addEventListener('change', onSubjectChange);
    document.getElementById('topic-dropdown')?.addEventListener('change', onTopicChange);
    
    // Topic refresh button
    document.getElementById('refresh-topics-btn')?.addEventListener('click', async (e) => {
        const btn = e.target;
        btn.classList.add('refreshing');
        btn.disabled = true;
        await refreshTopicAvailability();
        btn.classList.remove('refreshing');
        btn.disabled = false;
    });
    
    // Header buttons
    document.getElementById('new-checkin-btn')?.addEventListener('click', showCheckinStartModal);
    
    // Check-in modals
    document.getElementById('start-checkin-btn')?.addEventListener('click', showCheckinStartModal);
    document.getElementById('checkin-start-cancel')?.addEventListener('click', hideCheckinStartModal);
    document.getElementById('checkin-start-cancel-btn')?.addEventListener('click', hideCheckinStartModal);
    document.getElementById('checkin-start-confirm-btn')?.addEventListener('click', () => {
        const activeType = document.querySelector('.checkin-type-btn.active');
        const type = activeType?.dataset.type || 'weekly';
        hideCheckinStartModal();
        startCheckinMode(type);
    });
    
    // Check-in type selection
    document.querySelectorAll('.checkin-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.checkin-type-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });
    });
    
    // Floating bar stop
    document.getElementById('checkin-floating-stop')?.addEventListener('click', () => stopCheckinMode(false));
    
    // Quiz modal
    document.getElementById('quiz-submit-btn')?.addEventListener('click', submitQuizAnswer);
    document.getElementById('quiz-cancel-btn')?.addEventListener('click', closeQuiz);
    document.getElementById('quiz-cancel-btn-footer')?.addEventListener('click', closeQuiz);
    
    // Goals & Questions
    document.getElementById('add-goal-btn')?.addEventListener('click', addGoal);
    document.getElementById('add-question-btn')?.addEventListener('click', addQuestion);
    
    document.getElementById('new-goal-input')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            addGoal();
        }
    });
    
    document.getElementById('new-question-input')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            addQuestion();
        }
    });
    
    // Settings
    document.getElementById('dark-mode-toggle')?.addEventListener('change', toggleTheme);
    document.getElementById('student-name-input')?.addEventListener('change', (e) => {
        appState.student.name = e.target.value;
        saveData();
        renderStudentInfo();
    });
    document.getElementById('class-input')?.addEventListener('change', (e) => {
        appState.student.class = e.target.value;
        saveData();
    });
    
    // Level preferences - display mode
    document.querySelectorAll('.level-display-option').forEach(opt => {
        opt.addEventListener('click', () => {
            const mode = opt.dataset.mode;
            onDisplayModeChange(mode);
        });
    });
    
    // Level preferences - emoji progression
    document.getElementById('emoji-progression-select')?.addEventListener('change', (e) => {
        onEmojiProgressionChange(e.target.value);
    });
    
    // Level preferences - color pickers
    for (let i = 1; i <= 5; i++) {
        document.getElementById(`level-color-${i}`)?.addEventListener('input', (e) => {
            onLevelColorChange(i - 1, e.target.value);
        });
    }
    
    // Level preferences - reset colors
    document.getElementById('reset-colors-btn')?.addEventListener('click', resetLevelColors);
    
    // Data management - inline confirmations
    document.getElementById('clear-progress-btn')?.addEventListener('click', showClearTopicConfirm);
    document.getElementById('clear-topic-cancel')?.addEventListener('click', hideClearTopicConfirm);
    document.getElementById('clear-topic-delete')?.addEventListener('click', executeClearProgressForTopic);
    
    document.getElementById('clear-all-btn')?.addEventListener('click', showClearAllConfirm);
    document.getElementById('clear-all-cancel')?.addEventListener('click', hideClearAllConfirm);
    document.getElementById('clear-all-delete')?.addEventListener('click', executeClearAllData);
    
    // Export
    document.getElementById('export-pdf-btn')?.addEventListener('click', exportToPDF);
    document.getElementById('export-json-btn')?.addEventListener('click', exportToJSON);
    document.getElementById('email-report-btn')?.addEventListener('click', emailReport);
    
    // Expand/Collapse all
    document.getElementById('expand-all-btn')?.addEventListener('click', () => {
        document.querySelectorAll('.topic-header').forEach(h => {
            h.setAttribute('aria-expanded', 'true');
            document.getElementById(h.getAttribute('aria-controls'))?.classList.add('expanded');
        });
    });
    
    document.getElementById('collapse-all-btn')?.addEventListener('click', () => {
        document.querySelectorAll('.topic-header').forEach(h => {
            h.setAttribute('aria-expanded', 'false');
            document.getElementById(h.getAttribute('aria-controls'))?.classList.remove('expanded');
        });
    });
    
    // Keyboard shortcuts
    const debugKeysPressed = { q: false, w: false, e: false, a: false, s: false, d: false };
    
    document.addEventListener('keydown', (e) => {
        // Track debug keys
        if (e.key === 'q') debugKeysPressed.q = true;
        if (e.key === 'w') debugKeysPressed.w = true;
        if (e.key === 'e') debugKeysPressed.e = true;
        if (e.key === 'a') debugKeysPressed.a = true;
        if (e.key === 's') debugKeysPressed.s = true;
        if (e.key === 'd') debugKeysPressed.d = true;
        
        // Check if quiz is active
        const quizActive = document.getElementById('quiz-overlay')?.classList.contains('active');
        
        // Check for q+w+e combo
        if (debugKeysPressed.q && debugKeysPressed.w && debugKeysPressed.e) {
            e.preventDefault();
            if (quizActive) {
                debugSelectCorrectAnswer();
            } else {
                debugRandomizeLevels();
            }
            // Reset to prevent repeated triggers
            debugKeysPressed.q = false;
            debugKeysPressed.w = false;
            debugKeysPressed.e = false;
        }
        
        // Check for a+s+d combo (wrong answer in quiz)
        if (debugKeysPressed.a && debugKeysPressed.s && debugKeysPressed.d) {
            e.preventDefault();
            if (quizActive) {
                debugSelectWrongAnswer();
            }
            // Reset to prevent repeated triggers
            debugKeysPressed.a = false;
            debugKeysPressed.s = false;
            debugKeysPressed.d = false;
        }
    });
    
    document.addEventListener('keyup', (e) => {
        if (e.key === 'q') debugKeysPressed.q = false;
        if (e.key === 'w') debugKeysPressed.w = false;
        if (e.key === 'e') debugKeysPressed.e = false;
        if (e.key === 'a') debugKeysPressed.a = false;
        if (e.key === 's') debugKeysPressed.s = false;
        if (e.key === 'd') debugKeysPressed.d = false;
    });
}

// ============================================
// INITIALIZATION
// ============================================
async function init() {
    console.log('Dynamic Learning Check List v2.0.0 initializing...');
    
    // Load saved data
    loadData();
    loadQuizState();
    loadAvailabilityCache();
    loadLevelPrefs();
    
    // Setup event listeners
    setupEventListeners();
    
    // Initialize selection popup
    initSelectionPopup();
    
    // Apply theme
    applyTheme(appState.theme);
    
    // Apply level preferences
    applyLevelColors();
    updateLevelPrefsUI();
    
    // Load manifest
    await loadManifest();
    
    // Render everything
    renderAll();
    updateTopicCurrentDisplay();
    
    // Check for first run or schedule selection tip
    const firstRunComplete = localStorage.getItem(FIRST_RUN_KEY);
    if (!firstRunComplete) {
        showWelcomeDialog();
    } else {
        // Not first run - schedule selection tip if not shown yet
        scheduleSelectionTip();
    }
    
    console.log('Initialization complete');
}

// Start when DOM is ready
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
