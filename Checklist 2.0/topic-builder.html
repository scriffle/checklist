<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topic Builder - Dynamic Learning Check-in</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
/* ============================================
   CSS VARIABLES & RESET
   ============================================ */
:root {
    /* Colors */
    --color-primary: #2d9d78;
    --color-primary-dark: #1e7d5e;
    --color-primary-pale: #e8f5f0;
    
    --color-bg: #f8faf9;
    --color-bg-card: #ffffff;
    --color-bg-warm: #f5f7f6;
    --color-bg-hover: rgba(45, 157, 120, 0.08);
    
    --color-text: #1a2e28;
    --color-text-secondary: #4a5f58;
    --color-text-muted: #7a8f88;
    --color-text-inverse: #ffffff;
    
    --color-border: #d4ddd9;
    --color-border-light: #e8eeeb;
    
    --color-success: #22c55e;
    --color-warning: #f59e0b;
    --color-error: #ef4444;
    
    /* Typography */
    --font-display: 'Segoe UI', system-ui, -apple-system, sans-serif;
    --font-body: 'Segoe UI', system-ui, -apple-system, sans-serif;
    --font-mono: 'SF Mono', 'Consolas', 'Monaco', monospace;
    
    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    
    /* Spacing */
    --space-1: 0.25rem;
    --space-2: 0.5rem;
    --space-3: 0.75rem;
    --space-4: 1rem;
    --space-5: 1.5rem;
    --space-6: 2rem;
    
    /* Borders & Shadows */
    --radius-sm: 6px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
    --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
    
    /* Transitions */
    --transition-fast: 0.15s ease;
    --transition-normal: 0.25s ease;
}

/* Dark Mode */
[data-theme="dark"] {
    --color-bg: #0f1714;
    --color-bg-card: #1a2420;
    --color-bg-warm: #1f2d28;
    --color-bg-hover: rgba(45, 157, 120, 0.15);
    
    --color-text: #e8f0ed;
    --color-text-secondary: #a8b8b2;
    --color-text-muted: #6a7a74;
    
    --color-border: #2d3d36;
    --color-border-light: #243029;
    
    --color-primary-pale: rgba(45, 157, 120, 0.2);
}

/* Reset */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
}

body {
    font-family: var(--font-body);
    font-size: var(--text-base);
    line-height: 1.6;
    color: var(--color-text);
    background: var(--color-bg);
    min-height: 100vh;
    min-height: 100dvh;
}

/* ============================================
   LAYOUT
   ============================================ */
.app-container {
    min-height: 100vh;
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
}

.app-header {
    background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 100%);
    color: var(--color-text-inverse);
    padding: var(--space-4) var(--space-5);
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-content {
    max-width: 1100px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.app-title {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.app-subtitle {
    font-size: var(--text-sm);
    opacity: 0.9;
    font-weight: 400;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.header-btn {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--color-text-inverse);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: var(--text-sm);
    transition: all var(--transition-fast);
}

.header-btn:hover {
    background: rgba(255, 255, 255, 0.25);
}

.main-content {
    flex: 1;
    max-width: 1100px;
    width: 100%;
    margin: 0 auto;
    padding: var(--space-5);
}

/* ============================================
   WORKFLOW STEPS
   ============================================ */
.workflow-steps {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-5);
    flex-wrap: wrap;
}

.workflow-step {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.workflow-step:hover {
    border-color: var(--color-primary);
}

.workflow-step.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: var(--color-text-inverse);
}

.workflow-step.completed {
    background: var(--color-primary-pale);
    border-color: var(--color-primary);
    color: var(--color-primary-dark);
}

.step-number {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: currentColor;
    color: var(--color-bg-card);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-xs);
    font-weight: 700;
}

.workflow-step.active .step-number {
    background: var(--color-text-inverse);
    color: var(--color-primary);
}

.workflow-step.completed .step-number {
    background: var(--color-primary);
    color: var(--color-text-inverse);
}

/* ============================================
   CARDS & SECTIONS
   ============================================ */
.card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    margin-bottom: var(--space-4);
}

.card.hidden {
    display: none;
}

.card-header {
    margin-bottom: var(--space-4);
}

.card-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.card-description {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin-top: var(--space-2);
}

.section-divider {
    height: 1px;
    background: var(--color-border);
    margin: var(--space-5) 0;
}

/* ============================================
   FORMS
   ============================================ */
.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-4);
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-label {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
}

.form-label-hint {
    font-weight: 400;
    color: var(--color-text-muted);
}

.form-input,
.form-select,
.form-textarea {
    padding: var(--space-3);
    font-size: var(--text-sm);
    font-family: var(--font-body);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-pale);
}

.form-select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: var(--space-6);
}

.form-textarea {
    resize: vertical;
    min-height: 150px;
    line-height: 1.5;
}

.form-textarea.large {
    min-height: 250px;
}

.form-textarea.code {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
}

.form-hint {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.char-count {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-align: right;
}

/* ============================================
   BUTTONS
   ============================================ */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-5);
    font-size: var(--text-sm);
    font-weight: 600;
    font-family: var(--font-body);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    border: none;
}

.btn-primary {
    background: var(--color-primary);
    color: var(--color-text-inverse);
}

.btn-primary:hover {
    background: var(--color-primary-dark);
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-secondary {
    background: var(--color-bg-warm);
    color: var(--color-text);
    border: 1px solid var(--color-border);
}

.btn-secondary:hover {
    background: var(--color-bg-hover);
    border-color: var(--color-primary);
}

.btn-danger {
    background: var(--color-error);
    color: var(--color-text-inverse);
}

.btn-danger:hover {
    opacity: 0.9;
}

.btn-small {
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-xs);
}

.btn-large {
    padding: var(--space-4) var(--space-6);
    font-size: var(--text-base);
}

.btn-icon {
    font-size: 1.1em;
}

.btn-icon-only {
    padding: var(--space-2);
    min-width: 32px;
    min-height: 32px;
}

.btn-group {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
}

/* ============================================
   OUTPUT SECTION
   ============================================ */
.output-section {
    background: var(--color-bg-warm);
    border: 2px dashed var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
}

.output-section.has-content {
    border-style: solid;
    border-color: var(--color-primary);
    background: var(--color-bg-card);
}

.output-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
}

.output-title {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.output-actions {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
}

.output-preview {
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 400px;
    overflow-y: auto;
    color: var(--color-text-secondary);
}

.output-placeholder {
    text-align: center;
    color: var(--color-text-muted);
    padding: var(--space-6);
}

.output-placeholder-icon {
    font-size: 48px;
    margin-bottom: var(--space-3);
    opacity: 0.5;
}

/* ============================================
   EDITOR SECTION
   ============================================ */
.editor-section {
    margin-top: var(--space-4);
}

.editor-panel {
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-3);
}

.editor-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3) var(--space-4);
    border-bottom: 1px solid var(--color-border);
    cursor: pointer;
    user-select: none;
}

.editor-panel-header:hover {
    background: var(--color-bg-hover);
}

.editor-panel-title {
    font-weight: 600;
    font-size: var(--text-sm);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.editor-panel-meta {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.editor-panel-content {
    padding: var(--space-4);
    background: var(--color-bg-card);
    display: none;
}

.editor-panel.expanded .editor-panel-content {
    display: block;
}

.editor-panel-toggle {
    transition: transform var(--transition-fast);
}

.editor-panel.expanded .editor-panel-toggle {
    transform: rotate(180deg);
}

/* Learning Point Item */
.lp-item {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    margin-bottom: var(--space-3);
    position: relative;
}

.lp-item:last-child {
    margin-bottom: 0;
}

.lp-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
}

.lp-number {
    background: var(--color-primary-pale);
    color: var(--color-primary-dark);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: 600;
    white-space: nowrap;
}

.lp-title-input {
    flex: 1;
    font-weight: 600;
}

.lp-actions {
    display: flex;
    gap: var(--space-1);
}

.lp-fields {
    display: grid;
    gap: var(--space-3);
}

.lp-field-row {
    display: grid;
    grid-template-columns: 80px 1fr;
    gap: var(--space-2);
    align-items: start;
}

.lp-field-label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-muted);
    padding-top: var(--space-2);
}

.lp-meta {
    display: flex;
    gap: var(--space-3);
    margin-top: var(--space-3);
    padding-top: var(--space-3);
    border-top: 1px solid var(--color-border-light);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.lp-meta-item {
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

/* ============================================
   DOWNLOAD SECTION
   ============================================ */
.download-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: var(--space-3);
    margin-top: var(--space-4);
}

.download-item {
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.download-item-title {
    font-weight: 600;
    font-size: var(--text-sm);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.download-item-path {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    word-break: break-all;
}

/* ============================================
   TOAST NOTIFICATIONS
   ============================================ */
.toast-container {
    position: fixed;
    bottom: var(--space-5);
    right: var(--space-5);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.toast {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-3) var(--space-4);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    animation: slideIn 0.3s ease;
    max-width: 350px;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.toast-success { border-left: 3px solid var(--color-success); }
.toast-error { border-left: 3px solid var(--color-error); }
.toast-info { border-left: 3px solid var(--color-primary); }
.toast-warning { border-left: 3px solid var(--color-warning); }

.toast-message {
    font-size: var(--text-sm);
    color: var(--color-text);
    flex: 1;
}

.toast-close {
    background: none;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    padding: var(--space-1);
    font-size: var(--text-lg);
    line-height: 1;
}

/* ============================================
   INSTRUCTIONS PANEL
   ============================================ */
.instructions {
    background: var(--color-primary-pale);
    border: 1px solid var(--color-primary);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin-bottom: var(--space-5);
}

.instructions-title {
    font-weight: 600;
    color: var(--color-primary-dark);
    margin-bottom: var(--space-2);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.instructions-list {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    padding-left: var(--space-5);
}

.instructions-list li {
    margin-bottom: var(--space-1);
}

/* ============================================
   STATS BAR
   ============================================ */
.stats-bar {
    display: flex;
    gap: var(--space-4);
    padding: var(--space-3) var(--space-4);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
    flex-wrap: wrap;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
}

.stat-value {
    font-weight: 700;
    color: var(--color-primary);
}

.stat-label {
    color: var(--color-text-muted);
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 768px) {
    .main-content {
        padding: var(--space-3);
    }
    
    .card {
        padding: var(--space-4);
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .output-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .output-actions {
        justify-content: stretch;
    }
    
    .output-actions .btn {
        flex: 1;
    }
    
    .header-content {
        flex-direction: column;
        text-align: center;
    }
    
    .workflow-steps {
        justify-content: center;
    }
    
    .lp-field-row {
        grid-template-columns: 1fr;
    }
    
    .lp-field-label {
        padding-top: 0;
    }
}

/* ============================================
   PRINT
   ============================================ */
@media print {
    .app-header, .header-actions, .toast-container, .btn, .workflow-steps { display: none; }
    .card { break-inside: avoid; }
}

/* ============================================
   DRAG AND DROP
   ============================================ */
.drag-handle {
    cursor: grab;
    color: var(--color-text-muted);
    padding: var(--space-1);
}

.drag-handle:active {
    cursor: grabbing;
}

.lp-item.dragging {
    opacity: 0.5;
}

.lp-item.drag-over {
    border-color: var(--color-primary);
    border-style: dashed;
}

/* ============================================
   EMPTY STATE
   ============================================ */
.empty-state {
    text-align: center;
    padding: var(--space-6);
    color: var(--color-text-muted);
}

.empty-state-icon {
    font-size: 48px;
    opacity: 0.5;
    margin-bottom: var(--space-3);
}

.empty-state-text {
    font-size: var(--text-sm);
    margin-bottom: var(--space-4);
}
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <div>
                    <h1 class="app-title">
                        <span>üõ†Ô∏è</span>
                        <span>Topic Builder</span>
                    </h1>
                    <p class="app-subtitle">Create topics and learning points for Dynamic Learning Check-in</p>
                </div>
                <div class="header-actions">
                    <button class="header-btn" id="theme-toggle" title="Toggle dark mode">üåô</button>
                    <button class="header-btn" id="clear-all-btn" title="Start over">üóëÔ∏è Reset</button>
                </div>
            </div>
        </header>
        
        <main class="main-content">
            
            <!-- Workflow Steps -->
            <div class="workflow-steps">
                <div class="workflow-step active" data-step="1" onclick="goToStep(1)">
                    <span class="step-number">1</span>
                    <span>Input Content</span>
                </div>
                <div class="workflow-step" data-step="2" onclick="goToStep(2)">
                    <span class="step-number">2</span>
                    <span>Generate Prompt</span>
                </div>
                <div class="workflow-step" data-step="3" onclick="goToStep(3)">
                    <span class="step-number">3</span>
                    <span>Paste AI Response</span>
                </div>
                <div class="workflow-step" data-step="4" onclick="goToStep(4)">
                    <span class="step-number">4</span>
                    <span>Edit & Review</span>
                </div>
                <div class="workflow-step" data-step="5" onclick="goToStep(5)">
                    <span class="step-number">5</span>
                    <span>Download</span>
                </div>
            </div>
            
            <!-- STEP 1: Input Content -->
            <div class="card" id="step-1-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>üìù</span>
                        <span>Topic Details</span>
                    </h2>
                    <p class="card-description">Basic information about the topic. Fill in what you know; the AI can infer the rest.</p>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="year-level">Year Level</label>
                        <select class="form-select" id="year-level">
                            <option value="">-- Select or type below --</option>
                            <option value="Year 7">Year 7</option>
                            <option value="Year 8">Year 8</option>
                            <option value="Year 9">Year 9</option>
                            <option value="Year 10">Year 10</option>
                            <option value="Year 11">Year 11</option>
                            <option value="Year 12">Year 12</option>
                            <option value="VCE Unit 1">VCE Unit 1</option>
                            <option value="VCE Unit 2">VCE Unit 2</option>
                            <option value="VCE Unit 3">VCE Unit 3</option>
                            <option value="VCE Unit 4">VCE Unit 4</option>
                            <option value="custom">Custom...</option>
                        </select>
                        <input type="text" class="form-input" id="year-level-custom" placeholder="Enter custom year level" style="display: none;">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="subject">Subject</label>
                        <select class="form-select" id="subject">
                            <option value="">-- Select or type below --</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="English">English</option>
                            <option value="Science">Science</option>
                            <option value="Biology">Biology</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Physics">Physics</option>
                            <option value="Psychology">Psychology</option>
                            <option value="History">History</option>
                            <option value="Geography">Geography</option>
                            <option value="Economics">Economics</option>
                            <option value="Business Management">Business Management</option>
                            <option value="Legal Studies">Legal Studies</option>
                            <option value="Health and Physical Education">Health and Physical Education</option>
                            <option value="Digital Technologies">Digital Technologies</option>
                            <option value="custom">Custom...</option>
                        </select>
                        <input type="text" class="form-input" id="subject-custom" placeholder="Enter custom subject" style="display: none;">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="topic-name">Topic Name <span class="form-label-hint">(optional)</span></label>
                        <input type="text" class="form-input" id="topic-name" placeholder="e.g., Forces and Motion">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="class-code">Class Code <span class="form-label-hint">(optional)</span></label>
                        <input type="text" class="form-input" id="class-code" placeholder="e.g., 7A Science">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="curriculum-code">Curriculum Code <span class="form-label-hint">(optional)</span></label>
                        <input type="text" class="form-input" id="curriculum-code" placeholder="e.g., VCSSU091">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="ai-target">AI Target</label>
                        <select class="form-select" id="ai-target">
                            <option value="claude" selected>Claude (Anthropic)</option>
                            <option value="chatgpt">ChatGPT (OpenAI)</option>
                            <option value="gemini">Gemini (Google)</option>
                            <option value="generic">Generic / Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="section-divider"></div>
                
                <div class="card-header">
                    <h2 class="card-title">
                        <span>üìö</span>
                        <span>Content Sources</span>
                    </h2>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label" for="teacher-content">Teaching Content</label>
                    <textarea class="form-textarea large" id="teacher-content" placeholder="Paste your teaching notes, lesson plans, explanations, examples, assessment criteria, etc.

The more detail you provide, the better the AI can create relevant learning points."></textarea>
                    <div class="char-count" id="teacher-content-count">0 characters</div>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label" for="curriculum-content">Curriculum Specifications <span class="form-label-hint">(optional)</span></label>
                    <textarea class="form-textarea" id="curriculum-content" placeholder="Paste curriculum content: Area of Study, Key Knowledge, Key Skills, Content Descriptions, etc."></textarea>
                    <div class="char-count" id="curriculum-content-count">0 characters</div>
                </div>
                
                <div style="text-align: center; margin-top: var(--space-4);">
                    <button class="btn btn-primary btn-large" id="generate-btn" onclick="generatePrompt()">
                        <span class="btn-icon">‚ú®</span>
                        <span>Generate Prompt</span>
                    </button>
                </div>
            </div>
            
            <!-- STEP 2: Generated Prompt -->
            <div class="card hidden" id="step-2-card">
                <div class="output-section has-content">
                    <div class="output-header">
                        <h2 class="output-title">
                            <span>üì§</span>
                            <span>Generated Prompt</span>
                        </h2>
                        <div class="output-actions">
                            <button class="btn btn-primary" onclick="copyPrompt()">
                                <span class="btn-icon">üìã</span>
                                <span>Copy to Clipboard</span>
                            </button>
                        </div>
                    </div>
                    <div class="output-preview" id="prompt-output"></div>
                </div>
                
                <div style="text-align: center; margin-top: var(--space-4);">
                    <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back to Edit</button>
                    <button class="btn btn-primary" onclick="goToStep(3)">Continue to Paste Response ‚Üí</button>
                </div>
            </div>
            
            <!-- STEP 3: Paste AI Response -->
            <div class="card hidden" id="step-3-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>üì•</span>
                        <span>Paste AI Response</span>
                    </h2>
                    <p class="card-description">Copy the AI's response and paste it below. The builder will parse the JSON files automatically.</p>
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label" for="ai-response">AI Response</label>
                    <textarea class="form-textarea large code" id="ai-response" placeholder="Paste the complete AI response here...

It should contain blocks like:
--- FILE: topic.json ---
{...}

--- FILE: subtopics/understanding-forces.json ---
{...}"></textarea>
                </div>
                
                <div style="text-align: center; margin-top: var(--space-4);">
                    <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
                    <button class="btn btn-primary btn-large" onclick="parseResponse()">
                        <span class="btn-icon">üîç</span>
                        <span>Parse Response</span>
                    </button>
                </div>
            </div>
            
            <!-- STEP 4: Edit & Review -->
            <div class="card hidden" id="step-4-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>‚úèÔ∏è</span>
                        <span>Edit & Review</span>
                    </h2>
                    <p class="card-description">Review and edit the parsed content. UUIDs and version numbers are auto-generated.</p>
                </div>
                
                <div class="stats-bar" id="stats-bar">
                    <div class="stat-item">
                        <span class="stat-value" id="stat-subtopics">0</span>
                        <span class="stat-label">Subtopics</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="stat-lps">0</span>
                        <span class="stat-label">Learning Points</span>
                    </div>
                </div>
                
                <!-- Topic Metadata Panel -->
                <div class="editor-panel expanded" id="topic-panel">
                    <div class="editor-panel-header" onclick="togglePanel('topic-panel')">
                        <div class="editor-panel-title">
                            <span>üìã</span>
                            <span>Topic Metadata</span>
                        </div>
                        <span class="editor-panel-toggle">‚ñº</span>
                    </div>
                    <div class="editor-panel-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Topic ID</label>
                                <input type="text" class="form-input" id="edit-topic-id" placeholder="topic-id">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Topic Name</label>
                                <input type="text" class="form-input" id="edit-topic-name" placeholder="Topic Name">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Subject</label>
                                <input type="text" class="form-input" id="edit-topic-subject" placeholder="Subject">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Year Level</label>
                                <input type="text" class="form-input" id="edit-topic-year" placeholder="Year Level">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Class</label>
                                <input type="text" class="form-input" id="edit-topic-class" placeholder="Class">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Curriculum Code</label>
                                <input type="text" class="form-input" id="edit-topic-curriculum" placeholder="Curriculum Code">
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Description</label>
                            <textarea class="form-textarea" id="edit-topic-description" placeholder="Brief description of the topic" style="min-height: 80px;"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Subtopics Container -->
                <div id="subtopics-container"></div>
                
                <div style="text-align: center; margin-top: var(--space-4);">
                    <button class="btn btn-secondary" onclick="addSubtopic()">
                        <span class="btn-icon">‚ûï</span>
                        <span>Add Subtopic</span>
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: var(--space-5);">
                    <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back</button>
                    <button class="btn btn-primary btn-large" onclick="goToStep(5)">
                        <span class="btn-icon">üì¶</span>
                        <span>Continue to Download</span>
                    </button>
                </div>
            </div>
            
            <!-- STEP 5: Download -->
            <div class="card hidden" id="step-5-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <span>üì¶</span>
                        <span>Download Files</span>
                    </h2>
                    <p class="card-description">Download individual files or everything as a ZIP archive.</p>
                </div>
                
                <div class="stats-bar">
                    <div class="stat-item">
                        <span class="stat-value" id="dl-stat-files">0</span>
                        <span class="stat-label">Files Ready</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-bottom: var(--space-5);">
                    <button class="btn btn-primary btn-large" onclick="downloadZip()">
                        <span class="btn-icon">üì•</span>
                        <span>Download All (ZIP)</span>
                    </button>
                </div>
                
                <h3 style="margin-bottom: var(--space-3); font-size: var(--text-base);">Individual Files</h3>
                <div class="download-grid" id="download-grid"></div>
                
                <div style="text-align: center; margin-top: var(--space-5);">
                    <button class="btn btn-secondary" onclick="goToStep(4)">‚Üê Back to Edit</button>
                </div>
            </div>
            
        </main>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <script>
// ============================================
// STATE
// ============================================
let currentTheme = 'light';
let currentStep = 1;
let generatedPrompt = '';

// The main data structure
let topicData = {
    id: '',
    name: '',
    subject: '',
    yearLevel: '',
    class: '',
    curriculumCode: '',
    description: '',
    subtopics: []
};

// ============================================
// INITIALIZATION
// ============================================
function init() {
    // Theme
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        setTheme('dark');
    }
    
    // Event listeners
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
    document.getElementById('clear-all-btn').addEventListener('click', clearAll);
    
    // Custom field toggles
    document.getElementById('year-level').addEventListener('change', handleCustomSelect);
    document.getElementById('subject').addEventListener('change', handleCustomSelect);
    
    // Character counts
    document.getElementById('teacher-content').addEventListener('input', updateCharCount);
    document.getElementById('curriculum-content').addEventListener('input', updateCharCount);
}

// ============================================
// THEME
// ============================================
function setTheme(theme) {
    currentTheme = theme;
    document.documentElement.setAttribute('data-theme', theme);
    document.getElementById('theme-toggle').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}

function toggleTheme() {
    setTheme(currentTheme === 'dark' ? 'light' : 'dark');
}

// ============================================
// WORKFLOW STEPS
// ============================================
function goToStep(step) {
    // Update step indicators
    document.querySelectorAll('.workflow-step').forEach(el => {
        const stepNum = parseInt(el.dataset.step);
        el.classList.remove('active', 'completed');
        if (stepNum < step) {
            el.classList.add('completed');
        } else if (stepNum === step) {
            el.classList.add('active');
        }
    });
    
    // Show/hide cards
    for (let i = 1; i <= 5; i++) {
        const card = document.getElementById(`step-${i}-card`);
        if (card) {
            card.classList.toggle('hidden', i !== step);
        }
    }
    
    currentStep = step;
    
    // Prepare step content
    if (step === 5) {
        prepareDownloads();
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ============================================
// UI HELPERS
// ============================================
function handleCustomSelect(e) {
    const select = e.target;
    const customInput = document.getElementById(select.id + '-custom');
    
    if (select.value === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
    } else {
        customInput.style.display = 'none';
        customInput.value = '';
    }
}

function updateCharCount(e) {
    const textarea = e.target;
    const countEl = document.getElementById(textarea.id + '-count');
    if (countEl) {
        const count = textarea.value.length;
        countEl.textContent = `${count.toLocaleString()} characters`;
    }
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è' };
    
    toast.innerHTML = `
        <span>${icons[type] || icons.info}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

function togglePanel(panelId) {
    const panel = document.getElementById(panelId);
    panel.classList.toggle('expanded');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================
// FIELD VALUES
// ============================================
function getFieldValue(selectId) {
    const select = document.getElementById(selectId);
    const customInput = document.getElementById(selectId + '-custom');
    
    if (select.value === 'custom' && customInput) {
        return customInput.value.trim();
    }
    return select.value;
}

// ============================================
// UUID & HASH GENERATION
// ============================================
function generateUUID() {
    // Format: lp-{8hex}-{4hex}-{4hex}-{4hex}-{12hex}
    const hex = () => Math.random().toString(16).substring(2);
    return `lp-${hex().substring(0,8)}-${hex().substring(0,4)}-${hex().substring(0,4)}-${hex().substring(0,4)}-${hex().substring(0,12)}`;
}

async function computeContentHash(title, what, why, example) {
    const content = `${title}|${what}|${why}|${example}`;
    const encoder = new TextEncoder();
    const data = encoder.encode(content);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return `hash-${hashHex.substring(0, 8)}`;
}

function toKebabCase(str) {
    return str
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '');
}

// ============================================
// GENERATE PROMPT
// ============================================
function generatePrompt() {
    const yearLevel = getFieldValue('year-level');
    const subject = getFieldValue('subject');
    const topicName = document.getElementById('topic-name').value.trim();
    const classCode = document.getElementById('class-code').value.trim();
    const curriculumCode = document.getElementById('curriculum-code').value.trim();
    const aiTarget = document.getElementById('ai-target').value;
    const teacherContent = document.getElementById('teacher-content').value.trim();
    const curriculumContent = document.getElementById('curriculum-content').value.trim();
    
    // Validation
    if (!teacherContent && !curriculumContent) {
        showToast('Please provide teaching content or curriculum specifications', 'error');
        return;
    }
    
    // Build metadata section
    let metadataHints = [];
    if (yearLevel) metadataHints.push(`Year Level: ${yearLevel}`);
    if (subject) metadataHints.push(`Subject: ${subject}`);
    if (topicName) metadataHints.push(`Topic Name: ${topicName}`);
    if (classCode) metadataHints.push(`Class Code: ${classCode}`);
    if (curriculumCode) metadataHints.push(`Curriculum Code: ${curriculumCode}`);
    
    const metadataSection = metadataHints.length > 0 
        ? `The teacher has provided the following metadata:\n${metadataHints.join('\n')}`
        : `No metadata provided. Infer appropriate values from the content.`;
    
    // AI-specific instructions
    let aiInstructions = '';
    if (aiTarget === 'claude') {
        aiInstructions = `You are an expert curriculum designer helping a teacher create learning materials.`;
    } else if (aiTarget === 'chatgpt') {
        aiInstructions = `You are an expert curriculum designer. Follow instructions carefully and output only the requested format with no additional commentary.`;
    } else if (aiTarget === 'gemini') {
        aiInstructions = `You are an expert curriculum designer. Output only the requested format with no markdown code blocks.`;
    } else {
        aiInstructions = `You are an expert curriculum designer.`;
    }
    
    const prompt = `${aiInstructions}

Your task is to create learning materials for a student self-assessment app. You will output MULTIPLE JSON files, each clearly marked.

${metadataSection}

---

## TEACHER'S CONTENT

${teacherContent || '(No teacher content provided - rely on curriculum specifications)'}

---

## CURRICULUM SPECIFICATIONS

${curriculumContent || '(No curriculum specifications provided - rely on teacher content)'}

---

## OUTPUT FORMAT

Output multiple JSON files, each preceded by a file marker. Use this EXACT format:

--- FILE: topic.json ---
{
  "id": "topic-id-kebab-case",
  "name": "Topic Name",
  "subject": "Subject Name",
  "yearLevel": "Year X",
  "class": "Class code",
  "curriculumCode": "Curriculum codes",
  "description": "Brief 1-2 sentence description",
  "subtopics": [
    { "id": "subtopic-id", "name": "Subtopic Name", "icon": "üìä", "file": "subtopic-id.json" }
  ]
}

--- FILE: subtopics/subtopic-id.json ---
{
  "id": "subtopic-id",
  "name": "Subtopic Name",
  "icon": "üìä",
  "what": "What this subtopic covers (2-3 sentences)",
  "why": "Why it matters (2-3 sentences)",
  "items": [
    {
      "id": 1,
      "title": "I can [specific measurable skill]",
      "code": "1.1",
      "what": "Clear explanation (1-2 sentences)",
      "why": "Why this matters (1-2 sentences)",
      "example": "A concrete, specific example"
    }
  ]
}

---

## REQUIREMENTS

1. **Structure**: Create 3-6 subtopics with 3-8 learning points each (15-30 total)
2. **Learning Points**: Each title MUST start with "I can"
3. **IDs**: Use kebab-case for all IDs
4. **Icons**: Use relevant emoji for subtopics (üìê üìä üìà üî¢ üí° üßÆ üî¨ üìñ etc.)
5. **Tone**: Calm and factual. No exclamation marks. Student-friendly language.
6. **Examples**: Must be concrete and specific (use actual numbers, scenarios)
7. **File Markers**: Use exactly "--- FILE: filename ---" before each JSON block

## WHAT NOT TO DO

- No text before/after the file markers and JSON
- No markdown code blocks (\`\`\`)
- No exclamation marks
- No vague learning intentions
- No skipping what/why/example fields

Now generate the files:`;

    generatedPrompt = prompt;
    document.getElementById('prompt-output').textContent = prompt;
    goToStep(2);
    showToast('Prompt generated', 'success');
}

// ============================================
// COPY PROMPT
// ============================================
async function copyPrompt() {
    try {
        await navigator.clipboard.writeText(generatedPrompt);
        showToast('Copied to clipboard', 'success');
    } catch (err) {
        // Fallback
        const textarea = document.createElement('textarea');
        textarea.value = generatedPrompt;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showToast('Copied to clipboard', 'success');
        } catch (e) {
            showToast('Failed to copy', 'error');
        }
        document.body.removeChild(textarea);
    }
}

// ============================================
// PARSE AI RESPONSE
// ============================================
function parseResponse() {
    const response = document.getElementById('ai-response').value.trim();
    
    if (!response) {
        showToast('Please paste the AI response', 'error');
        return;
    }
    
    // Parse file blocks - more forgiving regex
    // Matches: --- FILE: path/to/file.json --- (with flexible whitespace and dashes)
    const filePattern = /---+\s*FILE:\s*([^\n]+?)\s*---+\s*\n([\s\S]*?)(?=---+\s*FILE:|$)/gi;
    const files = {};
    let match;
    let parseErrors = [];
    
    while ((match = filePattern.exec(response)) !== null) {
        let filename = match[1].trim();
        let content = match[2].trim();
        
        // Clean up filename (remove any trailing dashes or spaces)
        filename = filename.replace(/[-\s]+$/, '');
        
        // Try to parse JSON
        try {
            // Remove any markdown code blocks if present
            content = content.replace(/^```json?\s*/i, '').replace(/\s*```\s*$/i, '');
            // Also handle case where there might be text after the JSON
            // Find the last closing brace
            const lastBrace = content.lastIndexOf('}');
            if (lastBrace !== -1 && lastBrace < content.length - 1) {
                content = content.substring(0, lastBrace + 1);
            }
            files[filename] = JSON.parse(content);
            console.log(`Parsed: ${filename}`);
        } catch (e) {
            console.error(`Failed to parse ${filename}:`, e);
            parseErrors.push(filename);
        }
    }
    
    if (Object.keys(files).length === 0) {
        showToast('No valid file blocks found. Check the format.', 'error');
        return;
    }
    
    if (parseErrors.length > 0) {
        showToast(`Warning: Could not parse ${parseErrors.length} file(s)`, 'warning');
    }
    
    console.log('Parsed files:', Object.keys(files));
    
    // Process topic.json
    const topicJsonKey = Object.keys(files).find(k => k.toLowerCase().includes('topic.json') && !k.includes('subtopic'));
    
    if (topicJsonKey) {
        const topic = files[topicJsonKey];
        topicData.id = topic.id || toKebabCase(topic.name || 'untitled');
        topicData.name = topic.name || '';
        topicData.subject = topic.subject || '';
        topicData.yearLevel = topic.yearLevel || '';
        topicData.class = topic.class || '';
        topicData.curriculumCode = topic.curriculumCode || '';
        topicData.description = topic.description || '';
        topicData.subtopics = [];
        
        // Process each subtopic
        if (topic.subtopics && Array.isArray(topic.subtopics)) {
            for (const st of topic.subtopics) {
                // Try multiple ways to find the subtopic file
                const possibleKeys = [
                    `subtopics/${st.file}`,
                    `subtopics/${st.id}.json`,
                    st.file,
                    `${st.id}.json`,
                    // Also try finding by partial match
                ];
                
                let subtopicData = null;
                
                // First try exact matches
                for (const key of possibleKeys) {
                    if (files[key]) {
                        subtopicData = files[key];
                        console.log(`Found subtopic ${st.id} at key: ${key}`);
                        break;
                    }
                }
                
                // If not found, try partial match
                if (!subtopicData) {
                    const matchingKey = Object.keys(files).find(k => 
                        k.includes(st.id) || 
                        (st.file && k.includes(st.file.replace('.json', '')))
                    );
                    if (matchingKey) {
                        subtopicData = files[matchingKey];
                        console.log(`Found subtopic ${st.id} via partial match: ${matchingKey}`);
                    }
                }
                
                if (subtopicData) {
                    // Process learning points - add UUIDs
                    const items = (subtopicData.items || []).map((item, idx) => ({
                        id: item.id || idx + 1,
                        uuid: generateUUID(),
                        version: 1,
                        title: item.title || '',
                        code: item.code || `${topicData.subtopics.length + 1}.${idx + 1}`,
                        what: item.what || '',
                        why: item.why || '',
                        example: item.example || ''
                    }));
                    
                    topicData.subtopics.push({
                        id: subtopicData.id || st.id || toKebabCase(subtopicData.name || `subtopic-${topicData.subtopics.length + 1}`),
                        name: subtopicData.name || st.name || '',
                        icon: subtopicData.icon || st.icon || 'üìö',
                        what: subtopicData.what || '',
                        why: subtopicData.why || '',
                        items: items
                    });
                    
                    console.log(`Added subtopic: ${subtopicData.name} with ${items.length} items`);
                } else {
                    // Create empty subtopic from reference
                    console.warn(`Could not find subtopic data for: ${st.id}`);
                    topicData.subtopics.push({
                        id: st.id || toKebabCase(st.name || `subtopic-${topicData.subtopics.length + 1}`),
                        name: st.name || '',
                        icon: st.icon || 'üìö',
                        what: '',
                        why: '',
                        items: []
                    });
                }
            }
        }
    } else {
        showToast('No topic.json found in response', 'error');
        return;
    }
    
    // Render editor
    renderEditor();
    goToStep(4);
    
    const totalLPs = topicData.subtopics.reduce((sum, st) => sum + st.items.length, 0);
    showToast(`Parsed ${topicData.subtopics.length} subtopics with ${totalLPs} learning points`, 'success');
}

// ============================================
// EDITOR RENDERING
// ============================================
function renderEditor() {
    // Topic metadata
    document.getElementById('edit-topic-id').value = topicData.id;
    document.getElementById('edit-topic-name').value = topicData.name;
    document.getElementById('edit-topic-subject').value = topicData.subject;
    document.getElementById('edit-topic-year').value = topicData.yearLevel;
    document.getElementById('edit-topic-class').value = topicData.class;
    document.getElementById('edit-topic-curriculum').value = topicData.curriculumCode;
    document.getElementById('edit-topic-description').value = topicData.description;
    
    // Bind topic metadata changes
    ['id', 'name', 'subject', 'year', 'class', 'curriculum', 'description'].forEach(field => {
        const el = document.getElementById(`edit-topic-${field}`);
        el.oninput = () => {
            const dataField = field === 'year' ? 'yearLevel' : (field === 'curriculum' ? 'curriculumCode' : field);
            topicData[dataField] = el.value;
        };
    });
    
    // Subtopics
    renderSubtopics();
    updateStats();
}

function renderSubtopics() {
    const container = document.getElementById('subtopics-container');
    container.innerHTML = '';
    
    topicData.subtopics.forEach((subtopic, stIndex) => {
        const panel = document.createElement('div');
        panel.className = 'editor-panel';
        panel.id = `subtopic-panel-${stIndex}`;
        panel.innerHTML = `
            <div class="editor-panel-header" onclick="togglePanel('subtopic-panel-${stIndex}')">
                <div class="editor-panel-title">
                    <span>${subtopic.icon}</span>
                    <span>${subtopic.name || 'Untitled Subtopic'}</span>
                    <span class="editor-panel-meta">${subtopic.items.length} learning points</span>
                </div>
                <div style="display: flex; align-items: center; gap: var(--space-2);">
                    <button class="btn btn-secondary btn-small btn-icon-only" onclick="event.stopPropagation(); moveSubtopic(${stIndex}, -1)" title="Move up" ${stIndex === 0 ? 'disabled' : ''}>‚Üë</button>
                    <button class="btn btn-secondary btn-small btn-icon-only" onclick="event.stopPropagation(); moveSubtopic(${stIndex}, 1)" title="Move down" ${stIndex === topicData.subtopics.length - 1 ? 'disabled' : ''}>‚Üì</button>
                    <button class="btn btn-danger btn-small btn-icon-only" onclick="event.stopPropagation(); deleteSubtopic(${stIndex})" title="Delete">üóëÔ∏è</button>
                    <span class="editor-panel-toggle">‚ñº</span>
                </div>
            </div>
            <div class="editor-panel-content">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Subtopic ID</label>
                        <input type="text" class="form-input" value="${escapeHtml(subtopic.id)}" onchange="updateSubtopic(${stIndex}, 'id', this.value)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" value="${escapeHtml(subtopic.name)}" onchange="updateSubtopic(${stIndex}, 'name', this.value); renderSubtopics();">
                    </div>
                    <div class="form-group" style="max-width: 100px;">
                        <label class="form-label">Icon</label>
                        <input type="text" class="form-input" value="${subtopic.icon}" onchange="updateSubtopic(${stIndex}, 'icon', this.value); renderSubtopics();" style="text-align: center; font-size: 1.2em;">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">What (explanation)</label>
                        <textarea class="form-textarea" style="min-height: 60px;" onchange="updateSubtopic(${stIndex}, 'what', this.value)">${escapeHtml(subtopic.what)}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Why (importance)</label>
                        <textarea class="form-textarea" style="min-height: 60px;" onchange="updateSubtopic(${stIndex}, 'why', this.value)">${escapeHtml(subtopic.why)}</textarea>
                    </div>
                </div>
                
                <div class="section-divider"></div>
                
                <h4 style="margin-bottom: var(--space-3); font-size: var(--text-sm);">Learning Points</h4>
                <div id="lp-container-${stIndex}">
                    ${renderLearningPoints(subtopic.items, stIndex)}
                </div>
                
                <div style="text-align: center; margin-top: var(--space-3);">
                    <button class="btn btn-secondary btn-small" onclick="addLearningPoint(${stIndex})">
                        <span class="btn-icon">‚ûï</span>
                        <span>Add Learning Point</span>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(panel);
    });
}

function renderLearningPoints(items, stIndex) {
    if (items.length === 0) {
        return `<div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p class="empty-state-text">No learning points yet</p>
        </div>`;
    }
    
    return items.map((lp, lpIndex) => `
        <div class="lp-item" data-lp-index="${lpIndex}">
            <div class="lp-header">
                <span class="lp-number">#${lp.id}</span>
                <input type="text" class="form-input lp-title-input" value="${escapeHtml(lp.title)}" onchange="updateLP(${stIndex}, ${lpIndex}, 'title', this.value)" placeholder="I can...">
                <div class="lp-actions">
                    <button class="btn btn-secondary btn-small btn-icon-only drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</button>
                    <button class="btn btn-secondary btn-small btn-icon-only" onclick="moveLP(${stIndex}, ${lpIndex}, -1)" title="Move up" ${lpIndex === 0 ? 'disabled' : ''}>‚Üë</button>
                    <button class="btn btn-secondary btn-small btn-icon-only" onclick="moveLP(${stIndex}, ${lpIndex}, 1)" title="Move down" ${lpIndex === items.length - 1 ? 'disabled' : ''}>‚Üì</button>
                    <button class="btn btn-danger btn-small btn-icon-only" onclick="deleteLP(${stIndex}, ${lpIndex})" title="Delete">üóëÔ∏è</button>
                </div>
            </div>
            <div class="lp-fields">
                <div class="lp-field-row">
                    <span class="lp-field-label">Code</span>
                    <input type="text" class="form-input" value="${escapeHtml(lp.code)}" onchange="updateLP(${stIndex}, ${lpIndex}, 'code', this.value)" style="max-width: 150px;">
                </div>
                <div class="lp-field-row">
                    <span class="lp-field-label">What</span>
                    <textarea class="form-textarea" style="min-height: 50px;" onchange="updateLP(${stIndex}, ${lpIndex}, 'what', this.value)">${escapeHtml(lp.what)}</textarea>
                </div>
                <div class="lp-field-row">
                    <span class="lp-field-label">Why</span>
                    <textarea class="form-textarea" style="min-height: 50px;" onchange="updateLP(${stIndex}, ${lpIndex}, 'why', this.value)">${escapeHtml(lp.why)}</textarea>
                </div>
                <div class="lp-field-row">
                    <span class="lp-field-label">Example</span>
                    <textarea class="form-textarea" style="min-height: 50px;" onchange="updateLP(${stIndex}, ${lpIndex}, 'example', this.value)">${escapeHtml(lp.example)}</textarea>
                </div>
            </div>
            <div class="lp-meta">
                <div class="lp-meta-item" title="Permanent UUID">
                    <span>üîë</span>
                    <code style="font-size: 0.7em;">${lp.uuid.substring(0, 20)}...</code>
                </div>
                <div class="lp-meta-item" title="Version">
                    <span>üìå</span>
                    <span>v${lp.version}</span>
                </div>
            </div>
        </div>
    `).join('');
}

// ============================================
// CRUD OPERATIONS
// ============================================
function updateSubtopic(stIndex, field, value) {
    topicData.subtopics[stIndex][field] = value;
}

function updateLP(stIndex, lpIndex, field, value) {
    topicData.subtopics[stIndex].items[lpIndex][field] = value;
    // Increment version on content change
    if (['title', 'what', 'why', 'example'].includes(field)) {
        topicData.subtopics[stIndex].items[lpIndex].version++;
    }
}

function addSubtopic() {
    const newIndex = topicData.subtopics.length;
    topicData.subtopics.push({
        id: `subtopic-${newIndex + 1}`,
        name: 'New Subtopic',
        icon: 'üìö',
        what: '',
        why: '',
        items: []
    });
    renderSubtopics();
    updateStats();
    
    // Expand the new panel
    setTimeout(() => {
        const panel = document.getElementById(`subtopic-panel-${newIndex}`);
        if (panel) panel.classList.add('expanded');
    }, 0);
}

function deleteSubtopic(stIndex) {
    if (topicData.subtopics[stIndex].items.length > 0) {
        if (!confirm(`Delete "${topicData.subtopics[stIndex].name}" and its ${topicData.subtopics[stIndex].items.length} learning points?`)) {
            return;
        }
    }
    topicData.subtopics.splice(stIndex, 1);
    renderSubtopics();
    updateStats();
}

function moveSubtopic(stIndex, direction) {
    const newIndex = stIndex + direction;
    if (newIndex < 0 || newIndex >= topicData.subtopics.length) return;
    
    const temp = topicData.subtopics[stIndex];
    topicData.subtopics[stIndex] = topicData.subtopics[newIndex];
    topicData.subtopics[newIndex] = temp;
    renderSubtopics();
}

function addLearningPoint(stIndex) {
    const items = topicData.subtopics[stIndex].items;
    const newId = items.length > 0 ? Math.max(...items.map(i => i.id)) + 1 : 1;
    
    items.push({
        id: newId,
        uuid: generateUUID(),
        version: 1,
        title: 'I can ',
        code: `${stIndex + 1}.${newId}`,
        what: '',
        why: '',
        example: ''
    });
    
    renderSubtopics();
    updateStats();
    
    // Re-expand the panel
    setTimeout(() => {
        const panel = document.getElementById(`subtopic-panel-${stIndex}`);
        if (panel) panel.classList.add('expanded');
    }, 0);
}

function deleteLP(stIndex, lpIndex) {
    topicData.subtopics[stIndex].items.splice(lpIndex, 1);
    // Renumber IDs
    topicData.subtopics[stIndex].items.forEach((item, idx) => {
        item.id = idx + 1;
    });
    renderSubtopics();
    updateStats();
    
    // Re-expand the panel
    setTimeout(() => {
        const panel = document.getElementById(`subtopic-panel-${stIndex}`);
        if (panel) panel.classList.add('expanded');
    }, 0);
}

function moveLP(stIndex, lpIndex, direction) {
    const items = topicData.subtopics[stIndex].items;
    const newIndex = lpIndex + direction;
    if (newIndex < 0 || newIndex >= items.length) return;
    
    const temp = items[lpIndex];
    items[lpIndex] = items[newIndex];
    items[newIndex] = temp;
    
    // Renumber IDs
    items.forEach((item, idx) => {
        item.id = idx + 1;
    });
    
    renderSubtopics();
    
    // Re-expand the panel
    setTimeout(() => {
        const panel = document.getElementById(`subtopic-panel-${stIndex}`);
        if (panel) panel.classList.add('expanded');
    }, 0);
}

function updateStats() {
    const totalLPs = topicData.subtopics.reduce((sum, st) => sum + st.items.length, 0);
    document.getElementById('stat-subtopics').textContent = topicData.subtopics.length;
    document.getElementById('stat-lps').textContent = totalLPs;
}

// ============================================
// DOWNLOAD PREPARATION
// ============================================
let downloadFiles = {}; // Store files for individual download

async function prepareDownloads() {
    const grid = document.getElementById('download-grid');
    grid.innerHTML = '';
    downloadFiles = {}; // Reset
    
    let fileCount = 0;
    
    // topic.json
    const topicJson = {
        id: topicData.id,
        name: topicData.name,
        subject: topicData.subject,
        yearLevel: topicData.yearLevel,
        class: topicData.class,
        curriculumCode: topicData.curriculumCode,
        description: topicData.description,
        subtopics: topicData.subtopics.map(st => ({
            id: st.id,
            name: st.name,
            icon: st.icon,
            file: `${st.id}.json`
        }))
    };
    
    downloadFiles['topic.json'] = topicJson;
    addDownloadItem(grid, 'Topic Metadata', 'topic.json');
    fileCount++;
    
    // Subtopic files
    for (const st of topicData.subtopics) {
        const subtopicJson = {
            id: st.id,
            name: st.name,
            icon: st.icon,
            what: st.what,
            why: st.why,
            items: await Promise.all(st.items.map(async (item) => ({
                id: item.id,
                uuid: item.uuid,
                version: item.version,
                title: item.title,
                code: item.code,
                what: item.what,
                why: item.why,
                example: item.example,
                contentHash: await computeContentHash(item.title, item.what, item.why, item.example)
            })))
        };
        
        const filePath = `subtopics/${st.id}.json`;
        downloadFiles[filePath] = subtopicJson;
        addDownloadItem(grid, `${st.icon} ${st.name}`, filePath);
        fileCount++;
    }
    
    // Learning points export
    const exportJson = await generateExportJson();
    const exportPath = `exports/learning-points-export-${getDateStamp()}.json`;
    downloadFiles[exportPath] = exportJson;
    addDownloadItem(grid, 'Question Builder Export', exportPath);
    fileCount++;
    
    document.getElementById('dl-stat-files').textContent = fileCount;
}

function addDownloadItem(grid, title, filePath) {
    const item = document.createElement('div');
    item.className = 'download-item';
    item.innerHTML = `
        <div class="download-item-title">
            <span>üìÑ</span>
            <span>${escapeHtml(title)}</span>
        </div>
        <div class="download-item-path">${escapeHtml(filePath)}</div>
        <button class="btn btn-secondary btn-small" onclick="downloadSingleFile('${filePath}')">
            <span class="btn-icon">üì•</span>
            <span>Download</span>
        </button>
    `;
    grid.appendChild(item);
}

async function generateExportJson() {
    const items = [];
    
    for (const st of topicData.subtopics) {
        for (const item of st.items) {
            items.push({
                uuid: item.uuid,
                id: item.id,
                version: item.version,
                contentHash: await computeContentHash(item.title, item.what, item.why, item.example),
                title: item.title,
                code: item.code,
                what: item.what,
                why: item.why,
                example: item.example,
                subtopic: {
                    id: st.id,
                    name: st.name,
                    what: st.what,
                    why: st.why
                },
                questionsExist: false
            });
        }
    }
    
    return {
        _meta: {
            exportedAt: new Date().toISOString(),
            topicId: topicData.id,
            topicName: topicData.name
        },
        items: items
    };
}

function getDateStamp() {
    const now = new Date();
    return now.toISOString().split('T')[0];
}

// ============================================
// DOWNLOAD FUNCTIONS
// ============================================
function downloadSingleFile(filePath) {
    const data = downloadFiles[filePath];
    if (!data) {
        showToast(`File not found: ${filePath}`, 'error');
        return;
    }
    
    // Pretty print JSON with 2-space indentation
    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filePath.split('/').pop(); // Get just the filename
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast(`Downloaded ${filePath.split('/').pop()}`, 'success');
}

async function downloadZip() {
    const zip = new JSZip();
    
    // topic.json
    const topicJson = {
        id: topicData.id,
        name: topicData.name,
        subject: topicData.subject,
        yearLevel: topicData.yearLevel,
        class: topicData.class,
        curriculumCode: topicData.curriculumCode,
        description: topicData.description,
        subtopics: topicData.subtopics.map(st => ({
            id: st.id,
            name: st.name,
            icon: st.icon,
            file: `${st.id}.json`
        }))
    };
    zip.file('topic.json', JSON.stringify(topicJson, null, 2));
    
    // Subtopic files
    const subtopicsFolder = zip.folder('subtopics');
    for (const st of topicData.subtopics) {
        const subtopicJson = {
            id: st.id,
            name: st.name,
            icon: st.icon,
            what: st.what,
            why: st.why,
            items: await Promise.all(st.items.map(async (item) => ({
                id: item.id,
                uuid: item.uuid,
                version: item.version,
                title: item.title,
                code: item.code,
                what: item.what,
                why: item.why,
                example: item.example,
                contentHash: await computeContentHash(item.title, item.what, item.why, item.example)
            })))
        };
        subtopicsFolder.file(`${st.id}.json`, JSON.stringify(subtopicJson, null, 2));
    }
    
    // Exports folder
    const exportsFolder = zip.folder('exports');
    const exportJson = await generateExportJson();
    exportsFolder.file(`learning-points-export-${getDateStamp()}.json`, JSON.stringify(exportJson, null, 2));
    
    // Questions folder (empty, placeholder)
    zip.folder('questions');
    
    // Generate and download
    const content = await zip.generateAsync({ type: 'blob' });
    const url = URL.createObjectURL(content);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${topicData.id || 'topic'}.zip`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('ZIP downloaded', 'success');
}

// ============================================
// CLEAR ALL
// ============================================
function clearAll() {
    if (!confirm('Reset everything and start over?')) return;
    
    // Reset form fields
    document.getElementById('year-level').value = '';
    document.getElementById('year-level-custom').value = '';
    document.getElementById('year-level-custom').style.display = 'none';
    document.getElementById('subject').value = '';
    document.getElementById('subject-custom').value = '';
    document.getElementById('subject-custom').style.display = 'none';
    document.getElementById('topic-name').value = '';
    document.getElementById('class-code').value = '';
    document.getElementById('curriculum-code').value = '';
    document.getElementById('teacher-content').value = '';
    document.getElementById('curriculum-content').value = '';
    document.getElementById('teacher-content-count').textContent = '0 characters';
    document.getElementById('curriculum-content-count').textContent = '0 characters';
    document.getElementById('ai-response').value = '';
    
    // Reset data
    topicData = {
        id: '',
        name: '',
        subject: '',
        yearLevel: '',
        class: '',
        curriculumCode: '',
        description: '',
        subtopics: []
    };
    
    generatedPrompt = '';
    
    // Go to step 1
    goToStep(1);
    showToast('Reset complete', 'info');
}

// ============================================
// INIT
// ============================================
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
